const e={SHADER_CODE_NOT_FOUND:`SHADER_CODE_NOT_FOUND`,SHADER_MODULE_NOT_FOUND:`SHADER_MODULE_NOT_FOUND`,VERTEX_ENTRY_NOT_FOUND:`VERTEX_ENTRY_NOT_FOUND`,VERTEX_ATTRIBUTE_NOT_FOUND:`VERTEX_ATTRIBUTE_NOT_FOUND`,UNIFORM_NOT_FOUND:`UNIFORM_NOT_FOUND`,STORAGE_NOT_FOUND:`STORAGE_NOT_FOUND`,INVALID_UNIFORM_NAME:`INVALID_UNIFORM_NAME`,BINDING_NOT_FOUND:`BINDING_NOT_FOUND`,PIPELINE_NOT_FOUND:`PIPELINE_NOT_FOUND`},t={SHADER_CODE_NOT_FOUND:`Failed to get a WGSL shader when creating shader module.
        An empty shader will be used instead.`,SHADER_MODULE_NOT_FOUND:`Failed to get shader module in `,VERTEX_ENTRY_NOT_FOUND:`Failed to find function `,VERTEX_ATTRIBUTE_NOT_FOUND:`Failed to find vertex attribute `,UNIFORM_NOT_FOUND:`Failed to find uniform `,STORAGE_NOT_FOUND:`Failed to find storage `,INVALID_UNIFORM_NAME:`Requested uniform is already in use and managed internally: `,BINDING_NOT_FOUND:`Failed to find binding `,PIPELINE_NOT_FOUND:`Failed to get GPU`},n={PIPELINE_NOT_FOUND:8},r={RENDERER_NOT_FOUND:`RENDERER_NOT_FOUND`,TEXTURE_SIZE_NOT_FOUND:`TEXTURE_SIZE_NOT_FOUND`,TEXTURE_NOT_FOUND:`TEXTURE_NOT_FOUND`,INVALID_BYTES_PER_ROW:`INVALID_BYTES_PER_ROW`},i={RENDERER_NOT_FOUND:'"Device.Renderer" instance is required in `Texture` for this operation.\n        Pass it to the `Texture` constructor or use `Texture.Renderer` setter before ',TEXTURE_SIZE_NOT_FOUND:"`size` array or a `width` value is required in `options` parameter of ",TEXTURE_NOT_FOUND:"`options` is required to have a `texture` value or its `create` entry\n        to be either `true` or a `TextureDescriptor` object when calling ",INVALID_BYTES_PER_ROW:"`bytesPerRow` parameter is not a multiple of 256 in "},a={CANVAS_NOT_FOUND:`CANVAS_NOT_FOUND`,CONTEXT_NOT_FOUND:`CONTEXT_NOT_FOUND`,RENDER_PASS_NOT_FOUND:`RENDER_PASS_NOT_FOUND`,COMMAND_ENCODER_NOT_FOUND:`COMMAND_ENCODER_NOT_FOUND`},o={CANVAS_NOT_FOUND:`Failed to get a WebGPU canvas.`,CONTEXT_NOT_FOUND:`Failed to get a WebGPU context.`,RENDER_PASS_NOT_FOUND:`Failed to use pipeline in render pass because it has not started.`,COMMAND_ENCODER_NOT_FOUND:`Failed to get a GPUCommandEncoder.`},s={CANVAS_NOT_FOUND:5,CONTEXT_NOT_FOUND:6,COMMAND_ENCODER_NOT_FOUND:7},c={TIMESTAMP_QUERY_NOT_FOUND:`TIMESTAMP_QUERY_NOT_FOUND`,COMMAND_BUFFER_SUBMITTED:`COMMAND_BUFFER_SUBMITTED`},l={TIMESTAMP_QUERY_NOT_FOUND:'"timestamp-query" feature is required to be set with\n        `Device.SetRequiredFeatures` when creating a new `GPUTiming` instance.',COMMAND_BUFFER_SUBMITTED:"Failed get `GPUCommandEncoder` because `GPUCommandBuffer` was already submitted.\n        Pipeline's `Render` or `Compute` method has to be called with `submit` flag set to `false`."};Yn({DEVICE_LOST:`Device::Lost`});const u=Yn({WEBGPU_NOT_SUPPORTED:`WEBGPU_NOT_SUPPORTED`,ADAPTER_NOT_FOUND:`ADAPTER_NOT_FOUND`,FEATURE_NOT_FOUND:`FEATURE_NOT_FOUND`,DEVICE_NOT_FOUND:`DEVICE_NOT_FOUND`,DEVICE_NOT_REQUESTED:`DEVICE_NOT_REQUESTED`,DEVICE_LOST:`DEVICE_LOST`,INVALID_CALL:`INVALID_CALL`,...e,...r,...a,...c}),d=Yn({WEBGPU_NOT_SUPPORTED:`WebGPU is not supported in this browser.`,ADAPTER_NOT_FOUND:`Failed to get a GPUAdapter.`,DEVICE_NOT_FOUND:`Failed to get a GPUDevice.`,FEATURE_NOT_FOUND:`Failed to get a GPUFeature `,DEVICE_NOT_REQUESTED:`GPUDevice was not requested.`,DEVICE_LOST:`WebGPU device was lost. `,INVALID_CALL:`Invalid call to the following `,...t,...i,...o,...l}),f=Yn({WEBGPU_NOT_SUPPORTED:0,ADAPTER_NOT_FOUND:1,DEVICE_NOT_FOUND:2,DEVICE_NOT_REQUESTED:3,DEVICE_LOST:4,...s,...n});function p(e,t){let n=e,r=f[e];throw Error(`${d[n]}${t??``}`.replace(/\s\s+/g,` `),{cause:r})}function m(e,t){let n=e;console.warn(`${d[n]}${t??``}`.replace(/\s\s+/g,` `))}var h=class{Pipelines=[];#e;Device;#t;#n;#r;constructor(e,t,n=``){this.#r=n,this.#n=t,this.Device=e,this.#t=this.CreateStageLabel(`Command Encoder`)}CreateStageLabel(e){return this.#r&&e&&`${this.#r} ${e}`||``}#i(){return this.#n===`Render`&&GPUShaderStage.FRAGMENT||GPUShaderStage.COMPUTE}CreateTimestampWrites(e,t=0,n=1){return{querySet:e,beginningOfPassWriteIndex:t,endOfPassWriteIndex:n}}ResolveQuerySet(e,t,n=0,r=e.count,i=0){this.GetCommandEncoder(!0).resolveQuerySet(e,n,r,t,i)}CreateBufferBindingLayout(e,t,n,r,i){return r??=this.#i(),{binding:i,visibility:r,buffer:{type:e,hasDynamicOffset:t,minBindingSize:n}}}CreateSamplerBindingLayout(e,t,n){return t??=this.#i(),{binding:n,visibility:t,sampler:{type:e}}}CreateTextureBindingLayout(e,t,n,r,i){return r??=this.#i(),{binding:i,visibility:r,texture:{sampleType:e,viewDimension:t,multisampled:n}}}CreateStorageTextureBindingLayout(e,t,n,r,i){return r??=this.#i(),{binding:i,visibility:r,storageTexture:{access:t,format:e,viewDimension:n}}}CreateExternalTextureBindingLayout(e,t){return e??=this.#i(),{binding:t,visibility:e,externalTexture:{}}}CreateCommandEncoder(){return this.#e=this.Device.createCommandEncoder({label:this.#t})}GetCommandEncoder(e=!1){if(!this.#e){if(e){let e=`${this.#t&&`Label: "${this.#t}".`}`;m(u.COMMAND_ENCODER_NOT_FOUND,` ${e} Creating a new one.`)}return this.CreateCommandEncoder()}return this.#e}SubmitCommandBuffer(){this.Device.queue.submit([this.#e.finish()])}CopyBufferToBuffer(e,t,n=t.size,r=0,i=0){this.GetCommandEncoder(!0).copyBufferToBuffer(e,r,t,i,n)}RemovePipeline(e){let t=this.Pipelines.indexOf(e);t<0?(m(u.PIPELINE_NOT_FOUND,`${this.#n}Pipeline. The following pipeline was not found when
                calling \`${this.#n===`Render`&&`${this.#n}er`||`Computation`}.RemovePipeline\` method.`),console.warn(e)):(this.Pipelines[t].Destroy(),this.Pipelines.splice(t,1),this.Pipelines.forEach((e,t)=>e.Index=t))}set CommandEncoder(e){this.#e=e}set CommandEncoderLabel(e){this.#t=e}get Name(){return this.#r}Destroy(){this.Pipelines.forEach(e=>e.Destroy()),this.CommandEncoder=void 0,this.Pipelines.splice(0)}};const g=Yn({RENDER:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,STORAGE:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING}),_=Yn({NEAREST:`nearest`,LINEAR:`linear`});var v=`@group(0)@binding(0)var<uniform>meshModelViewProjection: mat4x4f;fn GetVertexClipSpace(position: vec4f)->vec4f{return meshModelViewProjection*position;}@vertex fn vertex(@location(0)position: vec4f)->@builtin(position)vec4f {return GetVertexClipSpace(position);}`,y=`@group(0)@binding(1)var<uniform>color: vec4f;@fragment fn fragment()->@location(0)vec4f {return color;}`,b=`@vertex fn vertex()->@builtin(position)vec4f {return vec4f(0);}@fragment fn fragment()->@location(0)vec4f {return vec4f(0);}@compute @workgroup_size(1)fn compute(){}`,x=`const QUAD=array(vec2f(-1.0,-1.0),vec2f(1.0,-1.0),vec2f(1.0,1.0),vec2f(1.0,1.0),vec2f(-1.0,1.0),vec2f(-1.0,-1.0));fn GetQuadCoord(index: u32)->vec2f{return QUAD[index];}struct VertexOutput{@builtin(position)position: vec4f,@location(0)textureCoord: vec2f};@group(0)@binding(0)var Sampler: sampler;@group(0)@binding(1)var Texture: texture_2d<f32>;@vertex fn vertex(@builtin(vertex_index)index: u32)->VertexOutput {let position=GetQuadCoord(index);let coord=(position+1)*0.5;var output: VertexOutput;output.position=vec4f(position,0.0,1.0);output.textureCoord=vec2f(coord.x,1-coord.y);return output;}@fragment fn fragment(@location(0)textureCoord: vec2f)->@location(0)vec4f {return textureSample(Texture,Sampler,textureCoord);}`,S=`const VERTEX=array(vec2f(0,-1),vec2f(1,-1),vec2f(0,0),vec2f(1,0));struct char{coords: vec2f,extent: vec2f,size : vec2f,offset: vec2f};struct text{alpha: f32,scale: f32,color: vec4f,transform: mat4x4f,chars: array<vec3f>};struct camera{view: mat4x4f,projection: mat4x4f};struct MSDFTextVertexOutput{@location(0)textureCoord: vec2f,@builtin(position)position: vec4f};@group(0)@binding(0)var Sampler: sampler;@group(0)@binding(1)var Texture: texture_2d<f32>;@group(0)@binding(2)var<storage>Characters: array<char>;@group(0)@binding(3)var<uniform>Camera: camera;@group(1)@binding(0)var<storage>Text: text;@vertex fn vertex(@builtin(vertex_index)index: u32,@builtin(instance_index)instance: u32)->MSDFTextVertexOutput{var output: MSDFTextVertexOutput;let vertexPosition=VERTEX[index];let textElement=Text.chars[instance];let character=Characters[u32(textElement.z)];output.textureCoord=vertexPosition*vec2f(1,-1);let characterPosition=(vertexPosition*character.size+textElement.xy+character.offset)*Text.scale;output.position=Camera.projection*Camera.view*Text.transform*vec4f(characterPosition,0,1);output.textureCoord*=character.extent;output.textureCoord+=character.coords;return output;}fn SampleMSDFTexture(coord: vec2f)->f32{let c=textureSample(Texture,Sampler,coord);return max(min(c.r,c.g),min(max(c.r,c.g),c.b));}@fragment fn fragment(@location(0)textureCoord: vec2f)->@location(0)vec4f {let signDistance=SampleMSDFTexture(textureCoord)-0.5;let dimensions=vec2f(textureDimensions(Texture,0));let dpdx=dpdxFine(textureCoord);let dpdy=dpdyFine(textureCoord);let x=length(vec2f(dpdx.x,dpdy.x));let y=length(vec2f(dpdx.y,dpdy.y));let dx=dimensions.x*x;let dy=dimensions.y*y;let px=inverseSqrt(dx*dx+dy*dy)*4;let pxDistance=signDistance*px;let a=smoothstep(Text.alpha,-Text.alpha,pxDistance);if(a<0.001){discard;}return vec4f(Text.color.rgb,Text.color.a*a);}`,C=`const QUAD=array(vec2f(-1.0,-1.0),vec2f(1.0,-1.0),vec2f(1.0,1.0),vec2f(1.0,1.0),vec2f(-1.0,1.0),vec2f(-1.0,-1.0));fn GetQuadCoord(index: u32)->vec2f{return QUAD[index];}`,w=`@group(0)@binding(0)var<uniform>resolution: vec3f;fn GetClipSpace(position: vec2f)->vec2f{let clipSpace=position/resolution.xy*2-1;return clipSpace*vec2f(1,-1);}`,T=`@group(0)@binding(0)var<uniform>shapeModelViewProjection: mat3x3f;fn GetVertexClipSpace(position: vec2f)->vec4f{return vec4f((shapeModelViewProjection*vec3f(position,1)).xy,0,1);}@vertex fn vertex(@location(0)position: vec2f)->@builtin(position)vec4f {return GetVertexClipSpace(position);}`,E=`@group(0)@binding(1)var<uniform>color: vec4f;@fragment fn fragment()->@location(0)vec4f {return color;}`;`${v}${y}`;const ee=`${T}\n\n${E}`;var D=class{#e;#t;#n;#r;#i;constructor(e,t){!e&&p(u.DEVICE_NOT_REQUESTED),this.#n=t,this.#e=e}#a(e){return e instanceof HTMLVideoElement?[e.videoWidth,e.videoHeight]:e instanceof VideoFrame?[e.codedWidth,e.codedHeight]:[e.width,e.height]}#o(e,t){let{size:n,width:r,height:i,depthOrArrayLayers:a}=e;return!n&&!r&&p(u.TEXTURE_SIZE_NOT_FOUND,`\`${t}\` method.`),n??{width:r,height:i,depthOrArrayLayers:a}}#s(e,t){let n=e/256;n!==(n|0)&&m(u.INVALID_BYTES_PER_ROW,`\`${t}\` options.`)}CreateSampler(e){if(!e)return this.#e.createSampler();let{addressModeUV:t,addressMode:n,minMagFilter:r,filter:i}=e;return t&&(e.addressModeU=e.addressModeV=t),n&&(e.addressModeU=e.addressModeV=e.addressModeW=n),r&&(e.minFilter=e.magFilter=r),i&&(e.minFilter=e.magFilter=e.mipmapFilter=i),this.#e.createSampler(e)}CreateTexture(e){let t=e.label??`Texture`,{format:n=tn.PreferredCanvasFormat,usage:r=g.RENDER}=e;return this.#e.createTexture({label:t,format:n,usage:r,...e})}WriteTexture(e,t){let{texture:n,mipLevel:r,origin:i,aspect:a,offset:o,rowsPerImage:s}=t,[c,l]=this.#a(n),{bytesPerRow:u}=t;u??=(t.width??c)*Float32Array.BYTES_PER_ELEMENT,this.#e.queue.writeTexture({texture:n,mipLevel:r,origin:i,aspect:a},e,{offset:o,bytesPerRow:u,rowsPerImage:s},this.#o({width:c,height:l,...t},`WriteTexture`))}CreateStorageTexture(e){let{size:t}=e,n=g.STORAGE|e.usage,r=e.label??`Storage Texture`,{format:i=this.PreferredStorageFormat}=e;return t=this.#n&&!t?this.#n.CanvasSize:t,this.CreateTexture({label:r,size:t,format:i,...e,usage:n})}CreateTextureFromSource(e,t={}){t=typeof t==`boolean`&&{}||t;let n=t.size,r=t.size,i=t.mipLevelCount??((t.mipmaps??!0)&&this.GetMipmapLevels(e)||void 0),a=Array.isArray(t.size)||!t.size?n??this.#a(e):[r.width,r.height];return this.CreateTexture({size:a,mipLevelCount:i,...t})}ImportExternalTexture(e,t,n){return this.#e.importExternalTexture({source:e,label:t,colorSpace:n})}async LoadExternalImageSource(e,t={}){return new Promise(n=>{let r=new Image;for(let e in t)r[e]=t[e];r.onload=()=>n(r),r.src=e})}async CreateImageBitmap(e,t,n){let r=await(await fetch(e,n)).blob();return t??={colorSpaceConversion:`none`},createImageBitmap(r,t)}CreateMultisampleTexture(e=!1,t=4,n){!this.#n&&p(u.RENDERER_NOT_FOUND,`creating a multisample texture.`);let{width:r,height:i,format:a}=this.#n.CurrentTexture;return(e||!this.#t||this.#t.width!==r||this.#t.height!==i)&&(this.#t?.destroy(),this.#t=this.CreateTexture({usage:GPUTextureUsage.RENDER_ATTACHMENT,label:n??`Multisample Texture`,size:[r,i],sampleCount:t,format:a})),this.#t}async CopyImageToTexture(e,t={create:!0}){let{create:n,texture:r}=t,[i,a]=this.#a(e),{flipY:o,mipLevel:s,aspect:c,colorSpace:l,premultipliedAlpha:d,mipmaps:f}=t;return f===!1&&((n=typeof n==`object`&&n||{}).mipmaps??=!1),!r&&!n&&p(u.TEXTURE_NOT_FOUND,"`CopyImageToTexture`."),r??=this.CreateTextureFromSource(e,n),this.#e.queue.copyExternalImageToTexture({source:e,origin:t.sourceOrigin,flipY:o},{texture:r,mipLevel:s,origin:t.destinationOrigin,aspect:c,colorSpace:l,premultipliedAlpha:d},this.#o({width:i,height:a,...t},`CopyImageToTexture`)),(f??!0)&&1<r.mipLevelCount&&await(r.depthOrArrayLayers===1?this.GenerateMipmaps(r):this.GenerateCubeMipmaps(r)),r}async#c(e,t,n){!this.#n&&p(u.RENDERER_NOT_FOUND,`creating a texture with mipmaps.`);let{UseDepthStencilAttachment:r,RenderPassDescriptor:i}=this.#n,a=this.#n.Pipelines.map(e=>{let t=e.Active;return e.Active=!1,t}),o=new this.#n.Pipeline;this.#n.UseDepthStencilAttachment=!1,o.DestroyPassEncoder=!0,o.UseTextureView=!1,o.SetDrawParams(6),(!this.#i||!this.#r)&&(this.#i=o.CreateShaderModule(x),this.#r=this.CreateSampler(t)),await this.#n.AddPipeline(o,{vertex:o.CreateVertexState(this.#i),fragment:o.CreateFragmentState(this.#i,o.CreateColorTargetState(e.format))});for(let t=1;t<e.mipLevelCount;++t)n(o,t);this.#n.SubmitCommandBuffer(),this.#n.CommandEncoder=void 0,this.#n.RemovePipeline(o),this.#i=this.#r=void 0,this.#n.UseDepthStencilAttachment=r,a.forEach((e,t)=>this.#n.Pipelines[t].Active=e);let s=i.depthStencilAttachment&&this.#n.CreateDepthStencilAttachment(i.depthStencilAttachment.view,i.depthStencilAttachment.depthClearValue,i.depthStencilAttachment.depthLoadOp,i.depthStencilAttachment.depthStoreOp,i.depthStencilAttachment.depthReadOnly,i.depthStencilAttachment.stencilAttachment);this.#n.CreatePassDescriptor(i.colorAttachments,s,i.label,i.occlusionQuerySet,i.timestampWrites,i.maxDrawCount)}async GenerateCubeMipmaps(e){return this.#c(e,{minMagFilter:_.LINEAR},(t,n)=>{for(let r=0;r<e.depthOrArrayLayers;++r)t.SetBindGroupFromResources([this.#r,e.createView({baseMipLevel:n-1,arrayLayerCount:1,baseArrayLayer:r,mipLevelCount:1,dimension:`2d`})]),this.#n.CreatePassDescriptor(this.#n.CreateColorAttachment(void 0,e.createView({arrayLayerCount:1,baseArrayLayer:r,mipLevelCount:1,dimension:`2d`,baseMipLevel:n}))),this.#n.Render(!1)})}async GenerateMipmaps(e){return this.#c(e,{minFilter:_.LINEAR},(t,n)=>{t.SetBindGroupFromResources([this.#r,e.createView({baseMipLevel:n-1,mipLevelCount:1})]),this.#n.CreatePassDescriptor(this.#n.CreateColorAttachment(void 0,e.createView({baseMipLevel:n,mipLevelCount:1}))),this.#n.Render(!1)})}CopyTextureToTexture(e){let{source:t,create:n}=e,{srcTexture:r,dstTexture:i}=e;!this.#n&&p(u.RENDERER_NOT_FOUND,`copying a texture to a texture.`),!r&&!t&&!n&&p(u.TEXTURE_NOT_FOUND,"`CopyTextureToTexture`."),r??=this.CreateTextureFromSource(t,n),i??=this.CreateTextureFromSource(r,n);let{srcMipLevel:a,srcOrigin:o,srcAspect:s}=e,{dstMipLevel:c,dstOrigin:l,dstAspect:d}=e,[f,m]=this.#a(r);this.#n.GetCommandEncoder(!0).copyTextureToTexture({texture:r,mipLevel:a,origin:o,aspect:s},{texture:i,mipLevel:c,origin:l,aspect:d},this.#o({width:f,height:m,...e},`CopyTextureToTexture`))}CopyTextureToBuffer(e){let{source:t,create:n}=e,{texture:r,bytesPerRow:i}=e;!this.#n&&p(u.RENDERER_NOT_FOUND,`copying a texture to a buffer.`),!r&&!t&&!n&&p(u.TEXTURE_NOT_FOUND,"`CopyTextureToBuffer`."),r??=this.CreateTextureFromSource(t,n);let[a,o]=this.#a(r),{buffer:s,offset:c,rowsPerImage:l,mipLevel:d,origin:f,aspect:m}=e;i??=(e.width??a)*Float32Array.BYTES_PER_ELEMENT,this.#s(i,`CopyTextureToBuffer`),this.#n.GetCommandEncoder(!0).copyTextureToBuffer({texture:r,mipLevel:d,origin:f,aspect:m},{buffer:s,offset:c,bytesPerRow:i,rowsPerImage:l},this.#o({width:a,height:o,...e},`CopyTextureToBuffer`))}CopyBufferToTexture(e){let{source:t,create:n}=e,{texture:r,bytesPerRow:i}=e;!this.#n&&p(u.RENDERER_NOT_FOUND,`copying a buffer to a texture.`),!r&&!t&&!n&&p(u.TEXTURE_NOT_FOUND,"`CopyBufferToTexture`."),r??=this.CreateTextureFromSource(t,n);let[a,o]=this.#a(r),{buffer:s,offset:c,rowsPerImage:l,mipLevel:d,origin:f,aspect:m}=e;i??=(e.width??a)*Float32Array.BYTES_PER_ELEMENT,this.#s(i,`CopyBufferToTexture`),this.#n.GetCommandEncoder(!0).copyBufferToTexture({buffer:s,offset:c,bytesPerRow:i,rowsPerImage:l},{texture:r,mipLevel:d,origin:f,aspect:m},this.#o({width:a,height:o,...e},`CopyBufferToTexture`))}get PreferredStorageFormat(){let e=tn.PreferredCanvasFormat;return this.#e.features.has(`bgra8unorm-storage`)&&e===`bgra8unorm`?e:`rgba8unorm`}GetMipmapLevels(e){let[t,n]=this.#a(e);return(Math.log2(Math.max(t,n))|0)+1}set Renderer(e){this.#n=e}Destroy(){this.#t=this.#t?.destroy()}},O=class{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}},k=class{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}},A=class extends O{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}},j=class extends O{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}},M=class extends O{constructor(e,t,n){super(e,n),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}},N=class extends O{constructor(e,t,n,r){super(e,n),this.format=t,this.access=r}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e===`vec2`||e===`vec3`||e===`vec4`||e===`mat2x2`||e===`mat2x3`||e===`mat2x4`||e===`mat3x2`||e===`mat3x3`||e===`mat3x4`||e===`mat4x2`||e===`mat4x3`||e===`mat4x4`){if(this.format.name===`f32`)return e+=`f`,e;if(this.format.name===`i32`)return e+=`i`,e;if(this.format.name===`u32`)return e+=`u`,e;if(this.format.name===`bool`)return e+=`b`,e;if(this.format.name===`f16`)return e+=`h`,e}e+=`<${this.format.name}>`}else if(e===`vec2`||e===`vec3`||e===`vec4`)return e;return e}},P;(e=>{e[e.Uniform=0]=`Uniform`,e[e.Storage=1]=`Storage`,e[e.Texture=2]=`Texture`,e[e.Sampler=3]=`Sampler`,e[e.StorageTexture=4]=`StorageTexture`})(P||={});var F=class{constructor(e,t,n,r,i,a,o){this.name=e,this.type=t,this.group=n,this.binding=r,this.attributes=i,this.resourceType=a,this.access=o}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}},te=class{constructor(e,t){this.name=e,this.type=t}},ne=class{constructor(e,t,n,r){this.name=e,this.type=t,this.locationType=n,this.location=r,this.interpolation=null}},re=class{constructor(e,t,n,r){this.name=e,this.type=t,this.locationType=n,this.location=r}},ie=class{constructor(e,t,n,r){this.name=e,this.type=t,this.attributes=n,this.id=r}},ae=class{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n}},oe=class{constructor(e,t=null,n){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=n}},se=class{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}};function ce(e){var t=(32768&e)>>15,n=(31744&e)>>10,r=1023&e;return n==0?(t?-1:1)*2**-14*(r/2**10):n==31?r?NaN:1/0*(t?-1:1):(t?-1:1)*2**(n-15)*(1+r/2**10)}var le=new Float32Array(1),ue=new Int32Array(le.buffer),I=new Uint16Array(1);function de(e){le[0]=e;let t=ue[0],n=t>>31&1,r=t>>23&255,i=8388607&t;if(r===255)return I[0]=n<<15|31744|(i===0?0:512),I[0];if(r===0){if(i===0)return I[0]=n<<15,I[0];i|=8388608;let e=113;for(;!(8388608&i);)i<<=1,e--;return r=127-e,i&=8388607,r>0?(i=(i>>126-r)+(i>>127-r&1),I[0]=n<<15|r<<10|i>>13,I[0]):(I[0]=n<<15,I[0])}return r=r-127+15,r>=31?(I[0]=n<<15|31744,I[0]):r<=0?r<-10?(I[0]=n<<15,I[0]):(i=(8388608|i)>>1-r,I[0]=n<<15|i>>13,I[0]):(i>>=13,I[0]=n<<15|r<<10|i,I[0])}var fe=new Uint32Array(1),pe=new Float32Array(fe.buffer,0,1);function me(e){return fe[0]=112+(e>>6&31)<<23|(63&e)<<17,pe[0]}function he(e,t,n,r,i,a,o,s,c){let l=r*(o>>=i)*(a>>=i)+n*o+t*s;switch(c){case`r8unorm`:return[L(e,l,`8unorm`,1)[0]];case`r8snorm`:return[L(e,l,`8snorm`,1)[0]];case`r8uint`:return[L(e,l,`8uint`,1)[0]];case`r8sint`:return[L(e,l,`8sint`,1)[0]];case`rg8unorm`:{let t=L(e,l,`8unorm`,2);return[t[0],t[1]]}case`rg8snorm`:{let t=L(e,l,`8snorm`,2);return[t[0],t[1]]}case`rg8uint`:{let t=L(e,l,`8uint`,2);return[t[0],t[1]]}case`rg8sint`:{let t=L(e,l,`8sint`,2);return[t[0],t[1]]}case`rgba8unorm-srgb`:case`rgba8unorm`:{let t=L(e,l,`8unorm`,4);return[t[0],t[1],t[2],t[3]]}case`rgba8snorm`:{let t=L(e,l,`8snorm`,4);return[t[0],t[1],t[2],t[3]]}case`rgba8uint`:{let t=L(e,l,`8uint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba8sint`:{let t=L(e,l,`8sint`,4);return[t[0],t[1],t[2],t[3]]}case`bgra8unorm-srgb`:case`bgra8unorm`:{let t=L(e,l,`8unorm`,4);return[t[2],t[1],t[0],t[3]]}case`r16uint`:return[L(e,l,`16uint`,1)[0]];case`r16sint`:return[L(e,l,`16sint`,1)[0]];case`r16float`:return[L(e,l,`16float`,1)[0]];case`rg16uint`:{let t=L(e,l,`16uint`,2);return[t[0],t[1]]}case`rg16sint`:{let t=L(e,l,`16sint`,2);return[t[0],t[1]]}case`rg16float`:{let t=L(e,l,`16float`,2);return[t[0],t[1]]}case`rgba16uint`:{let t=L(e,l,`16uint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba16sint`:{let t=L(e,l,`16sint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba16float`:{let t=L(e,l,`16float`,4);return[t[0],t[1],t[2],t[3]]}case`r32uint`:return[L(e,l,`32uint`,1)[0]];case`r32sint`:return[L(e,l,`32sint`,1)[0]];case`depth16unorm`:case`depth24plus`:case`depth24plus-stencil8`:case`depth32float`:case`depth32float-stencil8`:case`r32float`:return[L(e,l,`32float`,1)[0]];case`rg32uint`:{let t=L(e,l,`32uint`,2);return[t[0],t[1]]}case`rg32sint`:{let t=L(e,l,`32sint`,2);return[t[0],t[1]]}case`rg32float`:{let t=L(e,l,`32float`,2);return[t[0],t[1]]}case`rgba32uint`:{let t=L(e,l,`32uint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba32sint`:{let t=L(e,l,`32sint`,4);return[t[0],t[1],t[2],t[3]]}case`rgba32float`:{let t=L(e,l,`32float`,4);return[t[0],t[1],t[2],t[3]]}case`rg11b10ufloat`:{let t=new Uint32Array(e.buffer,l,1)[0],n=(4192256&t)>>11,r=(4290772992&t)>>22;return[me(2047&t),me(n),function(e){return fe[0]=112+(e>>5&31)<<23|(31&e)<<18,pe[0]}(r),1]}}return null}function L(e,t,n,r){let i=[0,0,0,0];for(let a=0;a<r;++a)switch(n){case`8unorm`:i[a]=e[t]/255,t++;break;case`8snorm`:i[a]=e[t]/255*2-1,t++;break;case`8uint`:i[a]=e[t],t++;break;case`8sint`:i[a]=e[t]-127,t++;break;case`16uint`:i[a]=e[t]|e[t+1]<<8,t+=2;break;case`16sint`:i[a]=(e[t]|e[t+1]<<8)-32768,t+=2;break;case`16float`:i[a]=ce(e[t]|e[t+1]<<8),t+=2;break;case`32uint`:case`32sint`:i[a]=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,t+=4;break;case`32float`:i[a]=new Float32Array(e.buffer,t,1)[0],t+=4}return i}function R(e,t,n,r,i){for(let a=0;a<r;++a)switch(n){case`8unorm`:e[t]=255*i[a],t++;break;case`8snorm`:e[t]=.5*(i[a]+1)*255,t++;break;case`8uint`:e[t]=i[a],t++;break;case`8sint`:e[t]=i[a]+127,t++;break;case`16uint`:new Uint16Array(e.buffer,t,1)[0]=i[a],t+=2;break;case`16sint`:new Int16Array(e.buffer,t,1)[0]=i[a],t+=2;break;case`16float`:{let n=de(i[a]);new Uint16Array(e.buffer,t,1)[0]=n,t+=2;break}case`32uint`:new Uint32Array(e.buffer,t,1)[0]=i[a],t+=4;break;case`32sint`:new Int32Array(e.buffer,t,1)[0]=i[a],t+=4;break;case`32float`:new Float32Array(e.buffer,t,1)[0]=i[a],t+=4}return i}var ge={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:`depth32float`,channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:`depth32float`,channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:`depth32float`,channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}},_e=class e{constructor(){this.id=e._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return``}search(e){e(this)}searchBlock(e,t){if(e){t(ve.instance);for(let n of e)n instanceof Array?this.searchBlock(n,t):n.search(t);t(ye.instance)}}constEvaluate(e,t){throw Error(`Cannot evaluate node`)}constEvaluateString(e){return this.constEvaluate(e).toString()}};_e._id=0;var ve=class extends _e{};ve.instance=new ve;var ye=class extends _e{};ye.instance=new ye;var be=new Set(`all.all.any.select.arrayLength.abs.acos.acosh.asin.asinh.atan.atanh.atan2.ceil.clamp.cos.cosh.countLeadingZeros.countOneBits.countTrailingZeros.cross.degrees.determinant.distance.dot.dot4U8Packed.dot4I8Packed.exp.exp2.extractBits.faceForward.firstLeadingBit.firstTrailingBit.floor.fma.fract.frexp.insertBits.inverseSqrt.ldexp.length.log.log2.max.min.mix.modf.normalize.pow.quantizeToF16.radians.reflect.refract.reverseBits.round.saturate.sign.sin.sinh.smoothStep.sqrt.step.tan.tanh.transpose.trunc.dpdx.dpdxCoarse.dpdxFine.dpdy.dpdyCoarse.dpdyFine.fwidth.fwidthCoarse.fwidthFine.textureDimensions.textureGather.textureGatherCompare.textureLoad.textureNumLayers.textureNumLevels.textureNumSamples.textureSample.textureSampleBias.textureSampleCompare.textureSampleCompareLevel.textureSampleGrad.textureSampleLevel.textureSampleBaseClampToEdge.textureStore.atomicLoad.atomicStore.atomicAdd.atomicSub.atomicMax.atomicMin.atomicAnd.atomicOr.atomicXor.atomicExchange.atomicCompareExchangeWeak.pack4x8snorm.pack4x8unorm.pack4xI8.pack4xU8.pack4x8Clamp.pack4xU8Clamp.pack2x16snorm.pack2x16unorm.pack2x16float.unpack4x8snorm.unpack4x8unorm.unpack4xI8.unpack4xU8.unpack2x16snorm.unpack2x16unorm.unpack2x16float.storageBarrier.textureBarrier.workgroupBarrier.workgroupUniformLoad.subgroupAdd.subgroupExclusiveAdd.subgroupInclusiveAdd.subgroupAll.subgroupAnd.subgroupAny.subgroupBallot.subgroupBroadcast.subgroupBroadcastFirst.subgroupElect.subgroupMax.subgroupMin.subgroupMul.subgroupExclusiveMul.subgroupInclusiveMul.subgroupOr.subgroupShuffle.subgroupShuffleDown.subgroupShuffleUp.subgroupShuffleXor.subgroupXor.quadBroadcast.quadSwapDiagonal.quadSwapX.quadSwapY`.split(`.`)),z=class extends _e{constructor(){super()}},xe=class extends z{constructor(e,t,n,r,i,a){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=n,this.body=r,this.startLine=i,this.endLine=a}get astNodeType(){return`function`}search(e){if(this.attributes)for(let t of this.attributes)e(t);e(this);for(let t of this.args)e(t);this.searchBlock(this.body,e)}},Se=class extends z{constructor(e){super(),this.expression=e}get astNodeType(){return`staticAssert`}search(e){this.expression.search(e)}},Ce=class extends z{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return`while`}search(e){this.condition.search(e),this.searchBlock(this.body,e)}},we=class extends z{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return`continuing`}search(e){this.searchBlock(this.body,e)}},Te=class extends z{constructor(e,t,n,r){super(),this.init=e,this.condition=t,this.increment=n,this.body=r}get astNodeType(){return`for`}search(e){var t,n,r;(t=this.init)==null||t.search(e),(n=this.condition)==null||n.search(e),(r=this.increment)==null||r.search(e),this.searchBlock(this.body,e)}},Ee=class extends z{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return`var`}search(e){var t;e(this),(t=this.value)==null||t.search(e)}},De=class extends z{constructor(e,t,n){super(),this.attributes=null,this.name=e,this.type=t,this.value=n}get astNodeType(){return`override`}search(e){var t;(t=this.value)==null||t.search(e)}},Oe=class extends z{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return`let`}search(e){var t;e(this),(t=this.value)==null||t.search(e)}},ke=class extends z{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return`const`}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)==null||t.search(e)}},Ae,je,B,V;(e=>{e.increment=`++`,e.decrement=`--`})(Ae||={}),(e=>{e.parse=function(t){let n=t;if(n==`parse`)throw Error(`Invalid value for IncrementOperator`);return e[n]}})(Ae||={});var Me=class extends z{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return`increment`}search(e){this.variable.search(e)}};(e=>{e.assign=`=`,e.addAssign=`+=`,e.subtractAssin=`-=`,e.multiplyAssign=`*=`,e.divideAssign=`/=`,e.moduloAssign=`%=`,e.andAssign=`&=`,e.orAssign=`|=`,e.xorAssign=`^=`,e.shiftLeftAssign=`<<=`,e.shiftRightAssign=`>>=`})(je||={}),(e=>{e.parse=function(e){let t=e;if(t==`parse`)throw Error(`Invalid value for AssignOperator`);return t}})(je||={});var Ne=class extends z{constructor(e,t,n){super(),this.operator=e,this.variable=t,this.value=n}get astNodeType(){return`assign`}search(e){this.variable.search(e),this.value.search(e)}},Pe=class extends z{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return`call`}isBuiltin(){return be.has(this.name)}search(e){for(let t of this.args)t.search(e);e(this)}},Fe=class extends z{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return`loop`}search(e){var t;this.searchBlock(this.body,e),(t=this.continuing)==null||t.search(e)}},Ie=class extends z{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return`switch`}search(e){e(this);for(let t of this.cases)t.search(e)}},Le=class extends z{constructor(e,t,n,r){super(),this.condition=e,this.body=t,this.elseif=n,this.else=r}get astNodeType(){return`if`}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}},Re=class extends z{constructor(e){super(),this.value=e}get astNodeType(){return`return`}search(e){var t;(t=this.value)==null||t.search(e)}},ze=class extends z{constructor(e){super(),this.name=e}get astNodeType(){return`enable`}},Be=class extends z{constructor(e){super(),this.extensions=e}get astNodeType(){return`requires`}},Ve=class extends z{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return`diagnostic`}},He=class extends z{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return`alias`}},Ue=class extends z{constructor(){super()}get astNodeType(){return`discard`}},We=class extends z{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return`break`}},Ge=class extends z{constructor(){super(),this.loopId=-1}get astNodeType(){return`continue`}},H=class e extends z{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return`type`}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(t){let n=t[0];if(n.name===`f32`)return n;for(let r=1;r<t.length;++r){let i=e._priority.get(n.name);e._priority.get(t[r].name)<i&&(n=t[r])}return n.name===`x32`?e.i32:n}getTypeName(){return this.name}};H.x32=new H(`x32`),H.f32=new H(`f32`),H.i32=new H(`i32`),H.u32=new H(`u32`),H.f16=new H(`f16`),H.bool=new H(`bool`),H.void=new H(`void`),H._priority=new Map([[`f32`,0],[`f16`,1],[`u32`,2],[`i32`,3],[`x32`,3]]);var Ke=class extends H{constructor(e){super(e)}},qe=class extends H{constructor(e,t,n,r){super(e),this.members=t,this.startLine=n,this.endLine=r}get astNodeType(){return`struct`}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(let t of this.members)e(t)}},U=class extends H{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return`template`}getTypeName(){let e=this.name;if(this.format!==null){if(e===`vec2`||e===`vec3`||e===`vec4`||e===`mat2x2`||e===`mat2x3`||e===`mat2x4`||e===`mat3x2`||e===`mat3x3`||e===`mat3x4`||e===`mat4x2`||e===`mat4x3`||e===`mat4x4`){if(this.format.name===`f32`)return e+=`f`,e;if(this.format.name===`i32`)return e+=`i`,e;if(this.format.name===`u32`)return e+=`u`,e;if(this.format.name===`bool`)return e+=`b`,e;if(this.format.name===`f16`)return e+=`h`,e}e+=`<${this.format.name}>`}else if(e===`vec2`||e===`vec3`||e===`vec4`)return e;return e}};U.vec2f=new U(`vec2`,H.f32,null),U.vec3f=new U(`vec3`,H.f32,null),U.vec4f=new U(`vec4`,H.f32,null),U.vec2i=new U(`vec2`,H.i32,null),U.vec3i=new U(`vec3`,H.i32,null),U.vec4i=new U(`vec4`,H.i32,null),U.vec2u=new U(`vec2`,H.u32,null),U.vec3u=new U(`vec3`,H.u32,null),U.vec4u=new U(`vec4`,H.u32,null),U.vec2h=new U(`vec2`,H.f16,null),U.vec3h=new U(`vec3`,H.f16,null),U.vec4h=new U(`vec4`,H.f16,null),U.vec2b=new U(`vec2`,H.bool,null),U.vec3b=new U(`vec3`,H.bool,null),U.vec4b=new U(`vec4`,H.bool,null),U.mat2x2f=new U(`mat2x2`,H.f32,null),U.mat2x3f=new U(`mat2x3`,H.f32,null),U.mat2x4f=new U(`mat2x4`,H.f32,null),U.mat3x2f=new U(`mat3x2`,H.f32,null),U.mat3x3f=new U(`mat3x3`,H.f32,null),U.mat3x4f=new U(`mat3x4`,H.f32,null),U.mat4x2f=new U(`mat4x2`,H.f32,null),U.mat4x3f=new U(`mat4x3`,H.f32,null),U.mat4x4f=new U(`mat4x4`,H.f32,null),U.mat2x2h=new U(`mat2x2`,H.f16,null),U.mat2x3h=new U(`mat2x3`,H.f16,null),U.mat2x4h=new U(`mat2x4`,H.f16,null),U.mat3x2h=new U(`mat3x2`,H.f16,null),U.mat3x3h=new U(`mat3x3`,H.f16,null),U.mat3x4h=new U(`mat3x4`,H.f16,null),U.mat4x2h=new U(`mat4x2`,H.f16,null),U.mat4x3h=new U(`mat4x3`,H.f16,null),U.mat4x4h=new U(`mat4x4`,H.f16,null),U.mat2x2i=new U(`mat2x2`,H.i32,null),U.mat2x3i=new U(`mat2x3`,H.i32,null),U.mat2x4i=new U(`mat2x4`,H.i32,null),U.mat3x2i=new U(`mat3x2`,H.i32,null),U.mat3x3i=new U(`mat3x3`,H.i32,null),U.mat3x4i=new U(`mat3x4`,H.i32,null),U.mat4x2i=new U(`mat4x2`,H.i32,null),U.mat4x3i=new U(`mat4x3`,H.i32,null),U.mat4x4i=new U(`mat4x4`,H.i32,null),U.mat2x2u=new U(`mat2x2`,H.u32,null),U.mat2x3u=new U(`mat2x3`,H.u32,null),U.mat2x4u=new U(`mat2x4`,H.u32,null),U.mat3x2u=new U(`mat3x2`,H.u32,null),U.mat3x3u=new U(`mat3x3`,H.u32,null),U.mat3x4u=new U(`mat3x4`,H.u32,null),U.mat4x2u=new U(`mat4x2`,H.u32,null),U.mat4x3u=new U(`mat4x3`,H.u32,null),U.mat4x4u=new U(`mat4x4`,H.u32,null);var Je=class extends H{constructor(e,t,n,r){super(e),this.storage=t,this.type=n,this.access=r}get astNodeType(){return`pointer`}},Ye=class extends H{constructor(e,t,n,r){super(e),this.attributes=t,this.format=n,this.count=r}get astNodeType(){return`array`}get isArray(){return!0}},Xe=class extends H{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return`sampler`}},Ze=class extends _e{constructor(){super(),this.postfix=null}},Qe=class extends Ze{constructor(e){super(),this.value=e}get astNodeType(){return`stringExpr`}toString(){return this.value}constEvaluateString(){return this.value}},$e=class extends Ze{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return`createExpr`}search(e){if(e(this),this.args)for(let t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}},et=class extends Ze{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return`callExpr`}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return be.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(let t of this.args)t.search(e);e(this)}},tt=class extends Ze{constructor(e){super(),this.name=e}get astNodeType(){return`varExpr`}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}},nt=class extends Ze{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return`constExpr`}constEvaluate(e,t){if(this.initializer){let t=e.evalExpression(this.initializer,e.context);return t!==null&&this.postfix?t.getSubData(e,this.postfix,e.context):t}return null}search(e){this.initializer.search(e)}},rt=class extends Ze{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return`literalExpr`}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof W}get isVector(){return this.value instanceof G||this.value instanceof K}get scalarValue(){return this.value instanceof W?this.value.value:(console.error(`Value is not scalar.`),0)}get vectorValue(){return this.value instanceof G||this.value instanceof K?this.value.data:(console.error(`Value is not a vector or matrix.`),new Float32Array)}},it=class extends Ze{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return`bitcastExpr`}search(e){this.value.search(e)}},at=class extends Ze{constructor(e){super(),this.index=e}search(e){this.index.search(e)}},ot=class extends Ze{constructor(){super()}},st=class extends ot{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return`unaryOp`}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}},ct=class extends ot{constructor(e,t,n){super(),this.operator=e,this.left=t,this.right=n}get astNodeType(){return`binaryOp`}_getPromotedType(e,t){return e.name===t.name?e:e.name===`f32`||t.name===`f32`?H.f32:e.name===`u32`||t.name===`u32`?H.u32:H.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}},lt=class extends _e{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}},ut=class extends Ze{constructor(){super()}get astNodeType(){return`default`}},dt=class extends lt{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return`case`}search(e){this.searchBlock(this.body,e)}},ft=class extends lt{constructor(e){super(e)}get astNodeType(){return`default`}search(e){this.searchBlock(this.body,e)}},pt=class extends _e{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return`argument`}},mt=class extends _e{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return`elseif`}search(e){this.condition.search(e),this.searchBlock(this.body,e)}},ht=class extends _e{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return`member`}},gt=class extends _e{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return`attribute`}},_t=class e{constructor(t,n){this.parent=null,this.typeInfo=t,this.parent=n,this.id=e._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,n,r){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,n){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}};_t._id=0;var vt=class extends _t{constructor(){super(new O(`void`,null),null)}toString(){return`void`}};vt.void=new vt;var yt=class extends _t{constructor(e){super(new M(`pointer`,e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,n,r){this.reference.setDataValue(e,t,n,r)}getSubData(e,t,n){return t?this.reference.getSubData(e,t,n):this}toString(){return`&${this.reference.toString()}`}},W=class e extends _t{constructor(e,t,n=null){super(t,n),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name===`x32`?e-Math.floor(e)===0?this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.data=new Float32Array([e]):this.typeInfo.name===`i32`||this.typeInfo.name===`bool`?this.data=new Int32Array([e]):this.typeInfo.name===`u32`?this.data=new Uint32Array([e]):this.typeInfo.name===`f32`||this.typeInfo.name===`f16`?this.data=new Float32Array([e]):console.error(`ScalarData2: Invalid type`,t)}clone(){if(this.data instanceof Float32Array)return new e(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new e(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new e(new Uint32Array(this.data),this.typeInfo,null);throw`ScalarData: Invalid data type`}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(t,n,r,i){if(r)return void console.error(`SetDataValue: Scalar data does not support postfix`,r);if(!(n instanceof e))return void console.error(`SetDataValue: Invalid value`,n);let a=n.data[0];this.typeInfo.name===`i32`||this.typeInfo.name===`u32`?a=Math.floor(a):this.typeInfo.name===`bool`&&(a=a?1:0),this.data[0]=a}getSubData(e,t,n){return t?(console.error(`getSubData: Scalar data does not support postfix`,t),null):this}toString(){return`${this.value}`}};function bt(e,t,n){let r=t.length;return r===2?n===`f32`?new G(new Float32Array(t),e.getTypeInfo(`vec2f`)):n===`i32`||n===`bool`?new G(new Int32Array(t),e.getTypeInfo(`vec2i`)):n===`u32`?new G(new Uint32Array(t),e.getTypeInfo(`vec2u`)):n===`f16`?new G(new Float32Array(t),e.getTypeInfo(`vec2h`)):(console.error(`getSubData: Unknown format ${n}`),null):r===3?n===`f32`?new G(new Float32Array(t),e.getTypeInfo(`vec3f`)):n===`i32`||n===`bool`?new G(new Int32Array(t),e.getTypeInfo(`vec3i`)):n===`u32`?new G(new Uint32Array(t),e.getTypeInfo(`vec3u`)):n===`f16`?new G(new Float32Array(t),e.getTypeInfo(`vec3h`)):(console.error(`getSubData: Unknown format ${n}`),null):r===4?n===`f32`?new G(new Float32Array(t),e.getTypeInfo(`vec4f`)):n===`i32`||n===`bool`?new G(new Int32Array(t),e.getTypeInfo(`vec4i`)):n===`u32`?new G(new Uint32Array(t),e.getTypeInfo(`vec4u`)):n===`f16`?new G(new Float32Array(t),e.getTypeInfo(`vec4h`)):(console.error(`getSubData: Unknown format ${n}`),null):(console.error(`getSubData: Invalid vector size ${t.length}`),null)}var G=class e extends _t{constructor(e,t,n=null){if(super(t,n),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{let t=this.typeInfo.name;t===`vec2f`||t===`vec3f`||t===`vec4f`?this.data=new Float32Array(e):t===`vec2i`||t===`vec3i`||t===`vec4i`?this.data=new Int32Array(e):t===`vec2u`||t===`vec3u`||t===`vec4u`?this.data=new Uint32Array(e):t===`vec2h`||t===`vec3h`||t===`vec4h`?this.data=new Float32Array(e):t===`vec2b`||t===`vec3b`||t===`vec4b`?this.data=new Int32Array(e):t===`vec2`||t===`vec3`||t===`vec4`?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${t}`)}}clone(){if(this.data instanceof Float32Array)return new e(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new e(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new e(new Uint32Array(this.data),this.typeInfo,null);throw`VectorData: Invalid data type`}setDataValue(t,n,r,i){r instanceof Qe?console.error(`TODO: Set vector postfix`):n instanceof e?this.data=n.data:console.error(`SetDataValue: Invalid value`,n)}getSubData(e,t,n){if(t===null)return this;let r=e.getTypeInfo(`f32`);if(this.typeInfo instanceof N)r=this.typeInfo.format||r;else{let t=this.typeInfo.name;t===`vec2f`||t===`vec3f`||t===`vec4f`?r=e.getTypeInfo(`f32`):t===`vec2i`||t===`vec3i`||t===`vec4i`?r=e.getTypeInfo(`i32`):t===`vec2b`||t===`vec3b`||t===`vec4b`?r=e.getTypeInfo(`bool`):t===`vec2u`||t===`vec3u`||t===`vec4u`?r=e.getTypeInfo(`u32`):t===`vec2h`||t===`vec3h`||t===`vec4h`?r=e.getTypeInfo(`f16`):console.error(`GetSubData: Unknown type ${t}`)}let i=this;for(;t!==null&&i!==null;){if(t instanceof at){let a=t.index,o=-1;if(a instanceof rt){if(!(a.value instanceof W))return console.error(`GetSubData: Invalid array index ${a.value}`),null;o=a.value.value}else{let t=e.evalExpression(a,n);if(!(t instanceof W))return console.error(`GetSubData: Unknown index type`,a),null;o=t.value}if(o<0||o>=i.data.length)return console.error(`GetSubData: Index out of range`,o),null;if(i.data instanceof Float32Array)return new W(new Float32Array(i.data.buffer,i.data.byteOffset+4*o,1),r);if(i.data instanceof Int32Array)return new W(new Int32Array(i.data.buffer,i.data.byteOffset+4*o,1),r);if(i.data instanceof Uint32Array)return new W(new Uint32Array(i.data.buffer,i.data.byteOffset+4*o,1),r);throw`GetSubData: Invalid data type`}if(!(t instanceof Qe))return console.error(`GetSubData: Unknown postfix`,t),null;{let n=t.value.toLowerCase();if(n.length===1){let e=0;if(n===`x`||n===`r`)e=0;else if(n===`y`||n===`g`)e=1;else if(n===`z`||n===`b`)e=2;else{if(n!==`w`&&n!==`a`)return console.error(`GetSubData: Unknown member ${n}`),null;e=3}if(this.data instanceof Float32Array)return new W(new Float32Array(this.data.buffer,this.data.byteOffset+4*e,1),r,this);if(this.data instanceof Int32Array)return new W(new Int32Array(this.data.buffer,this.data.byteOffset+4*e,1),r,this);if(this.data instanceof Uint32Array)return new W(new Uint32Array(this.data.buffer,this.data.byteOffset+4*e,1),r,this)}let a=[];for(let e of n)e===`x`||e===`r`?a.push(this.data[0]):e===`y`||e===`g`?a.push(this.data[1]):e===`z`||e===`b`?a.push(this.data[2]):e===`w`||e===`a`?a.push(this.data[3]):console.error(`GetDataValue: Unknown member ${e}`);i=bt(e,a,r.name)}t=t.postfix}return i}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}},K=class e extends _t{constructor(e,t,n=null){super(t,n),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new e(new Float32Array(this.data),this.typeInfo,null)}setDataValue(t,n,r,i){r instanceof Qe?console.error(`TODO: Set matrix postfix`):n instanceof e?this.data=n.data:console.error(`SetDataValue: Invalid value`,n)}getSubData(e,t,n){if(t===null)return this;let r=this.typeInfo.name;if(e.getTypeInfo(`f32`),this.typeInfo instanceof N)this.typeInfo.format;else if(r.endsWith(`f`))e.getTypeInfo(`f32`);else if(r.endsWith(`i`))e.getTypeInfo(`i32`);else if(r.endsWith(`u`))e.getTypeInfo(`u32`);else{if(!r.endsWith(`h`))return console.error(`GetDataValue: Unknown type ${r}`),null;e.getTypeInfo(`f16`)}if(t instanceof at){let i=t.index,a=-1;if(i instanceof rt){if(!(i.value instanceof W))return console.error(`GetDataValue: Invalid array index ${i.value}`),null;a=i.value.value}else{let t=e.evalExpression(i,n);if(!(t instanceof W))return console.error(`GetDataValue: Unknown index type`,i),null;a=t.value}if(a<0||a>=this.data.length)return console.error(`GetDataValue: Index out of range`,a),null;let o=r.endsWith(`h`)?`h`:`f`,s;if(r===`mat2x2`||r===`mat2x2f`||r===`mat2x2h`||r===`mat3x2`||r===`mat3x2f`||r===`mat3x2h`||r===`mat4x2`||r===`mat4x2f`||r===`mat4x2h`)s=new G(new Float32Array(this.data.buffer,this.data.byteOffset+2*a*4,2),e.getTypeInfo(`vec2${o}`));else if(r===`mat2x3`||r===`mat2x3f`||r===`mat2x3h`||r===`mat3x3`||r===`mat3x3f`||r===`mat3x3h`||r===`mat4x3`||r===`mat4x3f`||r===`mat4x3h`)s=new G(new Float32Array(this.data.buffer,this.data.byteOffset+3*a*4,3),e.getTypeInfo(`vec3${o}`));else{if(r!==`mat2x4`&&r!==`mat2x4f`&&r!==`mat2x4h`&&r!==`mat3x4`&&r!==`mat3x4f`&&r!==`mat3x4h`&&r!==`mat4x4`&&r!==`mat4x4f`&&r!==`mat4x4h`)return console.error(`GetDataValue: Unknown type ${r}`),null;s=new G(new Float32Array(this.data.buffer,this.data.byteOffset+4*a*4,4),e.getTypeInfo(`vec4${o}`))}return t.postfix?s.getSubData(e,t.postfix,n):s}return console.error(`GetDataValue: Invalid postfix`,t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}},xt=class e extends _t{constructor(e,t,n=0,r=null){super(t,r),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=n}clone(){return new e(new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size)).buffer,this.typeInfo,0,null)}setDataValue(e,t,n,r){if(t===null)return void console.log(`setDataValue: NULL data.`);let i=this.offset,a=this.typeInfo;for(;n;){if(n instanceof at)if(a instanceof j){let t=n.index;if(t instanceof rt){if(!(t.value instanceof W))return void console.error(`SetDataValue: Invalid index type ${t.value}`);i+=t.value.value*a.stride}else{let n=e.evalExpression(t,r);if(!(n instanceof W))return void console.error(`SetDataValue: Unknown index type`,t);i+=n.value*a.stride}a=a.format}else console.error(`SetDataValue: Type ${a.getTypeName()} is not an array`);else{if(!(n instanceof Qe))return void console.error(`SetDataValue: Unknown postfix type`,n);{let e=n.value;if(a instanceof A){let t=!1;for(let n of a.members)if(n.name===e){i+=n.offset,a=n.type,t=!0;break}if(!t)return void console.error(`SetDataValue: Member ${e} not found`)}else if(a instanceof O){let n=a.getTypeName(),r=0;if(e===`x`||e===`r`)r=0;else if(e===`y`||e===`g`)r=1;else if(e===`z`||e===`b`)r=2;else{if(e!==`w`&&e!==`a`)return void console.error(`SetDataValue: Unknown member ${e}`);r=3}if(!(t instanceof W))return void console.error(`SetDataValue: Invalid value`,t);let o=t.value;n===`vec2f`?new Float32Array(this.buffer,i,2)[r]=o:n===`vec3f`?new Float32Array(this.buffer,i,3)[r]=o:n===`vec4f`?new Float32Array(this.buffer,i,4)[r]=o:n===`vec2i`?new Int32Array(this.buffer,i,2)[r]=o:n===`vec3i`?new Int32Array(this.buffer,i,3)[r]=o:n===`vec4i`?new Int32Array(this.buffer,i,4)[r]=o:n===`vec2u`?new Uint32Array(this.buffer,i,2)[r]=o:n===`vec3u`?new Uint32Array(this.buffer,i,3)[r]=o:n===`vec4u`?new Uint32Array(this.buffer,i,4)[r]=o:console.error(`SetDataValue: Type ${n} is not a struct`);return}}}n=n.postfix}this.setData(e,t,a,i,r)}setData(t,n,r,i,a){let o=r.getTypeName();if(o!==`f32`&&o!==`f16`)if(o!==`i32`&&o!==`atomic<i32>`&&o!==`x32`)if(o!==`u32`&&o!==`atomic<u32>`)if(o!==`bool`){if(o===`vec2f`||o===`vec2h`){let e=new Float32Array(this.buffer,i,2);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1]):(e[0]=n[0],e[1]=n[1]);return}if(o===`vec3f`||o===`vec3h`){let e=new Float32Array(this.buffer,i,3);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2]):(e[0]=n[0],e[1]=n[1],e[2]=n[2]);return}if(o===`vec4f`||o===`vec4h`){let e=new Float32Array(this.buffer,i,4);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`vec2i`){let e=new Int32Array(this.buffer,i,2);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1]):(e[0]=n[0],e[1]=n[1]);return}if(o===`vec3i`){let e=new Int32Array(this.buffer,i,3);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2]):(e[0]=n[0],e[1]=n[1],e[2]=n[2]);return}if(o===`vec4i`){let e=new Int32Array(this.buffer,i,4);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`vec2u`){let e=new Uint32Array(this.buffer,i,2);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1]):(e[0]=n[0],e[1]=n[1]);return}if(o===`vec3u`){let e=new Uint32Array(this.buffer,i,3);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2]):(e[0]=n[0],e[1]=n[1],e[2]=n[2]);return}if(o===`vec4u`){let e=new Uint32Array(this.buffer,i,4);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`vec2b`){let e=new Uint32Array(this.buffer,i,2);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1]):(e[0]=n[0],e[1]=n[1]);return}if(o===`vec3b`){let e=new Uint32Array(this.buffer,i,3);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2]):(e[0]=n[0],e[1]=n[1],e[2]=n[2]);return}if(o===`vec4b`){let e=new Uint32Array(this.buffer,i,4);n instanceof G?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`mat2x2f`||o===`mat2x2h`){let e=new Float32Array(this.buffer,i,4);n instanceof K?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]);return}if(o===`mat2x3f`||o===`mat2x3h`){let e=new Float32Array(this.buffer,i,6);n instanceof K?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5]);return}if(o===`mat2x4f`||o===`mat2x4h`){let e=new Float32Array(this.buffer,i,8);n instanceof K?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7]);return}if(o===`mat3x2f`||o===`mat3x2h`){let e=new Float32Array(this.buffer,i,6);n instanceof K?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5]);return}if(o===`mat3x3f`||o===`mat3x3h`){let e=new Float32Array(this.buffer,i,9);n instanceof K?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7],e[8]=n.data[8]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8]);return}if(o===`mat3x4f`||o===`mat3x4h`){let e=new Float32Array(this.buffer,i,12);n instanceof K?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7],e[8]=n.data[8],e[9]=n.data[9],e[10]=n.data[10],e[11]=n.data[11]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11]);return}if(o===`mat4x2f`||o===`mat4x2h`){let e=new Float32Array(this.buffer,i,8);n instanceof K?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7]);return}if(o===`mat4x3f`||o===`mat4x3h`){let e=new Float32Array(this.buffer,i,12);n instanceof K?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7],e[8]=n.data[8],e[9]=n.data[9],e[10]=n.data[10],e[11]=n.data[11]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11]);return}if(o===`mat4x4f`||o===`mat4x4h`){let e=new Float32Array(this.buffer,i,16);n instanceof K?(e[0]=n.data[0],e[1]=n.data[1],e[2]=n.data[2],e[3]=n.data[3],e[4]=n.data[4],e[5]=n.data[5],e[6]=n.data[6],e[7]=n.data[7],e[8]=n.data[8],e[9]=n.data[9],e[10]=n.data[10],e[11]=n.data[11],e[12]=n.data[12],e[13]=n.data[13],e[14]=n.data[14],e[15]=n.data[15]):(e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15]);return}if(n instanceof e){if(r===n.typeInfo){new Uint8Array(this.buffer,i,n.buffer.byteLength).set(new Uint8Array(n.buffer));return}console.error(`SetDataValue: Type mismatch`,o,n.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${o}`)}else n instanceof W&&(new Int32Array(this.buffer,i,1)[0]=n.value);else n instanceof W&&(new Uint32Array(this.buffer,i,1)[0]=n.value);else n instanceof W&&(new Int32Array(this.buffer,i,1)[0]=n.value);else n instanceof W&&(new Float32Array(this.buffer,i,1)[0]=n.value)}getSubData(t,n,r){if(n===null)return this;let i=this.offset,a=this.typeInfo;for(;n;){if(n instanceof at){let e=n.index,o=e instanceof Ze?t.evalExpression(e,r):e,s=0;if(o instanceof W?s=o.value:typeof o==`number`?s=o:console.error(`GetDataValue: Invalid index type`,e),a instanceof j)i+=s*a.stride,a=a.format;else{let e=a.getTypeName();e===`mat4x4`||e===`mat4x4f`||e===`mat4x4h`?(i+=16*s,a=t.getTypeInfo(`vec4f`)):console.error(`getDataValue: Type ${a.getTypeName()} is not an array`)}}else{if(!(n instanceof Qe))return console.error(`GetDataValue: Unknown postfix type`,n),null;{let e=n.value;if(a instanceof A){let t=!1;for(let n of a.members)if(n.name===e){i+=n.offset,a=n.type,t=!0;break}if(!t)return console.error(`GetDataValue: Member ${e} not found`),null}else if(a instanceof O){let n=a.getTypeName();if(n===`vec2f`||n===`vec3f`||n===`vec4f`||n===`vec2i`||n===`vec3i`||n===`vec4i`||n===`vec2u`||n===`vec3u`||n===`vec4u`||n===`vec2b`||n===`vec3b`||n===`vec4b`||n===`vec2h`||n===`vec3h`||n===`vec4h`||n===`vec2`||n===`vec3`||n===`vec4`){if(e.length>0&&e.length<5){let r=`f`,o=[];for(let a=0;a<e.length;++a){let s=e[a].toLowerCase(),c=0;if(s===`x`||s===`r`)c=0;else if(s===`y`||s===`g`)c=1;else if(s===`z`||s===`b`)c=2;else{if(s!==`w`&&s!==`a`)return console.error(`Unknown member ${e}`),null;c=3}if(e.length===1){if(n.endsWith(`f`))return this.buffer.byteLength<i+4*c+4?(console.log(`Insufficient buffer data`),null):new W(new Float32Array(this.buffer,i+4*c,1),t.getTypeInfo(`f32`),this);if(n.endsWith(`h`))return new W(new Float32Array(this.buffer,i+4*c,1),t.getTypeInfo(`f16`),this);if(n.endsWith(`i`))return new W(new Int32Array(this.buffer,i+4*c,1),t.getTypeInfo(`i32`),this);if(n.endsWith(`b`))return new W(new Int32Array(this.buffer,i+4*c,1),t.getTypeInfo(`bool`),this);if(n.endsWith(`u`))return new W(new Uint32Array(this.buffer,i+4*c,1),t.getTypeInfo(`i32`),this)}if(n===`vec2f`)o.push(new Float32Array(this.buffer,i,2)[c]);else if(n===`vec3f`){if(i+12>=this.buffer.byteLength)return console.log(`Insufficient buffer data`),null;let e=new Float32Array(this.buffer,i,3);o.push(e[c])}else if(n===`vec4f`)o.push(new Float32Array(this.buffer,i,4)[c]);else if(n===`vec2i`)r=`i`,o.push(new Int32Array(this.buffer,i,2)[c]);else if(n===`vec3i`)r=`i`,o.push(new Int32Array(this.buffer,i,3)[c]);else if(n===`vec4i`)r=`i`,o.push(new Int32Array(this.buffer,i,4)[c]);else if(n===`vec2u`){r=`u`;let e=new Uint32Array(this.buffer,i,2);o.push(e[c])}else n===`vec3u`?(r=`u`,o.push(new Uint32Array(this.buffer,i,3)[c])):n===`vec4u`&&(r=`u`,o.push(new Uint32Array(this.buffer,i,4)[c]))}return o.length===2?a=t.getTypeInfo(`vec2${r}`):o.length===3?a=t.getTypeInfo(`vec3${r}`):o.length===4?a=t.getTypeInfo(`vec4${r}`):console.error(`GetDataValue: Invalid vector length ${o.length}`),new G(o,a,null)}return console.error(`GetDataValue: Unknown member ${e}`),null}return console.error(`GetDataValue: Type ${n} is not a struct`),null}}}n=n.postfix}let o=a.getTypeName();return o===`f32`?new W(new Float32Array(this.buffer,i,1),a,this):o===`i32`?new W(new Int32Array(this.buffer,i,1),a,this):o===`u32`?new W(new Uint32Array(this.buffer,i,1),a,this):o===`vec2f`?new G(new Float32Array(this.buffer,i,2),a,this):o===`vec3f`?new G(new Float32Array(this.buffer,i,3),a,this):o===`vec4f`?new G(new Float32Array(this.buffer,i,4),a,this):o===`vec2i`?new G(new Int32Array(this.buffer,i,2),a,this):o===`vec3i`?new G(new Int32Array(this.buffer,i,3),a,this):o===`vec4i`?new G(new Int32Array(this.buffer,i,4),a,this):o===`vec2u`?new G(new Uint32Array(this.buffer,i,2),a,this):o===`vec3u`?new G(new Uint32Array(this.buffer,i,3),a,this):o===`vec4u`?new G(new Uint32Array(this.buffer,i,4),a,this):a instanceof N&&a.name===`atomic`?a.format?.name===`u32`?new W(new Uint32Array(this.buffer,i,1)[0],a.format,this):a.format?.name===`i32`?new W(new Int32Array(this.buffer,i,1)[0],a.format,this):(console.error(`GetDataValue: Invalid atomic format ${a.format?.name}`),null):new e(this.buffer,a,i,this)}toString(){let e=``;if(this.typeInfo instanceof j)if(this.typeInfo.format.name===`f32`){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name===`i32`){let t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name===`u32`){let t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name===`vec2f`){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let n=1;n<t.length/2;++n)e+=`, [${t[2*n]}, ${t[2*n+1]}]`}else if(this.typeInfo.format.name===`vec3f`){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}]`}else if(this.typeInfo.format.name===`vec4f`){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}, ${t[n+3]}]`}else e=`[...]`;else this.typeInfo instanceof A?e+=`{...}`:e=`[...]`;return e}},St=class e extends _t{constructor(e,t,n,r){super(t,null),this.data=e,this.descriptor=n,this.view=r}clone(){return new e(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e;let t=this.descriptor.size;return t instanceof Array&&t.length>0?t[0]??0:t instanceof Object&&(e=t.width)!=null?e:0}get height(){var e;let t=this.descriptor.size;return t instanceof Array&&t.length>1?t[1]??0:t instanceof Object&&(e=t.height)!=null?e:0}get depthOrArrayLayers(){var e;let t=this.descriptor.size;return t instanceof Array&&t.length>2?t[2]??0:t instanceof Object&&(e=t.depthOrArrayLayers)!=null?e:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!=null?e:`rgba8unorm`}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!=null?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!=null?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!=null?e:`2d`}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];let t=[this.width,this.height,this.depthOrArrayLayers];for(let n=0;n<t.length;++n)t[n]=Math.max(1,t[n]>>e);return t}get texelByteSize(){let e=ge[this.format];return e?e.isDepthStencil?4:e.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){let e=ge[this.format];return!!e&&e.isDepthStencil}getGpuSize(){let e=this.format,t=ge[e],n=this.width;if(!e||n<=0||!t)return-1;let r=this.height,i=this.depthOrArrayLayers,a=this.dimension;return n/t.blockWidth*(a===`1d`?1:r/t.blockHeight)*t.bytesPerBlock*i}getPixel(e,t,n=0,r=0){let i=this.texelByteSize,a=this.bytesPerRow,o=this.height,s=this.data[r];return he(new Uint8Array(s),e,t,n,r,o,a,i,this.format)}setPixel(e,t,n,r,i){let a=this.texelByteSize,o=this.bytesPerRow,s=this.height,c=this.data[r];(function(e,t,n,r,i,a,o,s,c,l){let u=r*(o>>=i)*(a>>=i)+n*o+t*s;switch(c){case`r8unorm`:R(e,u,`8unorm`,1,l);return;case`r8snorm`:R(e,u,`8snorm`,1,l);return;case`r8uint`:R(e,u,`8uint`,1,l);return;case`r8sint`:R(e,u,`8sint`,1,l);return;case`rg8unorm`:R(e,u,`8unorm`,2,l);return;case`rg8snorm`:R(e,u,`8snorm`,2,l);return;case`rg8uint`:R(e,u,`8uint`,2,l);return;case`rg8sint`:R(e,u,`8sint`,2,l);return;case`rgba8unorm-srgb`:case`rgba8unorm`:case`bgra8unorm-srgb`:case`bgra8unorm`:R(e,u,`8unorm`,4,l);return;case`rgba8snorm`:R(e,u,`8snorm`,4,l);return;case`rgba8uint`:R(e,u,`8uint`,4,l);return;case`rgba8sint`:R(e,u,`8sint`,4,l);return;case`r16uint`:R(e,u,`16uint`,1,l);return;case`r16sint`:R(e,u,`16sint`,1,l);return;case`r16float`:R(e,u,`16float`,1,l);return;case`rg16uint`:R(e,u,`16uint`,2,l);return;case`rg16sint`:R(e,u,`16sint`,2,l);return;case`rg16float`:R(e,u,`16float`,2,l);return;case`rgba16uint`:R(e,u,`16uint`,4,l);return;case`rgba16sint`:R(e,u,`16sint`,4,l);return;case`rgba16float`:R(e,u,`16float`,4,l);return;case`r32uint`:R(e,u,`32uint`,1,l);return;case`r32sint`:R(e,u,`32sint`,1,l);return;case`depth16unorm`:case`depth24plus`:case`depth24plus-stencil8`:case`depth32float`:case`depth32float-stencil8`:case`r32float`:R(e,u,`32float`,1,l);return;case`rg32uint`:R(e,u,`32uint`,2,l);return;case`rg32sint`:R(e,u,`32sint`,2,l);return;case`rg32float`:R(e,u,`32float`,2,l);return;case`rgba32uint`:R(e,u,`32uint`,4,l);return;case`rgba32sint`:R(e,u,`32sint`,4,l);return;case`rgba32float`:R(e,u,`32float`,4,l);return;case`rg11b10ufloat`:console.error(`TODO: rg11b10ufloat not supported for writing`)}})(new Uint8Array(c),e,t,n,r,s,o,a,this.format,i)}};(e=>{e[e.token=0]=`token`,e[e.keyword=1]=`keyword`,e[e.reserved=2]=`reserved`})(V||={});var q=class{constructor(e,t,n){this.name=e,this.type=t,this.rule=n}toString(){return this.name}},J=class{};B=J,J.none=new q(``,V.reserved,``),J.eof=new q(`EOF`,V.token,``),J.reserved={asm:new q(`asm`,V.reserved,`asm`),bf16:new q(`bf16`,V.reserved,`bf16`),do:new q(`do`,V.reserved,`do`),enum:new q(`enum`,V.reserved,`enum`),f16:new q(`f16`,V.reserved,`f16`),f64:new q(`f64`,V.reserved,`f64`),handle:new q(`handle`,V.reserved,`handle`),i8:new q(`i8`,V.reserved,`i8`),i16:new q(`i16`,V.reserved,`i16`),i64:new q(`i64`,V.reserved,`i64`),mat:new q(`mat`,V.reserved,`mat`),premerge:new q(`premerge`,V.reserved,`premerge`),regardless:new q(`regardless`,V.reserved,`regardless`),typedef:new q(`typedef`,V.reserved,`typedef`),u8:new q(`u8`,V.reserved,`u8`),u16:new q(`u16`,V.reserved,`u16`),u64:new q(`u64`,V.reserved,`u64`),unless:new q(`unless`,V.reserved,`unless`),using:new q(`using`,V.reserved,`using`),vec:new q(`vec`,V.reserved,`vec`),void:new q(`void`,V.reserved,`void`)},J.keywords={array:new q(`array`,V.keyword,`array`),atomic:new q(`atomic`,V.keyword,`atomic`),bool:new q(`bool`,V.keyword,`bool`),f32:new q(`f32`,V.keyword,`f32`),i32:new q(`i32`,V.keyword,`i32`),mat2x2:new q(`mat2x2`,V.keyword,`mat2x2`),mat2x3:new q(`mat2x3`,V.keyword,`mat2x3`),mat2x4:new q(`mat2x4`,V.keyword,`mat2x4`),mat3x2:new q(`mat3x2`,V.keyword,`mat3x2`),mat3x3:new q(`mat3x3`,V.keyword,`mat3x3`),mat3x4:new q(`mat3x4`,V.keyword,`mat3x4`),mat4x2:new q(`mat4x2`,V.keyword,`mat4x2`),mat4x3:new q(`mat4x3`,V.keyword,`mat4x3`),mat4x4:new q(`mat4x4`,V.keyword,`mat4x4`),ptr:new q(`ptr`,V.keyword,`ptr`),sampler:new q(`sampler`,V.keyword,`sampler`),sampler_comparison:new q(`sampler_comparison`,V.keyword,`sampler_comparison`),struct:new q(`struct`,V.keyword,`struct`),texture_1d:new q(`texture_1d`,V.keyword,`texture_1d`),texture_2d:new q(`texture_2d`,V.keyword,`texture_2d`),texture_2d_array:new q(`texture_2d_array`,V.keyword,`texture_2d_array`),texture_3d:new q(`texture_3d`,V.keyword,`texture_3d`),texture_cube:new q(`texture_cube`,V.keyword,`texture_cube`),texture_cube_array:new q(`texture_cube_array`,V.keyword,`texture_cube_array`),texture_multisampled_2d:new q(`texture_multisampled_2d`,V.keyword,`texture_multisampled_2d`),texture_storage_1d:new q(`texture_storage_1d`,V.keyword,`texture_storage_1d`),texture_storage_2d:new q(`texture_storage_2d`,V.keyword,`texture_storage_2d`),texture_storage_2d_array:new q(`texture_storage_2d_array`,V.keyword,`texture_storage_2d_array`),texture_storage_3d:new q(`texture_storage_3d`,V.keyword,`texture_storage_3d`),texture_depth_2d:new q(`texture_depth_2d`,V.keyword,`texture_depth_2d`),texture_depth_2d_array:new q(`texture_depth_2d_array`,V.keyword,`texture_depth_2d_array`),texture_depth_cube:new q(`texture_depth_cube`,V.keyword,`texture_depth_cube`),texture_depth_cube_array:new q(`texture_depth_cube_array`,V.keyword,`texture_depth_cube_array`),texture_depth_multisampled_2d:new q(`texture_depth_multisampled_2d`,V.keyword,`texture_depth_multisampled_2d`),texture_external:new q(`texture_external`,V.keyword,`texture_external`),u32:new q(`u32`,V.keyword,`u32`),vec2:new q(`vec2`,V.keyword,`vec2`),vec3:new q(`vec3`,V.keyword,`vec3`),vec4:new q(`vec4`,V.keyword,`vec4`),bitcast:new q(`bitcast`,V.keyword,`bitcast`),block:new q(`block`,V.keyword,`block`),break:new q(`break`,V.keyword,`break`),case:new q(`case`,V.keyword,`case`),continue:new q(`continue`,V.keyword,`continue`),continuing:new q(`continuing`,V.keyword,`continuing`),default:new q(`default`,V.keyword,`default`),diagnostic:new q(`diagnostic`,V.keyword,`diagnostic`),discard:new q(`discard`,V.keyword,`discard`),else:new q(`else`,V.keyword,`else`),enable:new q(`enable`,V.keyword,`enable`),fallthrough:new q(`fallthrough`,V.keyword,`fallthrough`),false:new q(`false`,V.keyword,`false`),fn:new q(`fn`,V.keyword,`fn`),for:new q(`for`,V.keyword,`for`),function:new q(`function`,V.keyword,`function`),if:new q(`if`,V.keyword,`if`),let:new q(`let`,V.keyword,`let`),const:new q(`const`,V.keyword,`const`),loop:new q(`loop`,V.keyword,`loop`),while:new q(`while`,V.keyword,`while`),private:new q(`private`,V.keyword,`private`),read:new q(`read`,V.keyword,`read`),read_write:new q(`read_write`,V.keyword,`read_write`),return:new q(`return`,V.keyword,`return`),requires:new q(`requires`,V.keyword,`requires`),storage:new q(`storage`,V.keyword,`storage`),switch:new q(`switch`,V.keyword,`switch`),true:new q(`true`,V.keyword,`true`),alias:new q(`alias`,V.keyword,`alias`),type:new q(`type`,V.keyword,`type`),uniform:new q(`uniform`,V.keyword,`uniform`),var:new q(`var`,V.keyword,`var`),override:new q(`override`,V.keyword,`override`),workgroup:new q(`workgroup`,V.keyword,`workgroup`),write:new q(`write`,V.keyword,`write`),r8unorm:new q(`r8unorm`,V.keyword,`r8unorm`),r8snorm:new q(`r8snorm`,V.keyword,`r8snorm`),r8uint:new q(`r8uint`,V.keyword,`r8uint`),r8sint:new q(`r8sint`,V.keyword,`r8sint`),r16uint:new q(`r16uint`,V.keyword,`r16uint`),r16sint:new q(`r16sint`,V.keyword,`r16sint`),r16float:new q(`r16float`,V.keyword,`r16float`),rg8unorm:new q(`rg8unorm`,V.keyword,`rg8unorm`),rg8snorm:new q(`rg8snorm`,V.keyword,`rg8snorm`),rg8uint:new q(`rg8uint`,V.keyword,`rg8uint`),rg8sint:new q(`rg8sint`,V.keyword,`rg8sint`),r32uint:new q(`r32uint`,V.keyword,`r32uint`),r32sint:new q(`r32sint`,V.keyword,`r32sint`),r32float:new q(`r32float`,V.keyword,`r32float`),rg16uint:new q(`rg16uint`,V.keyword,`rg16uint`),rg16sint:new q(`rg16sint`,V.keyword,`rg16sint`),rg16float:new q(`rg16float`,V.keyword,`rg16float`),rgba8unorm:new q(`rgba8unorm`,V.keyword,`rgba8unorm`),rgba8unorm_srgb:new q(`rgba8unorm_srgb`,V.keyword,`rgba8unorm_srgb`),rgba8snorm:new q(`rgba8snorm`,V.keyword,`rgba8snorm`),rgba8uint:new q(`rgba8uint`,V.keyword,`rgba8uint`),rgba8sint:new q(`rgba8sint`,V.keyword,`rgba8sint`),bgra8unorm:new q(`bgra8unorm`,V.keyword,`bgra8unorm`),bgra8unorm_srgb:new q(`bgra8unorm_srgb`,V.keyword,`bgra8unorm_srgb`),rgb10a2unorm:new q(`rgb10a2unorm`,V.keyword,`rgb10a2unorm`),rg11b10float:new q(`rg11b10float`,V.keyword,`rg11b10float`),rg32uint:new q(`rg32uint`,V.keyword,`rg32uint`),rg32sint:new q(`rg32sint`,V.keyword,`rg32sint`),rg32float:new q(`rg32float`,V.keyword,`rg32float`),rgba16uint:new q(`rgba16uint`,V.keyword,`rgba16uint`),rgba16sint:new q(`rgba16sint`,V.keyword,`rgba16sint`),rgba16float:new q(`rgba16float`,V.keyword,`rgba16float`),rgba32uint:new q(`rgba32uint`,V.keyword,`rgba32uint`),rgba32sint:new q(`rgba32sint`,V.keyword,`rgba32sint`),rgba32float:new q(`rgba32float`,V.keyword,`rgba32float`),static_assert:new q(`static_assert`,V.keyword,`static_assert`)},J.tokens={decimal_float_literal:new q(`decimal_float_literal`,V.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new q(`hex_float_literal`,V.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new q(`int_literal`,V.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new q(`uint_literal`,V.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new q(`name`,V.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new q(`ident`,V.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new q(`and`,V.token,`&`),and_and:new q(`and_and`,V.token,`&&`),arrow:new q(`arrow `,V.token,`->`),attr:new q(`attr`,V.token,`@`),forward_slash:new q(`forward_slash`,V.token,`/`),bang:new q(`bang`,V.token,`!`),bracket_left:new q(`bracket_left`,V.token,`[`),bracket_right:new q(`bracket_right`,V.token,`]`),brace_left:new q(`brace_left`,V.token,`{`),brace_right:new q(`brace_right`,V.token,`}`),colon:new q(`colon`,V.token,`:`),comma:new q(`comma`,V.token,`,`),equal:new q(`equal`,V.token,`=`),equal_equal:new q(`equal_equal`,V.token,`==`),not_equal:new q(`not_equal`,V.token,`!=`),greater_than:new q(`greater_than`,V.token,`>`),greater_than_equal:new q(`greater_than_equal`,V.token,`>=`),shift_right:new q(`shift_right`,V.token,`>>`),less_than:new q(`less_than`,V.token,`<`),less_than_equal:new q(`less_than_equal`,V.token,`<=`),shift_left:new q(`shift_left`,V.token,`<<`),modulo:new q(`modulo`,V.token,`%`),minus:new q(`minus`,V.token,`-`),minus_minus:new q(`minus_minus`,V.token,`--`),period:new q(`period`,V.token,`.`),plus:new q(`plus`,V.token,`+`),plus_plus:new q(`plus_plus`,V.token,`++`),or:new q(`or`,V.token,`|`),or_or:new q(`or_or`,V.token,`||`),paren_left:new q(`paren_left`,V.token,`(`),paren_right:new q(`paren_right`,V.token,`)`),semicolon:new q(`semicolon`,V.token,`;`),star:new q(`star`,V.token,`*`),tilde:new q(`tilde`,V.token,`~`),underscore:new q(`underscore`,V.token,`_`),xor:new q(`xor`,V.token,`^`),plus_equal:new q(`plus_equal`,V.token,`+=`),minus_equal:new q(`minus_equal`,V.token,`-=`),times_equal:new q(`times_equal`,V.token,`*=`),division_equal:new q(`division_equal`,V.token,`/=`),modulo_equal:new q(`modulo_equal`,V.token,`%=`),and_equal:new q(`and_equal`,V.token,`&=`),or_equal:new q(`or_equal`,V.token,`|=`),xor_equal:new q(`xor_equal`,V.token,`^=`),shift_right_equal:new q(`shift_right_equal`,V.token,`>>=`),shift_left_equal:new q(`shift_left_equal`,V.token,`<<=`)},J.simpleTokens={"@":B.tokens.attr,"{":B.tokens.brace_left,"}":B.tokens.brace_right,":":B.tokens.colon,",":B.tokens.comma,"(":B.tokens.paren_left,")":B.tokens.paren_right,";":B.tokens.semicolon},J.literalTokens={"&":B.tokens.and,"&&":B.tokens.and_and,"->":B.tokens.arrow,"/":B.tokens.forward_slash,"!":B.tokens.bang,"[":B.tokens.bracket_left,"]":B.tokens.bracket_right,"=":B.tokens.equal,"==":B.tokens.equal_equal,"!=":B.tokens.not_equal,">":B.tokens.greater_than,">=":B.tokens.greater_than_equal,">>":B.tokens.shift_right,"<":B.tokens.less_than,"<=":B.tokens.less_than_equal,"<<":B.tokens.shift_left,"%":B.tokens.modulo,"-":B.tokens.minus,"--":B.tokens.minus_minus,".":B.tokens.period,"+":B.tokens.plus,"++":B.tokens.plus_plus,"|":B.tokens.or,"||":B.tokens.or_or,"*":B.tokens.star,"~":B.tokens.tilde,_:B.tokens.underscore,"^":B.tokens.xor,"+=":B.tokens.plus_equal,"-=":B.tokens.minus_equal,"*=":B.tokens.times_equal,"/=":B.tokens.division_equal,"%=":B.tokens.modulo_equal,"&=":B.tokens.and_equal,"|=":B.tokens.or_equal,"^=":B.tokens.xor_equal,">>=":B.tokens.shift_right_equal,"<<=":B.tokens.shift_left_equal},J.regexTokens={decimal_float_literal:B.tokens.decimal_float_literal,hex_float_literal:B.tokens.hex_float_literal,int_literal:B.tokens.int_literal,uint_literal:B.tokens.uint_literal,ident:B.tokens.ident},J.storage_class=[B.keywords.function,B.keywords.private,B.keywords.workgroup,B.keywords.uniform,B.keywords.storage],J.access_mode=[B.keywords.read,B.keywords.write,B.keywords.read_write],J.sampler_type=[B.keywords.sampler,B.keywords.sampler_comparison],J.sampled_texture_type=[B.keywords.texture_1d,B.keywords.texture_2d,B.keywords.texture_2d_array,B.keywords.texture_3d,B.keywords.texture_cube,B.keywords.texture_cube_array],J.multisampled_texture_type=[B.keywords.texture_multisampled_2d],J.storage_texture_type=[B.keywords.texture_storage_1d,B.keywords.texture_storage_2d,B.keywords.texture_storage_2d_array,B.keywords.texture_storage_3d],J.depth_texture_type=[B.keywords.texture_depth_2d,B.keywords.texture_depth_2d_array,B.keywords.texture_depth_cube,B.keywords.texture_depth_cube_array,B.keywords.texture_depth_multisampled_2d],J.texture_external_type=[B.keywords.texture_external],J.any_texture_type=[...B.sampled_texture_type,...B.multisampled_texture_type,...B.storage_texture_type,...B.depth_texture_type,...B.texture_external_type],J.texel_format=[B.keywords.r8unorm,B.keywords.r8snorm,B.keywords.r8uint,B.keywords.r8sint,B.keywords.r16uint,B.keywords.r16sint,B.keywords.r16float,B.keywords.rg8unorm,B.keywords.rg8snorm,B.keywords.rg8uint,B.keywords.rg8sint,B.keywords.r32uint,B.keywords.r32sint,B.keywords.r32float,B.keywords.rg16uint,B.keywords.rg16sint,B.keywords.rg16float,B.keywords.rgba8unorm,B.keywords.rgba8unorm_srgb,B.keywords.rgba8snorm,B.keywords.rgba8uint,B.keywords.rgba8sint,B.keywords.bgra8unorm,B.keywords.bgra8unorm_srgb,B.keywords.rgb10a2unorm,B.keywords.rg11b10float,B.keywords.rg32uint,B.keywords.rg32sint,B.keywords.rg32float,B.keywords.rgba16uint,B.keywords.rgba16sint,B.keywords.rgba16float,B.keywords.rgba32uint,B.keywords.rgba32sint,B.keywords.rgba32float],J.const_literal=[B.tokens.int_literal,B.tokens.uint_literal,B.tokens.decimal_float_literal,B.tokens.hex_float_literal,B.keywords.true,B.keywords.false],J.literal_or_ident=[B.tokens.ident,B.tokens.int_literal,B.tokens.uint_literal,B.tokens.decimal_float_literal,B.tokens.hex_float_literal,B.tokens.name],J.element_count_expression=[B.tokens.int_literal,B.tokens.uint_literal,B.tokens.ident],J.template_types=[B.keywords.vec2,B.keywords.vec3,B.keywords.vec4,B.keywords.mat2x2,B.keywords.mat2x3,B.keywords.mat2x4,B.keywords.mat3x2,B.keywords.mat3x3,B.keywords.mat3x4,B.keywords.mat4x2,B.keywords.mat4x3,B.keywords.mat4x4,B.keywords.atomic,B.keywords.bitcast,...B.any_texture_type],J.attribute_name=[B.tokens.ident,B.keywords.block,B.keywords.diagnostic],J.assignment_operators=[B.tokens.equal,B.tokens.plus_equal,B.tokens.minus_equal,B.tokens.times_equal,B.tokens.division_equal,B.tokens.modulo_equal,B.tokens.and_equal,B.tokens.or_equal,B.tokens.xor_equal,B.tokens.shift_right_equal,B.tokens.shift_left_equal],J.increment_operators=[B.tokens.plus_plus,B.tokens.minus_minus];var Ct=class{constructor(e,t,n,r,i){this.type=e,this.lexeme=t,this.line=n,this.start=r,this.end=i}toString(){return this.lexeme}isTemplateType(){return J.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==J.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}},wt=class{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??``}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Ct(J.eof,``,this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e==`/`){if(this._peekAhead()==`/`){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()==`*`){this._advance();let t=1;for(;t>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e==`*`){if(this._peekAhead()==`/`&&(this._advance(),t--,t==0))return!0}else e==`/`&&this._peekAhead()==`*`&&(this._advance(),t++)}return!0}}let t=J.simpleTokens[e];if(t)return this._addToken(t),!0;let n=J.none,r=this._isAlpha(e),i=e===`_`;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(r){let t=J.keywords[e];if(t)return this._addToken(t),!0}if(r||i)return this._addToken(J.tokens.ident),!0;for(;;){let t=this._findType(e),r=this._peekAhead();if(e==`-`&&this._tokens.length>0){if(r==`=`)return this._current++,e+=r,this._addToken(J.tokens.minus_equal),!0;if(r==`-`)return this._current++,e+=r,this._addToken(J.tokens.minus_minus),!0;let n=this._tokens.length-1;if((J.literal_or_ident.indexOf(this._tokens[n].type)!=-1||this._tokens[n].type==J.tokens.paren_right)&&r!=`>`)return this._addToken(t),!0}if(e==`>`&&(r==`>`||r==`=`)){let e=!1,n=this._tokens.length-1;for(let t=0;t<5&&n>=0&&J.assignment_operators.indexOf(this._tokens[n].type)===-1;++t,--n)if(this._tokens[n].type===J.tokens.less_than){n>0&&this._tokens[n-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===J.none){let r=e,i=0;for(let e=0;e<2;++e)if(r+=this._peekAhead(e),t=this._findType(r),t!==J.none){i=e;break}if(t===J.none)return n!==J.none&&(this._current--,this._addToken(n),!0);e=r,this._current+=i+1}if(n=t,this._isAtEnd())break;e+=this._advance()}return n!==J.none&&(this._addToken(n),!0)}_findType(e){for(let t in J.regexTokens){let n=J.regexTokens[t];if(this._match(e,n.rule))return n}return J.literalTokens[e]||J.none}_match(e,t){let n=t.exec(e);return n&&n.index==0&&n[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!==`_`&&e!==`.`&&e!==`(`&&e!==`)`&&e!==`[`&&e!==`]`&&e!==`{`&&e!==`}`&&e!==`,`&&e!==`;`&&e!==`:`&&e!==`=`&&e!==`!`&&e!==`<`&&e!==`>`&&e!==`+`&&e!==`-`&&e!==`*`&&e!==`/`&&e!==`%`&&e!==`&`&&e!==`|`&&e!==`^`&&e!==`~`&&e!==`@`&&e!==`#`&&e!==`?`&&e!==`'`&&e!=="`"&&e!==`"`&&e!==`\\`&&e!==`
`&&e!==`\r`&&e!==`	`&&e!==`\0`}_isNumeric(e){return e>=`0`&&e<=`9`}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e===`_`}_isWhitespace(e){return e==` `||e==`	`||e==`\r`}_advance(e=0){let t=this._source[this._current];return e||=0,e++,this._current+=e,t}_peekAhead(e=0){return e||=0,this._current+e>=this._source.length?`\0`:this._source[this._current+e]}_addToken(e){let t=this._source.substring(this._start,this._current);this._tokens.push(new Ct(e,t,this._line,this._start,this._current))}};function Y(e){return Array.isArray(e)||e?.buffer instanceof ArrayBuffer}var Tt=new Float32Array(1),Et=new Uint32Array(Tt.buffer),Dt=new Uint32Array(Tt.buffer),Ot=new Int32Array(1),kt=new Float32Array(Ot.buffer),At=new Uint32Array(Ot.buffer),jt=new Uint32Array(1),Mt=new Float32Array(jt.buffer),Nt=new Int32Array(jt.buffer);function Pt(e,t,n){if(t===n)return e;if(t===`f32`){if(n===`i32`||n===`x32`)return Tt[0]=e,Et[0];if(n===`u32`)return Tt[0]=e,Dt[0]}else if(t===`i32`||t===`x32`){if(n===`f32`)return Ot[0]=e,kt[0];if(n===`u32`)return Ot[0]=e,At[0]}else if(t===`u32`){if(n===`f32`)return jt[0]=e,Mt[0];if(n===`i32`||n===`x32`)return jt[0]=e,Nt[0]}return console.error(`Unsupported cast from ${t} to ${n}`),e}var Ft=class{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}},It=class{constructor(e,t){this.align=e,this.size=t}},Lt=class e{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new se,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name==`texture_storage_1d`||e.name==`texture_storage_2d`||e.name==`texture_storage_2d_array`||e.name==`texture_storage_3d`}updateAST(e){for(let t of e)t instanceof xe&&this._functions.set(t.name,new Ft(t));for(let t of e)if(t instanceof qe){let e=this.getTypeInfo(t,null);e instanceof A&&this.structs.push(e)}for(let t of e)if(t instanceof He)this.aliases.push(this._getAliasInfo(t));else{if(t instanceof De){let e=t,n=this._getAttributeNum(e.attributes,`id`,0),r=e.type==null?null:this.getTypeInfo(e.type,e.attributes);this.overrides.push(new ie(e.name,r,e.attributes,n));continue}if(this._isUniformVar(t)){let e=t,n=this._getAttributeNum(e.attributes,`group`,0),r=this._getAttributeNum(e.attributes,`binding`,0),i=this.getTypeInfo(e.type,e.attributes),a=new F(e.name,i,n,r,e.attributes,P.Uniform,e.access);a.access||=`read`,this.uniforms.push(a);continue}if(this._isStorageVar(t)){let e=t,n=this._getAttributeNum(e.attributes,`group`,0),r=this._getAttributeNum(e.attributes,`binding`,0),i=this.getTypeInfo(e.type,e.attributes),a=this._isStorageTexture(i),o=new F(e.name,i,n,r,e.attributes,a?P.StorageTexture:P.Storage,e.access);o.access||=`read`,this.storage.push(o);continue}if(this._isTextureVar(t)){let e=t,n=this._getAttributeNum(e.attributes,`group`,0),r=this._getAttributeNum(e.attributes,`binding`,0),i=this.getTypeInfo(e.type,e.attributes),a=this._isStorageTexture(i),o=new F(e.name,i,n,r,e.attributes,a?P.StorageTexture:P.Texture,e.access);o.access||=`read`,a?this.storage.push(o):this.textures.push(o);continue}if(this._isSamplerVar(t)){let e=t,n=this._getAttributeNum(e.attributes,`group`,0),r=this._getAttributeNum(e.attributes,`binding`,0),i=this.getTypeInfo(e.type,e.attributes),a=new F(e.name,i,n,r,e.attributes,P.Sampler,e.access);this.samplers.push(a);continue}}for(let t of e)if(t instanceof xe){let e=this._getAttribute(t,`vertex`),n=this._getAttribute(t,`fragment`),r=this._getAttribute(t,`compute`),i=e||n||r,a=new oe(t.name,i?.name,t.attributes);a.attributes=t.attributes,a.startLine=t.startLine,a.endLine=t.endLine,this.functions.push(a),this._functions.get(t.name).info=a,i&&(this._functions.get(t.name).inUse=!0,a.inUse=!0,a.resources=this._findResources(t,!!i),a.inputs=this._getInputs(t.args),a.outputs=this._getOutputs(t.returnType),this.entry[i.name].push(a)),a.arguments=t.args.map(e=>new ae(e.name,this.getTypeInfo(e.type,e.attributes),e.attributes)),a.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null;continue}for(let e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(let e of this._functions.values())e.node.search(t=>{var n,r,i;if(t instanceof gt){if(t.value)if(Y(t.value))for(let r of t.value)for(let t of this.overrides)r===t.name&&((n=e.info)==null||n.overrides.push(t));else for(let n of this.overrides)t.value===n.name&&((r=e.info)==null||r.overrides.push(n))}else if(t instanceof tt)for(let n of this.overrides)t.name===n.name&&((i=e.info)==null||i.overrides.push(n))});for(let e of this.uniforms)this._markStructsInUse(e.type);for(let e of this.storage)this._markStructsInUse(e.type)}getFunctionInfo(e){for(let t of this.functions)if(t.name==e)return t;return null}getStructInfo(e){for(let t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(let t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(let t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{let t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){for(let n of e.calls){let e=this._functions.get(n.name)?.info;e&&t.add(e)}}findResource(e,t,n){if(n){for(let r of this.entry.compute)if(r.name===n){for(let n of r.resources)if(n.group==e&&n.binding==t)return n}for(let r of this.entry.vertex)if(r.name===n){for(let n of r.resources)if(n.group==e&&n.binding==t)return n}for(let r of this.entry.fragment)if(r.name===n){for(let n of r.resources)if(n.group==e&&n.binding==t)return n}}for(let n of this.uniforms)if(n.group==e&&n.binding==t)return n;for(let n of this.storage)if(n.group==e&&n.binding==t)return n;for(let n of this.textures)if(n.group==e&&n.binding==t)return n;for(let n of this.samplers)if(n.group==e&&n.binding==t)return n;return null}_findResource(e){for(let t of this.uniforms)if(t.name==e)return t;for(let t of this.storage)if(t.name==e)return t;for(let t of this.textures)if(t.name==e)return t;for(let t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){let t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){let n=[],r=this,i=[];return e.search(a=>{if(a instanceof ve)i.push({});else if(a instanceof ye)i.pop();else if(a instanceof Ee){let e=a;t&&e.type!==null&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(a instanceof $e){let e=a;t&&e.type!==null&&this._markStructsFromAST(e.type)}else if(a instanceof Oe){let e=a;t&&e.type!==null&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(a instanceof tt){let e=a;if(i.length>0&&i[i.length-1][e.name])return;let t=r._findResource(e.name);t&&n.push(t)}else if(a instanceof et){let i=a,o=r._functions.get(i.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),o.resources===null&&(o.resources=r._findResources(o.node,t)),n.push(...o.resources))}else if(a instanceof Pe){let i=a,o=r._functions.get(i.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),o.resources===null&&(o.resources=r._findResources(o.node,t)),n.push(...o.resources))}}),[...new Map(n.map(e=>[e.name,e])).values()]}getBindGroups(){let e=[];function t(t,n){t>=e.length&&(e.length=t+1),e[t]===void 0&&(e[t]=[]),n>=e[t].length&&(e[t].length=n+1)}for(let n of this.uniforms)t(n.group,n.binding),e[n.group][n.binding]=n;for(let n of this.storage)t(n.group,n.binding),e[n.group][n.binding]=n;for(let n of this.textures)t(n.group,n.binding),e[n.group][n.binding]=n;for(let n of this.samplers)t(n.group,n.binding),e[n.group][n.binding]=n;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof qe)this._getStructOutputs(e,t);else{let n=this._getOutputInfo(e);n!==null&&t.push(n)}return t}_getStructOutputs(e,t){for(let n of e.members)if(n.type instanceof qe)this._getStructOutputs(n.type,t);else{let e=this._getAttribute(n,`location`)||this._getAttribute(n,`builtin`);if(e!==null){let r=this.getTypeInfo(n.type,n.type.attributes),i=this._parseInt(e.value),a=new re(n.name,r,e.name,i);t.push(a)}}}_getOutputInfo(e){let t=this._getAttribute(e,`location`)||this._getAttribute(e,`builtin`);if(t!==null){let n=this.getTypeInfo(e,e.attributes),r=this._parseInt(t.value);return new re(``,n,t.name,r)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(let n of e)if(n.type instanceof qe)this._getStructInputs(n.type,t);else{let e=this._getInputInfo(n);e!==null&&t.push(e)}return t}_getStructInputs(e,t){for(let n of e.members)if(n.type instanceof qe)this._getStructInputs(n.type,t);else{let e=this._getInputInfo(n);e!==null&&t.push(e)}}_getInputInfo(e){let t=this._getAttribute(e,`location`)||this._getAttribute(e,`builtin`);if(t!==null){let n=this._getAttribute(e,`interpolation`),r=this.getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),a=new ne(e.name,r,t.name,i);return n!==null&&(a.interpolation=this._parseString(n.value)),a}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);let t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(let t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new te(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(let t of this.structs)if(t.name==e)return t;for(let t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof Je){let n=e.type?this.getTypeInfo(e.type,e.attributes):null,r=new M(e.name,n,t);return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof Ye){let n=e,r=n.format?this.getTypeInfo(n.format,n.attributes):null,i=new j(n.name,t);return i.format=r,i.count=n.count,this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof qe){let n=e,r=new A(n.name,t);r.startLine=n.startLine,r.endLine=n.endLine;for(let e of n.members){let t=this.getTypeInfo(e.type,e.attributes);r.members.push(new k(e.name,t,e.attributes))}return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof Xe){let n=e,r=n.format instanceof H,i=n.format?r?this.getTypeInfo(n.format,null):new O(n.format,null):null,a=new N(n.name,i,t,n.access);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof U){let n=e,r=n.format?this.getTypeInfo(n.format,null):null,i=new N(n.name,r,t,n.access);return this._types.set(e,i),this._updateTypeInfo(i),i}let n=new O(e.name,t);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){if(e.size=this._getTypeSize(e)?.size??0,e instanceof j&&e.format){let t=this._getTypeSize(e.format);e.stride=Math.max(t?.size??0,t?.align??0),this._updateTypeInfo(e.format)}e instanceof M&&this._updateTypeInfo(e.format),e instanceof A&&this._updateStructInfo(e)}_updateStructInfo(e){let t=0,n=0,r=0,i=0;for(let a=0,o=e.members.length;a<o;++a){let o=e.members[a],s=this._getTypeSize(o);if(!s)continue;this._getAlias(o.type.name)??o.type;let c=s.align,l=s.size;t=this._roundUp(c,t+n),n=l,r=t,i=Math.max(i,c),o.offset=t,o.size=l,this._updateTypeInfo(o.type)}e.size=this._roundUp(i,r+n),e.align=i}_getTypeSize(t){if(t==null)return null;let n=this._getAttributeNum(t.attributes,`size`,0),r=this._getAttributeNum(t.attributes,`align`,0);if(t instanceof k&&(t=t.type),t instanceof O){let e=this._getAlias(t.name);e!==null&&(t=e)}{let i=e._typeInfo[t.name];if(i!==void 0){let e=t.format?.name===`f16`?2:1;return new It(Math.max(r,i.align/e),Math.max(n,i.size/e))}}{let i=e._typeInfo[t.name.substring(0,t.name.length-1)];if(i){let e=t.name[t.name.length-1]===`h`?2:1;return new It(Math.max(r,i.align/e),Math.max(n,i.size/e))}}if(t instanceof j){let e=t,i=8,a=8,o=this._getTypeSize(e.format);return o!==null&&(a=o.size,i=o.align),a=e.count*this._getAttributeNum(t?.attributes??null,`stride`,this._roundUp(i,a)),n&&(a=n),new It(Math.max(r,i),Math.max(n,a))}if(t instanceof A){let e=0,i=0,a=0,o=0,s=0;for(let n of t.members){let t=this._getTypeSize(n.type);t!==null&&(e=Math.max(t.align,e),a=this._roundUp(t.align,a+o),o=t.size,s=a)}return i=this._roundUp(e,s+o),new It(Math.max(r,e),Math.max(n,i))}return null}_isUniformVar(e){return e instanceof Ee&&e.storage==`uniform`}_isStorageVar(e){return e instanceof Ee&&e.storage==`storage`}_isTextureVar(t){return t instanceof Ee&&t.type!==null&&e._textureTypes.indexOf(t.type.name)!=-1}_isSamplerVar(t){return t instanceof Ee&&t.type!==null&&e._samplerTypes.indexOf(t.type.name)!=-1}_getAttribute(e,t){let n=e;if(!n||!n.attributes)return null;let r=n.attributes;for(let e of r)if(e.name==t)return e;return null}_getAttributeNum(e,t,n){if(e===null)return n;for(let r of e)if(r.name==t){let e=r!==null&&r.value!==null?r.value:n;return e instanceof Array&&(e=e[0]),typeof e==`number`?e:typeof e==`string`?parseInt(e):n}return n}_roundUp(e,t){return Math.ceil(t/e)*e}};Lt._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Lt._textureTypes=J.any_texture_type.map(e=>e.name),Lt._samplerTypes=J.sampler_type.map(e=>e.name);var Rt=0,zt=class e{constructor(e,t,n){this.id=Rt++,this.name=e,this.value=t,this.node=n}clone(){return new e(this.name,this.value,this.node)}},Bt=class e{constructor(e){this.id=Rt++,this.name=e.name,this.node=e}clone(){return new e(this.node)}},Vt=class e{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName=``,this.id=Rt++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){return this.variables.has(e)?this.variables.get(e)??null:this.parent?this.parent.getVariable(e):null}getFunction(e){return this.functions.has(e)?this.functions.get(e)??null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,n){this.variables.set(e,new zt(e,t,n??null))}setVariable(e,t,n){let r=this.getVariable(e);r===null?this.createVariable(e,t,n):r.value=t}getVariableValue(e){return this.getVariable(e)?.value??null}clone(){return new e(this)}},Ht=class{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return``}},Ut=class{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){let n=this.exec.evalExpression(e.args[0],t),r=!0;if(n instanceof G)return n.data.forEach(e=>{e||(r=!1)}),new W(r?1:0,this.getTypeInfo(`bool`));throw Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new W(n.data.some(e=>e)?1:0,this.getTypeInfo(`bool`));throw Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){let n=this.exec.evalExpression(e.args[2],t);if(!(n instanceof W))throw Error(`Select() expects a bool condition. Line ${e.line}`);return n.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.evalExpression(n,t);if(r instanceof xt&&r.typeInfo.size===0){let e=r.typeInfo;return new W(r.buffer.byteLength/e.stride,this.getTypeInfo(`u32`))}return new W(r.typeInfo.size,this.getTypeInfo(`u32`))}Abs(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.abs(e)),n.typeInfo);let r=n;return new W(Math.abs(r.value),r.typeInfo)}Acos(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.acos(e)),n.typeInfo);let r=n;return new W(Math.acos(r.value),n.typeInfo)}Acosh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.acosh(e)),n.typeInfo);let r=n;return new W(Math.acosh(r.value),n.typeInfo)}Asin(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.asin(e)),n.typeInfo);let r=n;return new W(Math.asin(r.value),n.typeInfo)}Asinh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.asinh(e)),n.typeInfo);let r=n;return new W(Math.asinh(r.value),n.typeInfo)}Atan(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.atan(e)),n.typeInfo);let r=n;return new W(Math.atan(r.value),n.typeInfo)}Atanh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.atanh(e)),n.typeInfo);let r=n;return new W(Math.atanh(r.value),n.typeInfo)}Atan2(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof G&&r instanceof G)return new G(n.data.map((e,t)=>Math.atan2(e,r.data[t])),n.typeInfo);let i=n,a=r;return new W(Math.atan2(i.value,a.value),n.typeInfo)}Ceil(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.ceil(e)),n.typeInfo);let r=n;return new W(Math.ceil(r.value),n.typeInfo)}_clamp(e,t,n){return Math.min(Math.max(e,t),n)}Clamp(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof G&&r instanceof G&&i instanceof G)return new G(n.data.map((e,t)=>this._clamp(e,r.data[t],i.data[t])),n.typeInfo);let a=n,o=r,s=i;return new W(this._clamp(a.value,o.value,s.value),n.typeInfo)}Cos(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.cos(e)),n.typeInfo);let r=n;return new W(Math.cos(r.value),n.typeInfo)}Cosh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.cosh(e)),n.typeInfo);let r=n;return new W(Math.cos(r.value),n.typeInfo)}CountLeadingZeros(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.clz32(e)),n.typeInfo);let r=n;return new W(Math.clz32(r.value),n.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>this._countOneBits(e)),n.typeInfo);let r=n;return new W(this._countOneBits(r.value),n.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>this._countTrailingZeros(e)),n.typeInfo);let r=n;return new W(this._countTrailingZeros(r.value),n.typeInfo)}Cross(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof G&&r instanceof G){if(n.data.length!==3||r.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;let t=n.data,i=r.data;return new G([t[1]*i[2]-i[1]*t[2],t[2]*i[0]-i[2]*t[0],t[0]*i[1]-i[0]*t[1]],n.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){let n=this.exec.evalExpression(e.args[0],t),r=180/Math.PI;return n instanceof G?new G(n.data.map(e=>e*r),n.typeInfo):new W(n.value*r,this.getTypeInfo(`f32`))}Determinant(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof K){let e=n.data,t=n.typeInfo.getTypeName(),r=t.endsWith(`h`)?this.getTypeInfo(`f16`):this.getTypeInfo(`f32`);if(t===`mat2x2`||t===`mat2x2f`||t===`mat2x2h`)return new W(e[0]*e[3]-e[1]*e[2],r);if(t===`mat2x3`||t===`mat2x3f`||t===`mat2x3h`)return new W(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),r);if(t===`mat2x4`||t===`mat2x4f`||t===`mat2x4h`)console.error(`TODO: Determinant for ${t}`);else if(t===`mat3x2`||t===`mat3x2f`||t===`mat3x2h`)console.error(`TODO: Determinant for ${t}`);else{if(t===`mat3x3`||t===`mat3x3f`||t===`mat3x3h`)return new W(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),r);t===`mat3x4`||t===`mat3x4f`||t===`mat3x4h`||t===`mat4x2`||t===`mat4x2f`||t===`mat4x2h`||t===`mat4x3`||t===`mat4x3f`||t===`mat4x3h`?console.error(`TODO: Determinant for ${t}`):t!==`mat4x4`&&t!==`mat4x4f`&&t!==`mat4x4h`||console.error(`TODO: Determinant for ${t}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof G&&r instanceof G){let e=0;for(let t=0;t<n.data.length;++t)e+=(n.data[t]-r.data[t])*(n.data[t]-r.data[t]);return new W(Math.sqrt(e),this.getTypeInfo(`f32`))}let i=n,a=r;return new W(Math.abs(i.value-a.value),n.typeInfo)}_dot(e,t){let n=0;for(let r=0;r<e.length;++r)n+=t[r]*e[r];return n}Dot(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return n instanceof G&&r instanceof G?new W(this._dot(n.data,r.data),this.getTypeInfo(`f32`)):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.exp(e)),n.typeInfo);let r=n;return new W(Math.exp(r.value),n.typeInfo)}Exp2(e,t){let n=this.exec.evalExpression(e.args[0],t);return n instanceof G?new G(n.data.map(e=>2**e),n.typeInfo):new W(2**n.value,n.typeInfo)}ExtractBits(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(r.typeInfo.name!==`u32`&&r.typeInfo.name!==`x32`)return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(i.typeInfo.name!==`u32`&&i.typeInfo.name!==`x32`)return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;let a=r.value,o=i.value;if(n instanceof G)return new G(n.data.map(e=>e>>a&(1<<o)-1),n.typeInfo);if(n.typeInfo.name!==`i32`&&n.typeInfo.name!==`x32`)return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;let s=n.value;return new W(s>>a&(1<<o)-1,this.getTypeInfo(`i32`))}FaceForward(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);return n instanceof G&&r instanceof G&&i instanceof G?new G(this._dot(r.data,i.data)<0?Array.from(n.data):n.data.map(e=>-e),n.typeInfo):(console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null)}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>this._firstLeadingBit(e)),n.typeInfo);let r=n;return new W(this._firstLeadingBit(r.value),n.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>this._firstTrailingBit(e)),n.typeInfo);let r=n;return new W(this._firstTrailingBit(r.value),n.typeInfo)}Floor(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.floor(e)),n.typeInfo);let r=n;return new W(Math.floor(r.value),n.typeInfo)}Fma(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof G&&r instanceof G&&i instanceof G)return n.data.length!==r.data.length||n.data.length!==i.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new G(n.data.map((e,t)=>e*r.data[t]+i.data[t]),n.typeInfo);let a=n,o=r,s=i;return new W(a.value*o.value+s.value,a.typeInfo)}Fract(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>e-Math.floor(e)),n.typeInfo);let r=n;return new W(r.value-Math.floor(r.value),n.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t),a=this.exec.evalExpression(e.args[3],t);if(i.typeInfo.name!==`u32`&&i.typeInfo.name!==`x32`)return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;let o=i.value,s=(1<<a.value)-1<<o,c=~s;if(n instanceof G&&r instanceof G)return new G(n.data.map((e,t)=>e&c|r.data[t]<<o&s),n.typeInfo);let l=n.value,u=r.value;return new W(l&c|u<<o&s,n.typeInfo)}InverseSqrt(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>1/Math.sqrt(e)),n.typeInfo);let r=n;return new W(1/Math.sqrt(r.value),n.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G){let e=0;return n.data.forEach(t=>{e+=t*t}),new W(Math.sqrt(e),this.getTypeInfo(`f32`))}let r=n;return new W(Math.abs(r.value),n.typeInfo)}Log(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.log(e)),n.typeInfo);let r=n;return new W(Math.log(r.value),n.typeInfo)}Log2(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.log2(e)),n.typeInfo);let r=n;return new W(Math.log2(r.value),n.typeInfo)}Max(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof G&&r instanceof G)return new G(n.data.map((e,t)=>Math.max(e,r.data[t])),n.typeInfo);let i=n,a=r;return new W(Math.max(i.value,a.value),n.typeInfo)}Min(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof G&&r instanceof G)return new G(n.data.map((e,t)=>Math.min(e,r.data[t])),n.typeInfo);let i=n,a=r;return new W(Math.min(i.value,a.value),n.typeInfo)}Mix(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof G&&r instanceof G&&i instanceof G)return new G(n.data.map((e,t)=>n.data[t]*(1-i.data[t])+r.data[t]*i.data[t]),n.typeInfo);let a=r,o=i;return new W(n.value*(1-o.value)+a.value*o.value,n.typeInfo)}Modf(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof G&&r instanceof G)return new G(n.data.map((e,t)=>e%r.data[t]),n.typeInfo);let i=r;return new W(n.value%i.value,n.typeInfo)}Normalize(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G){let r=this.Length(e,t).value;return new G(n.data.map(e=>e/r),n.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof G&&r instanceof G)return new G(n.data.map((e,t)=>e**+r.data[t]),n.typeInfo);let i=n,a=r;return new W(i.value**+a.value,n.typeInfo)}QuantizeToF16(e,t){let n=this.exec.evalExpression(e.args[0],t);return n instanceof G?new G(n.data.map(e=>e),n.typeInfo):new W(n.value,n.typeInfo)}Radians(e,t){let n=this.exec.evalExpression(e.args[0],t);return n instanceof G?new G(n.data.map(e=>e*Math.PI/180),n.typeInfo):new W(n.value*Math.PI/180,this.getTypeInfo(`f32`))}Reflect(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof G&&r instanceof G){let e=this._dot(n.data,r.data);return new G(n.data.map((t,n)=>t-2*e*r.data[n]),n.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof G&&r instanceof G&&i instanceof W){let e=this._dot(r.data,n.data);return new G(n.data.map((t,n)=>{let a=1-i.value*i.value*(1-e*e);if(a<0)return 0;let o=Math.sqrt(a);return i.value*t-(i.value*e+o)*r.data[n]}),n.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.round(e)),n.typeInfo);let r=n;return new W(Math.round(r.value),n.typeInfo)}Saturate(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.min(Math.max(e,0),1)),n.typeInfo);let r=n;return new W(Math.min(Math.max(r.value,0),1),n.typeInfo)}Sign(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.sign(e)),n.typeInfo);let r=n;return new W(Math.sign(r.value),n.typeInfo)}Sin(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.sin(e)),n.typeInfo);let r=n;return new W(Math.sin(r.value),n.typeInfo)}Sinh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.sinh(e)),n.typeInfo);let r=n;return new W(Math.sinh(r.value),n.typeInfo)}_smoothstep(e,t,n){let r=Math.min(Math.max((n-e)/(t-e),0),1);return r*r*(3-2*r)}SmoothStep(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(i instanceof G&&n instanceof G&&r instanceof G)return new G(i.data.map((e,t)=>this._smoothstep(n.data[t],r.data[t],e)),i.typeInfo);let a=n,o=r,s=i;return new W(this._smoothstep(a.value,o.value,s.value),i.typeInfo)}Sqrt(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.sqrt(e)),n.typeInfo);let r=n;return new W(Math.sqrt(r.value),n.typeInfo)}Step(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(r instanceof G&&n instanceof G)return new G(r.data.map((e,t)=>e<n.data[t]?0:1),r.typeInfo);let i=n;return new W(r.value<i.value?0:1,i.typeInfo)}Tan(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.tan(e)),n.typeInfo);let r=n;return new W(Math.tan(r.value),n.typeInfo)}Tanh(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.tanh(e)),n.typeInfo);let r=n;return new W(Math.tanh(r.value),n.typeInfo)}_getTransposeType(e){let t=e.getTypeName();return t===`mat2x2f`||t===`mat2x2h`?e:t===`mat2x3f`?this.getTypeInfo(`mat3x2f`):t===`mat2x3h`?this.getTypeInfo(`mat3x2h`):t===`mat2x4f`?this.getTypeInfo(`mat4x2f`):t===`mat2x4h`?this.getTypeInfo(`mat4x2h`):t===`mat3x2f`?this.getTypeInfo(`mat2x3f`):t===`mat3x2h`?this.getTypeInfo(`mat2x3h`):t===`mat3x3f`||t===`mat3x3h`?e:t===`mat3x4f`?this.getTypeInfo(`mat4x3f`):t===`mat3x4h`?this.getTypeInfo(`mat4x3h`):t===`mat4x2f`?this.getTypeInfo(`mat2x4f`):t===`mat4x2h`?this.getTypeInfo(`mat2x4h`):t===`mat4x3f`?this.getTypeInfo(`mat3x4f`):t===`mat4x3h`?this.getTypeInfo(`mat3x4h`):(t===`mat4x4f`||t===`mat4x4h`||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){let n=this.exec.evalExpression(e.args[0],t);if(!(n instanceof K))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;let r=this._getTransposeType(n.typeInfo);if(n.typeInfo.name===`mat2x2`||n.typeInfo.name===`mat2x2f`||n.typeInfo.name===`mat2x2h`){let e=n.data;return new K([e[0],e[2],e[1],e[3]],r)}if(n.typeInfo.name===`mat2x3`||n.typeInfo.name===`mat2x3f`||n.typeInfo.name===`mat2x3h`){let e=n.data;return new K([e[0],e[3],e[6],e[1],e[4],e[7]],r)}if(n.typeInfo.name===`mat2x4`||n.typeInfo.name===`mat2x4f`||n.typeInfo.name===`mat2x4h`){let e=n.data;return new K([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13]],r)}if(n.typeInfo.name===`mat3x2`||n.typeInfo.name===`mat3x2f`||n.typeInfo.name===`mat3x2h`){let e=n.data;return new K([e[0],e[3],e[1],e[4],e[2],e[5]],r)}if(n.typeInfo.name===`mat3x3`||n.typeInfo.name===`mat3x3f`||n.typeInfo.name===`mat3x3h`){let e=n.data;return new K([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]],r)}if(n.typeInfo.name===`mat3x4`||n.typeInfo.name===`mat3x4f`||n.typeInfo.name===`mat3x4h`){let e=n.data;return new K([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14]],r)}if(n.typeInfo.name===`mat4x2`||n.typeInfo.name===`mat4x2f`||n.typeInfo.name===`mat4x2h`){let e=n.data;return new K([e[0],e[4],e[1],e[5],e[2],e[6]],r)}if(n.typeInfo.name===`mat4x3`||n.typeInfo.name===`mat4x3f`||n.typeInfo.name===`mat4x3h`){let e=n.data;return new K([e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]],r)}if(n.typeInfo.name===`mat4x4`||n.typeInfo.name===`mat4x4f`||n.typeInfo.name===`mat4x4h`){let e=n.data;return new K([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]],r)}return console.error(`Invalid matrix type ${n.typeInfo.name}`),null}Trunc(e,t){let n=this.exec.evalExpression(e.args[0],t);if(n instanceof G)return new G(n.data.map(e=>Math.trunc(e)),n.typeInfo);let r=n;return new W(Math.trunc(r.value),n.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error(`TODO: dpdxFine`),null}Dpdy(e,t){return console.error(`TODO: dpdy`),null}DpdyCoarse(e,t){return console.error(`TODO: dpdyCoarse`),null}DpdyFine(e,t){return console.error(`TODO: dpdyFine`),null}Fwidth(e,t){return console.error(`TODO: fwidth`),null}FwidthCoarse(e,t){return console.error(`TODO: fwidthCoarse`),null}FwidthFine(e,t){return console.error(`TODO: fwidthFine`),null}TextureDimensions(e,t){let n=e.args[0],r=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(n instanceof tt){let i=n.name,a=t.getVariableValue(i);if(a instanceof St){if(r<0||r>=a.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;let t=a.getMipLevelSize(r),n=a.dimension;return n===`1d`?new W(t[0],this.getTypeInfo(`u32`)):n===`3d`?new G(t,this.getTypeInfo(`vec3u`)):n===`2d`?new G(t.slice(0,2),this.getTypeInfo(`vec2u`)):(console.error(`Invalid texture dimension ${n} not found. Line ${e.line}`),null)}return console.error(`Texture ${i} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error(`TODO: textureGather`),null}TextureGatherCompare(e,t){return console.error(`TODO: textureGatherCompare`),null}TextureLoad(e,t){let n=e.args[0],r=this.exec.evalExpression(e.args[1],t),i=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(r instanceof G)||r.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(n instanceof tt){let a=n.name,o=t.getVariableValue(a);if(o instanceof St){let t=Math.floor(r.data[0]),n=Math.floor(r.data[1]);if(t<0||t>=o.width||n<0||n>=o.height)return console.error(`Texture ${a} out of bounds. Line ${e.line}`),null;let s=o.getPixel(t,n,0,i);return s===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new G(s,this.getTypeInfo(`vec4f`))}return console.error(`Texture ${a} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){let n=e.args[0];if(n instanceof tt){let r=n.name,i=t.getVariableValue(r);return i instanceof St?new W(i.depthOrArrayLayers,this.getTypeInfo(`u32`)):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){let n=e.args[0];if(n instanceof tt){let r=n.name,i=t.getVariableValue(r);return i instanceof St?new W(i.mipLevelCount,this.getTypeInfo(`u32`)):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){let n=e.args[0];if(n instanceof tt){let r=n.name,i=t.getVariableValue(r);return i instanceof St?new W(i.sampleCount,this.getTypeInfo(`u32`)):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error(`TODO: textureSample`),null}TextureSampleBias(e,t){return console.error(`TODO: textureSampleBias`),null}TextureSampleCompare(e,t){return console.error(`TODO: textureSampleCompare`),null}TextureSampleCompareLevel(e,t){return console.error(`TODO: textureSampleCompareLevel`),null}TextureSampleGrad(e,t){return console.error(`TODO: textureSampleGrad`),null}TextureSampleLevel(e,t){return console.error(`TODO: textureSampleLevel`),null}TextureSampleBaseClampToEdge(e,t){return console.error(`TODO: textureSampleBaseClampToEdge`),null}TextureStore(e,t){let n=e.args[0],r=this.exec.evalExpression(e.args[1],t),i=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,a=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(a.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(r instanceof G)||r.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(n instanceof tt){let o=n.name,s=t.getVariableValue(o);if(s instanceof St){let t=s.getMipLevelSize(0),n=Math.floor(r.data[0]),c=Math.floor(r.data[1]);return n<0||n>=t[0]||c<0||c>=t[1]?(console.error(`Texture ${o} out of bounds. Line ${e.line}`),null):(s.setPixel(n,c,0,i,Array.from(a)),null)}return console.error(`Texture ${o} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t);return t.getVariable(r).value.getSubData(this.exec,n.postfix,t)}AtomicStore(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t);return s instanceof W&&o instanceof W&&(s.value=o.value),i.value instanceof xt&&i.value.setDataValue(this.exec,s,n.postfix,t),null}AtomicAdd(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new W(s.value,s.typeInfo);return s instanceof W&&o instanceof W&&(s.value+=o.value),i.value instanceof xt&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicSub(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new W(s.value,s.typeInfo);return s instanceof W&&o instanceof W&&(s.value-=o.value),i.value instanceof xt&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicMax(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new W(s.value,s.typeInfo);return s instanceof W&&o instanceof W&&(s.value=Math.max(s.value,o.value)),i.value instanceof xt&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicMin(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new W(s.value,s.typeInfo);return s instanceof W&&o instanceof W&&(s.value=Math.min(s.value,o.value)),i.value instanceof xt&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicAnd(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new W(s.value,s.typeInfo);return s instanceof W&&o instanceof W&&(s.value&=o.value),i.value instanceof xt&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicOr(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new W(s.value,s.typeInfo);return s instanceof W&&o instanceof W&&(s.value|=o.value),i.value instanceof xt&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicXor(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new W(s.value,s.typeInfo);return s instanceof W&&o instanceof W&&(s.value^=o.value),i.value instanceof xt&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicExchange(e,t){let n=e.args[0];n instanceof st&&(n=n.right);let r=this.exec.getVariableName(n,t),i=t.getVariable(r),a=e.args[1],o=this.exec.evalExpression(a,t),s=i.value.getSubData(this.exec,n.postfix,t),c=new W(s.value,s.typeInfo);return s instanceof W&&o instanceof W&&(s.value=o.value),i.value instanceof xt&&i.value.setDataValue(this.exec,s,n.postfix,t),c}AtomicCompareExchangeWeak(e,t){return console.error(`TODO: atomicCompareExchangeWeak`),null}Pack4x8snorm(e,t){return console.error(`TODO: pack4x8snorm`),null}Pack4x8unorm(e,t){return console.error(`TODO: pack4x8unorm`),null}Pack4xI8(e,t){return console.error(`TODO: pack4xI8`),null}Pack4xU8(e,t){return console.error(`TODO: pack4xU8`),null}Pack4x8Clamp(e,t){return console.error(`TODO: pack4x8Clamp`),null}Pack4xU8Clamp(e,t){return console.error(`TODO: pack4xU8Clamp`),null}Pack2x16snorm(e,t){return console.error(`TODO: pack2x16snorm`),null}Pack2x16unorm(e,t){return console.error(`TODO: pack2x16unorm`),null}Pack2x16float(e,t){return console.error(`TODO: pack2x16float`),null}Unpack4x8snorm(e,t){return console.error(`TODO: unpack4x8snorm`),null}Unpack4x8unorm(e,t){return console.error(`TODO: unpack4x8unorm`),null}Unpack4xI8(e,t){return console.error(`TODO: unpack4xI8`),null}Unpack4xU8(e,t){return console.error(`TODO: unpack4xU8`),null}Unpack2x16snorm(e,t){return console.error(`TODO: unpack2x16snorm`),null}Unpack2x16unorm(e,t){return console.error(`TODO: unpack2x16unorm`),null}Unpack2x16float(e,t){return console.error(`TODO: unpack2x16float`),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error(`TODO: subgroupAdd`),null}SubgroupExclusiveAdd(e,t){return console.error(`TODO: subgroupExclusiveAdd`),null}SubgroupInclusiveAdd(e,t){return console.error(`TODO: subgroupInclusiveAdd`),null}SubgroupAll(e,t){return console.error(`TODO: subgroupAll`),null}SubgroupAnd(e,t){return console.error(`TODO: subgroupAnd`),null}SubgroupAny(e,t){return console.error(`TODO: subgroupAny`),null}SubgroupBallot(e,t){return console.error(`TODO: subgroupBallot`),null}SubgroupBroadcast(e,t){return console.error(`TODO: subgroupBroadcast`),null}SubgroupBroadcastFirst(e,t){return console.error(`TODO: subgroupBroadcastFirst`),null}SubgroupElect(e,t){return console.error(`TODO: subgroupElect`),null}SubgroupMax(e,t){return console.error(`TODO: subgroupMax`),null}SubgroupMin(e,t){return console.error(`TODO: subgroupMin`),null}SubgroupMul(e,t){return console.error(`TODO: subgroupMul`),null}SubgroupExclusiveMul(e,t){return console.error(`TODO: subgroupExclusiveMul`),null}SubgroupInclusiveMul(e,t){return console.error(`TODO: subgroupInclusiveMul`),null}SubgroupOr(e,t){return console.error(`TODO: subgroupOr`),null}SubgroupShuffle(e,t){return console.error(`TODO: subgroupShuffle`),null}SubgroupShuffleDown(e,t){return console.error(`TODO: subgroupShuffleDown`),null}SubgroupShuffleUp(e,t){return console.error(`TODO: subgroupShuffleUp`),null}SubgroupShuffleXor(e,t){return console.error(`TODO: subgroupShuffleXor`),null}SubgroupXor(e,t){return console.error(`TODO: subgroupXor`),null}QuadBroadcast(e,t){return console.error(`TODO: quadBroadcast`),null}QuadSwapDiagonal(e,t){return console.error(`TODO: quadSwapDiagonal`),null}QuadSwapX(e,t){return console.error(`TODO: quadSwapX`),null}QuadSwapY(e,t){return console.error(`TODO: quadSwapY`),null}},Wt={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},Gt={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]},Kt=class e extends Ht{constructor(e,t){super(),this.ast=e??[],this.reflection=new Lt,this.reflection.updateAST(this.ast),this.context=t?.clone()??new Vt,this.builtins=new Ut(this),this.typeInfo={bool:this.getTypeInfo(H.bool),i32:this.getTypeInfo(H.i32),u32:this.getTypeInfo(H.u32),f32:this.getTypeInfo(H.f32),f16:this.getTypeInfo(H.f16),vec2f:this.getTypeInfo(U.vec2f),vec2u:this.getTypeInfo(U.vec2u),vec2i:this.getTypeInfo(U.vec2i),vec2h:this.getTypeInfo(U.vec2h),vec3f:this.getTypeInfo(U.vec3f),vec3u:this.getTypeInfo(U.vec3u),vec3i:this.getTypeInfo(U.vec3i),vec3h:this.getTypeInfo(U.vec3h),vec4f:this.getTypeInfo(U.vec4f),vec4u:this.getTypeInfo(U.vec4u),vec4i:this.getTypeInfo(U.vec4i),vec4h:this.getTypeInfo(U.vec4h),mat2x2f:this.getTypeInfo(U.mat2x2f),mat2x3f:this.getTypeInfo(U.mat2x3f),mat2x4f:this.getTypeInfo(U.mat2x4f),mat3x2f:this.getTypeInfo(U.mat3x2f),mat3x3f:this.getTypeInfo(U.mat3x3f),mat3x4f:this.getTypeInfo(U.mat3x4f),mat4x2f:this.getTypeInfo(U.mat4x2f),mat4x3f:this.getTypeInfo(U.mat4x3f),mat4x4f:this.getTypeInfo(U.mat4x4f)}}getVariableValue(e){let t=this.context.getVariable(e)?.value??null;if(t===null)return null;if(t instanceof W)return t.value;if(t instanceof G||t instanceof K)return Array.from(t.data);if(t instanceof xt&&t.typeInfo instanceof j){if(t.typeInfo.format.name===`u32`)return Array.from(new Uint32Array(t.buffer,t.offset,t.typeInfo.count));if(t.typeInfo.format.name===`i32`)return Array.from(new Int32Array(t.buffer,t.offset,t.typeInfo.count));if(t.typeInfo.format.name===`f32`)return Array.from(new Float32Array(t.buffer,t.offset,t.typeInfo.count))}return console.error(`Unsupported return variable type ${t.typeInfo.name}`),null}execute(e){(e??={}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,n,r){let i=this.context.clone();(r??={}).constants&&this._setOverrides(r.constants,i),this._execStatements(this.ast,i);let a=i.getFunction(e);if(!a)return void console.error(`Function ${e} not found`);if(typeof t==`number`)t=[t,1,1];else{if(t.length===0)return void console.error(`Invalid dispatch count`);t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}let o=t[0],s=t[1],c=t[2],l=this.getTypeInfo(`vec3u`);i.setVariable(`@num_workgroups`,new G(t,l));let u=this.reflection.getFunctionInfo(e);for(let t in u===null&&console.error(`Function ${e} not found in reflection data`),n)for(let e in n[t]){let r=n[t][e];i.variables.forEach(n=>{let i=n.node;if(i?.attributes){let a=null,o=null;for(let e of i.attributes)e.name===`binding`?a=e.value:e.name===`group`&&(o=e.value);if(e==a&&t==o){let a=!1;for(let r of u.resources)if(r.name===n.name&&r.group===parseInt(t)&&r.binding===parseInt(e)){a=!0;break}a&&(r.texture!==void 0&&r.descriptor!==void 0?n.value=new St(r.texture,this.getTypeInfo(i.type),r.descriptor,r.texture.view??null):r.uniform===void 0?n.value=new xt(r,this.getTypeInfo(i.type)):n.value=new xt(r.uniform,this.getTypeInfo(i.type)))}}})}for(let e=0;e<c;++e)for(let t=0;t<s;++t)for(let n=0;n<o;++n)i.setVariable(`@workgroup_id`,new G([n,t,e],this.getTypeInfo(`vec3u`))),this._dispatchWorkgroup(a,[n,t,e],i)}execStatement(t,n){if(t instanceof Re)return this.evalExpression(t.value,n);if(t instanceof We){if(t.condition){let e=this.evalExpression(t.condition,n);if(!(e instanceof W))throw Error(`Invalid break-if condition`);if(!e.value)return null}return e._breakObj}if(t instanceof Ge)return e._continueObj;if(t instanceof Oe)this._let(t,n);else if(t instanceof Ee)this._var(t,n);else if(t instanceof ke)this._const(t,n);else if(t instanceof xe)this._function(t,n);else{if(t instanceof Le)return this._if(t,n);if(t instanceof Ie)return this._switch(t,n);if(t instanceof Te)return this._for(t,n);if(t instanceof Ce)return this._while(t,n);if(t instanceof Fe)return this._loop(t,n);if(t instanceof we){let e=n.clone();return e.currentFunctionName=n.currentFunctionName,this._execStatements(t.body,e)}if(t instanceof Ne)this._assign(t,n);else if(t instanceof Me)this._increment(t,n);else{if(t instanceof qe)return null;if(t instanceof De){let e=t.name;n.getVariable(e)===null&&n.setVariable(e,new W(0,this.getTypeInfo(`u32`)))}else if(t instanceof Pe)this._call(t,n);else{if(t instanceof Ve||t instanceof He)return null;console.error(`Invalid statement type.`,t,`Line ${t.line}`)}}}return null}evalExpression(e,t){return e instanceof ct?this._evalBinaryOp(e,t):e instanceof rt?this._evalLiteral(e,t):e instanceof tt?this._evalVariable(e,t):e instanceof et?this._evalCall(e,t):e instanceof $e?this._evalCreate(e,t):e instanceof nt?this._evalConst(e,t):e instanceof it?this._evalBitcast(e,t):e instanceof st?this._evalUnaryOp(e,t):(console.error(`Invalid expression type`,e,`Line ${e.line}`),null)}getTypeInfo(e){if(e instanceof H){let t=this.reflection.getTypeInfo(e);if(t!==null)return t}let t=this.typeInfo[e]??null;return t!==null||(t=this.reflection.getTypeInfoByName(e)),t}_setOverrides(e,t){for(let n in e){let r=e[n],i=this.reflection.getOverrideInfo(n);i===null?console.error(`Override ${n} does not exist in the shader.`):(i.type===null&&(i.type=this.getTypeInfo(`u32`)),i.type.name===`u32`||i.type.name===`i32`||i.type.name===`f32`||i.type.name===`f16`?t.setVariable(n,new W(r,i.type)):i.type.name===`bool`?t.setVariable(n,new W(r?1:0,i.type)):i.type.name===`vec2`||i.type.name===`vec3`||i.type.name===`vec4`||i.type.name===`vec2f`||i.type.name===`vec3f`||i.type.name===`vec4f`||i.type.name===`vec2i`||i.type.name===`vec3i`||i.type.name===`vec4i`||i.type.name===`vec2u`||i.type.name===`vec3u`||i.type.name===`vec4u`||i.type.name===`vec2h`||i.type.name===`vec3h`||i.type.name===`vec4h`?t.setVariable(n,new G(r,i.type)):console.error(`Invalid constant type for ${n}`))}}_dispatchWorkgroup(e,t,n){let r=[1,1,1];for(let t of e.node.attributes)if(t.name===`workgroup_size`){if(t.value.length>0){let e=n.getVariableValue(t.value[0]);r[0]=e instanceof W?e.value:parseInt(t.value[0])}if(t.value.length>1){let e=n.getVariableValue(t.value[1]);r[1]=e instanceof W?e.value:parseInt(t.value[1])}if(t.value.length>2){let e=n.getVariableValue(t.value[2]);r[2]=e instanceof W?e.value:parseInt(t.value[2])}}let i=this.getTypeInfo(`vec3u`),a=this.getTypeInfo(`u32`);n.setVariable(`@workgroup_size`,new G(r,i));let o=r[0],s=r[1],c=r[2];for(let l=0,u=0;l<c;++l)for(let c=0;c<s;++c)for(let s=0;s<o;++s,++u){let o=[s,c,l],d=[s+t[0]*r[0],c+t[1]*r[1],l+t[2]*r[2]];n.setVariable(`@local_invocation_id`,new G(o,i)),n.setVariable(`@global_invocation_id`,new G(d,i)),n.setVariable(`@local_invocation_index`,new W(u,a)),this._dispatchExec(e,n)}}_dispatchExec(e,t){for(let n of e.node.args)for(let e of n.attributes)if(e.name===`builtin`){let r=`@${e.value}`,i=t.getVariable(r);i!==void 0&&t.variables.set(n.name,i)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof st;)e=e.right;return e instanceof tt?e.name:(console.error(`Unknown variable type`,e,`Line`,e.line),null)}_execStatements(e,t){for(let n of e){if(n instanceof Array){let e=t.clone(),r=this._execStatements(n,e);if(r)return r;continue}let e=this.execStatement(n,t);if(e)return e}return null}_call(e,t){let n=t.clone();n.currentFunctionName=e.name;let r=t.getFunction(e.name);if(r){for(let t=0;t<r.node.args.length;++t){let i=r.node.args[t],a=this.evalExpression(e.args[t],n);n.setVariable(i.name,a,i)}this._execStatements(r.node.body,n)}else e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){let n=this.getVariableName(e.variable,t),r=t.getVariable(n);r?e.operator===`++`?r.value instanceof W?r.value.value++:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):e.operator===`--`?r.value instanceof W?r.value.value--:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${n} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof tt){let n=this.getVariableName(e,t),r=t.getVariable(n);return r===null?(console.error(`Variable ${n} not found. Line ${e.line}`),null):r.value.getSubData(this,e.postfix,t)}if(e instanceof st){if(e.operator===`*`){let n=this._getVariableData(e.right,t);return n instanceof yt?n.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator===`&`)return new yt(this._getVariableData(e.right,t))}return null}_assign(e,t){let n=null,r=`<var>`,i=null;if(e.variable instanceof st){let n=this._getVariableData(e.variable,t),r=this.evalExpression(e.value,t),i=e.operator;if(i===`=`){if(n instanceof W||n instanceof G||n instanceof K){if(r instanceof W||r instanceof G||r instanceof K&&n.data.length===r.data.length)return void n.data.set(r.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(n instanceof xt&&r instanceof xt&&n.buffer.byteLength-n.offset>=r.buffer.byteLength-r.offset)return void(n.buffer.byteLength%4==0?new Uint32Array(n.buffer,n.offset,n.typeInfo.size/4).set(new Uint32Array(r.buffer,r.offset,r.typeInfo.size/4)):new Uint8Array(n.buffer,n.offset,n.typeInfo.size).set(new Uint8Array(r.buffer,r.offset,r.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(i===`+=`)return n instanceof W||n instanceof G||n instanceof K?r instanceof W||r instanceof G||r instanceof K?void n.data.set(r.data.map((e,t)=>n.data[t]+e)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(i===`-=`)return(n instanceof W||n instanceof G||n instanceof K)&&(r instanceof W||r instanceof G||r instanceof K)?void n.data.set(r.data.map((e,t)=>n.data[t]-e)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof st){if(e.variable.operator===`*`){r=this.getVariableName(e.variable.right,t);let i=t.getVariable(r);if(!(i&&i.value instanceof yt))return void console.error(`Variable ${r} is not a pointer. Line ${e.line}`);n=i.value.reference;let a=e.variable.postfix;if(!a){let t=e.variable.right;for(;t instanceof st;){if(t.postfix){a=t.postfix;break}t=t.right}}a&&(n=n.getSubData(this,a,t))}}else{i=e.variable.postfix,r=this.getVariableName(e.variable,t);let a=t.getVariable(r);if(a===null)return void console.error(`Variable ${r} not found. Line ${e.line}`);n=a.value}if(n instanceof yt&&(n=n.reference),n===null)return void console.error(`Variable ${r} not found. Line ${e.line}`);let a=this.evalExpression(e.value,t),o=e.operator;if(o!==`=`){let r=n.getSubData(this,i,t);if(r instanceof G&&a instanceof W){let t=r.data,n=a.value;if(o===`+=`)for(let e=0;e<t.length;++e)t[e]+=n;else if(o===`-=`)for(let e=0;e<t.length;++e)t[e]-=n;else if(o===`*=`)for(let e=0;e<t.length;++e)t[e]*=n;else if(o===`/=`)for(let e=0;e<t.length;++e)t[e]/=n;else if(o===`%=`)for(let e=0;e<t.length;++e)t[e]%=n;else if(o===`&=`)for(let e=0;e<t.length;++e)t[e]&=n;else if(o===`|=`)for(let e=0;e<t.length;++e)t[e]|=n;else if(o===`^=`)for(let e=0;e<t.length;++e)t[e]^=n;else if(o===`<<=`)for(let e=0;e<t.length;++e)t[e]<<=n;else if(o===`>>=`)for(let e=0;e<t.length;++e)t[e]>>=n;else console.error(`Invalid operator ${o}. Line ${e.line}`)}else if(r instanceof G&&a instanceof G){let t=r.data,n=a.data;if(t.length!==n.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(o===`+=`)for(let e=0;e<t.length;++e)t[e]+=n[e];else if(o===`-=`)for(let e=0;e<t.length;++e)t[e]-=n[e];else if(o===`*=`)for(let e=0;e<t.length;++e)t[e]*=n[e];else if(o===`/=`)for(let e=0;e<t.length;++e)t[e]/=n[e];else if(o===`%=`)for(let e=0;e<t.length;++e)t[e]%=n[e];else if(o===`&=`)for(let e=0;e<t.length;++e)t[e]&=n[e];else if(o===`|=`)for(let e=0;e<t.length;++e)t[e]|=n[e];else if(o===`^=`)for(let e=0;e<t.length;++e)t[e]^=n[e];else if(o===`<<=`)for(let e=0;e<t.length;++e)t[e]<<=n[e];else if(o===`>>=`)for(let e=0;e<t.length;++e)t[e]>>=n[e];else console.error(`Invalid operator ${o}. Line ${e.line}`)}else{if(!(r instanceof W&&a instanceof W))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);o===`+=`?r.value+=a.value:o===`-=`?r.value-=a.value:o===`*=`?r.value*=a.value:o===`/=`?r.value/=a.value:o===`%=`?r.value%=a.value:o===`&=`?r.value&=a.value:o===`|=`?r.value|=a.value:o===`^=`?r.value^=a.value:o===`<<=`?r.value<<=a.value:o===`>>=`?r.value>>=a.value:console.error(`Invalid operator ${o}. Line ${e.line}`)}n instanceof xt&&n.setDataValue(this,r,i,t);return}if(n instanceof xt)n.setDataValue(this,a,i,t);else if(i){if(!(n instanceof G||n instanceof K))return void console.error(`Variable ${r} is not a vector or matrix. Line ${e.line}`);if(i instanceof at){let o=this.evalExpression(i.index,t).value;if(n instanceof G){if(!(a instanceof W))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[o]=a.value}else{if(!(n instanceof K))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{let o=this.evalExpression(i.index,t).value;if(o<0||!(a instanceof G))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{let t=n.typeInfo.getTypeName();if(t===`mat2x2`||t===`mat2x2f`||t===`mat2x2h`){if(!(o<2&&a.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[2*o]=a.data[0],n.data[2*o+1]=a.data[1]}else if(t===`mat2x3`||t===`mat2x3f`||t===`mat2x3h`){if(!(o<2&&a.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[3*o]=a.data[0],n.data[3*o+1]=a.data[1],n.data[3*o+2]=a.data[2]}else if(t===`mat2x4`||t===`mat2x4f`||t===`mat2x4h`){if(!(o<2&&a.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[4*o]=a.data[0],n.data[4*o+1]=a.data[1],n.data[4*o+2]=a.data[2],n.data[4*o+3]=a.data[3]}else if(t===`mat3x2`||t===`mat3x2f`||t===`mat3x2h`){if(!(o<3&&a.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[2*o]=a.data[0],n.data[2*o+1]=a.data[1]}else if(t===`mat3x3`||t===`mat3x3f`||t===`mat3x3h`){if(!(o<3&&a.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[3*o]=a.data[0],n.data[3*o+1]=a.data[1],n.data[3*o+2]=a.data[2]}else if(t===`mat3x4`||t===`mat3x4f`||t===`mat3x4h`){if(!(o<3&&a.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[4*o]=a.data[0],n.data[4*o+1]=a.data[1],n.data[4*o+2]=a.data[2],n.data[4*o+3]=a.data[3]}else if(t===`mat4x2`||t===`mat4x2f`||t===`mat4x2h`){if(!(o<4&&a.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[2*o]=a.data[0],n.data[2*o+1]=a.data[1]}else if(t===`mat4x3`||t===`mat4x3f`||t===`mat4x3h`){if(!(o<4&&a.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[3*o]=a.data[0],n.data[3*o+1]=a.data[1],n.data[3*o+2]=a.data[2]}else{if(t!==`mat4x4`&&t!==`mat4x4f`&&t!==`mat4x4h`||!(o<4&&a.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[4*o]=a.data[0],n.data[4*o+1]=a.data[1],n.data[4*o+2]=a.data[2],n.data[4*o+3]=a.data[3]}}}}}else if(i instanceof Qe){let t=i.value;if(!(n instanceof G))return void console.error(`Invalid assignment to ${t}. Variable ${r} is not a vector. Line ${e.line}`);if(a instanceof W){if(t.length>1)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);if(t===`x`)n.data[0]=a.value;else if(t===`y`){if(n.data.length<2)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);n.data[1]=a.value}else if(t===`z`){if(n.data.length<3)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);n.data[2]=a.value}else if(t===`w`){if(n.data.length<4)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);n.data[3]=a.value}}else{if(!(a instanceof G))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(t.length!==a.data.length)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);for(let i=0;i<t.length;++i){let o=t[i];if(o===`x`||o===`r`)n.data[0]=a.data[i];else if(o===`y`||o===`g`){if(a.data.length<2)return void console.error(`Invalid assignment to ${o} for variable ${r}. Line ${e.line}`);n.data[1]=a.data[i]}else if(o===`z`||o===`b`){if(a.data.length<3)return void console.error(`Invalid assignment to ${o} for variable ${r}. Line ${e.line}`);n.data[2]=a.data[i]}else{if(o!==`w`&&o!==`a`||a.data.length<4)return void console.error(`Invalid assignment to ${o} for variable ${r}. Line ${e.line}`);n.data[3]=a.data[i]}}}}}else n instanceof W&&a instanceof W?n.value=a.value:n instanceof G&&a instanceof G||n instanceof K&&a instanceof K?n.data.set(a.data):console.error(`Invalid assignment to ${r}. Line ${e.line}`)}_function(e,t){let n=new Bt(e);t.functions.set(e.name,n)}_const(e,t){let n=null;e.value!==null&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_let(e,t){let n=null;if(e.value!==null){if(n=this.evalExpression(e.value,t),n===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof st||(n=n.clone())}else{let r=e.type.name;if(r===`f32`||r===`i32`||r===`u32`||r===`bool`||r===`f16`||r===`vec2`||r===`vec3`||r===`vec4`||r===`vec2f`||r===`vec3f`||r===`vec4f`||r===`vec2i`||r===`vec3i`||r===`vec4i`||r===`vec2u`||r===`vec3u`||r===`vec4u`||r===`vec2h`||r===`vec3h`||r===`vec4h`||r===`vec2b`||r===`vec3b`||r===`vec4b`||r===`mat2x2`||r===`mat2x3`||r===`mat2x4`||r===`mat3x2`||r===`mat3x3`||r===`mat3x4`||r===`mat4x2`||r===`mat4x3`||r===`mat4x4`||r===`mat2x2f`||r===`mat2x3f`||r===`mat2x4f`||r===`mat3x2f`||r===`mat3x3f`||r===`mat3x4f`||r===`mat4x2f`||r===`mat4x3f`||r===`mat4x4f`||r===`mat2x2h`||r===`mat2x3h`||r===`mat2x4h`||r===`mat3x2h`||r===`mat3x3h`||r===`mat3x4h`||r===`mat4x2h`||r===`mat4x3h`||r===`mat4x4h`||r===`array`){let r=new $e(e.type,[]);n=this._evalCreate(r,t)}}t.createVariable(e.name,n,e)}_var(e,t){let n=null;if(e.value!==null){if(n=this.evalExpression(e.value,t),n===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof st||(n=n.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);let r=e.type.name;if(r===`f32`||r===`i32`||r===`u32`||r===`bool`||r===`f16`||r===`vec2`||r===`vec3`||r===`vec4`||r===`vec2f`||r===`vec3f`||r===`vec4f`||r===`vec2i`||r===`vec3i`||r===`vec4i`||r===`vec2u`||r===`vec3u`||r===`vec4u`||r===`vec2h`||r===`vec3h`||r===`vec4h`||r===`vec2b`||r===`vec3b`||r===`vec4b`||r===`mat2x2`||r===`mat2x3`||r===`mat2x4`||r===`mat3x2`||r===`mat3x3`||r===`mat3x4`||r===`mat4x2`||r===`mat4x3`||r===`mat4x4`||r===`mat2x2f`||r===`mat2x3f`||r===`mat2x4f`||r===`mat3x2f`||r===`mat3x3f`||r===`mat3x4f`||r===`mat4x2f`||r===`mat4x3f`||r===`mat4x4f`||r===`mat2x2h`||r===`mat2x3h`||r===`mat2x4h`||r===`mat3x2h`||r===`mat3x3h`||r===`mat3x4h`||r===`mat4x2h`||r===`mat4x3h`||r===`mat4x4h`||e.type instanceof Ye||e.type instanceof qe||e.type instanceof U){let r=new $e(e.type,[]);n=this._evalCreate(r,t)}}t.createVariable(e.name,n,e)}_switch(e,t){t=t.clone();let n=this.evalExpression(e.condition,t);if(!(n instanceof W))return console.error(`Invalid if condition. Line ${e.line}`),null;let r=null;for(let i of e.cases)if(i instanceof dt)for(let a of i.selectors){if(a instanceof ut){r=i;continue}let o=this.evalExpression(a,t);if(!(o instanceof W))return console.error(`Invalid case selector. Line ${e.line}`),null;if(o.value===n.value)return this._execStatements(i.body,t)}else i instanceof ft&&(r=i);return r?this._execStatements(r.body,t):null}_if(e,t){t=t.clone();let n=this.evalExpression(e.condition,t);if(!(n instanceof W))return console.error(`Invalid if condition. Line ${e.line}`),null;if(n.value)return this._execStatements(e.body,t);for(let n of e.elseif){let r=this.evalExpression(n.condition,t);if(!(r instanceof W))return console.error(`Invalid if condition. Line ${e.line}`),null;if(r.value)return this._execStatements(n.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof W?e.value:(console.error(`Expected scalar value.`,e),0)}_for(t,n){for(n=n.clone(),this.execStatement(t.init,n);this._getScalarValue(this.evalExpression(t.condition,n));){let r=this._execStatements(t.body,n);if(r===e._breakObj)break;if(r!==null&&r!==e._continueObj)return r;this.execStatement(t.increment,n)}return null}_loop(t,n){for(n=n.clone();;){let r=this._execStatements(t.body,n);if(r===e._breakObj)break;if(r===e._continueObj){if(t.continuing&&this._execStatements(t.continuing.body,n)===e._breakObj)break}else if(r!==null)return r}return null}_while(t,n){for(n=n.clone();this._getScalarValue(this.evalExpression(t.condition,n));){let r=this._execStatements(t.body,n);if(r===e._breakObj)break;if(r!==e._continueObj&&r!==null)return r}return null}_evalBitcast(e,t){let n=this.evalExpression(e.value,t),r=e.type;if(n instanceof W)return new W(Pt(n.value,n.typeInfo.name,r.name),this.getTypeInfo(r));if(n instanceof G){let t=n.typeInfo.getTypeName(),i=``;if(t.endsWith(`f`))i=`f32`;else if(t.endsWith(`i`))i=`i32`;else if(t.endsWith(`u`))i=`u32`;else if(t.endsWith(`b`))i=`bool`;else{if(!t.endsWith(`h`))return console.error(`Unknown vector type ${t}. Line ${e.line}`),null;i=`f16`}let a=r.getTypeName(),o=``;if(a.endsWith(`f`))o=`f32`;else if(a.endsWith(`i`))o=`i32`;else if(a.endsWith(`u`))o=`u32`;else if(a.endsWith(`b`))o=`bool`;else{if(!a.endsWith(`h`))return console.error(`Unknown vector type ${o}. Line ${e.line}`),null;o=`f16`}return new G(function(e,t,n){if(t===n)return e;let r=Array(e.length);for(let i=0;i<e.length;i++)r[i]=Pt(e[i],t,n);return r}(Array.from(n.data),i,o),this.getTypeInfo(r))}return console.error(`TODO: bitcast for ${n.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){if(e instanceof $e){if(e.type===null)return vt.void;switch(e.type.getTypeName()){case`bool`:case`i32`:case`u32`:case`f32`:case`f16`:return this._callConstructorValue(e,t);case`vec2`:case`vec3`:case`vec4`:case`vec2f`:case`vec3f`:case`vec4f`:case`vec2h`:case`vec3h`:case`vec4h`:case`vec2i`:case`vec3i`:case`vec4i`:case`vec2u`:case`vec3u`:case`vec4u`:case`vec2b`:case`vec3b`:case`vec4b`:return this._callConstructorVec(e,t);case`mat2x2`:case`mat2x2f`:case`mat2x2h`:case`mat2x3`:case`mat2x3f`:case`mat2x3h`:case`mat2x4`:case`mat2x4f`:case`mat2x4h`:case`mat3x2`:case`mat3x2f`:case`mat3x2h`:case`mat3x3`:case`mat3x3f`:case`mat3x3h`:case`mat3x4`:case`mat3x4f`:case`mat3x4h`:case`mat4x2`:case`mat4x2f`:case`mat4x2h`:case`mat4x3`:case`mat4x3f`:case`mat4x3h`:case`mat4x4`:case`mat4x4f`:case`mat4x4h`:return this._callConstructorMatrix(e,t)}}let n=e instanceof $e?e.type.name:e.name,r=e instanceof $e?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(r===null)return console.error(`Unknown type ${n}. Line ${e.line}`),null;if(r.size===0)return null;let i=new xt(new ArrayBuffer(r.size),r,0);if(r instanceof A){if(e.args)for(let n=0;n<e.args.length;++n){let a=r.members[n],o=e.args[n],s=this.evalExpression(o,t);i.setData(this,s,a.type,a.offset,t)}}else if(r instanceof j){let n=0;if(e.args)for(let a=0;a<e.args.length;++a){let o=e.args[a],s=this.evalExpression(o,t);r.format===null&&(s.typeInfo?.name===`x32`?r.format=this.getTypeInfo(`i32`):r.format=s.typeInfo),i.setData(this,s,r.format,n,t),n+=r.stride}}else console.error(`Unknown type "${n}". Line ${e.line}`);return e instanceof $e?i.getSubData(this,e.postfix,t):i}_evalLiteral(e,t){let n=this.getTypeInfo(e.type),r=n.name;return r===`x32`||r===`u32`||r===`f32`||r===`f16`||r===`i32`||r===`bool`?new W(e.scalarValue,n):r===`vec2`||r===`vec3`||r===`vec4`||r===`vec2f`||r===`vec3f`||r===`vec4f`||r===`vec2h`||r===`vec3h`||r===`vec4h`||r===`vec2i`||r===`vec3i`||r===`vec4i`||r===`vec2u`||r===`vec3u`||r===`vec4u`?this._callConstructorVec(e,t):r===`mat2x2`||r===`mat2x3`||r===`mat2x4`||r===`mat3x2`||r===`mat3x3`||r===`mat3x4`||r===`mat4x2`||r===`mat4x3`||r===`mat4x4`||r===`mat2x2f`||r===`mat2x3f`||r===`mat2x4f`||r===`mat3x2f`||r===`mat3x3f`||r===`mat3x4f`||r===`mat4x2f`||r===`mat4x3f`||r===`mat4x4f`||r===`mat2x2h`||r===`mat2x3h`||r===`mat2x4h`||r===`mat3x2h`||r===`mat3x3h`||r===`mat3x4h`||r===`mat4x2h`||r===`mat4x3h`||r===`mat4x4h`?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){let n=t.getVariableValue(e.name);return n===null?n:n.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(t){let n=t[0];if(n.name===`f32`)return n;for(let r=1;r<t.length;++r){let i=e._priority.get(n.name);e._priority.get(t[r].name)<i&&(n=t[r])}return n.name===`x32`?this.getTypeInfo(`i32`):n}_evalUnaryOp(e,t){let n=this.evalExpression(e.right,t);if(e.operator===`&`)return new yt(n);if(e.operator===`*`)return n instanceof yt?n.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);let r=n instanceof W?n.value:n instanceof G?Array.from(n.data):null;switch(e.operator){case`+`:{if(Y(r))return new G(r.map((e,t)=>+e),n.typeInfo);let e=r,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new W(+e,t)}case`-`:{if(Y(r))return new G(r.map((e,t)=>-e),n.typeInfo);let e=r,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new W(-e,t)}case`!`:{if(Y(r))return new G(r.map((e,t)=>e?0:1),n.typeInfo);let e=r,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new W(e?0:1,t)}case`~`:{if(Y(r))return new G(r.map((e,t)=>~e),n.typeInfo);let e=r,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new W(~e,t)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){let n=this.evalExpression(e.left,t),r=this.evalExpression(e.right,t),i=n instanceof W?n.value:n instanceof G||n instanceof K?Array.from(n.data):null,a=r instanceof W?r.value:r instanceof G||r instanceof K?Array.from(r.data):null;switch(e.operator){case`+`:{if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e+r[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t+e),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e+t),r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t+o,s)}case`-`:{if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e-r[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t-e),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e-t),r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t-o,s)}case`*`:{if(Y(i)&&Y(a)){let t=i,o=a;if(n instanceof K&&r instanceof K){let i=function(e,t,n,r){if(Gt[t.name]===void 0||Gt[r.name]===void 0)return null;let i=Gt[t.name][0],a=Gt[t.name][1],o=Gt[r.name][0];if(i!==Gt[r.name][1])return null;let s=Array(o*a);for(let t=0;t<a;t++)for(let r=0;r<o;r++){let c=0;for(let o=0;o<i;o++)c+=e[o*a+t]*n[r*i+o];s[t*o+r]=c}return s}(t,n.typeInfo,o,r.typeInfo);if(i===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;let a=Gt[r.typeInfo.name][0],s=Gt[n.typeInfo.name][1];return new K(i,this.getTypeInfo(`mat${a}x${s}f`))}if(n instanceof K&&r instanceof G){let i=function(e,t,n,r){if(Gt[t.name]===void 0||Wt[r.name]===void 0)return null;let i=Gt[t.name][0],a=Gt[t.name][1];if(i!==n.length)return null;let o=Array(a);for(let t=0;t<a;t++){let r=0;for(let o=0;o<i;o++)r+=e[o*a+t]*n[o];o[t]=r}return o}(t,n.typeInfo,o,r.typeInfo);return i===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new G(i,r.typeInfo)}if(n instanceof G&&r instanceof K){let i=function(e,t,n,r){if(Wt[t.name]===void 0||Gt[r.name]===void 0)return null;let i=Gt[r.name][0],a=Gt[r.name][1];if(a!==e.length)return null;let o=[];for(let t=0;t<i;t++){let r=0;for(let o=0;o<a;o++)r+=e[o]*n[o*i+t];o[t]=r}return o}(t,n.typeInfo,o,r.typeInfo);return i===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new G(i,n.typeInfo)}return t.length===o.length?new G(t.map((e,t)=>e*o[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a,t=i.map((t,n)=>t*e);return n instanceof K?new K(t,n.typeInfo):new G(t,n.typeInfo)}if(Y(a)){let e=i,t=a.map((t,n)=>e*t);return r instanceof K?new K(t,r.typeInfo):new G(t,r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t*o,s)}case`%`:{if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e%r[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t%e),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e%t),r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t%o,s)}case`/`:{if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e/r[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t/e),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e/t),r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t/o,s)}case`&`:{if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e&r[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t&e),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e&t),r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t&o,s)}case`|`:{if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e|r[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t|e),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e|t),r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t|o,s)}case`^`:{if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e^r[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t^e),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e^t),r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t^o,s)}case`<<`:{if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e<<r[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t<<e),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e<<t),r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t<<o,s)}case`>>`:{if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e>>r[t]),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t>>e),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e>>t),r.typeInfo)}let t=i,o=a,s=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new W(t>>o,s)}case`>`:if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e>r[t]?1:0),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t>e?1:0),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e>t?1:0),r.typeInfo)}return new W(i>a?1:0,this.getTypeInfo(`bool`));case`<`:if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e<r[t]?1:0),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t<e?1:0),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e<t?1:0),r.typeInfo)}return new W(i<a?1:0,this.getTypeInfo(`bool`));case`==`:if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e===r[t]?1:0),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t==e?1:0),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e==t?1:0),r.typeInfo)}return new W(i===a?1:0,this.getTypeInfo(`bool`));case`!=`:if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e===r[t]?0:1),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t===e?0:1),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e===t?0:1),r.typeInfo)}return new W(i===a?0:1,this.getTypeInfo(`bool`));case`>=`:if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e>=r[t]?1:0),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t>=e?1:0),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e>=t?1:0),r.typeInfo)}return new W(i>=a?1:0,this.getTypeInfo(`bool`));case`<=`:if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e<=r[t]?1:0),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t<=e?1:0),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e<=t?1:0),r.typeInfo)}return new W(i<=a?1:0,this.getTypeInfo(`bool`));case`&&`:if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e&&r[t]?1:0),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t&&e?1:0),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e&&t?1:0),r.typeInfo)}return new W(i&&a?1:0,this.getTypeInfo(`bool`));case`||`:if(Y(i)&&Y(a)){let t=i,r=a;return t.length===r.length?new G(t.map((e,t)=>e||r[t]?1:0),n.typeInfo):(console.error(`Vector length mismatch. Line ${e.line}.`),null)}if(Y(i)){let e=a;return new G(i.map((t,n)=>t||e?1:0),n.typeInfo)}if(Y(a)){let e=i;return new G(a.map((t,n)=>e||t?1:0),r.typeInfo)}return new W(i||a?1:0,this.getTypeInfo(`bool`))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;let n=t.clone();n.currentFunctionName=e.name;let r=t.getFunction(e.name);if(!r)return e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let t=0;t<r.node.args.length;++t){let i=r.node.args[t],a=this.evalExpression(e.args[t],n);n.createVariable(i.name,a,i)}return this._execStatements(r.node.body,n)}_callBuiltinFunction(e,t){switch(e.name){case`all`:return this.builtins.All(e,t);case`any`:return this.builtins.Any(e,t);case`select`:return this.builtins.Select(e,t);case`arrayLength`:return this.builtins.ArrayLength(e,t);case`abs`:return this.builtins.Abs(e,t);case`acos`:return this.builtins.Acos(e,t);case`acosh`:return this.builtins.Acosh(e,t);case`asin`:return this.builtins.Asin(e,t);case`asinh`:return this.builtins.Asinh(e,t);case`atan`:return this.builtins.Atan(e,t);case`atanh`:return this.builtins.Atanh(e,t);case`atan2`:return this.builtins.Atan2(e,t);case`ceil`:return this.builtins.Ceil(e,t);case`clamp`:return this.builtins.Clamp(e,t);case`cos`:return this.builtins.Cos(e,t);case`cosh`:return this.builtins.Cosh(e,t);case`countLeadingZeros`:return this.builtins.CountLeadingZeros(e,t);case`countOneBits`:return this.builtins.CountOneBits(e,t);case`countTrailingZeros`:return this.builtins.CountTrailingZeros(e,t);case`cross`:return this.builtins.Cross(e,t);case`degrees`:return this.builtins.Degrees(e,t);case`determinant`:return this.builtins.Determinant(e,t);case`distance`:return this.builtins.Distance(e,t);case`dot`:return this.builtins.Dot(e,t);case`dot4U8Packed`:return this.builtins.Dot4U8Packed(e,t);case`dot4I8Packed`:return this.builtins.Dot4I8Packed(e,t);case`exp`:return this.builtins.Exp(e,t);case`exp2`:return this.builtins.Exp2(e,t);case`extractBits`:return this.builtins.ExtractBits(e,t);case`faceForward`:return this.builtins.FaceForward(e,t);case`firstLeadingBit`:return this.builtins.FirstLeadingBit(e,t);case`firstTrailingBit`:return this.builtins.FirstTrailingBit(e,t);case`floor`:return this.builtins.Floor(e,t);case`fma`:return this.builtins.Fma(e,t);case`fract`:return this.builtins.Fract(e,t);case`frexp`:return this.builtins.Frexp(e,t);case`insertBits`:return this.builtins.InsertBits(e,t);case`inverseSqrt`:return this.builtins.InverseSqrt(e,t);case`ldexp`:return this.builtins.Ldexp(e,t);case`length`:return this.builtins.Length(e,t);case`log`:return this.builtins.Log(e,t);case`log2`:return this.builtins.Log2(e,t);case`max`:return this.builtins.Max(e,t);case`min`:return this.builtins.Min(e,t);case`mix`:return this.builtins.Mix(e,t);case`modf`:return this.builtins.Modf(e,t);case`normalize`:return this.builtins.Normalize(e,t);case`pow`:return this.builtins.Pow(e,t);case`quantizeToF16`:return this.builtins.QuantizeToF16(e,t);case`radians`:return this.builtins.Radians(e,t);case`reflect`:return this.builtins.Reflect(e,t);case`refract`:return this.builtins.Refract(e,t);case`reverseBits`:return this.builtins.ReverseBits(e,t);case`round`:return this.builtins.Round(e,t);case`saturate`:return this.builtins.Saturate(e,t);case`sign`:return this.builtins.Sign(e,t);case`sin`:return this.builtins.Sin(e,t);case`sinh`:return this.builtins.Sinh(e,t);case`smoothstep`:return this.builtins.SmoothStep(e,t);case`sqrt`:return this.builtins.Sqrt(e,t);case`step`:return this.builtins.Step(e,t);case`tan`:return this.builtins.Tan(e,t);case`tanh`:return this.builtins.Tanh(e,t);case`transpose`:return this.builtins.Transpose(e,t);case`trunc`:return this.builtins.Trunc(e,t);case`dpdx`:return this.builtins.Dpdx(e,t);case`dpdxCoarse`:return this.builtins.DpdxCoarse(e,t);case`dpdxFine`:return this.builtins.DpdxFine(e,t);case`dpdy`:return this.builtins.Dpdy(e,t);case`dpdyCoarse`:return this.builtins.DpdyCoarse(e,t);case`dpdyFine`:return this.builtins.DpdyFine(e,t);case`fwidth`:return this.builtins.Fwidth(e,t);case`fwidthCoarse`:return this.builtins.FwidthCoarse(e,t);case`fwidthFine`:return this.builtins.FwidthFine(e,t);case`textureDimensions`:return this.builtins.TextureDimensions(e,t);case`textureGather`:return this.builtins.TextureGather(e,t);case`textureGatherCompare`:return this.builtins.TextureGatherCompare(e,t);case`textureLoad`:return this.builtins.TextureLoad(e,t);case`textureNumLayers`:return this.builtins.TextureNumLayers(e,t);case`textureNumLevels`:return this.builtins.TextureNumLevels(e,t);case`textureNumSamples`:return this.builtins.TextureNumSamples(e,t);case`textureSample`:return this.builtins.TextureSample(e,t);case`textureSampleBias`:return this.builtins.TextureSampleBias(e,t);case`textureSampleCompare`:return this.builtins.TextureSampleCompare(e,t);case`textureSampleCompareLevel`:return this.builtins.TextureSampleCompareLevel(e,t);case`textureSampleGrad`:return this.builtins.TextureSampleGrad(e,t);case`textureSampleLevel`:return this.builtins.TextureSampleLevel(e,t);case`textureSampleBaseClampToEdge`:return this.builtins.TextureSampleBaseClampToEdge(e,t);case`textureStore`:return this.builtins.TextureStore(e,t);case`atomicLoad`:return this.builtins.AtomicLoad(e,t);case`atomicStore`:return this.builtins.AtomicStore(e,t);case`atomicAdd`:return this.builtins.AtomicAdd(e,t);case`atomicSub`:return this.builtins.AtomicSub(e,t);case`atomicMax`:return this.builtins.AtomicMax(e,t);case`atomicMin`:return this.builtins.AtomicMin(e,t);case`atomicAnd`:return this.builtins.AtomicAnd(e,t);case`atomicOr`:return this.builtins.AtomicOr(e,t);case`atomicXor`:return this.builtins.AtomicXor(e,t);case`atomicExchange`:return this.builtins.AtomicExchange(e,t);case`atomicCompareExchangeWeak`:return this.builtins.AtomicCompareExchangeWeak(e,t);case`pack4x8snorm`:return this.builtins.Pack4x8snorm(e,t);case`pack4x8unorm`:return this.builtins.Pack4x8unorm(e,t);case`pack4xI8`:return this.builtins.Pack4xI8(e,t);case`pack4xU8`:return this.builtins.Pack4xU8(e,t);case`pack4x8Clamp`:return this.builtins.Pack4x8Clamp(e,t);case`pack4xU8Clamp`:return this.builtins.Pack4xU8Clamp(e,t);case`pack2x16snorm`:return this.builtins.Pack2x16snorm(e,t);case`pack2x16unorm`:return this.builtins.Pack2x16unorm(e,t);case`pack2x16float`:return this.builtins.Pack2x16float(e,t);case`unpack4x8snorm`:return this.builtins.Unpack4x8snorm(e,t);case`unpack4x8unorm`:return this.builtins.Unpack4x8unorm(e,t);case`unpack4xI8`:return this.builtins.Unpack4xI8(e,t);case`unpack4xU8`:return this.builtins.Unpack4xU8(e,t);case`unpack2x16snorm`:return this.builtins.Unpack2x16snorm(e,t);case`unpack2x16unorm`:return this.builtins.Unpack2x16unorm(e,t);case`unpack2x16float`:return this.builtins.Unpack2x16float(e,t);case`storageBarrier`:return this.builtins.StorageBarrier(e,t);case`textureBarrier`:return this.builtins.TextureBarrier(e,t);case`workgroupBarrier`:return this.builtins.WorkgroupBarrier(e,t);case`workgroupUniformLoad`:return this.builtins.WorkgroupUniformLoad(e,t);case`subgroupAdd`:return this.builtins.SubgroupAdd(e,t);case`subgroupExclusiveAdd`:return this.builtins.SubgroupExclusiveAdd(e,t);case`subgroupInclusiveAdd`:return this.builtins.SubgroupInclusiveAdd(e,t);case`subgroupAll`:return this.builtins.SubgroupAll(e,t);case`subgroupAnd`:return this.builtins.SubgroupAnd(e,t);case`subgroupAny`:return this.builtins.SubgroupAny(e,t);case`subgroupBallot`:return this.builtins.SubgroupBallot(e,t);case`subgroupBroadcast`:return this.builtins.SubgroupBroadcast(e,t);case`subgroupBroadcastFirst`:return this.builtins.SubgroupBroadcastFirst(e,t);case`subgroupElect`:return this.builtins.SubgroupElect(e,t);case`subgroupMax`:return this.builtins.SubgroupMax(e,t);case`subgroupMin`:return this.builtins.SubgroupMin(e,t);case`subgroupMul`:return this.builtins.SubgroupMul(e,t);case`subgroupExclusiveMul`:return this.builtins.SubgroupExclusiveMul(e,t);case`subgroupInclusiveMul`:return this.builtins.SubgroupInclusiveMul(e,t);case`subgroupOr`:return this.builtins.SubgroupOr(e,t);case`subgroupShuffle`:return this.builtins.SubgroupShuffle(e,t);case`subgroupShuffleDown`:return this.builtins.SubgroupShuffleDown(e,t);case`subgroupShuffleUp`:return this.builtins.SubgroupShuffleUp(e,t);case`subgroupShuffleXor`:return this.builtins.SubgroupShuffleXor(e,t);case`subgroupXor`:return this.builtins.SubgroupXor(e,t);case`quadBroadcast`:return this.builtins.QuadBroadcast(e,t);case`quadSwapDiagonal`:return this.builtins.QuadSwapDiagonal(e,t);case`quadSwapX`:return this.builtins.QuadSwapX(e,t);case`quadSwapY`:return this.builtins.QuadSwapY(e,t)}let n=t.getFunction(e.name);if(n){let r=t.clone();for(let t=0;t<n.node.args.length;++t){let i=n.node.args[t],a=this.evalExpression(e.args[t],r);r.setVariable(i.name,a,i)}return this._execStatements(n.node.body,r)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new W(0,this.getTypeInfo(e.type));let n=this.evalExpression(e.args[0],t);return n.typeInfo=this.getTypeInfo(e.type),n.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){let n=this.getTypeInfo(e.type),r=e.type.getTypeName(),i=Wt[r];if(i===void 0)return console.error(`Invalid vec constructor ${r}. Line ${e.line}`),null;let a=[];if(e instanceof rt)if(e.isVector){let t=e.vectorValue;for(let e of t)a.push(e)}else a.push(e.scalarValue);else if(e.args)for(let n of e.args){let e=this.evalExpression(n,t);if(e instanceof G){let t=e.data;for(let e=0;e<t.length;++e){let n=t[e];a.push(n)}}else if(e instanceof W){let t=e.value;a.push(t)}}if(e.type instanceof U&&e.type.format===null&&(e.type.format=U.f32),a.length===0)return new G(Array(i).fill(0),n).getSubData(this,e.postfix,t);if(a.length===1)for(;a.length<i;)a.push(a[0]);return a.length<i?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new G(a.length>i?a.slice(0,i):a,n).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){let n=this.getTypeInfo(e.type),r=e.type.getTypeName(),i=Gt[r];if(i===void 0)return console.error(`Invalid matrix constructor ${r}. Line ${e.line}`),null;let a=[];if(e instanceof rt)if(e.isVector){let t=e.vectorValue;for(let e of t)a.push(e)}else a.push(e.scalarValue);else if(e.args)for(let n of e.args){let e=this.evalExpression(n,t);e instanceof G?a.push(...e.data):e instanceof W?a.push(e.value):e instanceof K&&a.push(...e.data)}return n instanceof N&&n.format===null&&(n.format=this.getTypeInfo(`f32`)),a.length===0?new K(Array(i[2]).fill(0),n).getSubData(this,e.postfix,t):a.length===i[2]?new K(a,n).getSubData(this,e.postfix,t):(console.error(`Invalid matrix constructor. Line ${e.line}`),null)}};Kt._breakObj=new _t(new O(`BREAK`,null),null),Kt._continueObj=new _t(new O(`CONTINUE`,null),null),Kt._priority=new Map([[`f32`,0],[`f16`,1],[`u32`,2],[`i32`,3],[`x32`,3]]);var qt=class{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}},Jt=class{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new qt,this._exec=new Kt,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;let t=[];for(;!this._isAtEnd();){let e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(let e of this._deferArrayCountEval){let t=e.arrayType,n=e.countNode;if(n instanceof tt){let e=n.name,r=this._context.constants.get(e);if(r)try{t.count=r.constEvaluate(this._exec)}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(let e of t)e.search(e=>{e instanceof ht||e instanceof Je?e.type=this._forwardType(e.type):e instanceof Ye?e.format=this._forwardType(e.format):e instanceof Ee||e instanceof Oe||e instanceof ke?e.type=this._forwardType(e.type):e instanceof xe?e.returnType=this._forwardType(e.returnType):e instanceof pt&&(e.type=this._forwardType(e.type))});return t}_forwardType(e){if(e instanceof Ke){let t=this._getType(e.name);if(t)return t}else e instanceof Je?e.type=this._forwardType(e.type):e instanceof Ye&&(e.format=this._forwardType(e.format));return e}_initialize(e){e?typeof e==`string`?this._tokens=new wt(e).scanTokens():this._tokens=e:this._tokens=[],this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==J.eof}_match(e){if(e instanceof q)return!!this._check(e)&&(this._advance(),!0);for(let t=0,n=e.length;t<n;++t){let n=e[t];if(this._check(n))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;let t=this._peek();if(e instanceof Array){let n=t.type,r=!1;for(let t of e){if(n===t)return!0;t===J.tokens.name&&(r=!0)}if(r){let e=J.tokens.name.rule.exec(t.lexeme);if(e&&e.index==0&&e[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===J.tokens.name){let e=J.tokens.name.rule.exec(t.lexeme);return e&&e.index==0&&e[0]==t.lexeme}return!1}_advance(){return this._currentLine=this._peek()?.line??-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(J.tokens.semicolon)&&!this._isAtEnd(););if(this._match(J.keywords.alias)){let e=this._type_alias();return this._consume(J.tokens.semicolon,`Expected ';'`),this._exec.reflection.updateAST([e]),e}if(this._match(J.keywords.diagnostic)){let e=this._diagnostic();return this._consume(J.tokens.semicolon,`Expected ';'`),this._exec.reflection.updateAST([e]),e}if(this._match(J.keywords.requires)){let e=this._requires_directive();return this._consume(J.tokens.semicolon,`Expected ';'`),this._exec.reflection.updateAST([e]),e}if(this._match(J.keywords.enable)){let e=this._enable_directive();return this._consume(J.tokens.semicolon,`Expected ';'`),this._exec.reflection.updateAST([e]),e}let e=this._attribute();if(this._check(J.keywords.var)){let t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(J.tokens.semicolon,`Expected ';'.`),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.override)){let t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(J.tokens.semicolon,`Expected ';'.`),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.let)){let t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(J.tokens.semicolon,`Expected ';'.`),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.const)){let t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(J.tokens.semicolon,`Expected ';'.`),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.struct)){let t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.fn)){let t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(J.keywords.fn))return null;let e=this._currentLine,t=this._consume(J.tokens.ident,`Expected function name.`).toString();this._consume(J.tokens.paren_left,`Expected '(' for function arguments.`);let n=[];if(!this._check(J.tokens.paren_right))do{if(this._check(J.tokens.paren_right))break;let e=this._attribute(),t=this._consume(J.tokens.name,`Expected argument name.`).toString();this._consume(J.tokens.colon,`Expected ':' for argument type.`);let r=this._attribute(),i=this._type_decl();i!=null&&(i.attributes=r,n.push(this._updateNode(new pt(t,i,e))))}while(this._match(J.tokens.comma));this._consume(J.tokens.paren_right,`Expected ')' after function arguments.`);let r=null;if(this._match(J.tokens.arrow)){let e=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=e)}let i=this._compound_statement(),a=this._currentLine;return this._updateNode(new xe(t,n,r,i,e,a),e)}_compound_statement(){let e=[];for(this._consume(J.tokens.brace_left,`Expected '{' for block.`);!this._check(J.tokens.brace_right);){let t=this._statement();t!==null&&e.push(t)}return this._consume(J.tokens.brace_right,`Expected '}' for block.`),e}_statement(){for(;this._match(J.tokens.semicolon)&&!this._isAtEnd(););if(this._check(J.tokens.attr)&&this._attribute(),this._check(J.keywords.if))return this._if_statement();if(this._check(J.keywords.switch))return this._switch_statement();if(this._check(J.keywords.loop))return this._loop_statement();if(this._check(J.keywords.for))return this._for_statement();if(this._check(J.keywords.while))return this._while_statement();if(this._check(J.keywords.continuing))return this._continuing_statement();if(this._check(J.keywords.static_assert))return this._static_assert_statement();if(this._check(J.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(J.keywords.return))e=this._return_statement();else if(this._check([J.keywords.var,J.keywords.let,J.keywords.const]))e=this._variable_statement();else if(this._match(J.keywords.discard))e=this._updateNode(new Ue);else if(this._match(J.keywords.break)){let t=this._updateNode(new We);this._currentLoop.length>0&&(t.loopId=this._currentLoop[this._currentLoop.length-1].id),e=t,this._check(J.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(J.keywords.continue)){let t=this._updateNode(new Ge);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);t.loopId=this._currentLoop[this._currentLoop.length-1].id,e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(J.tokens.semicolon,`Expected ';' after statement.`),e}_static_assert_statement(){if(!this._match(J.keywords.static_assert))return null;let e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new Se(t),e)}_while_statement(){if(!this._match(J.keywords.while))return null;let e=this._updateNode(new Ce(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(J.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){let e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(J.keywords.continuing))return null;let t=this._currentLine,n=this._compound_statement();return this._updateNode(new we(n,e),t)}_for_statement(){if(!this._match(J.keywords.for))return null;this._consume(J.tokens.paren_left,`Expected '('.`);let e=this._updateNode(new Te(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(J.tokens.semicolon)?null:this._for_init(),this._consume(J.tokens.semicolon,`Expected ';'.`),e.condition=this._check(J.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(J.tokens.semicolon,`Expected ';'.`),e.increment=this._check(J.tokens.paren_right)?null:this._for_increment(),this._consume(J.tokens.paren_right,`Expected ')'.`),this._check(J.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(J.keywords.var)){let e=this._variable_decl();if(e===null)throw this._error(this._peek(),`Variable declaration expected.`);let t=null;return this._match(J.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new Ee(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(J.keywords.let)){let e=this._currentLine,t=this._consume(J.tokens.name,`Expected name for let.`).toString(),n=null;if(this._match(J.tokens.colon)){let e=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=e)}this._consume(J.tokens.equal,`Expected '=' for let.`);let r=this._short_circuit_or_expression();return this._updateNode(new Oe(t,n,null,null,r),e)}if(this._match(J.keywords.const)){let e=this._currentLine,t=this._consume(J.tokens.name,`Expected name for const.`).toString(),n=null;if(this._match(J.tokens.colon)){let e=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=e)}this._consume(J.tokens.equal,`Expected '=' for const.`);let r=this._short_circuit_or_expression();return n===null&&r instanceof rt&&(n=r.type),this._updateNode(new ke(t,n,null,null,r),e)}return null}_increment_decrement_statement(){let e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(J.increment_operators))return this._current=e,null;let n=this._consume(J.increment_operators,`Expected increment operator`);return this._updateNode(new Me(n.type===J.tokens.plus_plus?Ae.increment:Ae.decrement,t))}_assignment_statement(){let e=null,t=this._currentLine;if(this._check(J.tokens.brace_right))return null;let n=this._match(J.tokens.underscore);if(n||(e=this._unary_expression()),!n&&e==null)return null;let r=this._consume(J.assignment_operators,`Expected assignment operator.`),i=this._short_circuit_or_expression();return this._updateNode(new Ne(je.parse(r.lexeme),e,i),t)}_func_call_statement(){if(!this._check(J.tokens.ident))return null;let e=this._currentLine,t=this._current,n=this._consume(J.tokens.ident,`Expected function name.`),r=this._argument_expression_list();return r===null?(this._current=t,null):this._updateNode(new Pe(n.lexeme,r),e)}_loop_statement(){if(!this._match(J.keywords.loop))return null;this._check(J.tokens.attr)&&this._attribute(),this._consume(J.tokens.brace_left,`Expected '{' for loop.`);let e=this._updateNode(new Fe([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let n of t)e.body.push(n);else e.body.push(t);if(t instanceof we){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(J.tokens.brace_right,`Expected '}' for loop.`),e}_switch_statement(){if(!this._match(J.keywords.switch))return null;let e=this._updateNode(new Ie(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(J.tokens.attr)&&this._attribute(),this._consume(J.tokens.brace_left,`Expected '{' for switch.`),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),`Expected 'case' or 'default'.`);return this._consume(J.tokens.brace_right,`Expected '}' for switch.`),this._currentLoop.pop(),e}_switch_body(){let e=[],t=!1;for(;this._check([J.keywords.default,J.keywords.case]);){if(this._match(J.keywords.case)){let n=this._case_selectors();for(let e of n)if(e instanceof ut){if(t)throw this._error(this._previous(),`Multiple default cases in switch statement.`);t=!0;break}this._match(J.tokens.colon),this._check(J.tokens.attr)&&this._attribute(),this._consume(J.tokens.brace_left,`Exected '{' for switch case.`);let r=this._case_body();this._consume(J.tokens.brace_right,`Exected '}' for switch case.`),e.push(this._updateNode(new dt(n,r)))}if(this._match(J.keywords.default)){if(t)throw this._error(this._previous(),`Multiple default cases in switch statement.`);this._match(J.tokens.colon),this._check(J.tokens.attr)&&this._attribute(),this._consume(J.tokens.brace_left,`Exected '{' for switch default.`);let n=this._case_body();this._consume(J.tokens.brace_right,`Exected '}' for switch default.`),e.push(this._updateNode(new ft(n)))}}return e}_case_selectors(){let e=[];for(this._match(J.keywords.default)?e.push(this._updateNode(new ut)):e.push(this._shift_expression());this._match(J.tokens.comma);)this._match(J.keywords.default)?e.push(this._updateNode(new ut)):e.push(this._shift_expression());return e}_case_body(){if(this._match(J.keywords.fallthrough))return this._consume(J.tokens.semicolon,`Expected ';'`),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);let t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(J.keywords.if))return null;let e=this._currentLine,t=this._optional_paren_expression();this._check(J.tokens.attr)&&this._attribute();let n=this._compound_statement(),r=[];this._match_elseif()&&(this._check(J.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let i=null;return this._match(J.keywords.else)&&(this._check(J.tokens.attr)&&this._attribute(),i=this._compound_statement()),this._updateNode(new Le(t,n,r,i),e)}_match_elseif(){return this._tokens[this._current].type===J.keywords.else&&this._tokens[this._current+1].type===J.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){let t=this._optional_paren_expression(),n=this._compound_statement();return e.push(this._updateNode(new mt(t,n))),this._match_elseif()&&(this._check(J.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(J.keywords.return))return null;let e=this._short_circuit_or_expression();return this._updateNode(new Re(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(J.tokens.or_or);)e=this._updateNode(new ct(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(J.tokens.and_and);)e=this._updateNode(new ct(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(J.tokens.or);)e=this._updateNode(new ct(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(J.tokens.xor);)e=this._updateNode(new ct(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(J.tokens.and);)e=this._updateNode(new ct(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){let e=this._relational_expression();return this._match([J.tokens.equal_equal,J.tokens.not_equal])?this._updateNode(new ct(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([J.tokens.less_than,J.tokens.greater_than,J.tokens.less_than_equal,J.tokens.greater_than_equal]);)e=this._updateNode(new ct(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([J.tokens.shift_left,J.tokens.shift_right]);)e=this._updateNode(new ct(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([J.tokens.plus,J.tokens.minus]);)e=this._updateNode(new ct(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([J.tokens.star,J.tokens.forward_slash,J.tokens.modulo]);)e=this._updateNode(new ct(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([J.tokens.minus,J.tokens.bang,J.tokens.tilde,J.tokens.star,J.tokens.and])?this._updateNode(new st(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){let e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(J.tokens.bracket_left)){let e=this._short_circuit_or_expression();this._consume(J.tokens.bracket_right,`Expected ']'.`);let t=this._updateNode(new at(e)),n=this._postfix_expression();return n&&(t.postfix=n),t}if(this._match(J.tokens.period)){let e=this._consume(J.tokens.name,`Expected member name.`),t=this._postfix_expression(),n=this._updateNode(new Qe(e.lexeme));return t&&(n.postfix=t),n}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){let t=this._getStruct(e);if(t!==null)return t;switch(e){case`void`:return H.void;case`bool`:return H.bool;case`i32`:return H.i32;case`u32`:return H.u32;case`f32`:return H.f32;case`f16`:return H.f16;case`vec2f`:return U.vec2f;case`vec3f`:return U.vec3f;case`vec4f`:return U.vec4f;case`vec2i`:return U.vec2i;case`vec3i`:return U.vec3i;case`vec4i`:return U.vec4i;case`vec2u`:return U.vec2u;case`vec3u`:return U.vec3u;case`vec4u`:return U.vec4u;case`vec2h`:return U.vec2h;case`vec3h`:return U.vec3h;case`vec4h`:return U.vec4h;case`mat2x2f`:return U.mat2x2f;case`mat2x3f`:return U.mat2x3f;case`mat2x4f`:return U.mat2x4f;case`mat3x2f`:return U.mat3x2f;case`mat3x3f`:return U.mat3x3f;case`mat3x4f`:return U.mat3x4f;case`mat4x2f`:return U.mat4x2f;case`mat4x3f`:return U.mat4x3f;case`mat4x4f`:return U.mat4x4f;case`mat2x2h`:return U.mat2x2h;case`mat2x3h`:return U.mat2x3h;case`mat2x4h`:return U.mat2x4h;case`mat3x2h`:return U.mat3x2h;case`mat3x3h`:return U.mat3x3h;case`mat3x4h`:return U.mat3x4h;case`mat4x2h`:return U.mat4x2h;case`mat4x3h`:return U.mat4x3h;case`mat4x4h`:return U.mat4x4h;case`mat2x2i`:return U.mat2x2i;case`mat2x3i`:return U.mat2x3i;case`mat2x4i`:return U.mat2x4i;case`mat3x2i`:return U.mat3x2i;case`mat3x3i`:return U.mat3x3i;case`mat3x4i`:return U.mat3x4i;case`mat4x2i`:return U.mat4x2i;case`mat4x3i`:return U.mat4x3i;case`mat4x4i`:return U.mat4x4i;case`mat2x2u`:return U.mat2x2u;case`mat2x3u`:return U.mat2x3u;case`mat2x4u`:return U.mat2x4u;case`mat3x2u`:return U.mat3x2u;case`mat3x3u`:return U.mat3x3u;case`mat3x4u`:return U.mat3x4u;case`mat4x2u`:return U.mat4x2u;case`mat4x3u`:return U.mat4x3u;case`mat4x4u`:return U.mat4x4u}return null}_validateTypeRange(e,t){if(t.name===`i32`){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name===`u32`&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(J.tokens.ident)){let e=this._previous().toString();if(this._check(J.tokens.paren_left)){let t=this._argument_expression_list(),n=this._getType(e);return n===null?this._updateNode(new et(e,t)):this._updateNode(new $e(n,t))}if(this._context.constants.has(e)){let t=this._context.constants.get(e);return this._updateNode(new nt(e,t.value))}return this._updateNode(new tt(e))}if(this._match(J.tokens.int_literal)){let e=this._previous().toString(),t=e.endsWith(`i`)||e.endsWith(`i`)?H.i32:e.endsWith(`u`)||e.endsWith(`U`)?H.u32:H.x32,n=parseInt(e);return this._validateTypeRange(n,t),this._updateNode(new rt(new W(n,this._exec.getTypeInfo(t)),t))}if(this._match(J.tokens.uint_literal)){let e=parseInt(this._previous().toString());return this._validateTypeRange(e,H.u32),this._updateNode(new rt(new W(e,this._exec.getTypeInfo(H.u32)),H.u32))}if(this._match([J.tokens.decimal_float_literal,J.tokens.hex_float_literal])){let e=this._previous().toString(),t=e.endsWith(`h`);t&&(e=e.substring(0,e.length-1));let n=parseFloat(e);this._validateTypeRange(n,t?H.f16:H.f32);let r=t?H.f16:H.f32;return this._updateNode(new rt(new W(n,this._exec.getTypeInfo(r)),r))}if(this._match([J.keywords.true,J.keywords.false])){let e=this._previous().toString()===J.keywords.true.rule;return this._updateNode(new rt(new W(e?1:0,this._exec.getTypeInfo(H.bool)),H.bool))}if(this._check(J.tokens.paren_left))return this._paren_expression();if(this._match(J.keywords.bitcast)){this._consume(J.tokens.less_than,`Expected '<'.`);let e=this._type_decl();this._consume(J.tokens.greater_than,`Expected '>'.`);let t=this._paren_expression();return this._updateNode(new it(e,t))}let e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new $e(e,t))}_argument_expression_list(){if(!this._match(J.tokens.paren_left))return null;let e=[];do{if(this._check(J.tokens.paren_right))break;let t=this._short_circuit_or_expression();e.push(t)}while(this._match(J.tokens.comma));return this._consume(J.tokens.paren_right,`Expected ')' for agument list`),e}_optional_paren_expression(){this._match(J.tokens.paren_left);let e=this._short_circuit_or_expression();return this._match(J.tokens.paren_right),e}_paren_expression(){this._consume(J.tokens.paren_left,`Expected '('.`);let e=this._short_circuit_or_expression();return this._consume(J.tokens.paren_right,`Expected ')'.`),e}_struct_decl(){if(!this._match(J.keywords.struct))return null;let e=this._currentLine,t=this._consume(J.tokens.ident,`Expected name for struct.`).toString();this._consume(J.tokens.brace_left,`Expected '{' for struct body.`);let n=[];for(;!this._check(J.tokens.brace_right);){let e=this._attribute(),t=this._consume(J.tokens.name,`Expected variable name.`).toString();this._consume(J.tokens.colon,`Expected ':' for struct member type.`);let r=this._attribute(),i=this._type_decl();i!=null&&(i.attributes=r),this._check(J.tokens.brace_right)?this._match(J.tokens.comma):this._consume(J.tokens.comma,`Expected ',' for struct member.`),n.push(this._updateNode(new ht(t,i,e)))}this._consume(J.tokens.brace_right,`Expected '}' after struct body.`);let r=this._currentLine,i=this._updateNode(new qe(t,n,e,r),e);return this._context.structs.set(t,i),i}_global_variable_decl(){let e=this._variable_decl();if(!e)return null;if(this._match(J.tokens.equal)&&(e.value=this._const_expression()),e.type!==null&&e.value instanceof rt){if(e.value.type.name!==`x32`&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof rt&&(e.type=e.value.type.name===`x32`?H.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){let e=this._override_decl();return e&&this._match(J.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(J.keywords.const))return null;let e=this._consume(J.tokens.name,`Expected variable name`),t=this._currentLine,n=null;if(this._match(J.tokens.colon)){let e=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=e)}let r=null;this._consume(J.tokens.equal,`const declarations require an assignment`);let i=this._short_circuit_or_expression();try{let t=[H.f32],n=i.constEvaluate(this._exec,t);n instanceof W&&this._validateTypeRange(n.value,t[0]),t[0]instanceof U&&t[0].format===null&&n.typeInfo instanceof N&&n.typeInfo.format!==null&&(n.typeInfo.format.name===`f16`?t[0].format=H.f16:n.typeInfo.format.name===`f32`?t[0].format=H.f32:n.typeInfo.format.name===`i32`?t[0].format=H.i32:n.typeInfo.format.name===`u32`?t[0].format=H.u32:n.typeInfo.format.name===`bool`?t[0].format=H.bool:console.error(`TODO: impelement template format type ${n.typeInfo.format.name}`)),r=this._updateNode(new rt(n,t[0])),this._exec.context.setVariable(e.toString(),n)}catch{r=i}if(n!==null&&r instanceof rt){if(r.type.name!==`x32`&&n.getTypeName()!==r.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${n.name}. Line:${this._currentLine}`);r.type=n,r.isScalar&&this._validateTypeRange(r.scalarValue,r.type)}else n===null&&r instanceof rt&&(n=r?.type??H.f32,n===H.x32&&(n=H.i32));let a=this._updateNode(new ke(e.toString(),n,``,``,r),t);return this._context.constants.set(a.name,a),a}_global_let_decl(){if(!this._match(J.keywords.let))return null;let e=this._currentLine,t=this._consume(J.tokens.name,`Expected variable name`),n=null;if(this._match(J.tokens.colon)){let e=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=e)}let r=null;if(this._match(J.tokens.equal)&&(r=this._const_expression()),n!==null&&r instanceof rt){if(r.type.name!==`x32`&&n.getTypeName()!==r.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${n.name}. Line:${this._currentLine}`);r.type=n}else n===null&&r instanceof rt&&(n=r.type.name===`x32`?H.i32:r.type);return r instanceof rt&&r.isScalar&&this._validateTypeRange(r.scalarValue,n),this._updateNode(new Oe(t.toString(),n,``,``,r),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(J.keywords.var))return null;let e=this._currentLine,t=``,n=``;this._match(J.tokens.less_than)&&(t=this._consume(J.storage_class,`Expected storage_class.`).toString(),this._match(J.tokens.comma)&&(n=this._consume(J.access_mode,`Expected access_mode.`).toString()),this._consume(J.tokens.greater_than,`Expected '>'.`));let r=this._consume(J.tokens.name,`Expected variable name`),i=null;if(this._match(J.tokens.colon)){let e=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=e)}return this._updateNode(new Ee(r.toString(),i,t,n,null),e)}_override_decl(){if(!this._match(J.keywords.override))return null;let e=this._consume(J.tokens.name,`Expected variable name`),t=null;if(this._match(J.tokens.colon)){let e=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=e)}return this._updateNode(new De(e.toString(),t,null))}_diagnostic(){this._consume(J.tokens.paren_left,`Expected '('`);let e=this._consume(J.tokens.ident,`Expected severity control name.`);this._consume(J.tokens.comma,`Expected ','`);let t=this._consume(J.tokens.ident,`Expected diagnostic rule name.`).toString();return this._match(J.tokens.period)&&(t+=`.${this._consume(J.tokens.ident,`Expected diagnostic message.`).toString()}`),this._consume(J.tokens.paren_right,`Expected ')'`),this._updateNode(new Ve(e.toString(),t))}_enable_directive(){let e=this._consume(J.tokens.ident,`identity expected.`);return this._updateNode(new ze(e.toString()))}_requires_directive(){let e=[this._consume(J.tokens.ident,`identity expected.`).toString()];for(;this._match(J.tokens.comma);){let t=this._consume(J.tokens.ident,`identity expected.`);e.push(t.toString())}return this._updateNode(new Be(e))}_type_alias(){let e=this._consume(J.tokens.ident,`identity expected.`);this._consume(J.tokens.equal,`Expected '=' for type alias.`);let t=this._type_decl();if(t===null)throw this._error(this._peek(),`Expected Type for Alias.`);this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);let n=this._updateNode(new He(e.toString(),t));return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([J.tokens.ident,...J.texel_format,J.keywords.bool,J.keywords.f32,J.keywords.i32,J.keywords.u32])){let e=this._advance().toString();if(this._context.structs.has(e))return this._context.structs.get(e);if(this._context.aliases.has(e))return this._context.aliases.get(e).type;if(!this._getType(e)){let t=this._updateNode(new Ke(e));return this._forwardTypeCount++,t}return this._updateNode(new H(e))}let e=this._texture_sampler_types();if(e)return e;if(this._check(J.template_types)){let e=this._advance().toString(),t=null,n=null;return this._match(J.tokens.less_than)&&(t=this._type_decl(),n=null,this._match(J.tokens.comma)&&(n=this._consume(J.access_mode,`Expected access_mode for pointer`).toString()),this._consume(J.tokens.greater_than,`Expected '>' for type.`)),this._updateNode(new U(e,t,n))}if(this._match(J.keywords.ptr)){let e=this._previous().toString();this._consume(J.tokens.less_than,`Expected '<' for pointer.`);let t=this._consume(J.storage_class,`Expected storage_class for pointer`);this._consume(J.tokens.comma,`Expected ',' for pointer.`);let n=this._type_decl(),r=null;return this._match(J.tokens.comma)&&(r=this._consume(J.access_mode,`Expected access_mode for pointer`).toString()),this._consume(J.tokens.greater_than,`Expected '>' for pointer.`),this._updateNode(new Je(e,t.toString(),n,r))}let t=this._attribute();if(this._match(J.keywords.array)){let e=null,n=-1,r=this._previous(),i=null;if(this._match(J.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t=``;if(this._match(J.tokens.comma)){i=this._shift_expression();try{t=i.constEvaluate(this._exec).toString(),i=null}catch{t=`1`}}this._consume(J.tokens.greater_than,`Expected '>' for array.`),n=t?parseInt(t):0}let a=this._updateNode(new Ye(r.toString(),t,e,n));return i&&this._deferArrayCountEval.push({arrayType:a,countNode:i}),a}return null}_texture_sampler_types(){if(this._match(J.sampler_type)||this._match(J.depth_texture_type))return this._updateNode(new Xe(this._previous().toString(),null,null));if(this._match(J.sampled_texture_type)||this._match(J.multisampled_texture_type)){let e=this._previous();this._consume(J.tokens.less_than,`Expected '<' for sampler type.`);let t=this._type_decl();return this._consume(J.tokens.greater_than,`Expected '>' for sampler type.`),this._updateNode(new Xe(e.toString(),t,null))}if(this._match(J.storage_texture_type)){let e=this._previous();this._consume(J.tokens.less_than,`Expected '<' for sampler type.`);let t=this._consume(J.texel_format,`Invalid texel format.`).toString();this._consume(J.tokens.comma,`Expected ',' after texel format.`);let n=this._consume(J.access_mode,`Expected access mode for storage texture type.`).toString();return this._consume(J.tokens.greater_than,`Expected '>' for sampler type.`),this._updateNode(new Xe(e.toString(),t,n))}return null}_attribute(){let e=[];for(;this._match(J.tokens.attr);){let t=this._consume(J.attribute_name,`Expected attribute name`),n=this._updateNode(new gt(t.toString(),null));if(this._match(J.tokens.paren_left)){if(n.value=this._consume(J.literal_or_ident,`Expected attribute value`).toString(),this._check(J.tokens.comma)){this._advance();do{let e=this._consume(J.literal_or_ident,`Expected attribute value`).toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(e)}while(this._match(J.tokens.comma))}this._consume(J.tokens.paren_right,`Expected ')'`)}e.push(n)}return e.length==0?null:e}},Yt=class extends Lt{constructor(e){super(),e&&this.update(e)}update(e){let t=new Jt().parse(e);this.updateAST(t)}},Xt=class{#e;Active;Index=0;#t;Device;BindGroups=[];Reflect;GPUPipeline;constructor(e,t,n){this.#e=n,this.#t=t,this.Active=!0,this.Device=e}CreatePipelineLabel(e){return this.#e&&e&&`${this.#e} ${e}`||``}CreatePipelineLayout(e,t){return t??=this.CreatePipelineLabel(`${this.#t} Pipeline Layout`),e=$(e),this.Device.createPipelineLayout({label:t,bindGroupLayouts:e})}CreateShaderModule(e,t,n,r){e||(e=b,m(u.SHADER_CODE_NOT_FOUND)),t??=this.CreatePipelineLabel(`Shader Module`);let i=Array.isArray(e)&&e.join(`

`)||e;return this.Reflect=new Yt(i),this.Device.createShaderModule({label:t,code:i,sourceMap:n,compilationHints:r})}#n(e,t,n=0,r=[]){let{format:i}=e.type,a=e.type.members??i?.members,o=n+(e.offset??0);if(a)for(let n=0,s={},c=i?.isStruct&&e.count||1;n<c;++n)a.forEach(e=>s[e.name]=this.#n(e,t,o)),i?.isStruct&&(o+=e.stride),r.push(s);else{let n=Qn((i??e.type).name),r=e.size/$n(n);return new(er(n))(t,o,r)}return r.length===1&&r[0]||r}CreateBuffer(e){let t=e.label??this.CreatePipelineLabel(`Buffer`);return ir(this.Device,{label:t,...e})}CreateReadableBuffer(e){let t=typeof e==`number`,n=sr.READABLE|(!t&&e.usage||0),r=t&&e;r||=e.size;let i=e?.label??`Readable Buffer`;return this.CreateBuffer({label:i,size:r,...e,usage:n})}CreateWritableBuffer(e){let t=typeof e==`number`,n=sr.WRITABLE|(!t&&e.usage||0),r=t&&e;r||=e.size;let i=e?.label??`Writable Buffer`;return this.CreateBuffer({label:i,size:r,...e,usage:n})}CreateUniformBuffer(e,t){!this.Reflect&&p(u.SHADER_MODULE_NOT_FOUND,`\`${this.#t}Pipeline.CreateUniformBuffer\`.
            Use \`${this.#t}Pipeline.CreateShaderModule\` before creating a uniform buffer.`);let n=this.Reflect.uniforms.find(({name:t})=>e===t);!n&&p(u.UNIFORM_NOT_FOUND,`\`${e}\` in shader uniforms.`),e===`resolution`&&m(u.INVALID_UNIFORM_NAME,`\`${e}\`.`);let r=t?.label??`${e} Uniform Buffer`,i=new ArrayBuffer(n.size),a=sr.UNIFORM|t?.usage;return{buffer:this.CreateBuffer({label:r,size:i.byteLength,...t,usage:a}),[e]:this.#n(n,i)}}CreateStorageBuffer(e,t=1){!this.Reflect&&p(u.SHADER_MODULE_NOT_FOUND,`\`${this.#t}Pipeline.CreateStorageBuffer\`.
            Use \`${this.#t}Pipeline.CreateShaderModule\` before creating a storage buffer.`);let n=this.Reflect.storage.find(({name:t})=>e===t);!n&&p(u.STORAGE_NOT_FOUND,`\`${e}\` in shader bindings.`);let r=typeof t==`number`,i=r&&t||t.length,a=sr.STORAGE|(!r&&t.usage||0),o=!r&&t.label||`${e} Storage Buffer`,s=t.size??n.format.size*i,c=new ArrayBuffer(s),l=e=>(Object.keys(e).forEach(t=>{if(!(e[t].buffer instanceof ArrayBuffer))l(e[t]);else{let n=e[t].constructor;e[t]=new n(c,0,s/n.BYTES_PER_ELEMENT)}}),e),d=this.#n(n,c);return{buffer:this.CreateBuffer({label:o,size:s,...t,usage:a}),[e]:d.buffer instanceof ArrayBuffer?new d.constructor(c,0,i):l(d)}}WriteBuffer(e,t,n=0,r,i){ar(this.Device.queue,...arguments)}GetBufferMinBindingSize(e){return!this.Reflect&&p(u.SHADER_MODULE_NOT_FOUND,`\`${this.#t}Pipeline.GetBufferMinBindingSize\`.
            Use \`${this.#t}Pipeline.CreateShaderModule\` before requesting buffer's min binding size.`),this.Reflect.getBindGroups().flat().find(({name:t})=>e===t)?.size??p(u.BINDING_NOT_FOUND,`\`${e}\` in shader bind groups.`)}SetBindGroupFromResources(e,t=0,n=0,r,i){return this.SetBindGroups(this.CreateBindGroup(this.CreateBindGroupEntries(e,t),n,r),i)}AddBindGroupFromResources(e,t=0,n=0,r,i){return this.AddBindGroups(this.CreateBindGroup(this.CreateBindGroupEntries(e,t),n,r),i)}CreateBindGroupEntries(e,t=0){return Array.isArray(e)&&e.map((e,n)=>({binding:t?.[n]??n,resource:e}))||[{binding:t,resource:e}]}CreateBindGroupLayout(e,t){return t??=this.CreatePipelineLabel(`Bind Group Layout`),e=Array.isArray(e)&&e.map((e,t)=>({...e,binding:e.binding??t}))||[{...e,binding:e.binding??0}],this.Device.createBindGroupLayout({entries:e,label:t})}CreateBindGroup(e,t=0,n){return n??=this.CreatePipelineLabel(`Bind Group`),typeof t==`number`&&(t=this.GPUPipeline?this.GPUPipeline.getBindGroupLayout(t):p(u.PIPELINE_NOT_FOUND,`${this.#t}Pipeline.
                    Use \`${this.#t}Stage.AddPipeline\` before creating a bind group.`)),this.Device.createBindGroup({entries:e,label:n,layout:t})}SetBindGroups(e,t){let n=Array.isArray(e),r=Array.isArray(t);return t=n&&r?t.map(e=>$(e)):r&&t||t&&[t],t=t&&t||[],this.BindGroups=n&&e.map((e,n)=>({bindGroup:e,dynamicOffsets:t,active:!0}))||[{bindGroup:e,dynamicOffsets:t,active:!0}]}AddBindGroups(e,t){let n=Array.isArray(e),r=Array.isArray(t);return t=n&&r?t.map(e=>$(e)):r&&t||t&&[t],t=t&&t||[],this.BindGroups.push(...n&&e.map(e=>({bindGroup:e,dynamicOffsets:t,active:!0}))||[{bindGroup:e,dynamicOffsets:t,active:!0}]),this.BindGroups}SetActiveBindGroups(e){e=$(e);for(let t=this.BindGroups.length;t--;)this.BindGroups[t].active=e.includes(t)}UseBindGroups(e){for(let t=0,n=0,r=this.BindGroups.length;t<r;++t){let{bindGroup:r,dynamicOffsets:i,active:a}=this.BindGroups[t];a&&e.setBindGroup(n++,r,i)}}GetBindGroupsInfo(){!this.Reflect&&p(u.SHADER_MODULE_NOT_FOUND,`\`${this.#t}Pipeline.GetBindGroupsInfo\`.
            Use \`${this.#t}Pipeline.CreateShaderModule\` before requesting bind groups information.`);let e=this.BindGroups.length,t=Array(e),n=this.Reflect.getBindGroups();for(let r=0;r<e;++r){let{bindGroup:{label:e},dynamicOffsets:i,active:a}=this.BindGroups[r];t[r]={label:e,active:a,dynamicOffsets:i,bindings:n[r]}}return t}ClearBindGroups(){this.BindGroups.splice(0)}Destroy(){this.ClearBindGroups()}},Zt=class extends Xt{ColorAttachment=0;UseTextureView=!0;UseRenderBundles=!1;DestroyPassEncoder=!1;#e=[];#t=[0,0,0,0];TextureView;#n;VertexBuffers=[];IndexBuffer;DrawParams=[0,void 0,void 0,void 0,void 0];constructor(e,t,n){super(e,`Render`,n),this.#n=t}async Init(e={},t=0){Error().stack?.split(`
`)[2]?.trim().split(` `)[1].split(`.`)[1]!==`AddPipeline`&&m(u.INVALID_CALL,"method: `RenderPipeline.Init`."),this.Index=t;let n=rr(e),{vertex:r,fragment:i}=e;!n&&!r&&(n=this.CreateShaderModule()),n&&(r??=this.CreateVertexState(n),i??=this.CreateFragmentState(n));let a=e.label??this.CreatePipelineLabel(`Render Pipeline`),o=e.layout??`auto`;return this.GPUPipeline=await this.Device.createRenderPipelineAsync({label:a,layout:o,vertex:r,fragment:i,...e})}CreatePrimitiveState(e=`triangle-list`,t=`back`,n,r,i){return{topology:e,stripIndexFormat:n,frontFace:r,cullMode:t,unclippedDepth:i}}CreateBlendComponent(e=`one`,t=`zero`,n=`add`){return{operation:n,srcFactor:e,dstFactor:t}}CreateColorTargetState(e,t,n=this.#n){return e&&={color:e.color??{},alpha:e.alpha??{}},{format:n,blend:e,writeMask:t}}CreateMultisampleState(e=4,t,n){return{count:e,mask:t,alphaToCoverageEnabled:n}}CreateStencilFaceState(e,t,n,r){return{compare:e,failOp:t,depthFailOp:n,passOp:r}}CreateDepthStencilState(e=`depth24plus`,t=!0,n=`less`,r,i,a,o,s,c,l){return{format:e,depthWriteEnabled:t,depthCompare:n,stencilFront:r,stencilBack:i,stencilReadMask:a,stencilWriteMask:o,depthBias:s,depthBiasSlopeScale:c,depthBiasClamp:l}}CreateVertexState(e,t,n,r=`vertex`){return t=$(t),{module:e,entryPoint:r,buffers:t,constants:n}}CreateFragmentState(e,t,n,r=`fragment`){return t??=this.CreateColorTargetState(),t=$(t),{module:e,entryPoint:r,targets:t,constants:n}}#r(e,t=0,n=0){return{format:e,shaderLocation:t,offset:n}}CreateVertexBufferLayout(e,t=`vertex`,n=`vertex`){!this.Reflect&&p(u.SHADER_MODULE_NOT_FOUND,"`RenderPipeline.CreateVertexBufferLayout`.\n            Call `RenderPipeline.CreateShaderModule` before creating a vertex layout or vertex buffer.");let{entry:{vertex:r}}=this.Reflect,i=r.find(({name:e})=>n===e);!i&&p(u.VERTEX_ENTRY_NOT_FOUND,`\`${n}\` in vertex shader entries.`),e=$(e);let a=[],o=0;for(let t=0,n=e.length;t<n;++t){let n=e[t],r=typeof n==`string`,s=r?n:n.name,c=i.inputs.find(({name:e})=>s===e);if(c){let e=r?Xn(c.type.size):n.format;a.push(this.#r(e,+c.location,o)),o+=Zn(e);continue}m(u.VERTEX_ATTRIBUTE_NOT_FOUND,`\`${s}\` in vertex shader inputs.`)}return{arrayStride:o,stepMode:t,attributes:a}}CreateVertexBuffer(e,t=1,n=`vertex`,r=`vertex`){let i=typeof t==`number`,a=!i&&t.label||`Vertex Buffer`,o=sr.VERTEX|(!i&&t.usage||0);if(e instanceof Float32Array)return this.CreateBuffer({label:a,size:e.byteLength,...t,usage:o});let s=this.CreateVertexBufferLayout(e,n,r),c=(i&&t||(t.count??1))*s.arrayStride;return{buffer:this.CreateBuffer({label:a,size:c,...t,usage:o}),layout:s}}SetVertexBuffers(e,t,n){return n=$(n),t=$(t),this.VertexBuffers=Array.isArray(e)&&e.map((e,r)=>({buffer:e,offset:t[r],size:n[r]}))||[{buffer:e,offset:t[0],size:n[0]}]}AddVertexBuffers(e,t,n){return n=$(n),t=$(t),this.VertexBuffers.push(...Array.isArray(e)&&e.map((e,r)=>({buffer:e,offset:t[r],size:n[r]}))||[{buffer:e,offset:t[0],size:n[0]}]),this.VertexBuffers}CreateIndexBuffer(e,t){let n=sr.INDEX|t?.usage,r=t?.label??`Index Buffer`;return e=Array.isArray(e)&&new Uint32Array(e)||e,this.CreateBuffer({label:r,size:e.byteLength,...t,usage:n})}SetIndexBuffer(e,t=`uint32`,n,r){return this.IndexBuffer=e&&{buffer:e,format:t,offset:n,size:r}}UseRenderBuffers(e){for(let t=0,n=this.VertexBuffers.length;t<n;++t){let{buffer:n,offset:r,size:i}=this.VertexBuffers[t];e.setVertexBuffer(t,n,r,i)}this.IndexBuffer&&e.setIndexBuffer(this.IndexBuffer.buffer,this.IndexBuffer.format,this.IndexBuffer.offset,this.IndexBuffer.size)}SetDrawParams(e,t,n,r,i){return or(this.DrawParams,...arguments)}EncodeRenderBundle(e){e.setPipeline(this.GPUPipeline);for(let t=0,n=this.VertexBuffers.length;t<n;++t){let{buffer:n,offset:r,size:i}=this.VertexBuffers[t];e.setVertexBuffer(t,n,r,i)}this.IndexBuffer&&e.setIndexBuffer(this.IndexBuffer.buffer,this.IndexBuffer.format,this.IndexBuffer.offset,this.IndexBuffer.size);for(let t=0,n=0,r=this.BindGroups.length;t<r;++t){let{bindGroup:r,dynamicOffsets:i,active:a}=this.BindGroups[t];a&&e.setBindGroup(n++,r,i)}e[this.DrawMethod](...this.DrawParams),this.#e.push(e.finish()),this.UseRenderBundles=!0}SetRenderBundle(e,t,n,r,i,a){this.#e.splice(0),this.AddRenderBundle(e,t,n,r,i,a)}AddRenderBundle(e,t,n,r,i,a){if(e.setPipeline(this.GPUPipeline),r){r=$(r);for(let t=0,n=r.length;t<n;++t){let{buffer:n,offset:i,size:a}=r[t];e.setVertexBuffer(t,n,i,a)}}if(i&&e.setIndexBuffer(i.buffer,i.format,i.offset,i.size),a){a=$(a);for(let t=0,n=0,r=a.length;t<r;++t){let{bindGroup:r,dynamicOffsets:i,active:o}=a[t];o&&e.setBindGroup(n++,r,i)}}e[t](...n),this.#e.push(e.finish()),this.UseRenderBundles=!0}ExecuteRenderBundles(e){e.executeBundles(this.#e)}ClearRenderBundles(){this.UseRenderBundles=!1,this.#e.splice(0)}set BlendConstant(e){this.#t=typeof e==`number`&&nr(e)||tr(e)}get BlendConstant(){return this.#t}get DrawMethod(){return this.IndexBuffer&&`drawIndexed`||`draw`}Destroy(){super.Destroy(),this.ColorAttachment=0,this.TextureView=void 0,this.DestroyPassEncoder=!1,this.#t=[0,0,0,0],this.VertexBuffers.forEach(({buffer:e})=>e.destroy()),this.IndexBuffer?.buffer.destroy(),this.VertexBuffers.splice(0),this.ClearRenderBundles()}},Qt=class extends Xt{constructor(e,t){super(e,`Compute`,t)}async Init(e={},t=0){Error().stack?.split(`
`)[2]?.trim().split(` `)[1].split(`.`)[1]!==`AddPipeline`&&m(u.INVALID_CALL,"method: `ComputePipeline.Init`.");let{label:n,layout:r}=e;this.Index=t,n??=this.CreatePipelineLabel(`Compute Pipeline`),r??=`auto`;let i=rr(e)??this.CreateShaderModule();return this.GPUPipeline=await this.Device.createComputePipelineAsync({label:n,layout:r,compute:{module:i,...e}})}},$t=class extends h{#e=new Float32Array(3);UseDepthStencilAttachment=!1;#t;#n;#r;#i;#a=void 0;#o;#s;#c;#l;#u;#d=new Map;#f=[];#p=new Map;#m=[];#h={Pipeline:void 0,Index:-1,Geometry:``,Material:``};constructor(e,t,n,r){super(e,`Render`,t),!n&&p(u.CANVAS_NOT_FOUND);let i=n.getContext(`webgpu`);!i&&p(u.CONTEXT_NOT_FOUND),i.configure({device:e,...r}),this.#r=ir(this.Device,{size:this.#e.length*Float32Array.BYTES_PER_ELEMENT,label:`Render Pipeline Resolution Buffer`,usage:sr.UNIFORM}),this.#t=n,this.#n=i,this.#_(),this.#c=r.format,this.CreatePassDescriptor(this.CreateColorAttachment())}ConfigureContext(e){let t=e.format??this.#c;this.#n.configure({device:this.Device,format:t,...e})}CreateColorAttachment(e,t,n=`clear`,r=`store`,i,a){return{view:t,loadOp:n,storeOp:r,clearValue:e&&tr(e),resolveTarget:i,depthSlice:a}}CreateStencilAttachment(e=0,t=`clear`,n=`store`,r){return{stencilClearValue:e,stencilLoadOp:t,stencilStoreOp:n,stencilReadOnly:r}}CreateDepthStencilAttachment(e,t=1,n=`clear`,r=`store`,i,a){return this.UseDepthStencilAttachment=!0,this.#i=new D(this.Device),{view:e,depthClearValue:t,depthLoadOp:n,depthStoreOp:r,depthReadOnly:i,...a}}#g(){let e=this.CurrentTexture,{width:t,height:n}=e;(!this.#s||this.#s.width!==t||this.#s.height!==n)&&(this.#s?.destroy(),this.#s=this.#i.CreateTextureFromSource(e,{sampleCount:this.#l?.sampleCount??1,usage:GPUTextureUsage.RENDER_ATTACHMENT,label:`Depth Texture`,format:`depth24plus`,mipmaps:!1})),this.#o.depthStencilAttachment.view=this.#s.createView()}CreateRenderBundleEncoder(e=this.#c,t=`depth24plus`,n,r,i,a){return e=$(e),n??=this.CreateStageLabel(`Render Bundle Encoder`),this.Device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,label:n,sampleCount:r,depthReadOnly:i,stencilReadOnly:a})}CreatePassDescriptor(e,t,n,r,i,a){return e=$(e),n??=this.CreateStageLabel(`Render Pass`),this.#o={depthStencilAttachment:t,occlusionQuerySet:r,colorAttachments:e,timestampWrites:i,maxDrawCount:a,label:n}}CreateStorageTextureBindingLayout(e=this.#c,t,n,r,i){return{binding:i,visibility:GPUShaderStage.FRAGMENT,storageTexture:{access:t,format:e,viewDimension:n}}}#_(){this.#e.set([this.#t.width,this.#t.height,this.DevicePixelRatio]),ar(this.Device.queue,this.#r,this.#e)}SetCanvasSize(e,t,n=!0){!this.Device&&p(u.DEVICE_NOT_FOUND),!this.#t&&p(u.CANVAS_NOT_FOUND);let r=this.DevicePixelRatio*e|0,i=this.DevicePixelRatio*t|0,a=this.Device.limits.maxTextureDimension2D;r=Math.max(1,Math.min(r,a)),i=Math.max(1,Math.min(i,a)),(this.#t.width!==r||this.#t.height!==i)&&(this.#t.height=i,this.#t.width=r,this.#_(),n&&(this.#t.style.width=`${e}px`,this.#t.style.height=`${t}px`))}async CreatePipeline(e,t){let n=Array.isArray(e)||typeof e==`string`,r=n||`shader`in e,i=new this.Pipeline(e.pipelineName);return e=rr(e)??(r&&i.CreateShaderModule(...Object.values(n&&[e]||e))||e),await this.AddPipeline(i,e,t)}async AddPipeline(e,t,n){let r=await e.Init(t,this.Pipelines.length);return n&&(this.#u?this.#u.setPipeline(r):m(u.RENDER_PASS_NOT_FOUND)),this.Pipelines.push(e),e}#v(e,t,n,r=!0,i=!0){if(n||=!this.#u,r||=n,i||=n,!this.#u){let t=`view`,n=this.#o.colorAttachments[e.ColorAttachment];this.#l&&(t=`resolveTarget`,n.view=this.#l.createView()),e.UseTextureView&&(n[t]=e.TextureView??this.CurrentTextureView),this.#u=this.GetCommandEncoder().beginRenderPass(this.#o)}i&&this.#u.setBlendConstant(e.BlendConstant),e.UseRenderBundles?e.ExecuteRenderBundles(this.#u):(n&&this.#u.setPipeline(e.GPUPipeline),r&&e.UseRenderBuffers(this.#u),e.UseBindGroups(this.#u),this.#u[e.DrawMethod](...e.DrawParams)),e.DestroyPassEncoder&&!t&&this.DestroyRenderPass()}#y({Geometry:e,Material:t,Meshes:n},r,i){let a=e.ID!==this.#h.Geometry,o=t?.ID!==this.#h.Material;for(let s=0,c=n.length;s<c;++s,a=o=!1,this.#h.Index=this.#h.Pipeline.Index){let c=n[s],l=c.Pipeline,u=l.Index!==this.#h.Index;if(a||u){let{VertexBuffers:t,IndexBuffer:n,DrawParams:r}=e;l.SetDrawParams.apply(l,r),this.#h.Geometry=e.ID,l.VertexBuffers=t,l.IndexBuffer=n}(o||u)&&(o=!!t?.SetBlendConstant(this.#h.Pipeline),this.#h.Material=t?.ID),c.UpdateProjectionMatrix(r),c.SetBindGroups(),this.#v(this.#h.Pipeline=l,i,u,a,o)}}#b(e,t){for(let n=0,r,i=t.length;n<i;r=void 0,++n){let i=t[n],{Geometry:a,Material:o}=i,s=a.ID+`${(o&&`-${o.ID}`)??``}`;(r=e.get(s))||(r={Geometry:a,Material:o,Meshes:[]},e.set(s,r)),r.Meshes.push(i)}}#x(e,t=!0){e.UpdateWorldMatrix();let{Frustum:n,ProjectionMatrix:r,ViewProjectionMatrix:i}=e.MainCamera,a=i||r;if(e.Traverse(e=>{if(!e.Visible)return!0;(e.Material?.Transparent&&this.#m||this.#f).push(e)}),!this.#f.length&&!this.#m.length)return~this.DestroyRenderPass()&&(this.CommandEncoder=void 0);this.#b(this.#d,this.#f),this.#b(this.#p,this.#m),this.#d.forEach(e=>this.#y(e,a,t)),this.#p.forEach(e=>this.#y(e,a,t)),t&&this.Submit(),this.#d.clear(),this.#f.splice(0),this.#p.clear(),this.#m.splice(0)}Render(e=!0,t=!0){if(this.UseDepthStencilAttachment&&this.#g(),typeof e==`boolean`)t=e;else return this.#x(e,t);let n=this.Pipelines.length;if(!(n-1)&&this.Pipelines[0].Active)this.#v(this.Pipelines[0],t,!1);else for(let e=0;e<n;++e){let n=this.Pipelines[e];n.Active&&this.#v(n,t,!0)}t&&this.Submit()}DestroyRenderPass(){this.#u?.end(),this.#u=void 0}Submit(){this.DestroyRenderPass(),this.SubmitCommandBuffer(),this.CommandEncoder=void 0}get Canvas(){return this.#t}get Context(){return this.#n}get RenderPass(){return this.#u}get DepthTexture(){return this.#s}get CurrentTexture(){return this.#n.getCurrentTexture()}get CurrentTextureView(){return this.CurrentTexture.createView()}set MultisampleTexture(e){this.#l=e}get RenderPassDescriptor(){return this.#o}get MultisampleTexture(){return this.#l}set DevicePixelRatio(e){this.#a=e}get DevicePixelRatio(){return this.#a??globalThis.devicePixelRatio??1}get ResolutionBuffer(){return this.#r}get BaseCanvasSize(){let{width:e,height:t}=this.#t,n=this.DevicePixelRatio;return[e/n,t/n]}get CanvasSize(){return[this.#t.width,this.#t.height]}get AspectRatio(){return!this.#t&&p(u.CANVAS_NOT_FOUND),this.#t.width/this.#t.height}get Pipeline(){let{Name:e,Device:t}=this,n=this.#c;return class extends Zt{constructor(r=e){super(t,n,r)}}}Destroy(){super.Destroy(),this.DestroyRenderPass(),this.#r.destroy(),this.#s=this.#s?.destroy(),this.#i=this.#i?.Destroy(),this.#n.unconfigure()}},en=class extends h{#e=[1];#t;constructor(e,t){super(e,`Compute`,t),this.CreatePassDescriptor()}CreatePassDescriptor(e,t){return e??=this.CreateStageLabel(`Compute Pass`),this.#t={label:e,timestampWrites:t}}GetMaxEvenWorkgroupDimension(e=1){let{maxComputeInvocationsPerWorkgroup:t}=this.Device.limits;return(e===3?Math.cbrt(t):e===2?Math.sqrt(t):t)|0}async CreatePipeline(e){let t=Array.isArray(e)||typeof e==`string`,n=t||`shader`in e,r=new this.Pipeline(e.pipelineName);return e=rr(e)??(n&&r.CreateShaderModule(...Object.values(t&&[e]||e))||e),await this.AddPipeline(r,e)}async AddPipeline(e,t){return await e.Init(t,this.Pipelines.length),this.Pipelines.push(e),e}#n(e,t){t.setPipeline(e.GPUPipeline),e.UseBindGroups(t),t.dispatchWorkgroups(...this.#e),t.end()}Compute(e=!0){let t=this.Pipelines.length,n=this.GetCommandEncoder().beginComputePass(this.#t);if(!(t-1)&&this.Pipelines[0].Active)this.#n(this.Pipelines[0],n);else for(let e=0;e<t;++e){let t=this.Pipelines[e];t.Active&&this.#n(t,n)}e&&this.Submit()}Submit(){this.SubmitCommandBuffer(),this.CommandEncoder=void 0}set Workgroups(e){this.#e=$(e).map(Math.ceil)}get Pipeline(){let{Name:e,Device:t}=this;return class extends Qt{constructor(n=e){super(t,n)}}}Destroy(){super.Destroy(),this.Workgroups=1}},tn=class e{static#e=[];static#t=null;static#n=null;static#r={powerPreference:void 0,forceFallbackAdapter:!1};static OnLost;static#i={label:void 0,requiredFeatures:new Set,requiredLimits:void 0};static#a(e){this.#i.label??=e&&`${e} Device`||``}static async CreateQuerySet(e,t){let n=await this.GPUDevice;if(!n)return;let r=n.createQuerySet({type:e,count:t});return this.#e.push(r),r}static Renderer(e,t=``,n={}){return n.format??=this.PreferredCanvasFormat,this.#a(t),(async()=>{let r=await this.GPUDevice;return r&&new Proxy($t,{construct(i){return new i(r,t,e,n)}})})()}static Computation(e=``){return this.#a(e),(async()=>{let t=await this.GPUDevice;return t&&new Proxy(en,{construct(n){return new n(t,e)}})})()}static Texture(e){return(async()=>{let t=await this.GPUDevice;return t&&new Proxy(D,{construct(n){return new n(t,e)}})})()}static Destroy(e,t){this.#e.forEach(e=>e.destroy()),e=$(e),e.forEach(e=>e?.destroy()),t=$(t),t.forEach(e=>e?.destroy()),this.#t?.destroy(),this.#e.splice(0),this.#i.requiredFeatures.clear(),this.#n=this.#t=null,this.DescriptorLabel=this.RequiredLimits=void 0,this.ForceFallbackAdapter=!!(this.PowerPreference=void 0)}static#o(t){if(e.OnLost)return e.OnLost(t);let n=(t.message&&` | Message: ${t.message}`)??`.`;p(u.DEVICE_LOST,`Reason: ${t.reason}`+n)}static#s(){return!navigator.gpu&&p(u.WEBGPU_NOT_SUPPORTED),async()=>{let e=await navigator.gpu.requestAdapter(this.#r);return!e&&p(u.ADAPTER_NOT_FOUND),this.#n=e}}static#c(){return async()=>{let{requiredFeatures:e,requiredLimits:t,label:n}=this.#i,r=await(await this.Adapter)?.requestDevice({requiredFeatures:e,requiredLimits:t,defaultQueue:{label:n}});return r?(r.lost.then(this.#o),this.#t=r):p(u.DEVICE_NOT_FOUND)}}static set PowerPreference(e){this.#r.powerPreference=e}static set ForceFallbackAdapter(e){this.#r.forceFallbackAdapter=e}static set DescriptorLabel(e){this.#i.label=e}static async SetRequiredFeatures(e){let t=(await this.Adapter)?.features;return t&&(e=$(e),e.forEach(e=>t.has(e)?this.#i.requiredFeatures.add(e):m(u.FEATURE_NOT_FOUND,`"${e}".\nIt will be skipped when requesting a GPUDevice.`))),this.#i.requiredFeatures}static set RequiredLimits(e){this.#i.requiredLimits=e}static get PreferredCanvasFormat(){return!navigator.gpu&&p(u.WEBGPU_NOT_SUPPORTED),navigator.gpu.getPreferredCanvasFormat()}static get Adapter(){return(async()=>this.#n??await this.#s()())()}static get GPUDevice(){return(async()=>this.#t??await this.#c()())()}static get VERSION(){return`0.2.0`}};function nn(e,t){return class extends e{constructor(...e){super(...e),t(this)}}}var rn=nn(Array,e=>e.fill(0)),X=1e-6;function an(e){let t=X;return X=e,t}function on(e){return e*Math.PI/180}function sn(e){return e*180/Math.PI}function cn(e,t,n){return e+(t-e)*n}function ln(e,t,n){let r=t-e;return Math.abs(t-e)<X?e:(n-e)/r}function un(e,t){return(e%t+t)%t}var dn={__proto__:null,get EPSILON(){return X},degToRad:on,euclideanModulo:un,inverseLerp:ln,lerp:cn,radToDeg:sn,setEpsilon:an};function fn(e){function t(t=0,n=0){let r=new e(2);return t!==void 0&&(r[0]=t,n!==void 0&&(r[1]=n)),r}let n=t;function r(t,n,r){let i=r??new e(2);return i[0]=t,i[1]=n,i}function i(t,n){let r=n??new e(2);return r[0]=Math.ceil(t[0]),r[1]=Math.ceil(t[1]),r}function a(t,n){let r=n??new e(2);return r[0]=Math.floor(t[0]),r[1]=Math.floor(t[1]),r}function o(t,n){let r=n??new e(2);return r[0]=Math.round(t[0]),r[1]=Math.round(t[1]),r}function s(t,n=0,r=1,i){let a=i??new e(2);return a[0]=Math.min(r,Math.max(n,t[0])),a[1]=Math.min(r,Math.max(n,t[1])),a}function c(t,n,r){let i=r??new e(2);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i}function l(t,n,r,i){let a=i??new e(2);return a[0]=t[0]+n[0]*r,a[1]=t[1]+n[1]*r,a}function u(e,t){let n=e[0],r=e[1],i=t[0],a=t[1],o=Math.sqrt(n*n+r*r)*Math.sqrt(i*i+a*a),s=o&&T(e,t)/o;return Math.acos(s)}function d(t,n,r){let i=r??new e(2);return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i}let f=d;function p(e,t){return Math.abs(e[0]-t[0])<X&&Math.abs(e[1]-t[1])<X}function m(e,t){return e[0]===t[0]&&e[1]===t[1]}function h(t,n,r,i){let a=i??new e(2);return a[0]=t[0]+r*(n[0]-t[0]),a[1]=t[1]+r*(n[1]-t[1]),a}function g(t,n,r,i){let a=i??new e(2);return a[0]=t[0]+r[0]*(n[0]-t[0]),a[1]=t[1]+r[1]*(n[1]-t[1]),a}function _(t,n,r){let i=r??new e(2);return i[0]=Math.max(t[0],n[0]),i[1]=Math.max(t[1],n[1]),i}function v(t,n,r){let i=r??new e(2);return i[0]=Math.min(t[0],n[0]),i[1]=Math.min(t[1],n[1]),i}function y(t,n,r){let i=r??new e(2);return i[0]=t[0]*n,i[1]=t[1]*n,i}let b=y;function x(t,n,r){let i=r??new e(2);return i[0]=t[0]/n,i[1]=t[1]/n,i}function S(t,n){let r=n??new e(2);return r[0]=1/t[0],r[1]=1/t[1],r}let C=S;function w(t,n,r){let i=r??new e(3),a=t[0]*n[1]-t[1]*n[0];return i[0]=0,i[1]=0,i[2]=a,i}function T(e,t){return e[0]*t[0]+e[1]*t[1]}function E(e){let t=e[0],n=e[1];return Math.sqrt(t*t+n*n)}let ee=E;function D(e){let t=e[0],n=e[1];return t*t+n*n}let O=D;function k(e,t){let n=e[0]-t[0],r=e[1]-t[1];return Math.sqrt(n*n+r*r)}let A=k;function j(e,t){let n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r}let M=j;function N(t,n){let r=n??new e(2),i=t[0],a=t[1],o=Math.sqrt(i*i+a*a);return o>1e-5?(r[0]=i/o,r[1]=a/o):(r[0]=0,r[1]=0),r}function P(t,n){let r=n??new e(2);return r[0]=-t[0],r[1]=-t[1],r}function F(t,n){let r=n??new e(2);return r[0]=t[0],r[1]=t[1],r}let te=F;function ne(t,n,r){let i=r??new e(2);return i[0]=t[0]*n[0],i[1]=t[1]*n[1],i}let re=ne;function ie(t,n,r){let i=r??new e(2);return i[0]=t[0]/n[0],i[1]=t[1]/n[1],i}let ae=ie;function oe(t=1,n){let r=n??new e(2),i=Math.random()*2*Math.PI;return r[0]=Math.cos(i)*t,r[1]=Math.sin(i)*t,r}function se(t){let n=t??new e(2);return n[0]=0,n[1]=0,n}function ce(t,n,r){let i=r??new e(2),a=t[0],o=t[1];return i[0]=a*n[0]+o*n[4]+n[12],i[1]=a*n[1]+o*n[5]+n[13],i}function le(t,n,r){let i=r??new e(2),a=t[0],o=t[1];return i[0]=n[0]*a+n[4]*o+n[8],i[1]=n[1]*a+n[5]*o+n[9],i}function ue(t,n,r,i){let a=i??new e(2),o=t[0]-n[0],s=t[1]-n[1],c=Math.sin(r),l=Math.cos(r);return a[0]=o*l-s*c+n[0],a[1]=o*c+s*l+n[1],a}function I(t,n,r){let i=r??new e(2);return N(t,i),y(i,n,i)}function de(t,n,r){let i=r??new e(2);return E(t)>n?I(t,n,i):F(t,i)}function fe(t,n,r){return h(t,n,.5,r??new e(2))}return{create:t,fromValues:n,set:r,ceil:i,floor:a,round:o,clamp:s,add:c,addScaled:l,angle:u,subtract:d,sub:f,equalsApproximately:p,equals:m,lerp:h,lerpV:g,max:_,min:v,mulScalar:y,scale:b,divScalar:x,inverse:S,invert:C,cross:w,dot:T,length:E,len:ee,lengthSq:D,lenSq:O,distance:k,dist:A,distanceSq:j,distSq:M,normalize:N,negate:P,copy:F,clone:te,multiply:ne,mul:re,divide:ie,div:ae,random:oe,zero:se,transformMat4:ce,transformMat3:le,rotate:ue,setLength:I,truncate:de,midpoint:fe}}var pn=new Map;function mn(e){let t=pn.get(e);return t||(t=fn(e),pn.set(e,t)),t}function hn(e){function t(t,n,r){let i=new e(3);return t!==void 0&&(i[0]=t,n!==void 0&&(i[1]=n,r!==void 0&&(i[2]=r))),i}let n=t;function r(t,n,r,i){let a=i??new e(3);return a[0]=t,a[1]=n,a[2]=r,a}function i(t,n){let r=n??new e(3);return r[0]=Math.ceil(t[0]),r[1]=Math.ceil(t[1]),r[2]=Math.ceil(t[2]),r}function a(t,n){let r=n??new e(3);return r[0]=Math.floor(t[0]),r[1]=Math.floor(t[1]),r[2]=Math.floor(t[2]),r}function o(t,n){let r=n??new e(3);return r[0]=Math.round(t[0]),r[1]=Math.round(t[1]),r[2]=Math.round(t[2]),r}function s(t,n=0,r=1,i){let a=i??new e(3);return a[0]=Math.min(r,Math.max(n,t[0])),a[1]=Math.min(r,Math.max(n,t[1])),a[2]=Math.min(r,Math.max(n,t[2])),a}function c(t,n,r){let i=r??new e(3);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i}function l(t,n,r,i){let a=i??new e(3);return a[0]=t[0]+n[0]*r,a[1]=t[1]+n[1]*r,a[2]=t[2]+n[2]*r,a}function u(e,t){let n=e[0],r=e[1],i=e[2],a=t[0],o=t[1],s=t[2],c=Math.sqrt(n*n+r*r+i*i)*Math.sqrt(a*a+o*o+s*s),l=c&&T(e,t)/c;return Math.acos(l)}function d(t,n,r){let i=r??new e(3);return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],i}let f=d;function p(e,t){return Math.abs(e[0]-t[0])<X&&Math.abs(e[1]-t[1])<X&&Math.abs(e[2]-t[2])<X}function m(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function h(t,n,r,i){let a=i??new e(3);return a[0]=t[0]+r*(n[0]-t[0]),a[1]=t[1]+r*(n[1]-t[1]),a[2]=t[2]+r*(n[2]-t[2]),a}function g(t,n,r,i){let a=i??new e(3);return a[0]=t[0]+r[0]*(n[0]-t[0]),a[1]=t[1]+r[1]*(n[1]-t[1]),a[2]=t[2]+r[2]*(n[2]-t[2]),a}function _(t,n,r){let i=r??new e(3);return i[0]=Math.max(t[0],n[0]),i[1]=Math.max(t[1],n[1]),i[2]=Math.max(t[2],n[2]),i}function v(t,n,r){let i=r??new e(3);return i[0]=Math.min(t[0],n[0]),i[1]=Math.min(t[1],n[1]),i[2]=Math.min(t[2],n[2]),i}function y(t,n,r){let i=r??new e(3);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i}let b=y;function x(t,n,r){let i=r??new e(3);return i[0]=t[0]/n,i[1]=t[1]/n,i[2]=t[2]/n,i}function S(t,n){let r=n??new e(3);return r[0]=1/t[0],r[1]=1/t[1],r[2]=1/t[2],r}let C=S;function w(t,n,r){let i=r??new e(3),a=t[2]*n[0]-t[0]*n[2],o=t[0]*n[1]-t[1]*n[0];return i[0]=t[1]*n[2]-t[2]*n[1],i[1]=a,i[2]=o,i}function T(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function E(e){let t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)}let ee=E;function D(e){let t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r}let O=D;function k(e,t){let n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+r*r+i*i)}let A=k;function j(e,t){let n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return n*n+r*r+i*i}let M=j;function N(t,n){let r=n??new e(3),i=t[0],a=t[1],o=t[2],s=Math.sqrt(i*i+a*a+o*o);return s>1e-5?(r[0]=i/s,r[1]=a/s,r[2]=o/s):(r[0]=0,r[1]=0,r[2]=0),r}function P(t,n){let r=n??new e(3);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r}function F(t,n){let r=n??new e(3);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r}let te=F;function ne(t,n,r){let i=r??new e(3);return i[0]=t[0]*n[0],i[1]=t[1]*n[1],i[2]=t[2]*n[2],i}let re=ne;function ie(t,n,r){let i=r??new e(3);return i[0]=t[0]/n[0],i[1]=t[1]/n[1],i[2]=t[2]/n[2],i}let ae=ie;function oe(t=1,n){let r=n??new e(3),i=Math.random()*2*Math.PI,a=Math.random()*2-1,o=Math.sqrt(1-a*a)*t;return r[0]=Math.cos(i)*o,r[1]=Math.sin(i)*o,r[2]=a*t,r}function se(t){let n=t??new e(3);return n[0]=0,n[1]=0,n[2]=0,n}function ce(t,n,r){let i=r??new e(3),a=t[0],o=t[1],s=t[2],c=n[3]*a+n[7]*o+n[11]*s+n[15]||1;return i[0]=(n[0]*a+n[4]*o+n[8]*s+n[12])/c,i[1]=(n[1]*a+n[5]*o+n[9]*s+n[13])/c,i[2]=(n[2]*a+n[6]*o+n[10]*s+n[14])/c,i}function le(t,n,r){let i=r??new e(3),a=t[0],o=t[1],s=t[2];return i[0]=a*n[0]+o*n[4]+s*n[8],i[1]=a*n[1]+o*n[5]+s*n[9],i[2]=a*n[2]+o*n[6]+s*n[10],i}function ue(t,n,r){let i=r??new e(3),a=t[0],o=t[1],s=t[2];return i[0]=a*n[0]+o*n[4]+s*n[8],i[1]=a*n[1]+o*n[5]+s*n[9],i[2]=a*n[2]+o*n[6]+s*n[10],i}function I(t,n,r){let i=r??new e(3),a=n[0],o=n[1],s=n[2],c=n[3]*2,l=t[0],u=t[1],d=t[2],f=o*d-s*u,p=s*l-a*d,m=a*u-o*l;return i[0]=l+f*c+(o*m-s*p)*2,i[1]=u+p*c+(s*f-a*m)*2,i[2]=d+m*c+(a*p-o*f)*2,i}function de(t,n){let r=n??new e(3);return r[0]=t[12],r[1]=t[13],r[2]=t[14],r}function fe(t,n,r){let i=r??new e(3),a=n*4;return i[0]=t[a+0],i[1]=t[a+1],i[2]=t[a+2],i}function pe(t,n){let r=n??new e(3),i=t[0],a=t[1],o=t[2],s=t[4],c=t[5],l=t[6],u=t[8],d=t[9],f=t[10];return r[0]=Math.sqrt(i*i+a*a+o*o),r[1]=Math.sqrt(s*s+c*c+l*l),r[2]=Math.sqrt(u*u+d*d+f*f),r}function me(t,n,r,i){let a=i??new e(3),o=[],s=[];return o[0]=t[0]-n[0],o[1]=t[1]-n[1],o[2]=t[2]-n[2],s[0]=o[0],s[1]=o[1]*Math.cos(r)-o[2]*Math.sin(r),s[2]=o[1]*Math.sin(r)+o[2]*Math.cos(r),a[0]=s[0]+n[0],a[1]=s[1]+n[1],a[2]=s[2]+n[2],a}function he(t,n,r,i){let a=i??new e(3),o=[],s=[];return o[0]=t[0]-n[0],o[1]=t[1]-n[1],o[2]=t[2]-n[2],s[0]=o[2]*Math.sin(r)+o[0]*Math.cos(r),s[1]=o[1],s[2]=o[2]*Math.cos(r)-o[0]*Math.sin(r),a[0]=s[0]+n[0],a[1]=s[1]+n[1],a[2]=s[2]+n[2],a}function L(t,n,r,i){let a=i??new e(3),o=[],s=[];return o[0]=t[0]-n[0],o[1]=t[1]-n[1],o[2]=t[2]-n[2],s[0]=o[0]*Math.cos(r)-o[1]*Math.sin(r),s[1]=o[0]*Math.sin(r)+o[1]*Math.cos(r),s[2]=o[2],a[0]=s[0]+n[0],a[1]=s[1]+n[1],a[2]=s[2]+n[2],a}function R(t,n,r){let i=r??new e(3);return N(t,i),y(i,n,i)}function ge(t,n,r){let i=r??new e(3);return E(t)>n?R(t,n,i):F(t,i)}function _e(t,n,r){return h(t,n,.5,r??new e(3))}return{create:t,fromValues:n,set:r,ceil:i,floor:a,round:o,clamp:s,add:c,addScaled:l,angle:u,subtract:d,sub:f,equalsApproximately:p,equals:m,lerp:h,lerpV:g,max:_,min:v,mulScalar:y,scale:b,divScalar:x,inverse:S,invert:C,cross:w,dot:T,length:E,len:ee,lengthSq:D,lenSq:O,distance:k,dist:A,distanceSq:j,distSq:M,normalize:N,negate:P,copy:F,clone:te,multiply:ne,mul:re,divide:ie,div:ae,random:oe,zero:se,transformMat4:ce,transformMat4Upper3x3:le,transformMat3:ue,transformQuat:I,getTranslation:de,getAxis:fe,getScaling:pe,rotateX:me,rotateY:he,rotateZ:L,setLength:R,truncate:ge,midpoint:_e}}var gn=new Map;function _n(e){let t=gn.get(e);return t||(t=hn(e),gn.set(e,t)),t}function vn(e){let t=mn(e),n=_n(e);function r(t,n,r,i,a,o,s,c,l){let u=new e(12);return u[3]=0,u[7]=0,u[11]=0,t!==void 0&&(u[0]=t,n!==void 0&&(u[1]=n,r!==void 0&&(u[2]=r,i!==void 0&&(u[4]=i,a!==void 0&&(u[5]=a,o!==void 0&&(u[6]=o,s!==void 0&&(u[8]=s,c!==void 0&&(u[9]=c,l!==void 0&&(u[10]=l))))))))),u}function i(t,n,r,i,a,o,s,c,l,u){let d=u??new e(12);return d[0]=t,d[1]=n,d[2]=r,d[3]=0,d[4]=i,d[5]=a,d[6]=o,d[7]=0,d[8]=s,d[9]=c,d[10]=l,d[11]=0,d}function a(t,n){let r=n??new e(12);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=0,r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=0,r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=0,r}function o(t,n){let r=n??new e(12),i=t[0],a=t[1],o=t[2],s=t[3],c=i+i,l=a+a,u=o+o,d=i*c,f=a*c,p=a*l,m=o*c,h=o*l,g=o*u,_=s*c,v=s*l,y=s*u;return r[0]=1-p-g,r[1]=f+y,r[2]=m-v,r[3]=0,r[4]=f-y,r[5]=1-d-g,r[6]=h+_,r[7]=0,r[8]=m+v,r[9]=h-_,r[10]=1-d-p,r[11]=0,r}function s(t,n){let r=n??new e(12);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[4]=-t[4],r[5]=-t[5],r[6]=-t[6],r[8]=-t[8],r[9]=-t[9],r[10]=-t[10],r}function c(t,n,r){let i=r??new e(12);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*n,i[8]=t[8]*n,i[9]=t[9]*n,i[10]=t[10]*n,i}let l=c;function u(t,n,r){let i=r??new e(12);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i[4]=t[4]+n[4],i[5]=t[5]+n[5],i[6]=t[6]+n[6],i[8]=t[8]+n[8],i[9]=t[9]+n[9],i[10]=t[10]+n[10],i}function d(t,n){let r=n??new e(12);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[8]=t[8],r[9]=t[9],r[10]=t[10],r}let f=d;function p(e,t){return Math.abs(e[0]-t[0])<X&&Math.abs(e[1]-t[1])<X&&Math.abs(e[2]-t[2])<X&&Math.abs(e[4]-t[4])<X&&Math.abs(e[5]-t[5])<X&&Math.abs(e[6]-t[6])<X&&Math.abs(e[8]-t[8])<X&&Math.abs(e[9]-t[9])<X&&Math.abs(e[10]-t[10])<X}function m(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]}function h(t){let n=t??new e(12);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=1,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function g(t,n){let r=n??new e(12);if(r===t){let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,r}let i=t[0],a=t[1],o=t[2],s=t[4],c=t[5],l=t[6],u=t[8],d=t[9],f=t[10];return r[0]=i,r[1]=s,r[2]=u,r[4]=a,r[5]=c,r[6]=d,r[8]=o,r[9]=l,r[10]=f,r}function _(t,n){let r=n??new e(12),i=t[0],a=t[1],o=t[2],s=t[4],c=t[5],l=t[6],u=t[8],d=t[9],f=t[10],p=f*c-l*d,m=-f*s+l*u,h=d*s-c*u,g=1/(i*p+a*m+o*h);return r[0]=p*g,r[1]=(-f*a+o*d)*g,r[2]=(l*a-o*c)*g,r[4]=m*g,r[5]=(f*i-o*u)*g,r[6]=(-l*i+o*s)*g,r[8]=h*g,r[9]=(-d*i+a*u)*g,r[10]=(c*i-a*s)*g,r}function v(e){let t=e[0],n=e[1],r=e[2],i=e[4],a=e[5],o=e[6],s=e[8],c=e[9],l=e[10];return t*(a*l-c*o)-i*(n*l-c*r)+s*(n*o-a*r)}let y=_;function b(t,n,r){let i=r??new e(12),a=t[0],o=t[1],s=t[2],c=t[4],l=t[5],u=t[6],d=t[8],f=t[9],p=t[10],m=n[0],h=n[1],g=n[2],_=n[4],v=n[5],y=n[6],b=n[8],x=n[9],S=n[10];return i[0]=a*m+c*h+d*g,i[1]=o*m+l*h+f*g,i[2]=s*m+u*h+p*g,i[4]=a*_+c*v+d*y,i[5]=o*_+l*v+f*y,i[6]=s*_+u*v+p*y,i[8]=a*b+c*x+d*S,i[9]=o*b+l*x+f*S,i[10]=s*b+u*x+p*S,i}let x=b;function S(e,t,n){let r=n??h();return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[4]=e[4],r[5]=e[5],r[6]=e[6]),r[8]=t[0],r[9]=t[1],r[10]=1,r}function C(e,n){let r=n??t.create();return r[0]=e[8],r[1]=e[9],r}function w(e,n,r){let i=r??t.create(),a=n*4;return i[0]=e[a+0],i[1]=e[a+1],i}function T(e,t,n,r){let i=r===e?e:d(e,r),a=n*4;return i[a+0]=t[0],i[a+1]=t[1],i}function E(e,n){let r=n??t.create(),i=e[0],a=e[1],o=e[4],s=e[5];return r[0]=Math.sqrt(i*i+a*a),r[1]=Math.sqrt(o*o+s*s),r}function ee(e,t){let r=t??n.create(),i=e[0],a=e[1],o=e[2],s=e[4],c=e[5],l=e[6],u=e[8],d=e[9],f=e[10];return r[0]=Math.sqrt(i*i+a*a+o*o),r[1]=Math.sqrt(s*s+c*c+l*l),r[2]=Math.sqrt(u*u+d*d+f*f),r}function D(t,n){let r=n??new e(12);return r[0]=1,r[1]=0,r[2]=0,r[4]=0,r[5]=1,r[6]=0,r[8]=t[0],r[9]=t[1],r[10]=1,r}function O(t,n,r){let i=r??new e(12),a=n[0],o=n[1],s=t[0],c=t[1],l=t[2],u=t[4],d=t[5],f=t[6],p=t[8],m=t[9],h=t[10];return t!==i&&(i[0]=s,i[1]=c,i[2]=l,i[4]=u,i[5]=d,i[6]=f),i[8]=s*a+u*o+p,i[9]=c*a+d*o+m,i[10]=l*a+f*o+h,i}function k(t,n){let r=n??new e(12),i=Math.cos(t),a=Math.sin(t);return r[0]=i,r[1]=a,r[2]=0,r[4]=-a,r[5]=i,r[6]=0,r[8]=0,r[9]=0,r[10]=1,r}function A(t,n,r){let i=r??new e(12),a=t[0],o=t[1],s=t[2],c=t[4],l=t[5],u=t[6],d=Math.cos(n),f=Math.sin(n);return i[0]=d*a+f*c,i[1]=d*o+f*l,i[2]=d*s+f*u,i[4]=d*c-f*a,i[5]=d*l-f*o,i[6]=d*u-f*s,t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10]),i}function j(t,n){let r=n??new e(12),i=Math.cos(t),a=Math.sin(t);return r[0]=1,r[1]=0,r[2]=0,r[4]=0,r[5]=i,r[6]=a,r[8]=0,r[9]=-a,r[10]=i,r}function M(t,n,r){let i=r??new e(12),a=t[4],o=t[5],s=t[6],c=t[8],l=t[9],u=t[10],d=Math.cos(n),f=Math.sin(n);return i[4]=d*a+f*c,i[5]=d*o+f*l,i[6]=d*s+f*u,i[8]=d*c-f*a,i[9]=d*l-f*o,i[10]=d*u-f*s,t!==i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2]),i}function N(t,n){let r=n??new e(12),i=Math.cos(t),a=Math.sin(t);return r[0]=i,r[1]=0,r[2]=-a,r[4]=0,r[5]=1,r[6]=0,r[8]=a,r[9]=0,r[10]=i,r}function P(t,n,r){let i=r??new e(12),a=t[0],o=t[1],s=t[2],c=t[8],l=t[9],u=t[10],d=Math.cos(n),f=Math.sin(n);return i[0]=d*a-f*c,i[1]=d*o-f*l,i[2]=d*s-f*u,i[8]=d*c+f*a,i[9]=d*l+f*o,i[10]=d*u+f*s,t!==i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6]),i}let F=k,te=A;function ne(t,n){let r=n??new e(12);return r[0]=t[0],r[1]=0,r[2]=0,r[4]=0,r[5]=t[1],r[6]=0,r[8]=0,r[9]=0,r[10]=1,r}function re(t,n,r){let i=r??new e(12),a=n[0],o=n[1];return i[0]=a*t[0],i[1]=a*t[1],i[2]=a*t[2],i[4]=o*t[4],i[5]=o*t[5],i[6]=o*t[6],t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10]),i}function ie(t,n){let r=n??new e(12);return r[0]=t[0],r[1]=0,r[2]=0,r[4]=0,r[5]=t[1],r[6]=0,r[8]=0,r[9]=0,r[10]=t[2],r}function ae(t,n,r){let i=r??new e(12),a=n[0],o=n[1],s=n[2];return i[0]=a*t[0],i[1]=a*t[1],i[2]=a*t[2],i[4]=o*t[4],i[5]=o*t[5],i[6]=o*t[6],i[8]=s*t[8],i[9]=s*t[9],i[10]=s*t[10],i}function oe(t,n){let r=n??new e(12);return r[0]=t,r[1]=0,r[2]=0,r[4]=0,r[5]=t,r[6]=0,r[8]=0,r[9]=0,r[10]=1,r}function se(t,n,r){let i=r??new e(12);return i[0]=n*t[0],i[1]=n*t[1],i[2]=n*t[2],i[4]=n*t[4],i[5]=n*t[5],i[6]=n*t[6],t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10]),i}function ce(t,n){let r=n??new e(12);return r[0]=t,r[1]=0,r[2]=0,r[4]=0,r[5]=t,r[6]=0,r[8]=0,r[9]=0,r[10]=t,r}function le(t,n,r){let i=r??new e(12);return i[0]=n*t[0],i[1]=n*t[1],i[2]=n*t[2],i[4]=n*t[4],i[5]=n*t[5],i[6]=n*t[6],i[8]=n*t[8],i[9]=n*t[9],i[10]=n*t[10],i}return{add:u,clone:f,copy:d,create:r,determinant:v,equals:m,equalsApproximately:p,fromMat4:a,fromQuat:o,get3DScaling:ee,getAxis:w,getScaling:E,getTranslation:C,identity:h,inverse:_,invert:y,mul:x,mulScalar:l,multiply:b,multiplyScalar:c,negate:s,rotate:A,rotateX:M,rotateY:P,rotateZ:te,rotation:k,rotationX:j,rotationY:N,rotationZ:F,scale:re,scale3D:ae,scaling:ne,scaling3D:ie,set:i,setAxis:T,setTranslation:S,translate:O,translation:D,transpose:g,uniformScale:se,uniformScale3D:le,uniformScaling:oe,uniformScaling3D:ce}}var yn=new Map;function bn(e){let t=yn.get(e);return t||(t=vn(e),yn.set(e,t)),t}function xn(e){let t=_n(e);function n(t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g){let _=new e(16);return t!==void 0&&(_[0]=t,n!==void 0&&(_[1]=n,r!==void 0&&(_[2]=r,i!==void 0&&(_[3]=i,a!==void 0&&(_[4]=a,o!==void 0&&(_[5]=o,s!==void 0&&(_[6]=s,c!==void 0&&(_[7]=c,l!==void 0&&(_[8]=l,u!==void 0&&(_[9]=u,d!==void 0&&(_[10]=d,f!==void 0&&(_[11]=f,p!==void 0&&(_[12]=p,m!==void 0&&(_[13]=m,h!==void 0&&(_[14]=h,g!==void 0&&(_[15]=g)))))))))))))))),_}function r(t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g,_){let v=_??new e(16);return v[0]=t,v[1]=n,v[2]=r,v[3]=i,v[4]=a,v[5]=o,v[6]=s,v[7]=c,v[8]=l,v[9]=u,v[10]=d,v[11]=f,v[12]=p,v[13]=m,v[14]=h,v[15]=g,v}function i(t,n){let r=n??new e(16);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=0,r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=0,r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function a(t,n){let r=n??new e(16),i=t[0],a=t[1],o=t[2],s=t[3],c=i+i,l=a+a,u=o+o,d=i*c,f=a*c,p=a*l,m=o*c,h=o*l,g=o*u,_=s*c,v=s*l,y=s*u;return r[0]=1-p-g,r[1]=f+y,r[2]=m-v,r[3]=0,r[4]=f-y,r[5]=1-d-g,r[6]=h+_,r[7]=0,r[8]=m+v,r[9]=h-_,r[10]=1-d-p,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function o(t,n){let r=n??new e(16);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[3]=-t[3],r[4]=-t[4],r[5]=-t[5],r[6]=-t[6],r[7]=-t[7],r[8]=-t[8],r[9]=-t[9],r[10]=-t[10],r[11]=-t[11],r[12]=-t[12],r[13]=-t[13],r[14]=-t[14],r[15]=-t[15],r}function s(t,n,r){let i=r??new e(16);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i[3]=t[3]+n[3],i[4]=t[4]+n[4],i[5]=t[5]+n[5],i[6]=t[6]+n[6],i[7]=t[7]+n[7],i[8]=t[8]+n[8],i[9]=t[9]+n[9],i[10]=t[10]+n[10],i[11]=t[11]+n[11],i[12]=t[12]+n[12],i[13]=t[13]+n[13],i[14]=t[14]+n[14],i[15]=t[15]+n[15],i}function c(t,n,r){let i=r??new e(16);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[3]=t[3]*n,i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*n,i[7]=t[7]*n,i[8]=t[8]*n,i[9]=t[9]*n,i[10]=t[10]*n,i[11]=t[11]*n,i[12]=t[12]*n,i[13]=t[13]*n,i[14]=t[14]*n,i[15]=t[15]*n,i}let l=c;function u(t,n){let r=n??new e(16);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}let d=u;function f(e,t){return Math.abs(e[0]-t[0])<X&&Math.abs(e[1]-t[1])<X&&Math.abs(e[2]-t[2])<X&&Math.abs(e[3]-t[3])<X&&Math.abs(e[4]-t[4])<X&&Math.abs(e[5]-t[5])<X&&Math.abs(e[6]-t[6])<X&&Math.abs(e[7]-t[7])<X&&Math.abs(e[8]-t[8])<X&&Math.abs(e[9]-t[9])<X&&Math.abs(e[10]-t[10])<X&&Math.abs(e[11]-t[11])<X&&Math.abs(e[12]-t[12])<X&&Math.abs(e[13]-t[13])<X&&Math.abs(e[14]-t[14])<X&&Math.abs(e[15]-t[15])<X}function p(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function m(t){let n=t??new e(16);return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function h(t,n){let r=n??new e(16);if(r===t){let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,r}let i=t[0],a=t[1],o=t[2],s=t[3],c=t[4],l=t[5],u=t[6],d=t[7],f=t[8],p=t[9],m=t[10],h=t[11],g=t[12],_=t[13],v=t[14],y=t[15];return r[0]=i,r[1]=c,r[2]=f,r[3]=g,r[4]=a,r[5]=l,r[6]=p,r[7]=_,r[8]=o,r[9]=u,r[10]=m,r[11]=v,r[12]=s,r[13]=d,r[14]=h,r[15]=y,r}function g(t,n){let r=n??new e(16),i=t[0],a=t[1],o=t[2],s=t[3],c=t[4],l=t[5],u=t[6],d=t[7],f=t[8],p=t[9],m=t[10],h=t[11],g=t[12],_=t[13],v=t[14],y=t[15],b=m*y,x=v*h,S=u*y,C=v*d,w=u*h,T=m*d,E=o*y,ee=v*s,D=o*h,O=m*s,k=o*d,A=u*s,j=f*_,M=g*p,N=c*_,P=g*l,F=c*p,te=f*l,ne=i*_,re=g*a,ie=i*p,ae=f*a,oe=i*l,se=c*a,ce=b*l+C*p+w*_-(x*l+S*p+T*_),le=x*a+E*p+O*_-(b*a+ee*p+D*_),ue=S*a+ee*l+k*_-(C*a+E*l+A*_),I=T*a+D*l+A*p-(w*a+O*l+k*p),de=1/(i*ce+c*le+f*ue+g*I);return r[0]=de*ce,r[1]=de*le,r[2]=de*ue,r[3]=de*I,r[4]=de*(x*c+S*f+T*g-(b*c+C*f+w*g)),r[5]=de*(b*i+ee*f+D*g-(x*i+E*f+O*g)),r[6]=de*(C*i+E*c+A*g-(S*i+ee*c+k*g)),r[7]=de*(w*i+O*c+k*f-(T*i+D*c+A*f)),r[8]=de*(j*d+P*h+F*y-(M*d+N*h+te*y)),r[9]=de*(M*s+ne*h+ae*y-(j*s+re*h+ie*y)),r[10]=de*(N*s+re*d+oe*y-(P*s+ne*d+se*y)),r[11]=de*(te*s+ie*d+se*h-(F*s+ae*d+oe*h)),r[12]=de*(N*m+te*v+M*u-(F*v+j*u+P*m)),r[13]=de*(ie*v+j*o+re*m-(ne*m+ae*v+M*o)),r[14]=de*(ne*u+se*v+P*o-(oe*v+N*o+re*u)),r[15]=de*(oe*m+F*o+ae*u-(ie*u+se*m+te*o)),r}function _(e){let t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],c=e[7],l=e[8],u=e[9],d=e[10],f=e[11],p=e[12],m=e[13],h=e[14],g=e[15],_=d*g,v=h*f,y=s*g,b=h*c,x=s*f,S=d*c,C=r*g,w=h*i,T=r*f,E=d*i,ee=r*c,D=s*i,O=_*o+b*u+x*m-(v*o+y*u+S*m),k=v*n+C*u+E*m-(_*n+w*u+T*m),A=y*n+w*o+ee*m-(b*n+C*o+D*m),j=S*n+T*o+D*u-(x*n+E*o+ee*u);return t*O+a*k+l*A+p*j}let v=g;function y(t,n,r){let i=r??new e(16),a=t[0],o=t[1],s=t[2],c=t[3],l=t[4],u=t[5],d=t[6],f=t[7],p=t[8],m=t[9],h=t[10],g=t[11],_=t[12],v=t[13],y=t[14],b=t[15],x=n[0],S=n[1],C=n[2],w=n[3],T=n[4],E=n[5],ee=n[6],D=n[7],O=n[8],k=n[9],A=n[10],j=n[11],M=n[12],N=n[13],P=n[14],F=n[15];return i[0]=a*x+l*S+p*C+_*w,i[1]=o*x+u*S+m*C+v*w,i[2]=s*x+d*S+h*C+y*w,i[3]=c*x+f*S+g*C+b*w,i[4]=a*T+l*E+p*ee+_*D,i[5]=o*T+u*E+m*ee+v*D,i[6]=s*T+d*E+h*ee+y*D,i[7]=c*T+f*E+g*ee+b*D,i[8]=a*O+l*k+p*A+_*j,i[9]=o*O+u*k+m*A+v*j,i[10]=s*O+d*k+h*A+y*j,i[11]=c*O+f*k+g*A+b*j,i[12]=a*M+l*N+p*P+_*F,i[13]=o*M+u*N+m*P+v*F,i[14]=s*M+d*N+h*P+y*F,i[15]=c*M+f*N+g*P+b*F,i}let b=y;function x(e,t,n){let r=n??m();return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11]),r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function S(e,n){let r=n??t.create();return r[0]=e[12],r[1]=e[13],r[2]=e[14],r}function C(e,n,r){let i=r??t.create(),a=n*4;return i[0]=e[a+0],i[1]=e[a+1],i[2]=e[a+2],i}function w(e,t,n,r){let i=r===e?r:u(e,r),a=n*4;return i[a+0]=t[0],i[a+1]=t[1],i[a+2]=t[2],i}function T(e,n){let r=n??t.create(),i=e[0],a=e[1],o=e[2],s=e[4],c=e[5],l=e[6],u=e[8],d=e[9],f=e[10];return r[0]=Math.sqrt(i*i+a*a+o*o),r[1]=Math.sqrt(s*s+c*c+l*l),r[2]=Math.sqrt(u*u+d*d+f*f),r}function E(t,n,r,i,a){let o=a??new e(16),s=Math.tan(Math.PI*.5-.5*t);if(o[0]=s/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=s,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,Number.isFinite(i)){let e=1/(r-i);o[10]=i*e,o[14]=i*r*e}else o[10]=-1,o[14]=-r;return o}function ee(t,n,r,i=1/0,a){let o=a??new e(16),s=1/Math.tan(t*.5);if(o[0]=s/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=s,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,i===1/0)o[10]=0,o[14]=r;else{let e=1/(i-r);o[10]=r*e,o[14]=i*r*e}return o}function D(t,n,r,i,a,o,s){let c=s??new e(16);return c[0]=2/(n-t),c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=2/(i-r),c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=1/(a-o),c[11]=0,c[12]=(n+t)/(t-n),c[13]=(i+r)/(r-i),c[14]=a/(a-o),c[15]=1,c}function O(t,n,r,i,a,o,s){let c=s??new e(16),l=n-t,u=i-r,d=a-o;return c[0]=2*a/l,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=2*a/u,c[6]=0,c[7]=0,c[8]=(t+n)/l,c[9]=(i+r)/u,c[10]=o/d,c[11]=-1,c[12]=0,c[13]=0,c[14]=a*o/d,c[15]=0,c}function k(t,n,r,i,a,o=1/0,s){let c=s??new e(16),l=n-t,u=i-r;if(c[0]=2*a/l,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=2*a/u,c[6]=0,c[7]=0,c[8]=(t+n)/l,c[9]=(i+r)/u,c[11]=-1,c[12]=0,c[13]=0,c[15]=0,o===1/0)c[10]=0,c[14]=a;else{let e=1/(o-a);c[10]=a*e,c[14]=o*a*e}return c}let A=t.create(),j=t.create(),M=t.create();function N(n,r,i,a){let o=a??new e(16);return t.normalize(t.subtract(r,n,M),M),t.normalize(t.cross(i,M,A),A),t.normalize(t.cross(M,A,j),j),o[0]=A[0],o[1]=A[1],o[2]=A[2],o[3]=0,o[4]=j[0],o[5]=j[1],o[6]=j[2],o[7]=0,o[8]=M[0],o[9]=M[1],o[10]=M[2],o[11]=0,o[12]=n[0],o[13]=n[1],o[14]=n[2],o[15]=1,o}function P(n,r,i,a){let o=a??new e(16);return t.normalize(t.subtract(n,r,M),M),t.normalize(t.cross(i,M,A),A),t.normalize(t.cross(M,A,j),j),o[0]=A[0],o[1]=A[1],o[2]=A[2],o[3]=0,o[4]=j[0],o[5]=j[1],o[6]=j[2],o[7]=0,o[8]=M[0],o[9]=M[1],o[10]=M[2],o[11]=0,o[12]=n[0],o[13]=n[1],o[14]=n[2],o[15]=1,o}function F(n,r,i,a){let o=a??new e(16);return t.normalize(t.subtract(n,r,M),M),t.normalize(t.cross(i,M,A),A),t.normalize(t.cross(M,A,j),j),o[0]=A[0],o[1]=j[0],o[2]=M[0],o[3]=0,o[4]=A[1],o[5]=j[1],o[6]=M[1],o[7]=0,o[8]=A[2],o[9]=j[2],o[10]=M[2],o[11]=0,o[12]=-(A[0]*n[0]+A[1]*n[1]+A[2]*n[2]),o[13]=-(j[0]*n[0]+j[1]*n[1]+j[2]*n[2]),o[14]=-(M[0]*n[0]+M[1]*n[1]+M[2]*n[2]),o[15]=1,o}function te(t,n){let r=n??new e(16);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function ne(t,n,r){let i=r??new e(16),a=n[0],o=n[1],s=n[2],c=t[0],l=t[1],u=t[2],d=t[3],f=t[4],p=t[5],m=t[6],h=t[7],g=t[8],_=t[9],v=t[10],y=t[11],b=t[12],x=t[13],S=t[14],C=t[15];return t!==i&&(i[0]=c,i[1]=l,i[2]=u,i[3]=d,i[4]=f,i[5]=p,i[6]=m,i[7]=h,i[8]=g,i[9]=_,i[10]=v,i[11]=y),i[12]=c*a+f*o+g*s+b,i[13]=l*a+p*o+_*s+x,i[14]=u*a+m*o+v*s+S,i[15]=d*a+h*o+y*s+C,i}function re(t,n){let r=n??new e(16),i=Math.cos(t),a=Math.sin(t);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=i,r[6]=a,r[7]=0,r[8]=0,r[9]=-a,r[10]=i,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function ie(t,n,r){let i=r??new e(16),a=t[4],o=t[5],s=t[6],c=t[7],l=t[8],u=t[9],d=t[10],f=t[11],p=Math.cos(n),m=Math.sin(n);return i[4]=p*a+m*l,i[5]=p*o+m*u,i[6]=p*s+m*d,i[7]=p*c+m*f,i[8]=p*l-m*a,i[9]=p*u-m*o,i[10]=p*d-m*s,i[11]=p*f-m*c,t!==i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i}function ae(t,n){let r=n??new e(16),i=Math.cos(t),a=Math.sin(t);return r[0]=i,r[1]=0,r[2]=-a,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=a,r[9]=0,r[10]=i,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function oe(t,n,r){let i=r??new e(16),a=t[0],o=t[1],s=t[2],c=t[3],l=t[8],u=t[9],d=t[10],f=t[11],p=Math.cos(n),m=Math.sin(n);return i[0]=p*a-m*l,i[1]=p*o-m*u,i[2]=p*s-m*d,i[3]=p*c-m*f,i[8]=p*l+m*a,i[9]=p*u+m*o,i[10]=p*d+m*s,i[11]=p*f+m*c,t!==i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i}function se(t,n){let r=n??new e(16),i=Math.cos(t),a=Math.sin(t);return r[0]=i,r[1]=a,r[2]=0,r[3]=0,r[4]=-a,r[5]=i,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function ce(t,n,r){let i=r??new e(16),a=t[0],o=t[1],s=t[2],c=t[3],l=t[4],u=t[5],d=t[6],f=t[7],p=Math.cos(n),m=Math.sin(n);return i[0]=p*a+m*l,i[1]=p*o+m*u,i[2]=p*s+m*d,i[3]=p*c+m*f,i[4]=p*l-m*a,i[5]=p*u-m*o,i[6]=p*d-m*s,i[7]=p*f-m*c,t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i}function le(t,n,r){let i=r??new e(16),a=t[0],o=t[1],s=t[2],c=Math.sqrt(a*a+o*o+s*s);a/=c,o/=c,s/=c;let l=a*a,u=o*o,d=s*s,f=Math.cos(n),p=Math.sin(n),m=1-f;return i[0]=l+(1-l)*f,i[1]=a*o*m+s*p,i[2]=a*s*m-o*p,i[3]=0,i[4]=a*o*m-s*p,i[5]=u+(1-u)*f,i[6]=o*s*m+a*p,i[7]=0,i[8]=a*s*m+o*p,i[9]=o*s*m-a*p,i[10]=d+(1-d)*f,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}let ue=le;function I(t,n,r,i){let a=i??new e(16),o=n[0],s=n[1],c=n[2],l=Math.sqrt(o*o+s*s+c*c);o/=l,s/=l,c/=l;let u=o*o,d=s*s,f=c*c,p=Math.cos(r),m=Math.sin(r),h=1-p,g=u+(1-u)*p,_=o*s*h+c*m,v=o*c*h-s*m,y=o*s*h-c*m,b=d+(1-d)*p,x=s*c*h+o*m,S=o*c*h+s*m,C=s*c*h-o*m,w=f+(1-f)*p,T=t[0],E=t[1],ee=t[2],D=t[3],O=t[4],k=t[5],A=t[6],j=t[7],M=t[8],N=t[9],P=t[10],F=t[11];return a[0]=g*T+_*O+v*M,a[1]=g*E+_*k+v*N,a[2]=g*ee+_*A+v*P,a[3]=g*D+_*j+v*F,a[4]=y*T+b*O+x*M,a[5]=y*E+b*k+x*N,a[6]=y*ee+b*A+x*P,a[7]=y*D+b*j+x*F,a[8]=S*T+C*O+w*M,a[9]=S*E+C*k+w*N,a[10]=S*ee+C*A+w*P,a[11]=S*D+C*j+w*F,t!==a&&(a[12]=t[12],a[13]=t[13],a[14]=t[14],a[15]=t[15]),a}let de=I;function fe(t,n){let r=n??new e(16);return r[0]=t[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function pe(t,n,r){let i=r??new e(16),a=n[0],o=n[1],s=n[2];return i[0]=a*t[0],i[1]=a*t[1],i[2]=a*t[2],i[3]=a*t[3],i[4]=o*t[4],i[5]=o*t[5],i[6]=o*t[6],i[7]=o*t[7],i[8]=s*t[8],i[9]=s*t[9],i[10]=s*t[10],i[11]=s*t[11],t!==i&&(i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i}function me(t,n){let r=n??new e(16);return r[0]=t,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function he(t,n,r){let i=r??new e(16);return i[0]=n*t[0],i[1]=n*t[1],i[2]=n*t[2],i[3]=n*t[3],i[4]=n*t[4],i[5]=n*t[5],i[6]=n*t[6],i[7]=n*t[7],i[8]=n*t[8],i[9]=n*t[9],i[10]=n*t[10],i[11]=n*t[11],t!==i&&(i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i}return{add:s,aim:N,axisRotate:I,axisRotation:le,cameraAim:P,clone:d,copy:u,create:n,determinant:_,equals:p,equalsApproximately:f,fromMat3:i,fromQuat:a,frustum:O,frustumReverseZ:k,getAxis:C,getScaling:T,getTranslation:S,identity:m,inverse:g,invert:v,lookAt:F,mul:b,mulScalar:l,multiply:y,multiplyScalar:c,negate:o,ortho:D,perspective:E,perspectiveReverseZ:ee,rotate:de,rotateX:ie,rotateY:oe,rotateZ:ce,rotation:ue,rotationX:re,rotationY:ae,rotationZ:se,scale:pe,scaling:fe,set:r,setAxis:w,setTranslation:x,translate:ne,translation:te,transpose:h,uniformScale:he,uniformScaling:me}}var Sn=new Map;function Cn(e){let t=Sn.get(e);return t||(t=xn(e),Sn.set(e,t)),t}function wn(e){let t=_n(e);function n(t,n,r,i){let a=new e(4);return t!==void 0&&(a[0]=t,n!==void 0&&(a[1]=n,r!==void 0&&(a[2]=r,i!==void 0&&(a[3]=i)))),a}let r=n;function i(t,n,r,i,a){let o=a??new e(4);return o[0]=t,o[1]=n,o[2]=r,o[3]=i,o}function a(t,n,r){let i=r??new e(4),a=n*.5,o=Math.sin(a);return i[0]=o*t[0],i[1]=o*t[1],i[2]=o*t[2],i[3]=Math.cos(a),i}function o(e,n){let r=n??t.create(3),i=Math.acos(e[3])*2,a=Math.sin(i*.5);return a>X?(r[0]=e[0]/a,r[1]=e[1]/a,r[2]=e[2]/a):(r[0]=1,r[1]=0,r[2]=0),{angle:i,axis:r}}function s(e,t){let n=E(e,t);return Math.acos(2*n*n-1)}function c(t,n,r){let i=r??new e(4),a=t[0],o=t[1],s=t[2],c=t[3],l=n[0],u=n[1],d=n[2],f=n[3];return i[0]=a*f+c*l+o*d-s*u,i[1]=o*f+c*u+s*l-a*d,i[2]=s*f+c*d+a*u-o*l,i[3]=c*f-a*l-o*u-s*d,i}let l=c;function u(t,n,r){let i=r??new e(4),a=n*.5,o=t[0],s=t[1],c=t[2],l=t[3],u=Math.sin(a),d=Math.cos(a);return i[0]=o*d+l*u,i[1]=s*d+c*u,i[2]=c*d-s*u,i[3]=l*d-o*u,i}function d(t,n,r){let i=r??new e(4),a=n*.5,o=t[0],s=t[1],c=t[2],l=t[3],u=Math.sin(a),d=Math.cos(a);return i[0]=o*d-c*u,i[1]=s*d+l*u,i[2]=c*d+o*u,i[3]=l*d-s*u,i}function f(t,n,r){let i=r??new e(4),a=n*.5,o=t[0],s=t[1],c=t[2],l=t[3],u=Math.sin(a),d=Math.cos(a);return i[0]=o*d+s*u,i[1]=s*d-o*u,i[2]=c*d+l*u,i[3]=l*d-c*u,i}function p(t,n,r,i){let a=i??new e(4),o=t[0],s=t[1],c=t[2],l=t[3],u=n[0],d=n[1],f=n[2],p=n[3],m=o*u+s*d+c*f+l*p;m<0&&(m=-m,u=-u,d=-d,f=-f,p=-p);let h,g;if(1-m>X){let e=Math.acos(m),t=Math.sin(e);h=Math.sin((1-r)*e)/t,g=Math.sin(r*e)/t}else h=1-r,g=r;return a[0]=h*o+g*u,a[1]=h*s+g*d,a[2]=h*c+g*f,a[3]=h*l+g*p,a}function m(t,n){let r=n??new e(4),i=t[0],a=t[1],o=t[2],s=t[3],c=i*i+a*a+o*o+s*s,l=c?1/c:0;return r[0]=-i*l,r[1]=-a*l,r[2]=-o*l,r[3]=s*l,r}function h(t,n){let r=n??new e(4);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[3]=t[3],r}function g(t,n){let r=n??new e(4),i=t[0]+t[5]+t[10];if(i>0){let e=Math.sqrt(i+1);r[3]=.5*e;let n=.5/e;r[0]=(t[6]-t[9])*n,r[1]=(t[8]-t[2])*n,r[2]=(t[1]-t[4])*n}else{let e=0;t[5]>t[0]&&(e=1),t[10]>t[e*4+e]&&(e=2);let n=(e+1)%3,i=(e+2)%3,a=Math.sqrt(t[e*4+e]-t[n*4+n]-t[i*4+i]+1);r[e]=.5*a;let o=.5/a;r[3]=(t[n*4+i]-t[i*4+n])*o,r[n]=(t[n*4+e]+t[e*4+n])*o,r[i]=(t[i*4+e]+t[e*4+i])*o}return r}function _(t,n,r,i,a){let o=a??new e(4),s=t*.5,c=n*.5,l=r*.5,u=Math.sin(s),d=Math.cos(s),f=Math.sin(c),p=Math.cos(c),m=Math.sin(l),h=Math.cos(l);switch(i){case`xyz`:o[0]=u*p*h+d*f*m,o[1]=d*f*h-u*p*m,o[2]=d*p*m+u*f*h,o[3]=d*p*h-u*f*m;break;case`xzy`:o[0]=u*p*h-d*f*m,o[1]=d*f*h-u*p*m,o[2]=d*p*m+u*f*h,o[3]=d*p*h+u*f*m;break;case`yxz`:o[0]=u*p*h+d*f*m,o[1]=d*f*h-u*p*m,o[2]=d*p*m-u*f*h,o[3]=d*p*h+u*f*m;break;case`yzx`:o[0]=u*p*h+d*f*m,o[1]=d*f*h+u*p*m,o[2]=d*p*m-u*f*h,o[3]=d*p*h-u*f*m;break;case`zxy`:o[0]=u*p*h-d*f*m,o[1]=d*f*h+u*p*m,o[2]=d*p*m+u*f*h,o[3]=d*p*h-u*f*m;break;case`zyx`:o[0]=u*p*h-d*f*m,o[1]=d*f*h+u*p*m,o[2]=d*p*m-u*f*h,o[3]=d*p*h+u*f*m;break;default:throw Error(`Unknown rotation order: ${i}`)}return o}function v(t,n){let r=n??new e(4);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r}let y=v;function b(t,n,r){let i=r??new e(4);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i[3]=t[3]+n[3],i}function x(t,n,r){let i=r??new e(4);return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],i[3]=t[3]-n[3],i}let S=x;function C(t,n,r){let i=r??new e(4);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[3]=t[3]*n,i}let w=C;function T(t,n,r){let i=r??new e(4);return i[0]=t[0]/n,i[1]=t[1]/n,i[2]=t[2]/n,i[3]=t[3]/n,i}function E(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function ee(t,n,r,i){let a=i??new e(4);return a[0]=t[0]+r*(n[0]-t[0]),a[1]=t[1]+r*(n[1]-t[1]),a[2]=t[2]+r*(n[2]-t[2]),a[3]=t[3]+r*(n[3]-t[3]),a}function D(e){let t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)}let O=D;function k(e){let t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i}let A=k;function j(t,n){let r=n??new e(4),i=t[0],a=t[1],o=t[2],s=t[3],c=Math.sqrt(i*i+a*a+o*o+s*s);return c>1e-5?(r[0]=i/c,r[1]=a/c,r[2]=o/c,r[3]=s/c):(r[0]=0,r[1]=0,r[2]=0,r[3]=1),r}function M(e,t){return Math.abs(e[0]-t[0])<X&&Math.abs(e[1]-t[1])<X&&Math.abs(e[2]-t[2])<X&&Math.abs(e[3]-t[3])<X}function N(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function P(t){let n=t??new e(4);return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}let F=t.create(),te=t.create(),ne=t.create();function re(n,r,i){let o=i??new e(4),s=t.dot(n,r);return s<-.999999?(t.cross(te,n,F),t.len(F)<1e-6&&t.cross(ne,n,F),t.normalize(F,F),a(F,Math.PI,o),o):s>.999999?(o[0]=0,o[1]=0,o[2]=0,o[3]=1,o):(t.cross(n,r,F),o[0]=F[0],o[1]=F[1],o[2]=F[2],o[3]=1+s,j(o,o))}let ie=new e(4),ae=new e(4);function oe(t,n,r,i,a,o){let s=o??new e(4);return p(t,i,a,ie),p(n,r,a,ae),p(ie,ae,2*a*(1-a),s),s}return{create:n,fromValues:r,set:i,fromAxisAngle:a,toAxisAngle:o,angle:s,multiply:c,mul:l,rotateX:u,rotateY:d,rotateZ:f,slerp:p,inverse:m,conjugate:h,fromMat:g,fromEuler:_,copy:v,clone:y,add:b,subtract:x,sub:S,mulScalar:C,scale:w,divScalar:T,dot:E,lerp:ee,length:D,len:O,lengthSq:k,lenSq:A,normalize:j,equalsApproximately:M,equals:N,identity:P,rotationTo:re,sqlerp:oe}}var Tn=new Map;function En(e){let t=Tn.get(e);return t||(t=wn(e),Tn.set(e,t)),t}function Dn(e){function t(t,n,r,i){let a=new e(4);return t!==void 0&&(a[0]=t,n!==void 0&&(a[1]=n,r!==void 0&&(a[2]=r,i!==void 0&&(a[3]=i)))),a}let n=t;function r(t,n,r,i,a){let o=a??new e(4);return o[0]=t,o[1]=n,o[2]=r,o[3]=i,o}function i(t,n){let r=n??new e(4);return r[0]=Math.ceil(t[0]),r[1]=Math.ceil(t[1]),r[2]=Math.ceil(t[2]),r[3]=Math.ceil(t[3]),r}function a(t,n){let r=n??new e(4);return r[0]=Math.floor(t[0]),r[1]=Math.floor(t[1]),r[2]=Math.floor(t[2]),r[3]=Math.floor(t[3]),r}function o(t,n){let r=n??new e(4);return r[0]=Math.round(t[0]),r[1]=Math.round(t[1]),r[2]=Math.round(t[2]),r[3]=Math.round(t[3]),r}function s(t,n=0,r=1,i){let a=i??new e(4);return a[0]=Math.min(r,Math.max(n,t[0])),a[1]=Math.min(r,Math.max(n,t[1])),a[2]=Math.min(r,Math.max(n,t[2])),a[3]=Math.min(r,Math.max(n,t[3])),a}function c(t,n,r){let i=r??new e(4);return i[0]=t[0]+n[0],i[1]=t[1]+n[1],i[2]=t[2]+n[2],i[3]=t[3]+n[3],i}function l(t,n,r,i){let a=i??new e(4);return a[0]=t[0]+n[0]*r,a[1]=t[1]+n[1]*r,a[2]=t[2]+n[2]*r,a[3]=t[3]+n[3]*r,a}function u(t,n,r){let i=r??new e(4);return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],i[3]=t[3]-n[3],i}let d=u;function f(e,t){return Math.abs(e[0]-t[0])<X&&Math.abs(e[1]-t[1])<X&&Math.abs(e[2]-t[2])<X&&Math.abs(e[3]-t[3])<X}function p(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function m(t,n,r,i){let a=i??new e(4);return a[0]=t[0]+r*(n[0]-t[0]),a[1]=t[1]+r*(n[1]-t[1]),a[2]=t[2]+r*(n[2]-t[2]),a[3]=t[3]+r*(n[3]-t[3]),a}function h(t,n,r,i){let a=i??new e(4);return a[0]=t[0]+r[0]*(n[0]-t[0]),a[1]=t[1]+r[1]*(n[1]-t[1]),a[2]=t[2]+r[2]*(n[2]-t[2]),a[3]=t[3]+r[3]*(n[3]-t[3]),a}function g(t,n,r){let i=r??new e(4);return i[0]=Math.max(t[0],n[0]),i[1]=Math.max(t[1],n[1]),i[2]=Math.max(t[2],n[2]),i[3]=Math.max(t[3],n[3]),i}function _(t,n,r){let i=r??new e(4);return i[0]=Math.min(t[0],n[0]),i[1]=Math.min(t[1],n[1]),i[2]=Math.min(t[2],n[2]),i[3]=Math.min(t[3],n[3]),i}function v(t,n,r){let i=r??new e(4);return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[3]=t[3]*n,i}let y=v;function b(t,n,r){let i=r??new e(4);return i[0]=t[0]/n,i[1]=t[1]/n,i[2]=t[2]/n,i[3]=t[3]/n,i}function x(t,n){let r=n??new e(4);return r[0]=1/t[0],r[1]=1/t[1],r[2]=1/t[2],r[3]=1/t[3],r}let S=x;function C(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function w(e){let t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)}let T=w;function E(e){let t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i}let ee=E;function D(e,t){let n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],a=e[3]-t[3];return Math.sqrt(n*n+r*r+i*i+a*a)}let O=D;function k(e,t){let n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],a=e[3]-t[3];return n*n+r*r+i*i+a*a}let A=k;function j(t,n){let r=n??new e(4),i=t[0],a=t[1],o=t[2],s=t[3],c=Math.sqrt(i*i+a*a+o*o+s*s);return c>1e-5?(r[0]=i/c,r[1]=a/c,r[2]=o/c,r[3]=s/c):(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function M(t,n){let r=n??new e(4);return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[3]=-t[3],r}function N(t,n){let r=n??new e(4);return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r}let P=N;function F(t,n,r){let i=r??new e(4);return i[0]=t[0]*n[0],i[1]=t[1]*n[1],i[2]=t[2]*n[2],i[3]=t[3]*n[3],i}let te=F;function ne(t,n,r){let i=r??new e(4);return i[0]=t[0]/n[0],i[1]=t[1]/n[1],i[2]=t[2]/n[2],i[3]=t[3]/n[3],i}let re=ne;function ie(t){let n=t??new e(4);return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n}function ae(t,n,r){let i=r??new e(4),a=t[0],o=t[1],s=t[2],c=t[3];return i[0]=n[0]*a+n[4]*o+n[8]*s+n[12]*c,i[1]=n[1]*a+n[5]*o+n[9]*s+n[13]*c,i[2]=n[2]*a+n[6]*o+n[10]*s+n[14]*c,i[3]=n[3]*a+n[7]*o+n[11]*s+n[15]*c,i}function oe(t,n,r){let i=r??new e(4);return j(t,i),v(i,n,i)}function se(t,n,r){let i=r??new e(4);return w(t)>n?oe(t,n,i):N(t,i)}function ce(t,n,r){return m(t,n,.5,r??new e(4))}return{create:t,fromValues:n,set:r,ceil:i,floor:a,round:o,clamp:s,add:c,addScaled:l,subtract:u,sub:d,equalsApproximately:f,equals:p,lerp:m,lerpV:h,max:g,min:_,mulScalar:v,scale:y,divScalar:b,inverse:x,invert:S,dot:C,length:w,len:T,lengthSq:E,lenSq:ee,distance:D,dist:O,distanceSq:k,distSq:A,normalize:j,negate:M,copy:N,clone:P,multiply:F,mul:te,divide:ne,div:re,zero:ie,transformMat4:ae,setLength:oe,truncate:se,midpoint:ce}}var On=new Map;function kn(e){let t=On.get(e);return t||(t=Dn(e),On.set(e,t)),t}function An(e,t,n,r,i,a){return{mat3:bn(e),mat4:Cn(t),quat:En(n),vec2:mn(r),vec3:_n(i),vec4:kn(a)}}var{mat3:Z,mat4:Q,quat:jn,vec2:Mn,vec3:Nn,vec4:Pn}=An(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat3:Fn,mat4:In,quat:Ln,vec2:Rn,vec3:zn,vec4:Bn}=An(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat3:Vn,mat4:Hn,quat:Un,vec2:Wn,vec3:Gn,vec4:Kn}=An(rn,Array,Array,Array,Array,Array),qn={Clamp:(e,t=0,n=1)=>Math.max(t,Math.min(e,n)),RandomInt:(e,t)=>(Math.random()*(t-e+1)|0)+e,Random:(e=0,t=1)=>Math.random()*(t-e)+e,SmootherStep(e,t=0,n=1){return e<=t?0:e>=n?1:(e=(e-t)/(n-t),e*e*e*(e*(e*6-15)+10))},SmoothStep(e,t=0,n=1){return e<=t?0:e>=n?1:(e=(e-t)/(n-t),e*e*(3-2*e))},EuclideanModulo:dn.euclideanModulo,DegreesToRadians:dn.degToRad,RadiansToDegrees:dn.radToDeg,InverseLerp:dn.inverseLerp,SetEpsilon:dn.setEpsilon,EPSILON:dn.EPSILON,Lerp:dn.lerp,PHI:Math.sqrt(5)*.5+.5,DELTA_UPDATE:1/.06,DELTA_FRAME:1/60,RAD:Math.PI/180,DEG:180/Math.PI,HPI:Math.PI/2,TAU:Math.PI*2,Mat3:Z,Mat4:Q,Quat:jn,Vec2:Mn,Vec3:Nn,Vec4:Pn},Jn=class e{#e=0;#t=0;#n=0;#r=1;constructor(e=0,t,n,r=255){typeof t==`number`&&typeof n==`number`?this.RGBA=[e,t,n,r]:this.Set(e,r)}Set(e,t=255){let n=nr(e,t);return this.#e=n[0],this.#t=n[1],this.#n=n[2],this.#r=n[3],this}Premultiply(t,n){return n??=new e,t??=this.#r,n.rgba=[this.#e*t,this.#t*t,this.#n*t,t],n}Random(e=1){return this.rgb=[qn.Random(),qn.Random(),qn.Random(),e??qn.Random()],this}Equals(e){let[t,n,r,i=1]=typeof e==`number`&&nr(e)||tr(e);return this.#e===t&&this.#t===n&&this.#n===r&&this.#r===i}set rgb(e){this.#e=e[0],this.#t=e[1],this.#n=e[2],this.#r=e[3]??1}get rgb(){return[this.#e,this.#t,this.#n]}set a(e){this.#r=e}get a(){return this.#r}set rgba(e){this.rgb=e}get rgba(){return this.rgb.concat(this.#r)}set RGB(e){this.#e=e[0]/255,this.#t=e[1]/255,this.#n=e[2]/255,this.#r=(e[3]??255)/255}get RGB(){return[this.#e*255,this.#t*255,this.#n*255]}set A(e){this.#r=e/255}get A(){return this.#r*255}set RGBA(e){this.RGB=e}get RGBA(){return this.RGB.concat(this.A)}};function Yn(e){for(let t in e)e[t]={value:e[t]};return Object.freeze(Object.create(null,e))}function Xn(e){switch(e){case 2:return`unorm8x2`;case 4:return`float32`;case 8:return`float32x2`;case 12:return`float32x3`;case 16:return`float32x4`}return``}function Zn(e){switch(e){case`uint8x2`:case`sint8x2`:case`unorm8x2`:case`snorm8x2`:return 2;case`uint32`:case`sint32`:case`float32`:case`uint8x4`:case`sint8x4`:case`unorm8x4`:case`snorm8x4`:case`uint16x2`:case`sint16x2`:case`unorm16x2`:case`snorm16x2`:case`float16x2`:return 4;case`uint16x4`:case`sint16x4`:case`uint32x2`:case`sint32x2`:case`unorm16x4`:case`snorm16x4`:case`float16x4`:case`float32x2`:return 8;case`uint32x3`:case`sint32x3`:case`float32x3`:return 12;case`uint32x4`:case`sint32x4`:case`float32x4`:return 16}return 0}function Qn(e){return e===`f16`||e.includes(`h`)?`f16`:e.includes(`f`)?`f32`:e.includes(`u`)?`u32`:`i32`}function $n(e){return e.slice(1)/8}function er(e){return e===`f16`?Float16Array:e===`f32`?Float32Array:e===`u32`?Uint32Array:Int32Array}function $(e){return Array.isArray(e)&&e||[e]}function tr(e){return e instanceof Jn&&e.rgba||Object.values(e)}function nr(e,t=255){return[(e>>16&255)/255,(e>>8&255)/255,(e&255)/255,t/255]}function rr(e){return e instanceof GPUShaderModule&&e||e.module}function ir(e,t){return e.createBuffer(t)}function ar(e,t,n,r=0,i,a){e.writeBuffer(t,r,n,i,a)}function or(e,t,n,r,i,a){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e[4]=a,a!==void 0&&(e[3]=a,e[4]=i),e}const sr=Yn({INDEX:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,VERTEX:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,STORAGE:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,UNIFORM:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,READABLE:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST,WRITABLE:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,QUERY:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC});var cr={operation:`add`,srcFactor:`one`,dstFactor:`zero`},lr={operation:`add`,srcFactor:`one`,dstFactor:`one`},ur={operation:`add`,srcFactor:`one`,dstFactor:`one-minus-src-alpha`},dr={operation:`add`,srcFactor:`one-minus-dst-alpha`,dstFactor:`one`},fr={operation:`add`,srcFactor:`dst-alpha`,dstFactor:`zero`},pr={operation:`add`,srcFactor:`zero`,dstFactor:`src-alpha`},mr={operation:`add`,srcFactor:`one-minus-dst-alpha`,dstFactor:`zero`},hr={operation:`add`,srcFactor:`zero`,dstFactor:`one-minus-src-alpha`},gr={operation:`add`,srcFactor:`src-alpha`,dstFactor:`one-minus-src-alpha`},_r={operation:`add`,srcFactor:`dst-alpha`,dstFactor:`one-minus-src-alpha`},vr={operation:`add`,srcFactor:`one-minus-dst-alpha`,dstFactor:`src-alpha`};const yr=Yn({COPY:Yn({color:cr,alpha:cr}),ADDITIVE:Yn({color:lr,alpha:lr}),SOURCE_OVER:Yn({color:ur,alpha:ur}),DESTINATION_OVER:Yn({color:dr,alpha:dr}),SOURCE_IN:Yn({color:fr,alpha:fr}),DESTINATION_IN:Yn({color:pr,alpha:pr}),SOURCE_OUT:Yn({color:mr,alpha:mr}),DESTINATION_OUT:Yn({color:hr,alpha:hr}),ALPHA_ADDITIVE:Yn({color:gr,alpha:lr}),SOURCE_ATOP:Yn({color:_r,alpha:_r}),DESTINATION_ATOP:Yn({color:vr,alpha:vr})});var br=class{Children=[];Label;RotationOrder=`XYZ`;TransformationOrder=`TRS`;#e=null;ProjectionMatrix=Q.identity();#t=Q.identity();#n=Q.identity();#r=Nn.set(1,1,1);#i=Nn.create();#a=Nn.create();constructor(e,t=null){this.Label=e,this.Parent=t}Find(e){let t=null;return this.Traverse(n=>n.Label===e&&(t=n)||!1),t}Add(e){e=$(e),e.forEach(e=>e.Parent=this)}Remove(e){e=$(e),e.forEach(e=>e.Parent=null)}Traverse(e){if(!e(this))for(let t=0,n=this.Children.length;t<n;++t)this.Children[t].Traverse(e)}ResetLocalMatrix(){Q.identity(this.#t)}UpdateWorldMatrix(){this.#o(),this.#e?Q.multiply(this.#e.WorldMatrix,this.#t,this.#n):Q.copy(this.#t,this.#n),this.Children.forEach(e=>e.UpdateWorldMatrix())}#o(){Q.identity(this.#t);let e=this.TransformationOrder.split(``);for(let t=0,n=e.length;t<n;t++)switch(e[t]){case`T`:Q.translate(this.#t,this.#i,this.#t);break;case`R`:for(let e=0,t=this.RotationOrder.length;e<t;++e){let t=this.RotationOrder[e],n=this.#a[t.charCodeAt(0)-88];Q[`rotate${t}`](this.#t,n,this.#t)}break;case`S`:Q.scale(this.#t,this.#r,this.#t);break}}UpdateProjectionMatrix(e){let t=this.#e&&this.#n||this.#t;return Q.multiply(e,t,this.ProjectionMatrix)}ResetProjectionMatrix(){Q.identity(this.ProjectionMatrix)}RotateAxis(e,t){Q.rotate(this.#t,e,t,this.#t)}RotateX(e){Q.rotateX(this.#t,e,this.#t)}RotateY(e){Q.rotateY(this.#t,e,this.#t)}RotateZ(e){Q.rotateZ(this.#t,e,this.#t)}Scale(e){Q.scale(this.#t,e,this.#t)}set Transform(e){Q.identity(this.#t);let[t,n,r]=e,i=this.TransformationOrder.split(``);for(let e=0,a=i.length;e<a;e++)switch(i[e]){case`T`:t&&(this.Position=t);break;case`R`:n&&(this.Rotation=n);break;case`S`:r&&(this.Scaling=r);break}}set Position(e){Nn.copy(e,this.#i),Q.translate(this.#t,e,this.#t)}get Position(){return this.#i}set Rotation(e){Nn.copy(e,this.#a);for(let t=0,n=this.RotationOrder.length;t<n;++t){let n=this.RotationOrder[t],r=e[n.charCodeAt(0)-88];Q[`rotate${n}`](this.#t,r,this.#t)}}get Rotation(){return this.#a}set Scaling(e){Nn.copy(e,this.#r),Q.scale(this.#t,e,this.#t)}get Scaling(){return this.#r}get LocalMatrix(){return this.#t}get WorldMatrix(){return this.#n}set Parent(e){if(this.#e){let e=this.#e.Children.indexOf(this);0<=e&&this.#e.Children.splice(e,1)}e&&e.Children.push(this),this.#e=e}get Parent(){return this.#e}},xr=class{#e;#t;#n;Transparent=!1;#r=crypto.randomUUID();#i;#a;#o=new Jn(0,0);constructor(e=16777215,t=`Mesh`){this.Color=e,this.#e=t}CreateColorBuffer(e,t=this.#e){let{color:n,buffer:r}=e.CreateUniformBuffer(`color`,{label:`${t} Color Buffer`});this.#t=n,this.#n=e,this.#a=r,this.#t.set(this.#i),e.WriteBuffer(r,n)}SetBlendConstant(e){if(!e?.BlendConstant||!this.#o.Equals(e.BlendConstant))return this.#n.BlendConstant=this.#o}set BlendConstant(e){typeof e==`number`&&this.#o.Set(e)||(this.#o.rgba=tr(e))}get BlendConstant(){return this.#o}get ColorBuffer(){return this.#a}set Color(e){this.#i=typeof e==`number`&&nr(e)||tr(e),this.#t?.fill(1).set(this.#i),this.#n?.WriteBuffer(this.#a,this.#t)}get Color(){return this.#i}get ID(){return this.#r}Destroy(){this.#n=void 0,this.#a?.destroy(),this.#a=void 0}},Sr=class extends br{#e;Visible=!0;#t;#n;#r;#i=[];constructor(e,t,n=`Mesh`,r=null){super(n,r),this.#e=e,this.#t=t===void 0&&new xr||t}SetRenderPipeline(e,t){this.#n=e,this.#e.CreateBuffers(e),this.#t?.CreateColorBuffer(e),this.#a(t)}#a(e,t){let{meshModelViewProjection:n,buffer:r}=this.#n.CreateUniformBuffer(`meshModelViewProjection`,{label:`${this.Label} Projection Buffer`,...t});this.ProjectionMatrix=Q.identity(n),this.#r=r,e=[r,this.#t?.ColorBuffer,...$(e)].filter(Boolean),this.#i=this.#n.SetBindGroupFromResources(e,0,0,`${this.Label} Bind Group`)}UpdateProjectionMatrix(e){let t=super.UpdateProjectionMatrix(e);return this.#n.WriteBuffer(this.#r,t),t}SetBindGroups(){!this.#n&&p(u.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `Mesh.SetRenderPipeline` method before setting its data."),this.#n.BindGroups=this.#i}get ProjectionBuffer(){return this.#r}get Geometry(){return this.#e}get Material(){return this.#t}get Pipeline(){return this.#n}Destroy(){this.#e.Destroy(),this.#t?.Destroy(),this.#n=void 0,this.#i.splice(0),this.#r?.destroy(),this.#r=void 0}},Cr=class{Children=[];Label;TransformationOrder=`TRS`;#e=null;ProjectionMatrix=Z.identity();#t=Z.identity();#n=Z.identity();#r=Mn.create();#i=Mn.set(1,1);#a=0;constructor(e,t=null){this.Label=e,this.Parent=t}Find(e){let t=null;return this.Traverse(n=>n.Label===e&&(t=n)||!1),t}Add(e){e=$(e),e.forEach(e=>e.Parent=this)}Remove(e){e=$(e),e.forEach(e=>e.Parent=null)}Traverse(e){if(!e(this))for(let t=0,n=this.Children.length;t<n;++t)this.Children[t].Traverse(e)}ResetLocalMatrix(){Z.identity(this.#t)}UpdateWorldMatrix(){this.UpdateLocalMatrix(),this.#e?Z.multiply(this.#e.WorldMatrix,this.#t,this.#n):Z.copy(this.#t,this.#n),this.Children.forEach(e=>e.UpdateWorldMatrix())}UpdateLocalMatrix(){Z.identity(this.#t);let e=this.TransformationOrder.split(``);for(let t=0,n=e.length;t<n;t++)switch(e[t]){case`T`:Z.translate(this.#t,this.#r,this.#t);break;case`R`:Z.rotate(this.#t,this.#a,this.#t);break;case`S`:Z.scale(this.#t,this.#i,this.#t);break}}UpdateProjectionMatrix(e){let t=this.#e&&this.#n||this.#t;return Z.multiply(e,t,this.ProjectionMatrix)}ResetProjectionMatrix(){Z.identity(this.ProjectionMatrix)}Rotate(e){Z.rotate(this.#t,e,this.#t)}Scale(e){Z.scale(this.#t,e,this.#t)}set Transform(e){Z.identity(this.#t);let[t,n,r]=e,i=this.TransformationOrder.split(``);for(let e=0,a=i.length;e<a;e++)switch(i[e]){case`T`:t&&(this.Position=t);break;case`R`:n!==void 0&&(this.Rotation=n);break;case`S`:r&&(this.Scaling=r);break}}set Position(e){Mn.copy(e,this.#r),Z.translate(this.#t,e,this.#t)}get Position(){return this.#r}set Rotation(e){this.#a=e,Z.rotate(this.#t,e,this.#t)}get Rotation(){return this.#a}set Scaling(e){Mn.copy(e,this.#i),Z.scale(this.#t,e,this.#t)}get Scaling(){return this.#i}get LocalMatrix(){return this.#t}get WorldMatrix(){return this.#n}set Parent(e){if(this.#e){let e=this.#e.Children.indexOf(this);0<=e&&this.#e.Children.splice(e,1)}e&&e.Children.push(this),this.#e=e}get Parent(){return this.#e}},wr=class{#e;#t;#n;Transparent=!1;#r=crypto.randomUUID();#i;#a;#o=new Jn(0,0);constructor(e=16777215,t=`Shape`){this.Color=e,this.#e=t}CreateColorBuffer(e,t=this.#e){let{color:n,buffer:r}=e.CreateUniformBuffer(`color`,{label:`${t} Color Buffer`});this.#t=n,this.#n=e,this.#a=r,this.#t.set(this.#i),e.WriteBuffer(r,n)}SetBlendConstant(e){if(!e?.BlendConstant||!this.#o.Equals(e.BlendConstant))return this.#n.BlendConstant=this.#o}set BlendConstant(e){typeof e==`number`&&this.#o.Set(e)||(this.#o.rgba=tr(e))}get BlendConstant(){return this.#o}get ColorBuffer(){return this.#a}set Color(e){this.#i=typeof e==`number`&&nr(e)||tr(e),this.#t?.fill(1).set(this.#i),this.#n?.WriteBuffer(this.#a,this.#t)}get Color(){return this.#i}get ID(){return this.#r}Destroy(){this.#n=void 0,this.#a?.destroy(),this.#a=void 0}},Tr=class extends Cr{#e;Visible=!0;#t;#n=Mn.set(0,0);#r=Mn.set(0,0);#i;#a;#o=Yn({min:Mn.create(),max:Mn.create()});#s=[];constructor(e,t,n=`Shape`,r=null){super(n,r),this.#e=e,this.#t=t===void 0&&new wr||t}SetRenderPipeline(e,t){this.#i=e,this.#e.CreateBuffers(e),this.#t?.CreateColorBuffer(e),this.#c(t)}#c(e,t){let{shapeModelViewProjection:n,buffer:r}=this.#i.CreateUniformBuffer(`shapeModelViewProjection`,{label:`${this.Label} Projection Buffer`,...t});this.ProjectionMatrix=Z.identity(n),this.#a=r,e=[r,this.#t?.ColorBuffer,...$(e)].filter(Boolean),this.#s=this.#i.SetBindGroupFromResources(e,0,0,`${this.Label} Bind Group`)}UpdateProjectionMatrix(e){let t=super.UpdateProjectionMatrix(e);return this.#i.WriteBuffer(this.#a,t),t}UpdateLocalMatrix(){super.UpdateLocalMatrix();let e=this.LocalMatrix,{Radius:t}=this.#e;this.#o.min[0]=e[8]-t,this.#o.min[1]=e[9]-t,this.#o.max[0]=e[8]+t,this.#o.max[1]=e[9]+t,Z.translate(e,this.#n,e),this.#r[0]=this.#n[0]+this.#o.max[0],this.#r[1]=this.#n[1]+this.#o.max[1]}SetBindGroups(){!this.#i&&p(u.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `Shape.SetRenderPipeline` method before setting its data."),this.#i.BindGroups=this.#s}get ProjectionBuffer(){return this.#a}set Origin(e){this.#n[0]=-e[0],this.#n[1]=-e[1];let t=this.LocalMatrix;Z.translate(t,e,t)}get Origin(){return this.#n}get Center(){return this.#r}get BoundingBox(){return this.#o}get Geometry(){return this.#e}get Material(){return this.#t}get Pipeline(){return this.#i}Destroy(){this.#e.Destroy(),this.#t?.Destroy(),this.#i=void 0,this.#s.splice(0),this.#a?.destroy(),this.#a=void 0}},Er=class{Label;Children=[];MainCamera;#e=new Set;#t=Q.identity();constructor(e=`Scene`){this.Label=e}Find(e){let t=null;if(this.Traverse(n=>n.Label===e&&(t=n)||!1),t)return t;for(let t of this.#e)if(t.Label===e)return t;return null}Add(e){e=$(e),e.forEach(e=>e.Parent=this)}Remove(e){e=$(e),e.forEach(e=>e.Parent=null)}AddCamera(e){this.#e.add(e),this.#e.size===1&&(this.MainCamera=e)}RemoveCamera(e){this.#e.delete(e),this.MainCamera===e&&(this.MainCamera=void 0)}Traverse(e){for(let t=0,n=this.Children.length;t<n;++t)this.Children[t].Traverse(e)}Destroy(){this.Traverse(e=>e.Destroy?.()),this.MainCamera=void 0,this.Children.splice(0),this.#e.clear()}UpdateWorldMatrix(){this.Children.forEach(e=>e.UpdateWorldMatrix())}get WorldMatrix(){return this.#t}},Dr=class{Label;DrawParams=[];#e=crypto.randomUUID();IndexFormat;VertexBuffers;IndexBuffer;constructor(e=`Mesh`,t){this.IndexFormat=t,this.Label=e}SetDrawParams(...e){return or(this.DrawParams,...e)}CreateVertexBuffer(e,t,n=this.Label){let r=e.CreateVertexBuffer(t,{label:`${n} Vertex Buffer`});e.WriteBuffer(r,t),this.VertexBuffers=e.SetVertexBuffers(r)}CreateIndexBuffer(e,t,n=this.Label){let r=e.CreateIndexBuffer(t,{label:`${n} Index Buffer`});e.WriteBuffer(r,t),e.SetDrawParams.apply(e,this.SetDrawParams(t.length)),this.IndexBuffer=e.SetIndexBuffer(r,this.IndexFormat)}CreateBuffers(e,t=this.Label){}get Vertices(){return this.DrawParams[0]}get ID(){return this.#e}Destroy(){this.IndexBuffer?.buffer.destroy(),this.IndexBuffer=void 0,this.VertexBuffers&&=(this.VertexBuffers[0]?.buffer.destroy(),this.VertexBuffers.splice(0),void 0)}},Or=class extends Dr{#e;#t;constructor(e=`Cube`){super(e,`uint16`)}GetPositionBufferLayout(e,t={name:`position`,format:`float32x3`},n=`vertex`,r=`vertex`){return e.CreateVertexBufferLayout(t,n,r)}CreateTextureCoordsBuffer(e,t,n=`vertex`,r=`vertex`){let i=new Float32Array([.5,.5,.75,.5,.5,1,.75,1,.25,.5,.5,.5,.25,1,.5,1,0,0,0,.5,.25,0,.25,.5,.5,0,.5,.5,.75,0,.75,.5,0,.5,.25,.5,0,1,.25,1,.25,0,.5,0,.25,.5,.5,.5]);return this.AddVertexBuffer(e,i,t??`textureCoords`,n,r)}AddVertexBuffer(e,t,n,r=`vertex`,i=`vertex`){let{buffer:a,layout:o}=e.CreateVertexBuffer(n,this.Vertices,r,i);return this.VertexBuffers=e.AddVertexBuffers(a),e.WriteBuffer(a,t),{buffer:a,layout:o}}#n(e,t=this.Label){super.CreateVertexBuffer(e,this.#t??new Float32Array([-.5,.5,.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,-.5,.5]),t)}#r(e,t=this.Label){super.CreateIndexBuffer(e,this.#e??new Uint16Array([0,1,2,2,1,3,4,5,6,6,5,7,8,9,10,10,9,11,12,13,14,14,13,15,16,17,18,18,17,19,20,21,22,22,21,23]),t)}CreateBuffers(e,t=this.Label){this.#n(e,t),this.#r(e,t)}set VertexData(e){this.#t=e}set IndexData(e){this.#e=e}get Vertices(){return(this.#t&&this.#t.length/3)??this.#e?.length??super.Vertices??24}Destroy(){super.Destroy(),this.#e=void 0,this.#t=void 0}},kr=Yn({TRIANGLE:3,SQUARE:4,PENTAGON:5,HEXAGON:6,HEPTAGON:7,OCTAGON:8,NONAGON:9,DECAGON:10,DODECAGON:12}),Ar=class{#e;#t;DrawParams=[];IndexFormat;#n;#r=crypto.randomUUID();#i;#a;VertexBuffers;IndexBuffer;constructor(e={segments:`SQUARE`,radius:0}){let t=e.segments,n=typeof t==`number`&&t;t||=`SQUARE`,this.IndexFormat=e.indexFormat??`uint16`,this.#n={label:`Shape`,...e},this.#e=e.radius??0,this.#t=n||kr[t]}GetPositionBufferLayout(e,t=`position`,n=`vertex`,r=`vertex`){return e.CreateVertexBufferLayout(t,n,r)}SetDrawParams(...e){return or(this.DrawParams,...e)}#o(e,t=this.#n.label){let n=this.#a;if(!n){n=new Float32Array((this.#t+1)*2*3);let{endAngle:e=qn.TAU,startAngle:t=0,innerRadius:r=0}=this.#n,i=e-t;for(let e=0,a=0,o=this.#t;a<=o;++a){let s=t+a*i/o,c=Math.cos(s),l=Math.sin(s);n[e++]=c*this.#e,n[e++]=l*this.#e,n[e++]=c*r,n[e++]=l*r}}let r=e.CreateVertexBuffer(n,{label:`${t} Vertex Buffer`});this.VertexBuffers=e.SetVertexBuffers(r),e.WriteBuffer(r,n)}#s(e,t=this.#n.label){let n=this.#i;if(!n){n=new Uint16Array(this.#t*6);for(let e=0,t=0,r=this.#t;t<r;++t){let r=t*2;n[e++]=r+1,n[e++]=r+3,n[e++]=r+2,n[e++]=r+2,n[e++]=r+0,n[e++]=r+1}}let r=e.CreateIndexBuffer(n,{label:`${t} Index Buffer`});e.SetDrawParams.apply(e,this.SetDrawParams(n.length)),this.IndexBuffer=e.SetIndexBuffer(r,this.IndexFormat),e.WriteBuffer(r,n)}CreateBuffers(e,t=this.#n.label){this.#o(e,t),this.#s(e,t)}set VertexData(e){this.#a=e}set IndexData(e){this.#i=e}get Vertices(){return this.DrawParams[0]}get Radius(){return this.#e}get ID(){return this.#r}Destroy(){this.IndexBuffer?.buffer.destroy(),this.IndexBuffer=void 0,this.#a=void 0,this.#i=void 0,this.VertexBuffers&&=(this.VertexBuffers[0]?.buffer.destroy(),this.VertexBuffers.splice(0),void 0)}},jr=class{#e;#t;#n;#r;constructor(e,t){if(this.#n=t.get(63)??t.entries().next().value[1],this.#r=e.common.lineHeight,this.#t=t,e.kernings){this.#e=new Map;for(let t of e.kernings){let e=this.#e.get(t.first);e||(e=new Map,this.#e.set(t.first,e)),e.set(t.second,t.amount)}}}GetCharacter(e){return this.#t.get(e)??this.#n}GetXAdvance(e,t=-1){let n=this.GetCharacter(e);if(t>-1){let r=this.#e.get(e);if(r)return n.xadvance+(r.get(t)??0)}return n.xadvance}get LineHeight(){return this.#r}},Mr=class{#e;#t;#n;#r;#i;#a;#o;#s;#c;#l=new Float32Array(8);constructor(e=`MSDFText`){this.#e=e}CreateRenderPipeline(e){this.#t=e,this.#r=new this.#t.Pipeline;let t=this.#r.CreateShaderModule(S),n=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT;return this.#s=this.#r.CreateBindGroupLayout([this.#t.CreateSamplerBindingLayout(),this.#t.CreateTextureBindingLayout(),this.#t.CreateBufferBindingLayout(`read-only-storage`,!1,0,GPUShaderStage.VERTEX),this.#t.CreateBufferBindingLayout(void 0,!1,0,GPUShaderStage.VERTEX)]),this.#c=this.#r.CreateBindGroupLayout(this.#t.CreateBufferBindingLayout(`read-only-storage`,!1,0,n)),this.#t.AddPipeline(this.#r,{layout:this.#r.CreatePipelineLayout([this.#s,this.#c]),primitive:this.#r.CreatePrimitiveState(`triangle-strip`,void 0,`uint32`),depthStencil:this.#r.CreateDepthStencilState(void 0,!1),vertex:this.#r.CreateVertexState(t),fragment:this.#r.CreateFragmentState(t,this.#r.CreateColorTargetState(yr.ALPHA_ADDITIVE))})}async#u(e){return this.#o.CopyImageToTexture(await this.#o.CreateImageBitmap(e),{mipmaps:!1,create:{label:`${this.#e} Font Texture`}})}#d(e,t,n){let r=0,i=0,a=e.charCodeAt(0),o=[0,0],s=[],{LineHeight:c}=t;for(let l=0,u=0,d=a,f=e.length,p=f-1;l<f;d=a,++l)switch(a=l<p&&e.charCodeAt(l+1)||-1,d){case 10:case 13:r=Math.max(r,o[0]),s.push(o[0]),o[1]-=c,o[0]=0,u++;break;case 32:o[0]+=t.GetXAdvance(d);break;default:n?.(o,u,t.GetCharacter(d).c),o[0]+=t.GetXAdvance(d,a),i++}s.push(o[0]),r=Math.max(r,o[0]);let l=c*s.length;return{lineWidths:s,instances:i,height:l,width:r}}async LoadFont(e,t=!1,n){!this.#r&&p(u.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before loading a font file."),this.#n=t;let r=e.lastIndexOf(`/`)+1;this.#o=new(await(tn.Texture()));let i=r&&e.substring(0,r)||``,a=await(await fetch(e,n)).json(),o=a.pages.map(e=>this.#u(i+e)),{buffer:s}=this.#r.CreateStorageBuffer(`Characters`,{label:`${this.#e} Characters Buffer`,length:a.chars.length,mappedAtCreation:!0});this.#i=this.#r.CreateUniformBuffer(`Camera`,{label:`${this.#e} Camera Buffer`}).buffer;let c=new Map,l=1/a.common.scaleW,d=1/a.common.scaleH,f=new Float32Array(s.getMappedRange());for(let e=0,t=0,n=a.chars.length;e<n;t+=8,++e){let n=a.chars[e];f[t+0]=n.x*l,f[t+1]=n.y*d,f[t+2]=n.width*l,f[t+3]=n.height*d,f[t+4]=n.width,f[t+5]=n.height,f[t+6]=n.xoffset,f[t+7]=-n.yoffset,c.set(n.id,Object.assign({c:e},n))}let m=this.#o.CreateSampler({label:`${this.#e} Sampler`,maxAnisotropy:16,filter:`linear`});return s.unmap(),this.#a=await Promise.all(o),this.#r.SetBindGroupFromResources([m,this.#a[0].createView(),s,this.#i],0,this.#s),new jr(a,c)}Write(e,t,n=0,r=.01,i=!1){!this.#r&&p(u.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before writing a string.");let a=this.#r.CreateStorageBuffer(`Text`,{label:`${this.#e} Storage Buffer`,size:e.length*16+96,mappedAtCreation:!0}).buffer,o=new Float32Array(a.getMappedRange()),s=24,c;return i?(c=this.#d(e,t),this.#d(e,t,([e,t],n,r)=>{let{lineWidths:i,width:a,height:l}=c,u=a*-.5-(a-i[n])*-.5;o[s+0]=e+u,o[s+1]=t+l*.5,o[s+2]=r,s+=4})):c=this.#d(e,t,([e,t],n,r)=>{o[s+0]=e,o[s+1]=t,o[s+2]=r,s+=4}),a.unmap(),this.#r.BindGroups.length===1?this.#r.AddBindGroupFromResources(a,0,this.#c):this.#r.BindGroups[1].bindGroup=this.#r.CreateBindGroup(this.#r.CreateBindGroupEntries(a),this.#c),this.#r.SetDrawParams(4,c.instances),this.#r.EncodeRenderBundle(this.#t.CreateRenderBundleEncoder()),this.#l.set([-this.#n+.5,r]),this.#r.WriteBuffer(a,this.#l,0,0,2),this.SetColor(n,a),a}SetTransform(e,t){!this.#r&&p(u.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before setting transform matrix."),this.#r.WriteBuffer(t,e,32,0,16)}SetColor(e,t){!this.#r&&p(u.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before setting text color."),this.#l.set(typeof e==`number`&&nr(e)||tr(e),4),this.#r.WriteBuffer(t,this.#l,16,4,4)}SetScale(e,t){!this.#r&&p(u.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before setting text scale."),this.#l[1]=e,this.#r.WriteBuffer(t,this.#l,4,1,1)}UpdatePerspective(e){!this.#r&&p(u.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before updating projection matrix."),this.#r.WriteBuffer(this.#i,e.LocalMatrix,0),this.#r.WriteBuffer(this.#i,e.ProjectionMatrix,64)}get Pipeline(){return this.#r}Destroy(){this.#a?.forEach(e=>e?.destroy()),this.#i?.destroy(),this.#r.Destroy(),this.#o?.Destroy()}},Nr=class extends br{#e=1;#t=1e3;#n=0;#r=innerWidth;#i=innerHeight;#a=0;#o=new Float32Array(24);constructor(e=1,t=1e3,n=0,r=innerWidth,i=innerHeight,a=0){if(super(`OrthographicCamera`),this.#e=e,this.#t=t,this.#n=n,this.#a=a,typeof r!=`number`){let[e,t]=r.CanvasSize;this.#r=e,this.#i=t}else this.#r=r,this.#i=i;this.UpdateProjectionMatrix()}#s(e=!1){let[t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g]=this.ProjectionMatrix;if(this.#o[0]=p+l,this.#o[1]=m+u,this.#o[2]=h+d,this.#o[3]=g+f,this.#o[4]=p-l,this.#o[5]=m-u,this.#o[6]=h-d,this.#o[7]=g-f,this.#o[8]=p-a,this.#o[9]=m-o,this.#o[10]=h-s,this.#o[11]=g-c,this.#o[12]=p-t,this.#o[13]=m-n,this.#o[14]=h-r,this.#o[15]=g-i,this.#o[16]=p+a,this.#o[17]=m+o,this.#o[18]=h+s,this.#o[19]=g+c,this.#o[20]=p+t,this.#o[21]=m+n,this.#o[22]=h+r,this.#o[23]=g+i,!e)return this.#o;for(let e=0;e<6;++e){let t=e*4,n=Math.hypot(this.#o[t+0],this.#o[t+1],this.#o[t+2])||1;this.#o[t+0]/=n,this.#o[t+1]/=n,this.#o[t+2]/=n,this.#o[t+3]/=n}return this.#o}UpdateProjectionMatrix(){return Q.ortho(this.#a,this.#r,this.#i,this.#n,this.#e,this.#t,this.ProjectionMatrix),this.#s(),this.ProjectionMatrix}get Frustum(){return this.#o}set Near(e){this.#e=e,this.UpdateProjectionMatrix()}get Near(){return this.#e}set Far(e){this.#t=e,this.UpdateProjectionMatrix()}get Far(){return this.#t}set Top(e){this.#n=e,this.UpdateProjectionMatrix()}get Top(){return this.#n}set Right(e){this.#r=e,this.UpdateProjectionMatrix()}get Right(){return this.#r}set Bottom(e){this.#i=e,this.UpdateProjectionMatrix()}get Bottom(){return this.#i}set Left(e){this.#a=e,this.UpdateProjectionMatrix()}get Left(){return this.#a}},Pr=class extends br{#e=Nn.set(0,1,0);#t=60;#n=1;#r=1e3;#i=innerWidth/innerHeight;#a=Q.identity();#o=new Float32Array(24);#s=Q.identity();constructor(e=60,t=1,n=1e3,r=innerWidth/innerHeight){super(`PerspectiveCamera`),this.#t=e,this.#n=t,this.#r=n,this.#i=typeof r==`number`?r:r.AspectRatio,this.UpdateProjectionMatrix()}#c(e=!1){let[t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g]=this.#s;if(this.#o[0]=p+l,this.#o[1]=m+u,this.#o[2]=h+d,this.#o[3]=g+f,this.#o[4]=p-l,this.#o[5]=m-u,this.#o[6]=h-d,this.#o[7]=g-f,this.#o[8]=p-a,this.#o[9]=m-o,this.#o[10]=h-s,this.#o[11]=g-c,this.#o[12]=p-t,this.#o[13]=m-n,this.#o[14]=h-r,this.#o[15]=g-i,this.#o[16]=p+a,this.#o[17]=m+o,this.#o[18]=h+s,this.#o[19]=g+c,this.#o[20]=p+t,this.#o[21]=m+n,this.#o[22]=h+r,this.#o[23]=g+i,!e)return this.#o;for(let e=0;e<6;++e){let t=e*4,n=Math.hypot(this.#o[t+0],this.#o[t+1],this.#o[t+2])||1;this.#o[t+0]/=n,this.#o[t+1]/=n,this.#o[t+2]/=n,this.#o[t+3]/=n}return this.#o}UpdateViewProjectionMatrix(){return Q.inverse(this.LocalMatrix,this.#a),Q.multiply(this.ProjectionMatrix,this.#a,this.#s),this.#c(),this.#s}UpdateProjectionMatrix(){let e=qn.DegreesToRadians(this.#t);return Q.perspective(e,this.#i,this.#n,this.#r,this.ProjectionMatrix)}LookAt(e,t=this.#e){return Q.lookAt(this.Position,e,t,this.#a),Q.multiply(this.ProjectionMatrix,this.#a,this.#s)}get ViewProjectionMatrix(){return this.#s}get Frustum(){return this.#o}set FieldOfView(e){this.#t=e,this.UpdateProjectionMatrix()}get FieldOfView(){return this.#t}set AspectRatio(e){this.#i=typeof e==`number`?e:e.AspectRatio,this.UpdateProjectionMatrix()}get AspectRatio(){return this.#i}set Near(e){this.#n=e,this.UpdateProjectionMatrix()}get Near(){return this.#n}set Far(e){this.#r=e,this.UpdateProjectionMatrix()}get Far(){return this.#r}},Fr=class extends Cr{#e=0;#t=innerWidth;#n=innerHeight;#r=0;#i=new Float32Array(4);constructor(e=innerWidth,t=innerHeight){super(`Camera2D`),this.Size=typeof e!=`number`&&e.CanvasSize||[e,t]}#a(e=!1){}UpdateProjectionMatrix(){let e=this.#e,t=this.#t,n=this.#n,r=this.#r;return Z.set(2/t,0,0,0,-2/n,0,r/t*2-1,e/n*-2+1,1,this.ProjectionMatrix),this.#a(),this.ProjectionMatrix}set Size([e,t]){this.#t=e,this.#n=t,this.UpdateProjectionMatrix()}set Top(e){this.#e=e,this.UpdateProjectionMatrix()}get Top(){return this.#e}set Right(e){this.#t=e,this.UpdateProjectionMatrix()}get Right(){return this.#t}set Bottom(e){this.#n=e,this.UpdateProjectionMatrix()}get Bottom(){return this.#n}set Left(e){this.#r=e,this.UpdateProjectionMatrix()}get Left(){return this.#r}get Frustum(){return this.#i}};console.info(`%cUWAL v0.2.0`,`background:#005a9c;padding:3px;color:#fff;`);export{C as _,Ar as a,Tr as c,Jn as d,qn as f,w as g,T as h,Mr as i,wr as l,ee as m,Pr as n,Or as o,tn as p,Nr as r,Er as s,Fr as t,Sr as u,v,_ as y};