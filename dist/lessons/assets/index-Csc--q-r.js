import{B as b,T as g,E as v,D as S,b as P,a as D}from"./index-CMZei-k1.js";var B="const QUAD=array(vec2f(-1.0,-1.0),vec2f(1.0,-1.0),vec2f(1.0,1.0),vec2f(1.0,1.0),vec2f(-1.0,1.0),vec2f(-1.0,-1.0));fn GetQuadCoord(index: u32)->vec2f{return QUAD[index];}struct char{coords: vec2f,extent: vec2f,size : vec2f,offset: vec2f};struct text{scale: f32,color: vec4f,transform: mat4x4f,chars: array<vec3f>};struct VertexOutput{@location(0)textureCoord: vec2f,@builtin(position)position: vec4f};@group(0)@binding(0)var Sampler: sampler;@group(0)@binding(1)var Texture: texture_2d<f32>;@group(0)@binding(2)var<storage>Characters: array<char>;@group(1)@binding(0)var<storage>Text: text;fn MapQuadCoord(index: u32)->vec2f{return(GetQuadCoord(index)+vec2f(1))/vec2f(2);}@vertex fn vertex(@builtin(vertex_index)index: u32)->VertexOutput {let quad=array(MapQuadCoord(4),MapQuadCoord(2),MapQuadCoord(0),MapQuadCoord(1));var output: VertexOutput;let character=Characters[0];output.textureCoord=quad[index];output.textureCoord*=character.extent;output.textureCoord+=character.offset;output.position=vec4f(GetQuadCoord(index),0,1);return output;}fn SampleMSDFTexture(coord: vec2f)->f32{let c=textureSample(Texture,Sampler,coord);return max(min(c.r,c.g),min(max(c.r,c.g),c.b));}@fragment fn fragment(@location(0)textureCoord: vec2f)->@location(0)vec4f {return vec4f(vec3f(SampleMSDFTexture(textureCoord)),1);}";const A=""+new URL("ya-hei-ascii-BNsUZnRi.json",import.meta.url).href;class M{#t;#r;#e;#a;constructor(e,t){if(this.#e=Array.from(t.values()),this.#r=this.#e[0],this.#a=e.common.lineHeight,!!e.kernings){this.#t=new Map;for(const s of e.kernings){let r=this.#t.get(s.first);r||(r=new Map,this.#t.set(s.first,r)),r.set(s.second,s.amount)}}}GetCharacter(e){return this.#e[e]??this.#r}GetXAdvance(e,t=-1){const s=this.GetCharacter(e);if(t>-1){const r=this.#t.get(e);if(r)return s.xadvance+(r.get(t)??0)}return s.xadvance}get LineHeight(){return this.#a}}class y{#t;#r;#e;#a;#h;#i=!1;#n;#s;#o=new Float32Array(24);constructor(e="MSDFText"){this.#t=e}CreateRenderPipeline(e){this.#r=e,this.#e=new this.#r.Pipeline;const t=this.#e.CreateShaderModule(B);return this.#r.AddPipeline(this.#e,{vertex:this.#e.CreateVertexState(t),fragment:this.#e.CreateFragmentState(t,this.#e.CreateColorTargetState(b.ALPHA_ADDITIVE)),primitive:this.#e.CreatePrimitiveState("triangle-strip",void 0,"uint32"),depthStencil:this.#e.CreateDepthStencilState(void 0,!1)})}async LoadFont(e,t){!this.#e&&g(v.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before loading a font file.");const s=e.lastIndexOf("/")+1;this.#s=new(await S.Texture());const r=s&&e.substring(0,s)||"",a=await(await fetch(e,t)).json(),i=a.pages.map(l=>this.#l(r+l)),{Characters:n,buffer:f}=this.#e.CreateStorageBuffer("Characters",{label:`${this.#t} Characters Buffer`,length:a.chars.length,mappedAtCreation:!0}),c=new Map,x=1/a.common.scaleW,h=1/a.common.scaleH;for(let l=0,o=0,C=a.chars.length;l<C;o+=8,++l){const u=a.chars[l];c.set(u.id,Object.assign({c:l},u)),n[o+0]=u.x*x,n[o+1]=u.y*h,n[o+2]=u.width*x,n[o+3]=u.height*h,n[o+4]=u.width,n[o+5]=u.height,n[o+6]=u.xoffset,n[o+7]=-u.yoffset}const p=this.#s.CreateSampler({label:`${this.#t} Sampler`,maxAnisotropy:16,filter:"linear"}),d=await Promise.all(i);return f.unmap(),this.#a=this.#e.CreateBindGroup(this.#e.CreateBindGroupEntries([p,d[0].createView(),f])),new M(a,c)}async#l(e){return this.#s.CopyImageToTexture(await this.#s.CreateImageBitmap(e),{mipmaps:!1,create:{label:`${this.#t} Font Texture`}})}WriteString(e,t,s={pixelScale:1/512,color:0}){this.#n=this.#e.CreateStorageBuffer("Text",{size:e.length*16+96,mappedAtCreation:!0}).buffer;const r=new Float32Array(this.#n.getMappedRange());let a=24;const{pixelScale:i,color:n,centered:f}=s;let c;f?(c=this.#c(e,t),this.#c(e,t,(p,d,[l,o])=>{const{lineWidths:C,width:u,height:T}=c,w=u*-.5-(u-C[d])*-.5;r[a+0]=l+w,r[a+1]=o+T*.5,r[a+2]=p.c,a+=4})):c=this.#c(e,t,(p,d,[l,o])=>{r[a+0]=l,r[a+1]=o,r[a+2]=p.c,a+=4}),this.#n.unmap();const x=this.#e.CreateBindGroup(this.#e.CreateBindGroupEntries([this.#n])),h=this.#r.CreateRenderBundleEncoder();h.setPipeline(this.#e.GPUPipeline),h.setBindGroup(0,this.#a),h.setBindGroup(1,x),h.draw(4,c.instances),this.#h=h.finish(),this.PixelScale=i,this.Color=n}#c(e,t,s){let r=0,a=0;const i=[],n=[],f=t.LineHeight;let c=e.charCodeAt(0);for(let h=0,p=0,d=c,l=e.length,o=l-1;h<l;d=c,++h)switch(c=h<o&&e.charCodeAt(h+1)||-1,d){case 10:case 13:r=Math.max(r,i[0]),n.push(i[0]),i[1]-=f,i[0]=0,p++;break;case 32:i[0]+=t.GetXAdvance(d);break;default:s?.(t.GetCharacter(d),p,i),i[0]+=t.GetXAdvance(d,c),a++}n.push(i[0]),r=Math.max(r,i[0]);const x=f*n.length;return{lineWidths:n,instances:a,height:x,width:r}}set Transform(e){this.#i=!0,this.#o.set(e)}set PixelScale(e){this.#i=!0,this.#o[0]=e}set Color(e){const t=typeof e=="number"&&P(e)||D(e);this.#o.fill(1,4,8).set(t,4),this.#i=!0}get RenderBundle(){return!this.#e&&g(v.PIPELINE_NOT_FOUND,"RenderPipeline.\n            Call `MSDFText.CreateRenderPipeline` method before getting a render bundle."),this.#i&&(this.#e.WriteBuffer(this.#n,this.#o),this.#i=!1),this.#h}get Pipeline(){return this.#e}}(async function(m){let e;try{e=new(await S.Renderer(m,"MSDF Text"))}catch(i){alert(i)}e.CreatePassDescriptor(e.CreateColorAttachment(),e.CreateDepthStencilAttachment());const t=new y,s=await t.CreateRenderPipeline(e),r=await t.LoadFont(A);t.WriteString("UWAL",r),new ResizeObserver(i=>{for(const n of i){const{inlineSize:f,blockSize:c}=n.contentBoxSize[0];e.SetCanvasSize(f,c)}s.SetDrawParams(6),e.Render()}).observe(document.body)})(document.getElementById("lesson"));
