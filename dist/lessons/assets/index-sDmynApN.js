var la=Object.defineProperty;var qr=u=>{throw TypeError(u)};var ha=(u,e,t)=>e in u?la(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var ct=(u,e,t)=>ha(u,typeof e!="symbol"?e+"":e,t),ur=(u,e,t)=>e.has(u)||qr("Cannot "+t);var p=(u,e,t)=>(ur(u,e,"read from private field"),t?t.call(u):e.get(u)),W=(u,e,t)=>e.has(u)?qr("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(u):e.set(u,t),$=(u,e,t,n)=>(ur(u,e,"write to private field"),n?n.call(u,t):e.set(u,t),t),Q=(u,e,t)=>(ur(u,e,"access private method"),t);var Kt,Jt,en,wt;const Fr=class Fr{constructor(e=0,t,n,s=255){W(this,Kt,0);W(this,Jt,0);W(this,en,0);W(this,wt,1);typeof t=="number"&&typeof n=="number"?this.RGBA=[e,t,n,s]:($(this,Kt,(e>>16&255)/255),$(this,Jt,(e>>8&255)/255),$(this,en,(e&255)/255),$(this,wt,s/255))}Set(e,t=255){return $(this,Kt,(e>>16&255)/255),$(this,Jt,(e>>8&255)/255),$(this,en,(e&255)/255),$(this,wt,t/255),this}Premultiply(e,t){t??(t=new Fr),e??(e=p(this,wt));const n=p(this,Kt)*e,s=p(this,Jt)*e,r=p(this,en)*e;return t.rgba=[n,s,r,e],t}set rgb(e){$(this,Kt,e[0]),$(this,Jt,e[1]),$(this,en,e[2]),$(this,wt,e[3]??1)}get rgb(){return[p(this,Kt),p(this,Jt),p(this,en)]}set a(e){$(this,wt,e)}get a(){return p(this,wt)}set rgba(e){this.rgb=e}get rgba(){return this.rgb.concat(p(this,wt))}set RGB(e){$(this,Kt,e[0]/255),$(this,Jt,e[1]/255),$(this,en,e[2]/255),$(this,wt,(e[3]??255)/255)}get RGB(){return[p(this,Kt)*255,p(this,Jt)*255,p(this,en)*255]}set A(e){$(this,wt,e/255)}get A(){return p(this,wt)*255}set RGBA(e){this.RGB=e}get RGBA(){return this.RGB.concat(this.A)}};Kt=new WeakMap,Jt=new WeakMap,en=new WeakMap,wt=new WeakMap;let Ks=Fr;const vi=Pe({RAD:Math.PI/180,DEG:180/Math.PI,HPI:Math.PI/2,TAU:Math.PI*2}),fa={SHADER_CODE_NOT_FOUND:"SHADER_CODE_NOT_FOUND",SHADER_MODULE_NOT_FOUND:"SHADER_MODULE_NOT_FOUND",VERTEX_ENTRY_NOT_FOUND:"VERTEX_ENTRY_NOT_FOUND",VERTEX_ATTRIBUTE_NOT_FOUND:"VERTEX_ATTRIBUTE_NOT_FOUND",UNIFORM_NOT_FOUND:"UNIFORM_NOT_FOUND",STORAGE_NOT_FOUND:"STORAGE_NOT_FOUND",INVALID_UNIFORM_NAME:"INVALID_UNIFORM_NAME",BINDING_NOT_FOUND:"BINDING_NOT_FOUND",PIPELINE_NOT_FOUND:"PIPELINE_NOT_FOUND"},da={SHADER_CODE_NOT_FOUND:`Failed to get a WGSL shader when creating shader module.
        An empty shader will be used instead.`,SHADER_MODULE_NOT_FOUND:"Failed to get shader module in ",VERTEX_ENTRY_NOT_FOUND:"Failed to find function ",VERTEX_ATTRIBUTE_NOT_FOUND:"Failed to find vertex attribute ",UNIFORM_NOT_FOUND:"Failed to find uniform ",STORAGE_NOT_FOUND:"Failed to find storage ",INVALID_UNIFORM_NAME:"Requested uniform is already in use and managed internally: ",BINDING_NOT_FOUND:"Failed to find binding ",PIPELINE_NOT_FOUND:"Failed to get GPU"},pa={PIPELINE_NOT_FOUND:8},ma={LEGACY_RENDER_PIPELINE_NOT_FOUND:"LEGACY_RENDER_PIPELINE_NOT_FOUND",RENDERER_NOT_FOUND:"RENDERER_NOT_FOUND",TEXTURE_SIZE_NOT_FOUND:"TEXTURE_SIZE_NOT_FOUND",TEXTURE_NOT_FOUND:"TEXTURE_NOT_FOUND",INVALID_BYTES_PER_ROW:"INVALID_BYTES_PER_ROW"},ga={LEGACY_RENDER_PIPELINE_NOT_FOUND:'"Device.RenderPipeline" instance is required in `LegacyTexture` for this operation.\n        Pass it to the `LegacyTexture` constructor or use `Texture.LegacyRenderer` setter before ',RENDERER_NOT_FOUND:'"Device.Renderer" instance is required in `Texture` for this operation.\n        Pass it to the `Texture` constructor or use `Texture.Renderer` setter before ',TEXTURE_SIZE_NOT_FOUND:"`size` array or a `width` value is required in `options` parameter of ",TEXTURE_NOT_FOUND:"`options` is required to have a `texture` value or its `create` entry\n        to be either `true` or a `TextureDescriptor` object when calling ",INVALID_BYTES_PER_ROW:"`bytesPerRow` parameter is not a multiple of 256 in "},_a={CANVAS_NOT_FOUND:"CANVAS_NOT_FOUND",CONTEXT_NOT_FOUND:"CONTEXT_NOT_FOUND",RENDER_PASS_NOT_FOUND:"RENDER_PASS_NOT_FOUND",COMMAND_ENCODER_NOT_FOUND:"COMMAND_ENCODER_NOT_FOUND"},ya={CANVAS_NOT_FOUND:"Failed to get a WebGPU canvas.",CONTEXT_NOT_FOUND:"Failed to get a WebGPU context.",RENDER_PASS_NOT_FOUND:"Failed to use pipeline in render pass because it has not started.",COMMAND_ENCODER_NOT_FOUND:"Failed to get a GPUCommandEncoder."},xa={CANVAS_NOT_FOUND:5,CONTEXT_NOT_FOUND:6,COMMAND_ENCODER_NOT_FOUND:7},wa={FONT_TEXTURE_NOT_FOUND:"FONT_TEXTURE_NOT_FOUND"},va={FONT_TEXTURE_NOT_FOUND:"Failed to find font texture in "},ba={TIMESTAMP_QUERY_NOT_FOUND:"TIMESTAMP_QUERY_NOT_FOUND",RENDER_PASS_ENDED:"RENDER_PASS_ENDED"},ka={TIMESTAMP_QUERY_NOT_FOUND:'"timestamp-query" feature is required to be set with\n        `Device.SetRequiredFeatures` when creating a new `GPUTiming` instance.',RENDER_PASS_ENDED:"Failed get a render pass because it has ended.\n        `Render` method has to be called with `submit` flag set to `false`."};Pe({DEVICE_LOST:"Device::Lost"});const Y=Pe({FORMAT_NOT_SUPPORTED:"FORMAT_NOT_SUPPORTED",WEBGPU_NOT_SUPPORTED:"WEBGPU_NOT_SUPPORTED",ADAPTER_NOT_FOUND:"ADAPTER_NOT_FOUND",FEATURE_NOT_FOUND:"FEATURE_NOT_FOUND",DEVICE_NOT_FOUND:"DEVICE_NOT_FOUND",DEVICE_NOT_REQUESTED:"DEVICE_NOT_REQUESTED",DEVICE_LOST:"DEVICE_LOST",...fa,...ma,..._a,...wa,...ba}),bi=Pe({FORMAT_NOT_SUPPORTED:"Format is not yet supported: ",WEBGPU_NOT_SUPPORTED:"WebGPU is not supported in this browser.",ADAPTER_NOT_FOUND:"Failed to get a GPUAdapter.",DEVICE_NOT_FOUND:"Failed to get a GPUDevice.",FEATURE_NOT_FOUND:"Failed to get a GPUFeature ",DEVICE_NOT_REQUESTED:"GPUDevice was not requested.",DEVICE_LOST:"WebGPU device was lost. ",...da,...ga,...ya,...va,...ka}),Ta=Pe({WEBGPU_NOT_SUPPORTED:0,ADAPTER_NOT_FOUND:1,DEVICE_NOT_FOUND:2,DEVICE_NOT_REQUESTED:3,DEVICE_LOST:4,...xa,...pa});function Ve(u,e){console.warn(`${bi[u]}${e??""}`.replace(/\s\s+/g," "))}function ee(u,e){throw new Error(`${bi[u]}${e??""}`.replace(/\s\s+/g," "),{cause:Ta[u]})}class Mt{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}}class Wr{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class On extends Mt{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class Pn extends Mt{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}}class fr extends Mt{constructor(e,t,n){super(e,n),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}}class Yn extends Mt{constructor(e,t,n,s){super(e,n),this.format=t,this.access=s}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}var mn;(u=>{u[u.Uniform=0]="Uniform",u[u.Storage=1]="Storage",u[u.Texture=2]="Texture",u[u.Sampler=3]="Sampler",u[u.StorageTexture=4]="StorageTexture"})(mn||(mn={}));class Hs{constructor(e,t,n,s,r,a,i){this.name=e,this.type=t,this.group=n,this.binding=s,this.attributes=r,this.resourceType=a,this.access=i}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Ea{constructor(e,t){this.name=e,this.type=t}}class Ia{constructor(e,t,n,s){this.name=e,this.type=t,this.locationType=n,this.location=s,this.interpolation=null}}class Hr{constructor(e,t,n,s){this.name=e,this.type=t,this.locationType=n,this.location=s}}class Aa{constructor(e,t,n,s){this.name=e,this.type=t,this.attributes=n,this.id=s}}class Sa{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n}}class Da{constructor(e,t=null,n){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=n}}class Na{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}const ki=new Float32Array(1),Ma=new Int32Array(ki.buffer),Ze=new Uint16Array(1);function Oa(u){ki[0]=u;const e=Ma[0],t=e>>31&1;let n=e>>23&255,s=8388607&e;if(n===255)return Ze[0]=t<<15|31744|(s!==0?512:0),Ze[0];if(n===0){if(s===0)return Ze[0]=t<<15,Ze[0];s|=8388608;let r=113;for(;!(8388608&s);)s<<=1,r--;return n=127-r,s&=8388607,n>0?(s=(s>>126-n)+(s>>127-n&1),Ze[0]=t<<15|n<<10|s>>13,Ze[0]):(Ze[0]=t<<15,Ze[0])}return n=n-127+15,n>=31?(Ze[0]=t<<15|31744,Ze[0]):n<=0?n<-10?(Ze[0]=t<<15,Ze[0]):(s=(8388608|s)>>1-n,Ze[0]=t<<15|s>>13,Ze[0]):(s>>=13,Ze[0]=t<<15|n<<10|s,Ze[0])}const Sr=new Uint32Array(1),Ti=new Float32Array(Sr.buffer,0,1);function Xr(u){const e=112+(u>>6&31)<<23|(63&u)<<17;return Sr[0]=e,Ti[0]}function Pa(u,e,t,n,s,r,a,i,c){const h=n*(a>>=s)*(r>>=s)+t*a+e*i;switch(c){case"r8unorm":return[ge(u,h,"8unorm",1)[0]];case"r8snorm":return[ge(u,h,"8snorm",1)[0]];case"r8uint":return[ge(u,h,"8uint",1)[0]];case"r8sint":return[ge(u,h,"8sint",1)[0]];case"rg8unorm":{const f=ge(u,h,"8unorm",2);return[f[0],f[1]]}case"rg8snorm":{const f=ge(u,h,"8snorm",2);return[f[0],f[1]]}case"rg8uint":{const f=ge(u,h,"8uint",2);return[f[0],f[1]]}case"rg8sint":{const f=ge(u,h,"8sint",2);return[f[0],f[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const f=ge(u,h,"8unorm",4);return[f[0],f[1],f[2],f[3]]}case"rgba8snorm":{const f=ge(u,h,"8snorm",4);return[f[0],f[1],f[2],f[3]]}case"rgba8uint":{const f=ge(u,h,"8uint",4);return[f[0],f[1],f[2],f[3]]}case"rgba8sint":{const f=ge(u,h,"8sint",4);return[f[0],f[1],f[2],f[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const f=ge(u,h,"8unorm",4);return[f[2],f[1],f[0],f[3]]}case"r16uint":return[ge(u,h,"16uint",1)[0]];case"r16sint":return[ge(u,h,"16sint",1)[0]];case"r16float":return[ge(u,h,"16float",1)[0]];case"rg16uint":{const f=ge(u,h,"16uint",2);return[f[0],f[1]]}case"rg16sint":{const f=ge(u,h,"16sint",2);return[f[0],f[1]]}case"rg16float":{const f=ge(u,h,"16float",2);return[f[0],f[1]]}case"rgba16uint":{const f=ge(u,h,"16uint",4);return[f[0],f[1],f[2],f[3]]}case"rgba16sint":{const f=ge(u,h,"16sint",4);return[f[0],f[1],f[2],f[3]]}case"rgba16float":{const f=ge(u,h,"16float",4);return[f[0],f[1],f[2],f[3]]}case"r32uint":return[ge(u,h,"32uint",1)[0]];case"r32sint":return[ge(u,h,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[ge(u,h,"32float",1)[0]];case"rg32uint":{const f=ge(u,h,"32uint",2);return[f[0],f[1]]}case"rg32sint":{const f=ge(u,h,"32sint",2);return[f[0],f[1]]}case"rg32float":{const f=ge(u,h,"32float",2);return[f[0],f[1]]}case"rgba32uint":{const f=ge(u,h,"32uint",4);return[f[0],f[1],f[2],f[3]]}case"rgba32sint":{const f=ge(u,h,"32sint",4);return[f[0],f[1],f[2],f[3]]}case"rgba32float":{const f=ge(u,h,"32float",4);return[f[0],f[1],f[2],f[3]]}case"rg11b10ufloat":{const f=new Uint32Array(u.buffer,h,1)[0],w=(4192256&f)>>11,B=(4290772992&f)>>22;return[Xr(2047&f),Xr(w),function(F){const Z=112+(F>>5&31)<<23|(31&F)<<18;return Sr[0]=Z,Ti[0]}(B),1]}}return null}function ge(u,e,t,n){const s=[0,0,0,0];for(let h=0;h<n;++h)switch(t){case"8unorm":s[h]=u[e]/255,e++;break;case"8snorm":s[h]=u[e]/255*2-1,e++;break;case"8uint":s[h]=u[e],e++;break;case"8sint":s[h]=u[e]-127,e++;break;case"16uint":s[h]=u[e]|u[e+1]<<8,e+=2;break;case"16sint":s[h]=(u[e]|u[e+1]<<8)-32768,e+=2;break;case"16float":s[h]=(r=u[e]|u[e+1]<<8,a=void 0,i=void 0,c=void 0,a=(32768&r)>>15,c=1023&r,(i=(31744&r)>>10)==0?(a?-1:1)*Math.pow(2,-14)*(c/Math.pow(2,10)):i==31?c?NaN:1/0*(a?-1:1):(a?-1:1)*Math.pow(2,i-15)*(1+c/Math.pow(2,10))),e+=2;break;case"32uint":case"32sint":s[h]=u[e]|u[e+1]<<8|u[e+2]<<16|u[e+3]<<24,e+=4;break;case"32float":s[h]=new Float32Array(u.buffer,e,1)[0],e+=4}var r,a,i,c;return s}function ye(u,e,t,n,s){for(let r=0;r<n;++r)switch(t){case"8unorm":u[e]=255*s[r],e++;break;case"8snorm":u[e]=.5*(s[r]+1)*255,e++;break;case"8uint":u[e]=s[r],e++;break;case"8sint":u[e]=s[r]+127,e++;break;case"16uint":new Uint16Array(u.buffer,e,1)[0]=s[r],e+=2;break;case"16sint":new Int16Array(u.buffer,e,1)[0]=s[r],e+=2;break;case"16float":{const a=Oa(s[r]);new Uint16Array(u.buffer,e,1)[0]=a,e+=2;break}case"32uint":new Uint32Array(u.buffer,e,1)[0]=s[r],e+=4;break;case"32sint":new Int32Array(u.buffer,e,1)[0]=s[r],e+=4;break;case"32float":new Float32Array(u.buffer,e,1)[0]=s[r],e+=4}return s}const lr={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class Pt{constructor(){this.id=Pt._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){t(Js.instance);for(const n of e)n instanceof Array?this.searchBlock(n,t):n.search(t);t(er.instance)}}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}Pt._id=0;class Js extends Pt{}Js.instance=new Js;class er extends Pt{}er.instance=new er;const Ei=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class Te extends Pt{constructor(){super()}}class Is extends Te{constructor(e,t,n,s,r,a){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=n,this.body=s,this.startLine=r,this.endLine=a}get astNodeType(){return"function"}search(e){if(this.attributes)for(const t of this.attributes)e(t);e(this);for(const t of this.args)e(t);this.searchBlock(this.body,e)}}class Ca extends Te{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Ii extends Te{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class dr extends Te{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class Ai extends Te{constructor(e,t,n,s){super(),this.init=e,this.condition=t,this.increment=n,this.body=s}get astNodeType(){return"for"}search(e){var t,n,s;(t=this.init)===null||t===void 0||t.search(e),(n=this.condition)===null||n===void 0||n.search(e),(s=this.increment)===null||s===void 0||s.search(e),this.searchBlock(this.body,e)}}class fn extends Te{constructor(e,t,n,s,r){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=s,this.value=r}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Dr extends Te{constructor(e,t,n){super(),this.attributes=null,this.name=e,this.type=t,this.value=n}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Ts extends Te{constructor(e,t,n,s,r){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=s,this.value=r}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Ys extends Te{constructor(e,t,n,s,r){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=s,this.value=r}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}var ts,ws,U,O;(u=>{u.increment="++",u.decrement="--"})(ts||(ts={})),(u=>{u.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return u[t]}})(ts||(ts={}));class Si extends Te{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(u=>{u.assign="=",u.addAssign="+=",u.subtractAssin="-=",u.multiplyAssign="*=",u.divideAssign="/=",u.moduloAssign="%=",u.andAssign="&=",u.orAssign="|=",u.xorAssign="^=",u.shiftLeftAssign="<<=",u.shiftRightAssign=">>="})(ws||(ws={})),(u=>{u.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}})(ws||(ws={}));class Di extends Te{constructor(e,t,n){super(),this.operator=e,this.variable=t,this.value=n}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Nr extends Te{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return Ei.has(this.name)}search(e){for(const t of this.args)t.search(e);e(this)}}class Ni extends Te{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class Mi extends Te{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}search(e){e(this);for(const t of this.cases)t.search(e)}}class Oi extends Te{constructor(e,t,n,s){super(),this.condition=e,this.body=t,this.elseif=n,this.else=s}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Pi extends Te{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Ba extends Te{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Ua extends Te{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Ci extends Te{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class Mr extends Te{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class La extends Te{constructor(){super()}get astNodeType(){return"discard"}}class Bi extends Te{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class Ui extends Te{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class G extends Te{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if(t.name==="f32")return t;for(let n=1;n<e.length;++n){const s=G._priority.get(t.name);G._priority.get(e[n].name)<s&&(t=e[n])}return t.name==="x32"?G.i32:t}getTypeName(){return this.name}}G.x32=new G("x32"),G.f32=new G("f32"),G.i32=new G("i32"),G.u32=new G("u32"),G.f16=new G("f16"),G.bool=new G("bool"),G.void=new G("void"),G._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class Yr extends G{constructor(e){super(e)}}class an extends G{constructor(e,t,n,s){super(e),this.members=t,this.startLine=n,this.endLine=s}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(const t of this.members)e(t)}}class C extends G{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}C.vec2f=new C("vec2",G.f32,null),C.vec3f=new C("vec3",G.f32,null),C.vec4f=new C("vec4",G.f32,null),C.vec2i=new C("vec2",G.i32,null),C.vec3i=new C("vec3",G.i32,null),C.vec4i=new C("vec4",G.i32,null),C.vec2u=new C("vec2",G.u32,null),C.vec3u=new C("vec3",G.u32,null),C.vec4u=new C("vec4",G.u32,null),C.vec2h=new C("vec2",G.f16,null),C.vec3h=new C("vec3",G.f16,null),C.vec4h=new C("vec4",G.f16,null),C.vec2b=new C("vec2",G.bool,null),C.vec3b=new C("vec3",G.bool,null),C.vec4b=new C("vec4",G.bool,null),C.mat2x2f=new C("mat2x2",G.f32,null),C.mat2x3f=new C("mat2x3",G.f32,null),C.mat2x4f=new C("mat2x4",G.f32,null),C.mat3x2f=new C("mat3x2",G.f32,null),C.mat3x3f=new C("mat3x3",G.f32,null),C.mat3x4f=new C("mat3x4",G.f32,null),C.mat4x2f=new C("mat4x2",G.f32,null),C.mat4x3f=new C("mat4x3",G.f32,null),C.mat4x4f=new C("mat4x4",G.f32,null),C.mat2x2h=new C("mat2x2",G.f16,null),C.mat2x3h=new C("mat2x3",G.f16,null),C.mat2x4h=new C("mat2x4",G.f16,null),C.mat3x2h=new C("mat3x2",G.f16,null),C.mat3x3h=new C("mat3x3",G.f16,null),C.mat3x4h=new C("mat3x4",G.f16,null),C.mat4x2h=new C("mat4x2",G.f16,null),C.mat4x3h=new C("mat4x3",G.f16,null),C.mat4x4h=new C("mat4x4",G.f16,null),C.mat2x2i=new C("mat2x2",G.i32,null),C.mat2x3i=new C("mat2x3",G.i32,null),C.mat2x4i=new C("mat2x4",G.i32,null),C.mat3x2i=new C("mat3x2",G.i32,null),C.mat3x3i=new C("mat3x3",G.i32,null),C.mat3x4i=new C("mat3x4",G.i32,null),C.mat4x2i=new C("mat4x2",G.i32,null),C.mat4x3i=new C("mat4x3",G.i32,null),C.mat4x4i=new C("mat4x4",G.i32,null),C.mat2x2u=new C("mat2x2",G.u32,null),C.mat2x3u=new C("mat2x3",G.u32,null),C.mat2x4u=new C("mat2x4",G.u32,null),C.mat3x2u=new C("mat3x2",G.u32,null),C.mat3x3u=new C("mat3x3",G.u32,null),C.mat3x4u=new C("mat3x4",G.u32,null),C.mat4x2u=new C("mat4x2",G.u32,null),C.mat4x3u=new C("mat4x3",G.u32,null),C.mat4x4u=new C("mat4x4",G.u32,null);class Qs extends G{constructor(e,t,n,s){super(e),this.storage=t,this.type=n,this.access=s}get astNodeType(){return"pointer"}}class Es extends G{constructor(e,t,n,s){super(e),this.attributes=t,this.format=n,this.count=s}get astNodeType(){return"array"}get isArray(){return!0}}class vs extends G{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"sampler"}}class jt extends Pt{constructor(){super(),this.postfix=null}}class Qn extends jt{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class Zt extends jt{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class Or extends jt{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return Ei.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}class vt extends jt{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class Li extends jt{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const n=e.evalExpression(this.initializer,e.context);return n!==null&&this.postfix?n.getSubData(e,this.postfix,e.context):n}return null}search(e){this.initializer.search(e)}}class Re extends jt{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof M}get isVector(){return this.value instanceof T||this.value instanceof oe}get scalarValue(){return this.value instanceof M?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof T||this.value instanceof oe?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class Ri extends jt{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class xs extends jt{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class Fi extends jt{constructor(){super()}}class Oe extends Fi{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class Rt extends Fi{constructor(e,t,n){super(),this.operator=e,this.left=t,this.right=n}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:e.name==="f32"||t.name==="f32"?G.f32:e.name==="u32"||t.name==="u32"?G.u32:G.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class $i extends Pt{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}}class js extends jt{constructor(){super()}get astNodeType(){return"default"}}class Vi extends $i{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class Gi extends $i{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class Qr extends Pt{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"argument"}}class Ra extends Pt{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class jr extends Pt{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"member"}}class zi extends Pt{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class Ot{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=Ot._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,n,s){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,n){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}Ot._id=0;class pr extends Ot{constructor(){super(new Mt("void",null),null)}toString(){return"void"}}pr.void=new pr;class jn extends Ot{constructor(e){super(new fr("pointer",e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,n,s){this.reference.setDataValue(e,t,n,s)}getSubData(e,t,n){return t?this.reference.getSubData(e,t,n):this}toString(){return`&${this.reference.toString()}`}}class M extends Ot{constructor(e,t,n=null){super(t,n),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name==="x32"?e-Math.floor(e)!=0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([e]):this.typeInfo.name==="u32"?this.data=new Uint32Array([e]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new M(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new M(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new M(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,n,s){if(n)return void console.error("SetDataValue: Scalar data does not support postfix",n);if(!(t instanceof M))return void console.error("SetDataValue: Invalid value",t);let r=t.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?r=Math.floor(r):this.typeInfo.name==="bool"&&(r=r?1:0),this.data[0]=r}getSubData(e,t,n){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}function Fa(u,e,t){const n=e.length;return n===2?t==="f32"?new T(new Float32Array(e),u.getTypeInfo("vec2f")):t==="i32"||t==="bool"?new T(new Int32Array(e),u.getTypeInfo("vec2i")):t==="u32"?new T(new Uint32Array(e),u.getTypeInfo("vec2u")):t==="f16"?new T(new Float32Array(e),u.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${t}`),null):n===3?t==="f32"?new T(new Float32Array(e),u.getTypeInfo("vec3f")):t==="i32"||t==="bool"?new T(new Int32Array(e),u.getTypeInfo("vec3i")):t==="u32"?new T(new Uint32Array(e),u.getTypeInfo("vec3u")):t==="f16"?new T(new Float32Array(e),u.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${t}`),null):n===4?t==="f32"?new T(new Float32Array(e),u.getTypeInfo("vec4f")):t==="i32"||t==="bool"?new T(new Int32Array(e),u.getTypeInfo("vec4i")):t==="u32"?new T(new Uint32Array(e),u.getTypeInfo("vec4u")):t==="f16"?new T(new Float32Array(e),u.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${t}`),null):(console.error(`getSubData: Invalid vector size ${e.length}`),null)}class T extends Ot{constructor(e,t,n=null){if(super(t,n),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const s=this.typeInfo.name;s==="vec2f"||s==="vec3f"||s==="vec4f"?this.data=new Float32Array(e):s==="vec2i"||s==="vec3i"||s==="vec4i"?this.data=new Int32Array(e):s==="vec2u"||s==="vec3u"||s==="vec4u"?this.data=new Uint32Array(e):s==="vec2h"||s==="vec3h"||s==="vec4h"?this.data=new Float32Array(e):s==="vec2b"||s==="vec3b"||s==="vec4b"?this.data=new Int32Array(e):s==="vec2"||s==="vec3"||s==="vec4"?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${s}`)}}clone(){if(this.data instanceof Float32Array)return new T(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new T(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new T(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,n,s){n instanceof Qn?console.error("TODO: Set vector postfix"):t instanceof T?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,n){if(t===null)return this;let s=e.getTypeInfo("f32");if(this.typeInfo instanceof Yn)s=this.typeInfo.format||s;else{const a=this.typeInfo.name;a==="vec2f"||a==="vec3f"||a==="vec4f"?s=e.getTypeInfo("f32"):a==="vec2i"||a==="vec3i"||a==="vec4i"?s=e.getTypeInfo("i32"):a==="vec2b"||a==="vec3b"||a==="vec4b"?s=e.getTypeInfo("bool"):a==="vec2u"||a==="vec3u"||a==="vec4u"?s=e.getTypeInfo("u32"):a==="vec2h"||a==="vec3h"||a==="vec4h"?s=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${a}`)}let r=this;for(;t!==null&&r!==null;){if(t instanceof xs){const a=t.index;let i=-1;if(a instanceof Re){if(!(a.value instanceof M))return console.error(`GetSubData: Invalid array index ${a.value}`),null;i=a.value.value}else{const c=e.evalExpression(a,n);if(!(c instanceof M))return console.error("GetSubData: Unknown index type",a),null;i=c.value}if(i<0||i>=r.data.length)return console.error("GetSubData: Index out of range",i),null;if(r.data instanceof Float32Array){const c=new Float32Array(r.data.buffer,r.data.byteOffset+4*i,1);return new M(c,s)}if(r.data instanceof Int32Array){const c=new Int32Array(r.data.buffer,r.data.byteOffset+4*i,1);return new M(c,s)}if(r.data instanceof Uint32Array){const c=new Uint32Array(r.data.buffer,r.data.byteOffset+4*i,1);return new M(c,s)}throw"GetSubData: Invalid data type"}if(!(t instanceof Qn))return console.error("GetSubData: Unknown postfix",t),null;{const a=t.value.toLowerCase();if(a.length===1){let c=0;if(a==="x"||a==="r")c=0;else if(a==="y"||a==="g")c=1;else if(a==="z"||a==="b")c=2;else{if(a!=="w"&&a!=="a")return console.error(`GetSubData: Unknown member ${a}`),null;c=3}if(this.data instanceof Float32Array){let h=new Float32Array(this.data.buffer,this.data.byteOffset+4*c,1);return new M(h,s,this)}if(this.data instanceof Int32Array){let h=new Int32Array(this.data.buffer,this.data.byteOffset+4*c,1);return new M(h,s,this)}if(this.data instanceof Uint32Array){let h=new Uint32Array(this.data.buffer,this.data.byteOffset+4*c,1);return new M(h,s,this)}}const i=[];for(const c of a)c==="x"||c==="r"?i.push(this.data[0]):c==="y"||c==="g"?i.push(this.data[1]):c==="z"||c==="b"?i.push(this.data[2]):c==="w"||c==="a"?i.push(this.data[3]):console.error(`GetDataValue: Unknown member ${c}`);r=Fa(e,i,s.name)}t=t.postfix}return r}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class oe extends Ot{constructor(e,t,n=null){super(t,n),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new oe(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,n,s){n instanceof Qn?console.error("TODO: Set matrix postfix"):t instanceof oe?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,n){if(t===null)return this;const s=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof Yn)this.typeInfo.format;else if(s.endsWith("f"))e.getTypeInfo("f32");else if(s.endsWith("i"))e.getTypeInfo("i32");else if(s.endsWith("u"))e.getTypeInfo("u32");else{if(!s.endsWith("h"))return console.error(`GetDataValue: Unknown type ${s}`),null;e.getTypeInfo("f16")}if(t instanceof xs){const r=t.index;let a=-1;if(r instanceof Re){if(!(r.value instanceof M))return console.error(`GetDataValue: Invalid array index ${r.value}`),null;a=r.value.value}else{const h=e.evalExpression(r,n);if(!(h instanceof M))return console.error("GetDataValue: Unknown index type",r),null;a=h.value}if(a<0||a>=this.data.length)return console.error("GetDataValue: Index out of range",a),null;const i=s.endsWith("h")?"h":"f";let c;if(s==="mat2x2"||s==="mat2x2f"||s==="mat2x2h"||s==="mat3x2"||s==="mat3x2f"||s==="mat3x2h"||s==="mat4x2"||s==="mat4x2f"||s==="mat4x2h")c=new T(new Float32Array(this.data.buffer,this.data.byteOffset+2*a*4,2),e.getTypeInfo(`vec2${i}`));else if(s==="mat2x3"||s==="mat2x3f"||s==="mat2x3h"||s==="mat3x3"||s==="mat3x3f"||s==="mat3x3h"||s==="mat4x3"||s==="mat4x3f"||s==="mat4x3h")c=new T(new Float32Array(this.data.buffer,this.data.byteOffset+3*a*4,3),e.getTypeInfo(`vec3${i}`));else{if(s!=="mat2x4"&&s!=="mat2x4f"&&s!=="mat2x4h"&&s!=="mat3x4"&&s!=="mat3x4f"&&s!=="mat3x4h"&&s!=="mat4x4"&&s!=="mat4x4f"&&s!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${s}`),null;c=new T(new Float32Array(this.data.buffer,this.data.byteOffset+4*a*4,4),e.getTypeInfo(`vec4${i}`))}return t.postfix?c.getSubData(e,t.postfix,n):c}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class Ie extends Ot{constructor(e,t,n=0,s=null){super(t,s),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=n}clone(){const e=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new Ie(e.buffer,this.typeInfo,0,null)}setDataValue(e,t,n,s){if(t===null)return void console.log("setDataValue: NULL data.");let r=this.offset,a=this.typeInfo;for(;n;){if(n instanceof xs)if(a instanceof Pn){const i=n.index;if(i instanceof Re){if(!(i.value instanceof M))return void console.error(`SetDataValue: Invalid index type ${i.value}`);r+=i.value.value*a.stride}else{const c=e.evalExpression(i,s);if(!(c instanceof M))return void console.error("SetDataValue: Unknown index type",i);r+=c.value*a.stride}a=a.format}else console.error(`SetDataValue: Type ${a.getTypeName()} is not an array`);else{if(!(n instanceof Qn))return void console.error("SetDataValue: Unknown postfix type",n);{const i=n.value;if(a instanceof On){let c=!1;for(const h of a.members)if(h.name===i){r+=h.offset,a=h.type,c=!0;break}if(!c)return void console.error(`SetDataValue: Member ${i} not found`)}else if(a instanceof Mt){const c=a.getTypeName();let h=0;if(i==="x"||i==="r")h=0;else if(i==="y"||i==="g")h=1;else if(i==="z"||i==="b")h=2;else{if(i!=="w"&&i!=="a")return void console.error(`SetDataValue: Unknown member ${i}`);h=3}if(!(t instanceof M))return void console.error("SetDataValue: Invalid value",t);const f=t.value;return c==="vec2f"?void(new Float32Array(this.buffer,r,2)[h]=f):c==="vec3f"?void(new Float32Array(this.buffer,r,3)[h]=f):c==="vec4f"?void(new Float32Array(this.buffer,r,4)[h]=f):c==="vec2i"?void(new Int32Array(this.buffer,r,2)[h]=f):c==="vec3i"?void(new Int32Array(this.buffer,r,3)[h]=f):c==="vec4i"?void(new Int32Array(this.buffer,r,4)[h]=f):c==="vec2u"?void(new Uint32Array(this.buffer,r,2)[h]=f):c==="vec3u"?void(new Uint32Array(this.buffer,r,3)[h]=f):c==="vec4u"?void(new Uint32Array(this.buffer,r,4)[h]=f):void console.error(`SetDataValue: Type ${c} is not a struct`)}}}n=n.postfix}this.setData(e,t,a,r,s)}setData(e,t,n,s,r){const a=n.getTypeName();if(a!=="f32"&&a!=="f16")if(a!=="i32"&&a!=="atomic<i32>"&&a!=="x32")if(a!=="u32"&&a!=="atomic<u32>")if(a!=="bool")if(a!=="vec2f"&&a!=="vec2h")if(a!=="vec3f"&&a!=="vec3h")if(a!=="vec4f"&&a!=="vec4h")if(a!=="vec2i")if(a!=="vec3i")if(a!=="vec4i")if(a!=="vec2u")if(a!=="vec3u")if(a!=="vec4u")if(a!=="vec2b")if(a!=="vec3b")if(a!=="vec4b")if(a!=="mat2x2f"&&a!=="mat2x2h")if(a!=="mat2x3f"&&a!=="mat2x3h")if(a!=="mat2x4f"&&a!=="mat2x4h")if(a!=="mat3x2f"&&a!=="mat3x2h")if(a!=="mat3x3f"&&a!=="mat3x3h")if(a!=="mat3x4f"&&a!=="mat3x4h")if(a!=="mat4x2f"&&a!=="mat4x2h")if(a!=="mat4x3f"&&a!=="mat4x3h")if(a!=="mat4x4f"&&a!=="mat4x4h")if(t instanceof Ie){if(n===t.typeInfo)return void new Uint8Array(this.buffer,s,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",a,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${a}`);else{const i=new Float32Array(this.buffer,s,16);t instanceof oe?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3],i[4]=t.data[4],i[5]=t.data[5],i[6]=t.data[6],i[7]=t.data[7],i[8]=t.data[8],i[9]=t.data[9],i[10]=t.data[10],i[11]=t.data[11],i[12]=t.data[12],i[13]=t.data[13],i[14]=t.data[14],i[15]=t.data[15]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15])}else{const i=new Float32Array(this.buffer,s,12);t instanceof oe?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3],i[4]=t.data[4],i[5]=t.data[5],i[6]=t.data[6],i[7]=t.data[7],i[8]=t.data[8],i[9]=t.data[9],i[10]=t.data[10],i[11]=t.data[11]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11])}else{const i=new Float32Array(this.buffer,s,8);t instanceof oe?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3],i[4]=t.data[4],i[5]=t.data[5],i[6]=t.data[6],i[7]=t.data[7]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7])}else{const i=new Float32Array(this.buffer,s,12);t instanceof oe?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3],i[4]=t.data[4],i[5]=t.data[5],i[6]=t.data[6],i[7]=t.data[7],i[8]=t.data[8],i[9]=t.data[9],i[10]=t.data[10],i[11]=t.data[11]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11])}else{const i=new Float32Array(this.buffer,s,9);t instanceof oe?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3],i[4]=t.data[4],i[5]=t.data[5],i[6]=t.data[6],i[7]=t.data[7],i[8]=t.data[8]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8])}else{const i=new Float32Array(this.buffer,s,6);t instanceof oe?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3],i[4]=t.data[4],i[5]=t.data[5]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5])}else{const i=new Float32Array(this.buffer,s,8);t instanceof oe?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3],i[4]=t.data[4],i[5]=t.data[5],i[6]=t.data[6],i[7]=t.data[7]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7])}else{const i=new Float32Array(this.buffer,s,6);t instanceof oe?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3],i[4]=t.data[4],i[5]=t.data[5]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5])}else{const i=new Float32Array(this.buffer,s,4);t instanceof oe?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3])}else{const i=new Uint32Array(this.buffer,s,4);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3])}else{const i=new Uint32Array(this.buffer,s,3);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2]):(i[0]=t[0],i[1]=t[1],i[2]=t[2])}else{const i=new Uint32Array(this.buffer,s,2);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1]):(i[0]=t[0],i[1]=t[1])}else{const i=new Uint32Array(this.buffer,s,4);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3])}else{const i=new Uint32Array(this.buffer,s,3);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2]):(i[0]=t[0],i[1]=t[1],i[2]=t[2])}else{const i=new Uint32Array(this.buffer,s,2);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1]):(i[0]=t[0],i[1]=t[1])}else{const i=new Int32Array(this.buffer,s,4);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3])}else{const i=new Int32Array(this.buffer,s,3);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2]):(i[0]=t[0],i[1]=t[1],i[2]=t[2])}else{const i=new Int32Array(this.buffer,s,2);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1]):(i[0]=t[0],i[1]=t[1])}else{const i=new Float32Array(this.buffer,s,4);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2],i[3]=t.data[3]):(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3])}else{const i=new Float32Array(this.buffer,s,3);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1],i[2]=t.data[2]):(i[0]=t[0],i[1]=t[1],i[2]=t[2])}else{const i=new Float32Array(this.buffer,s,2);t instanceof T?(i[0]=t.data[0],i[1]=t.data[1]):(i[0]=t[0],i[1]=t[1])}else t instanceof M&&(new Int32Array(this.buffer,s,1)[0]=t.value);else t instanceof M&&(new Uint32Array(this.buffer,s,1)[0]=t.value);else t instanceof M&&(new Int32Array(this.buffer,s,1)[0]=t.value);else t instanceof M&&(new Float32Array(this.buffer,s,1)[0]=t.value)}getSubData(e,t,n){var s,r,a;if(t===null)return this;let i=this.offset,c=this.typeInfo;for(;t;){if(t instanceof xs){const f=t.index,w=f instanceof jt?e.evalExpression(f,n):f;let B=0;if(w instanceof M?B=w.value:typeof w=="number"?B=w:console.error("GetDataValue: Invalid index type",f),c instanceof Pn)i+=B*c.stride,c=c.format;else{const F=c.getTypeName();F==="mat4x4"||F==="mat4x4f"||F==="mat4x4h"?(i+=16*B,c=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${c.getTypeName()} is not an array`)}}else{if(!(t instanceof Qn))return console.error("GetDataValue: Unknown postfix type",t),null;{const f=t.value;if(c instanceof On){let w=!1;for(const B of c.members)if(B.name===f){i+=B.offset,c=B.type,w=!0;break}if(!w)return console.error(`GetDataValue: Member ${f} not found`),null}else if(c instanceof Mt){const w=c.getTypeName();if(w==="vec2f"||w==="vec3f"||w==="vec4f"||w==="vec2i"||w==="vec3i"||w==="vec4i"||w==="vec2u"||w==="vec3u"||w==="vec4u"||w==="vec2b"||w==="vec3b"||w==="vec4b"||w==="vec2h"||w==="vec3h"||w==="vec4h"||w==="vec2"||w==="vec3"||w==="vec4"){if(f.length>0&&f.length<5){let B="f";const F=[];for(let Z=0;Z<f.length;++Z){const ie=f[Z].toLowerCase();let ae=0;if(ie==="x"||ie==="r")ae=0;else if(ie==="y"||ie==="g")ae=1;else if(ie==="z"||ie==="b")ae=2;else{if(ie!=="w"&&ie!=="a")return console.error(`Unknown member ${f}`),null;ae=3}if(f.length===1){if(w.endsWith("f"))return this.buffer.byteLength<i+4*ae+4?(console.log("Insufficient buffer data"),null):new M(new Float32Array(this.buffer,i+4*ae,1),e.getTypeInfo("f32"),this);if(w.endsWith("h"))return new M(new Float32Array(this.buffer,i+4*ae,1),e.getTypeInfo("f16"),this);if(w.endsWith("i"))return new M(new Int32Array(this.buffer,i+4*ae,1),e.getTypeInfo("i32"),this);if(w.endsWith("b"))return new M(new Int32Array(this.buffer,i+4*ae,1),e.getTypeInfo("bool"),this);if(w.endsWith("u"))return new M(new Uint32Array(this.buffer,i+4*ae,1),e.getTypeInfo("i32"),this)}if(w==="vec2f")F.push(new Float32Array(this.buffer,i,2)[ae]);else if(w==="vec3f"){if(i+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const me=new Float32Array(this.buffer,i,3);F.push(me[ae])}else if(w==="vec4f")F.push(new Float32Array(this.buffer,i,4)[ae]);else if(w==="vec2i")B="i",F.push(new Int32Array(this.buffer,i,2)[ae]);else if(w==="vec3i")B="i",F.push(new Int32Array(this.buffer,i,3)[ae]);else if(w==="vec4i")B="i",F.push(new Int32Array(this.buffer,i,4)[ae]);else if(w==="vec2u"){B="u";const me=new Uint32Array(this.buffer,i,2);F.push(me[ae])}else w==="vec3u"?(B="u",F.push(new Uint32Array(this.buffer,i,3)[ae])):w==="vec4u"&&(B="u",F.push(new Uint32Array(this.buffer,i,4)[ae]))}return F.length===2?c=e.getTypeInfo(`vec2${B}`):F.length===3?c=e.getTypeInfo(`vec3${B}`):F.length===4?c=e.getTypeInfo(`vec4${B}`):console.error(`GetDataValue: Invalid vector length ${F.length}`),new T(F,c,null)}return console.error(`GetDataValue: Unknown member ${f}`),null}return console.error(`GetDataValue: Type ${w} is not a struct`),null}}}t=t.postfix}const h=c.getTypeName();return h==="f32"?new M(new Float32Array(this.buffer,i,1),c,this):h==="i32"?new M(new Int32Array(this.buffer,i,1),c,this):h==="u32"?new M(new Uint32Array(this.buffer,i,1),c,this):h==="vec2f"?new T(new Float32Array(this.buffer,i,2),c,this):h==="vec3f"?new T(new Float32Array(this.buffer,i,3),c,this):h==="vec4f"?new T(new Float32Array(this.buffer,i,4),c,this):h==="vec2i"?new T(new Int32Array(this.buffer,i,2),c,this):h==="vec3i"?new T(new Int32Array(this.buffer,i,3),c,this):h==="vec4i"?new T(new Int32Array(this.buffer,i,4),c,this):h==="vec2u"?new T(new Uint32Array(this.buffer,i,2),c,this):h==="vec3u"?new T(new Uint32Array(this.buffer,i,3),c,this):h==="vec4u"?new T(new Uint32Array(this.buffer,i,4),c,this):c instanceof Yn&&c.name==="atomic"?((s=c.format)===null||s===void 0?void 0:s.name)==="u32"?new M(new Uint32Array(this.buffer,i,1)[0],c.format,this):((r=c.format)===null||r===void 0?void 0:r.name)==="i32"?new M(new Int32Array(this.buffer,i,1)[0],c.format,this):(console.error(`GetDataValue: Invalid atomic format ${(a=c.format)===null||a===void 0?void 0:a.name}`),null):new Ie(this.buffer,c,i,this)}toString(){let e="";if(this.typeInfo instanceof Pn)if(this.typeInfo.format.name==="f32"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name==="i32"){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name==="u32"){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name==="vec2f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let n=1;n<t.length/2;++n)e+=`, [${t[2*n]}, ${t[2*n+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}, ${t[n+3]}]`}else e="[...]";else this.typeInfo instanceof On?e+="{...}":e="[...]";return e}}class on extends Ot{constructor(e,t,n,s){super(t,null),this.data=e,this.descriptor=n,this.view=s}clone(){return new on(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;const n=this.descriptor.size;return n instanceof Array&&n.length>0?(e=n[0])!==null&&e!==void 0?e:0:n instanceof Object&&(t=n.width)!==null&&t!==void 0?t:0}get height(){var e,t;const n=this.descriptor.size;return n instanceof Array&&n.length>1?(e=n[1])!==null&&e!==void 0?e:0:n instanceof Object&&(t=n.height)!==null&&t!==void 0?t:0}get depthOrArrayLayers(){var e,t;const n=this.descriptor.size;return n instanceof Array&&n.length>2?(e=n[2])!==null&&e!==void 0?e:0:n instanceof Object&&(t=n.depthOrArrayLayers)!==null&&t!==void 0?t:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!==null&&e!==void 0?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!==null&&e!==void 0?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!==null&&e!==void 0?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!==null&&e!==void 0?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];const t=[this.width,this.height,this.depthOrArrayLayers];for(let n=0;n<t.length;++n)t[n]=Math.max(1,t[n]>>e);return t}get texelByteSize(){const e=this.format,t=lr[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const e=this.format,t=lr[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.format,t=lr[e],n=this.width;if(!e||n<=0||!t)return-1;const s=this.height,r=this.depthOrArrayLayers,a=this.dimension;return n/t.blockWidth*(a==="1d"?1:s/t.blockHeight)*t.bytesPerBlock*r}getPixel(e,t,n=0,s=0){const r=this.texelByteSize,a=this.bytesPerRow,i=this.height,c=this.data[s];return Pa(new Uint8Array(c),e,t,n,s,i,a,r,this.format)}setPixel(e,t,n,s,r){const a=this.texelByteSize,i=this.bytesPerRow,c=this.height,h=this.data[s];(function(f,w,B,F,Z,ie,ae,me,xe,J){const te=F*(ae>>=Z)*(ie>>=Z)+B*ae+w*me;switch(xe){case"r8unorm":return void ye(f,te,"8unorm",1,J);case"r8snorm":return void ye(f,te,"8snorm",1,J);case"r8uint":return void ye(f,te,"8uint",1,J);case"r8sint":return void ye(f,te,"8sint",1,J);case"rg8unorm":return void ye(f,te,"8unorm",2,J);case"rg8snorm":return void ye(f,te,"8snorm",2,J);case"rg8uint":return void ye(f,te,"8uint",2,J);case"rg8sint":return void ye(f,te,"8sint",2,J);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void ye(f,te,"8unorm",4,J);case"rgba8snorm":return void ye(f,te,"8snorm",4,J);case"rgba8uint":return void ye(f,te,"8uint",4,J);case"rgba8sint":return void ye(f,te,"8sint",4,J);case"r16uint":return void ye(f,te,"16uint",1,J);case"r16sint":return void ye(f,te,"16sint",1,J);case"r16float":return void ye(f,te,"16float",1,J);case"rg16uint":return void ye(f,te,"16uint",2,J);case"rg16sint":return void ye(f,te,"16sint",2,J);case"rg16float":return void ye(f,te,"16float",2,J);case"rgba16uint":return void ye(f,te,"16uint",4,J);case"rgba16sint":return void ye(f,te,"16sint",4,J);case"rgba16float":return void ye(f,te,"16float",4,J);case"r32uint":return void ye(f,te,"32uint",1,J);case"r32sint":return void ye(f,te,"32sint",1,J);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void ye(f,te,"32float",1,J);case"rg32uint":return void ye(f,te,"32uint",2,J);case"rg32sint":return void ye(f,te,"32sint",2,J);case"rg32float":return void ye(f,te,"32float",2,J);case"rgba32uint":return void ye(f,te,"32uint",4,J);case"rgba32sint":return void ye(f,te,"32sint",4,J);case"rgba32float":return void ye(f,te,"32float",4,J);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(h),e,t,n,s,c,i,a,this.format,r)}}(u=>{u[u.token=0]="token",u[u.keyword=1]="keyword",u[u.reserved=2]="reserved"})(O||(O={}));class P{constructor(e,t,n){this.name=e,this.type=t,this.rule=n}toString(){return this.name}}class b{}U=b,b.none=new P("",O.reserved,""),b.eof=new P("EOF",O.token,""),b.reserved={asm:new P("asm",O.reserved,"asm"),bf16:new P("bf16",O.reserved,"bf16"),do:new P("do",O.reserved,"do"),enum:new P("enum",O.reserved,"enum"),f16:new P("f16",O.reserved,"f16"),f64:new P("f64",O.reserved,"f64"),handle:new P("handle",O.reserved,"handle"),i8:new P("i8",O.reserved,"i8"),i16:new P("i16",O.reserved,"i16"),i64:new P("i64",O.reserved,"i64"),mat:new P("mat",O.reserved,"mat"),premerge:new P("premerge",O.reserved,"premerge"),regardless:new P("regardless",O.reserved,"regardless"),typedef:new P("typedef",O.reserved,"typedef"),u8:new P("u8",O.reserved,"u8"),u16:new P("u16",O.reserved,"u16"),u64:new P("u64",O.reserved,"u64"),unless:new P("unless",O.reserved,"unless"),using:new P("using",O.reserved,"using"),vec:new P("vec",O.reserved,"vec"),void:new P("void",O.reserved,"void")},b.keywords={array:new P("array",O.keyword,"array"),atomic:new P("atomic",O.keyword,"atomic"),bool:new P("bool",O.keyword,"bool"),f32:new P("f32",O.keyword,"f32"),i32:new P("i32",O.keyword,"i32"),mat2x2:new P("mat2x2",O.keyword,"mat2x2"),mat2x3:new P("mat2x3",O.keyword,"mat2x3"),mat2x4:new P("mat2x4",O.keyword,"mat2x4"),mat3x2:new P("mat3x2",O.keyword,"mat3x2"),mat3x3:new P("mat3x3",O.keyword,"mat3x3"),mat3x4:new P("mat3x4",O.keyword,"mat3x4"),mat4x2:new P("mat4x2",O.keyword,"mat4x2"),mat4x3:new P("mat4x3",O.keyword,"mat4x3"),mat4x4:new P("mat4x4",O.keyword,"mat4x4"),ptr:new P("ptr",O.keyword,"ptr"),sampler:new P("sampler",O.keyword,"sampler"),sampler_comparison:new P("sampler_comparison",O.keyword,"sampler_comparison"),struct:new P("struct",O.keyword,"struct"),texture_1d:new P("texture_1d",O.keyword,"texture_1d"),texture_2d:new P("texture_2d",O.keyword,"texture_2d"),texture_2d_array:new P("texture_2d_array",O.keyword,"texture_2d_array"),texture_3d:new P("texture_3d",O.keyword,"texture_3d"),texture_cube:new P("texture_cube",O.keyword,"texture_cube"),texture_cube_array:new P("texture_cube_array",O.keyword,"texture_cube_array"),texture_multisampled_2d:new P("texture_multisampled_2d",O.keyword,"texture_multisampled_2d"),texture_storage_1d:new P("texture_storage_1d",O.keyword,"texture_storage_1d"),texture_storage_2d:new P("texture_storage_2d",O.keyword,"texture_storage_2d"),texture_storage_2d_array:new P("texture_storage_2d_array",O.keyword,"texture_storage_2d_array"),texture_storage_3d:new P("texture_storage_3d",O.keyword,"texture_storage_3d"),texture_depth_2d:new P("texture_depth_2d",O.keyword,"texture_depth_2d"),texture_depth_2d_array:new P("texture_depth_2d_array",O.keyword,"texture_depth_2d_array"),texture_depth_cube:new P("texture_depth_cube",O.keyword,"texture_depth_cube"),texture_depth_cube_array:new P("texture_depth_cube_array",O.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new P("texture_depth_multisampled_2d",O.keyword,"texture_depth_multisampled_2d"),texture_external:new P("texture_external",O.keyword,"texture_external"),u32:new P("u32",O.keyword,"u32"),vec2:new P("vec2",O.keyword,"vec2"),vec3:new P("vec3",O.keyword,"vec3"),vec4:new P("vec4",O.keyword,"vec4"),bitcast:new P("bitcast",O.keyword,"bitcast"),block:new P("block",O.keyword,"block"),break:new P("break",O.keyword,"break"),case:new P("case",O.keyword,"case"),continue:new P("continue",O.keyword,"continue"),continuing:new P("continuing",O.keyword,"continuing"),default:new P("default",O.keyword,"default"),diagnostic:new P("diagnostic",O.keyword,"diagnostic"),discard:new P("discard",O.keyword,"discard"),else:new P("else",O.keyword,"else"),enable:new P("enable",O.keyword,"enable"),fallthrough:new P("fallthrough",O.keyword,"fallthrough"),false:new P("false",O.keyword,"false"),fn:new P("fn",O.keyword,"fn"),for:new P("for",O.keyword,"for"),function:new P("function",O.keyword,"function"),if:new P("if",O.keyword,"if"),let:new P("let",O.keyword,"let"),const:new P("const",O.keyword,"const"),loop:new P("loop",O.keyword,"loop"),while:new P("while",O.keyword,"while"),private:new P("private",O.keyword,"private"),read:new P("read",O.keyword,"read"),read_write:new P("read_write",O.keyword,"read_write"),return:new P("return",O.keyword,"return"),requires:new P("requires",O.keyword,"requires"),storage:new P("storage",O.keyword,"storage"),switch:new P("switch",O.keyword,"switch"),true:new P("true",O.keyword,"true"),alias:new P("alias",O.keyword,"alias"),type:new P("type",O.keyword,"type"),uniform:new P("uniform",O.keyword,"uniform"),var:new P("var",O.keyword,"var"),override:new P("override",O.keyword,"override"),workgroup:new P("workgroup",O.keyword,"workgroup"),write:new P("write",O.keyword,"write"),r8unorm:new P("r8unorm",O.keyword,"r8unorm"),r8snorm:new P("r8snorm",O.keyword,"r8snorm"),r8uint:new P("r8uint",O.keyword,"r8uint"),r8sint:new P("r8sint",O.keyword,"r8sint"),r16uint:new P("r16uint",O.keyword,"r16uint"),r16sint:new P("r16sint",O.keyword,"r16sint"),r16float:new P("r16float",O.keyword,"r16float"),rg8unorm:new P("rg8unorm",O.keyword,"rg8unorm"),rg8snorm:new P("rg8snorm",O.keyword,"rg8snorm"),rg8uint:new P("rg8uint",O.keyword,"rg8uint"),rg8sint:new P("rg8sint",O.keyword,"rg8sint"),r32uint:new P("r32uint",O.keyword,"r32uint"),r32sint:new P("r32sint",O.keyword,"r32sint"),r32float:new P("r32float",O.keyword,"r32float"),rg16uint:new P("rg16uint",O.keyword,"rg16uint"),rg16sint:new P("rg16sint",O.keyword,"rg16sint"),rg16float:new P("rg16float",O.keyword,"rg16float"),rgba8unorm:new P("rgba8unorm",O.keyword,"rgba8unorm"),rgba8unorm_srgb:new P("rgba8unorm_srgb",O.keyword,"rgba8unorm_srgb"),rgba8snorm:new P("rgba8snorm",O.keyword,"rgba8snorm"),rgba8uint:new P("rgba8uint",O.keyword,"rgba8uint"),rgba8sint:new P("rgba8sint",O.keyword,"rgba8sint"),bgra8unorm:new P("bgra8unorm",O.keyword,"bgra8unorm"),bgra8unorm_srgb:new P("bgra8unorm_srgb",O.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new P("rgb10a2unorm",O.keyword,"rgb10a2unorm"),rg11b10float:new P("rg11b10float",O.keyword,"rg11b10float"),rg32uint:new P("rg32uint",O.keyword,"rg32uint"),rg32sint:new P("rg32sint",O.keyword,"rg32sint"),rg32float:new P("rg32float",O.keyword,"rg32float"),rgba16uint:new P("rgba16uint",O.keyword,"rgba16uint"),rgba16sint:new P("rgba16sint",O.keyword,"rgba16sint"),rgba16float:new P("rgba16float",O.keyword,"rgba16float"),rgba32uint:new P("rgba32uint",O.keyword,"rgba32uint"),rgba32sint:new P("rgba32sint",O.keyword,"rgba32sint"),rgba32float:new P("rgba32float",O.keyword,"rgba32float"),static_assert:new P("static_assert",O.keyword,"static_assert")},b.tokens={decimal_float_literal:new P("decimal_float_literal",O.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new P("hex_float_literal",O.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new P("int_literal",O.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new P("uint_literal",O.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new P("name",O.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new P("ident",O.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new P("and",O.token,"&"),and_and:new P("and_and",O.token,"&&"),arrow:new P("arrow ",O.token,"->"),attr:new P("attr",O.token,"@"),forward_slash:new P("forward_slash",O.token,"/"),bang:new P("bang",O.token,"!"),bracket_left:new P("bracket_left",O.token,"["),bracket_right:new P("bracket_right",O.token,"]"),brace_left:new P("brace_left",O.token,"{"),brace_right:new P("brace_right",O.token,"}"),colon:new P("colon",O.token,":"),comma:new P("comma",O.token,","),equal:new P("equal",O.token,"="),equal_equal:new P("equal_equal",O.token,"=="),not_equal:new P("not_equal",O.token,"!="),greater_than:new P("greater_than",O.token,">"),greater_than_equal:new P("greater_than_equal",O.token,">="),shift_right:new P("shift_right",O.token,">>"),less_than:new P("less_than",O.token,"<"),less_than_equal:new P("less_than_equal",O.token,"<="),shift_left:new P("shift_left",O.token,"<<"),modulo:new P("modulo",O.token,"%"),minus:new P("minus",O.token,"-"),minus_minus:new P("minus_minus",O.token,"--"),period:new P("period",O.token,"."),plus:new P("plus",O.token,"+"),plus_plus:new P("plus_plus",O.token,"++"),or:new P("or",O.token,"|"),or_or:new P("or_or",O.token,"||"),paren_left:new P("paren_left",O.token,"("),paren_right:new P("paren_right",O.token,")"),semicolon:new P("semicolon",O.token,";"),star:new P("star",O.token,"*"),tilde:new P("tilde",O.token,"~"),underscore:new P("underscore",O.token,"_"),xor:new P("xor",O.token,"^"),plus_equal:new P("plus_equal",O.token,"+="),minus_equal:new P("minus_equal",O.token,"-="),times_equal:new P("times_equal",O.token,"*="),division_equal:new P("division_equal",O.token,"/="),modulo_equal:new P("modulo_equal",O.token,"%="),and_equal:new P("and_equal",O.token,"&="),or_equal:new P("or_equal",O.token,"|="),xor_equal:new P("xor_equal",O.token,"^="),shift_right_equal:new P("shift_right_equal",O.token,">>="),shift_left_equal:new P("shift_left_equal",O.token,"<<=")},b.simpleTokens={"@":U.tokens.attr,"{":U.tokens.brace_left,"}":U.tokens.brace_right,":":U.tokens.colon,",":U.tokens.comma,"(":U.tokens.paren_left,")":U.tokens.paren_right,";":U.tokens.semicolon},b.literalTokens={"&":U.tokens.and,"&&":U.tokens.and_and,"->":U.tokens.arrow,"/":U.tokens.forward_slash,"!":U.tokens.bang,"[":U.tokens.bracket_left,"]":U.tokens.bracket_right,"=":U.tokens.equal,"==":U.tokens.equal_equal,"!=":U.tokens.not_equal,">":U.tokens.greater_than,">=":U.tokens.greater_than_equal,">>":U.tokens.shift_right,"<":U.tokens.less_than,"<=":U.tokens.less_than_equal,"<<":U.tokens.shift_left,"%":U.tokens.modulo,"-":U.tokens.minus,"--":U.tokens.minus_minus,".":U.tokens.period,"+":U.tokens.plus,"++":U.tokens.plus_plus,"|":U.tokens.or,"||":U.tokens.or_or,"*":U.tokens.star,"~":U.tokens.tilde,_:U.tokens.underscore,"^":U.tokens.xor,"+=":U.tokens.plus_equal,"-=":U.tokens.minus_equal,"*=":U.tokens.times_equal,"/=":U.tokens.division_equal,"%=":U.tokens.modulo_equal,"&=":U.tokens.and_equal,"|=":U.tokens.or_equal,"^=":U.tokens.xor_equal,">>=":U.tokens.shift_right_equal,"<<=":U.tokens.shift_left_equal},b.regexTokens={decimal_float_literal:U.tokens.decimal_float_literal,hex_float_literal:U.tokens.hex_float_literal,int_literal:U.tokens.int_literal,uint_literal:U.tokens.uint_literal,ident:U.tokens.ident},b.storage_class=[U.keywords.function,U.keywords.private,U.keywords.workgroup,U.keywords.uniform,U.keywords.storage],b.access_mode=[U.keywords.read,U.keywords.write,U.keywords.read_write],b.sampler_type=[U.keywords.sampler,U.keywords.sampler_comparison],b.sampled_texture_type=[U.keywords.texture_1d,U.keywords.texture_2d,U.keywords.texture_2d_array,U.keywords.texture_3d,U.keywords.texture_cube,U.keywords.texture_cube_array],b.multisampled_texture_type=[U.keywords.texture_multisampled_2d],b.storage_texture_type=[U.keywords.texture_storage_1d,U.keywords.texture_storage_2d,U.keywords.texture_storage_2d_array,U.keywords.texture_storage_3d],b.depth_texture_type=[U.keywords.texture_depth_2d,U.keywords.texture_depth_2d_array,U.keywords.texture_depth_cube,U.keywords.texture_depth_cube_array,U.keywords.texture_depth_multisampled_2d],b.texture_external_type=[U.keywords.texture_external],b.any_texture_type=[...U.sampled_texture_type,...U.multisampled_texture_type,...U.storage_texture_type,...U.depth_texture_type,...U.texture_external_type],b.texel_format=[U.keywords.r8unorm,U.keywords.r8snorm,U.keywords.r8uint,U.keywords.r8sint,U.keywords.r16uint,U.keywords.r16sint,U.keywords.r16float,U.keywords.rg8unorm,U.keywords.rg8snorm,U.keywords.rg8uint,U.keywords.rg8sint,U.keywords.r32uint,U.keywords.r32sint,U.keywords.r32float,U.keywords.rg16uint,U.keywords.rg16sint,U.keywords.rg16float,U.keywords.rgba8unorm,U.keywords.rgba8unorm_srgb,U.keywords.rgba8snorm,U.keywords.rgba8uint,U.keywords.rgba8sint,U.keywords.bgra8unorm,U.keywords.bgra8unorm_srgb,U.keywords.rgb10a2unorm,U.keywords.rg11b10float,U.keywords.rg32uint,U.keywords.rg32sint,U.keywords.rg32float,U.keywords.rgba16uint,U.keywords.rgba16sint,U.keywords.rgba16float,U.keywords.rgba32uint,U.keywords.rgba32sint,U.keywords.rgba32float],b.const_literal=[U.tokens.int_literal,U.tokens.uint_literal,U.tokens.decimal_float_literal,U.tokens.hex_float_literal,U.keywords.true,U.keywords.false],b.literal_or_ident=[U.tokens.ident,U.tokens.int_literal,U.tokens.uint_literal,U.tokens.decimal_float_literal,U.tokens.hex_float_literal,U.tokens.name],b.element_count_expression=[U.tokens.int_literal,U.tokens.uint_literal,U.tokens.ident],b.template_types=[U.keywords.vec2,U.keywords.vec3,U.keywords.vec4,U.keywords.mat2x2,U.keywords.mat2x3,U.keywords.mat2x4,U.keywords.mat3x2,U.keywords.mat3x3,U.keywords.mat3x4,U.keywords.mat4x2,U.keywords.mat4x3,U.keywords.mat4x4,U.keywords.atomic,U.keywords.bitcast,...U.any_texture_type],b.attribute_name=[U.tokens.ident,U.keywords.block,U.keywords.diagnostic],b.assignment_operators=[U.tokens.equal,U.tokens.plus_equal,U.tokens.minus_equal,U.tokens.times_equal,U.tokens.division_equal,U.tokens.modulo_equal,U.tokens.and_equal,U.tokens.or_equal,U.tokens.xor_equal,U.tokens.shift_right_equal,U.tokens.shift_left_equal],b.increment_operators=[U.tokens.plus_plus,U.tokens.minus_minus];class Zr{constructor(e,t,n,s,r){this.type=e,this.lexeme=t,this.line=n,this.start=s,this.end=r}toString(){return this.lexeme}isTemplateType(){return b.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==b.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class $a{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Zr(b.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let a=1;for(;a>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),a--,a==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),a++)}return!0}}const t=b.simpleTokens[e];if(t)return this._addToken(t),!0;let n=b.none;const s=this._isAlpha(e),r=e==="_";if(this._isAlphaNumeric(e)){let a=this._peekAhead();for(;this._isAlphaNumeric(a);)e+=this._advance(),a=this._peekAhead()}if(s){const a=b.keywords[e];if(a)return this._addToken(a),!0}if(s||r)return this._addToken(b.tokens.ident),!0;for(;;){let a=this._findType(e);const i=this._peekAhead();if(e=="-"&&this._tokens.length>0){if(i=="=")return this._current++,e+=i,this._addToken(b.tokens.minus_equal),!0;if(i=="-")return this._current++,e+=i,this._addToken(b.tokens.minus_minus),!0;const c=this._tokens.length-1;if((b.literal_or_ident.indexOf(this._tokens[c].type)!=-1||this._tokens[c].type==b.tokens.paren_right)&&i!=">")return this._addToken(a),!0}if(e==">"&&(i==">"||i=="=")){let c=!1,h=this._tokens.length-1;for(let f=0;f<5&&h>=0&&b.assignment_operators.indexOf(this._tokens[h].type)===-1;++f,--h)if(this._tokens[h].type===b.tokens.less_than){h>0&&this._tokens[h-1].isArrayOrTemplateType()&&(c=!0);break}if(c)return this._addToken(a),!0}if(a===b.none){let c=e,h=0;const f=2;for(let w=0;w<f;++w)if(c+=this._peekAhead(w),a=this._findType(c),a!==b.none){h=w;break}if(a===b.none)return n!==b.none&&(this._current--,this._addToken(n),!0);e=c,this._current+=h+1}if(n=a,this._isAtEnd())break;e+=this._advance()}return n!==b.none&&(this._addToken(n),!0)}_findType(e){for(const n in b.regexTokens){const s=b.regexTokens[n];if(this._match(e,s.rule))return s}return b.literalTokens[e]||b.none}_match(e,t){const n=t.exec(e);return n&&n.index==0&&n[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!=="_"&&e!=="."&&e!=="("&&e!==")"&&e!=="["&&e!=="]"&&e!=="{"&&e!=="}"&&e!==","&&e!==";"&&e!==":"&&e!=="="&&e!=="!"&&e!=="<"&&e!==">"&&e!=="+"&&e!=="-"&&e!=="*"&&e!=="/"&&e!=="%"&&e!=="&"&&e!=="|"&&e!=="^"&&e!=="~"&&e!=="@"&&e!=="#"&&e!=="?"&&e!=="'"&&e!=="`"&&e!=='"'&&e!=="\\"&&e!==`
`&&e!=="\r"&&e!=="	"&&e!=="\0"}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e==="_"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new Zr(e,t,this._line,this._start,this._current))}}function j(u){return Array.isArray(u)||(u==null?void 0:u.buffer)instanceof ArrayBuffer}const tr=new Float32Array(1),Va=new Uint32Array(tr.buffer),Ga=new Uint32Array(tr.buffer),nr=new Int32Array(1),za=new Float32Array(nr.buffer),qa=new Uint32Array(nr.buffer),sr=new Uint32Array(1),Wa=new Float32Array(sr.buffer),Ha=new Int32Array(sr.buffer);function Kr(u,e,t){if(e===t)return u;if(e==="f32"){if(t==="i32"||t==="x32")return tr[0]=u,Va[0];if(t==="u32")return tr[0]=u,Ga[0]}else if(e==="i32"||e==="x32"){if(t==="f32")return nr[0]=u,za[0];if(t==="u32")return nr[0]=u,qa[0]}else if(e==="u32"){if(t==="f32")return sr[0]=u,Wa[0];if(t==="i32"||t==="x32")return sr[0]=u,Ha[0]}return console.error(`Unsupported cast from ${e} to ${t}`),u}class Xa{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class Xs{constructor(e,t){this.align=e,this.size=t}}class rn{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new Na,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}updateAST(e){for(const t of e)t instanceof Is&&this._functions.set(t.name,new Xa(t));for(const t of e)if(t instanceof an){const n=this.getTypeInfo(t,null);n instanceof On&&this.structs.push(n)}for(const t of e)if(t instanceof Mr)this.aliases.push(this._getAliasInfo(t));else if(t instanceof Dr){const n=t,s=this._getAttributeNum(n.attributes,"id",0),r=n.type!=null?this.getTypeInfo(n.type,n.attributes):null;this.overrides.push(new Aa(n.name,r,n.attributes,s))}else if(this._isUniformVar(t)){const n=t,s=this._getAttributeNum(n.attributes,"group",0),r=this._getAttributeNum(n.attributes,"binding",0),a=this.getTypeInfo(n.type,n.attributes),i=new Hs(n.name,a,s,r,n.attributes,mn.Uniform,n.access);i.access||(i.access="read"),this.uniforms.push(i)}else if(this._isStorageVar(t)){const n=t,s=this._getAttributeNum(n.attributes,"group",0),r=this._getAttributeNum(n.attributes,"binding",0),a=this.getTypeInfo(n.type,n.attributes),i=this._isStorageTexture(a),c=new Hs(n.name,a,s,r,n.attributes,i?mn.StorageTexture:mn.Storage,n.access);c.access||(c.access="read"),this.storage.push(c)}else if(this._isTextureVar(t)){const n=t,s=this._getAttributeNum(n.attributes,"group",0),r=this._getAttributeNum(n.attributes,"binding",0),a=this.getTypeInfo(n.type,n.attributes),i=this._isStorageTexture(a),c=new Hs(n.name,a,s,r,n.attributes,i?mn.StorageTexture:mn.Texture,n.access);c.access||(c.access="read"),i?this.storage.push(c):this.textures.push(c)}else if(this._isSamplerVar(t)){const n=t,s=this._getAttributeNum(n.attributes,"group",0),r=this._getAttributeNum(n.attributes,"binding",0),a=this.getTypeInfo(n.type,n.attributes),i=new Hs(n.name,a,s,r,n.attributes,mn.Sampler,n.access);this.samplers.push(i)}for(const t of e)if(t instanceof Is){const n=this._getAttribute(t,"vertex"),s=this._getAttribute(t,"fragment"),r=this._getAttribute(t,"compute"),a=n||s||r,i=new Da(t.name,a==null?void 0:a.name,t.attributes);i.attributes=t.attributes,i.startLine=t.startLine,i.endLine=t.endLine,this.functions.push(i),this._functions.get(t.name).info=i,a&&(this._functions.get(t.name).inUse=!0,i.inUse=!0,i.resources=this._findResources(t,!!a),i.inputs=this._getInputs(t.args),i.outputs=this._getOutputs(t.returnType),this.entry[a.name].push(i)),i.arguments=t.args.map(c=>new Sa(c.name,this.getTypeInfo(c.type,c.attributes),c.attributes)),i.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search(n=>{var s,r,a;if(n instanceof zi){if(n.value)if(j(n.value))for(const i of n.value)for(const c of this.overrides)i===c.name&&((s=t.info)===null||s===void 0||s.overrides.push(c));else for(const i of this.overrides)n.value===i.name&&((r=t.info)===null||r===void 0||r.overrides.push(i))}else if(n instanceof vt)for(const i of this.overrides)n.name===i.name&&((a=t.info)===null||a===void 0||a.overrides.push(i))});for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var n;for(const s of e.calls){const r=(n=this._functions.get(s.name))===null||n===void 0?void 0:n.info;r&&t.add(r)}}findResource(e,t,n){if(n){for(const s of this.entry.compute)if(s.name===n){for(const r of s.resources)if(r.group==e&&r.binding==t)return r}for(const s of this.entry.vertex)if(s.name===n){for(const r of s.resources)if(r.group==e&&r.binding==t)return r}for(const s of this.entry.fragment)if(s.name===n){for(const r of s.resources)if(r.group==e&&r.binding==t)return r}}for(const s of this.uniforms)if(s.group==e&&s.binding==t)return s;for(const s of this.storage)if(s.group==e&&s.binding==t)return s;for(const s of this.textures)if(s.group==e&&s.binding==t)return s;for(const s of this.samplers)if(s.group==e&&s.binding==t)return s;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const n=[],s=this,r=[];return e.search(a=>{if(a instanceof Js)r.push({});else if(a instanceof er)r.pop();else if(a instanceof fn){const i=a;t&&i.type!==null&&this._markStructsFromAST(i.type),r.length>0&&(r[r.length-1][i.name]=i)}else if(a instanceof Zt){const i=a;t&&i.type!==null&&this._markStructsFromAST(i.type)}else if(a instanceof Ts){const i=a;t&&i.type!==null&&this._markStructsFromAST(i.type),r.length>0&&(r[r.length-1][i.name]=i)}else if(a instanceof vt){const i=a;if(r.length>0&&r[r.length-1][i.name])return;const c=s._findResource(i.name);c&&n.push(c)}else if(a instanceof Or){const i=a,c=s._functions.get(i.name);c&&(t&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=s._findResources(c.node,t)),n.push(...c.resources))}else if(a instanceof Nr){const i=a,c=s._functions.get(i.name);c&&(t&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=s._findResources(c.node,t)),n.push(...c.resources))}}),[...new Map(n.map(a=>[a.name,a])).values()]}getBindGroups(){const e=[];function t(n,s){n>=e.length&&(e.length=n+1),e[n]===void 0&&(e[n]=[]),s>=e[n].length&&(e[n].length=s+1)}for(const n of this.uniforms)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.storage)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.textures)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.samplers)t(n.group,n.binding),e[n.group][n.binding]=n;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof an)this._getStructOutputs(e,t);else{const n=this._getOutputInfo(e);n!==null&&t.push(n)}return t}_getStructOutputs(e,t){for(const n of e.members)if(n.type instanceof an)this._getStructOutputs(n.type,t);else{const s=this._getAttribute(n,"location")||this._getAttribute(n,"builtin");if(s!==null){const r=this.getTypeInfo(n.type,n.type.attributes),a=this._parseInt(s.value),i=new Hr(n.name,r,s.name,a);t.push(i)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const n=this.getTypeInfo(e,e.attributes),s=this._parseInt(t.value);return new Hr("",n,t.name,s)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const n of e)if(n.type instanceof an)this._getStructInputs(n.type,t);else{const s=this._getInputInfo(n);s!==null&&t.push(s)}return t}_getStructInputs(e,t){for(const n of e.members)if(n.type instanceof an)this._getStructInputs(n.type,t);else{const s=this._getInputInfo(n);s!==null&&t.push(s)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const n=this._getAttribute(e,"interpolation"),s=this.getTypeInfo(e.type,e.attributes),r=this._parseInt(t.value),a=new Ia(e.name,s,t.name,r);return n!==null&&(a.interpolation=this._parseString(n.value)),a}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new Ea(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(const t of this.structs)if(t.name==e)return t;for(const t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof Qs){const s=e.type?this.getTypeInfo(e.type,e.attributes):null,r=new fr(e.name,s,t);return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof Es){const s=e,r=s.format?this.getTypeInfo(s.format,s.attributes):null,a=new Pn(s.name,t);return a.format=r,a.count=s.count,this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof an){const s=e,r=new On(s.name,t);r.startLine=s.startLine,r.endLine=s.endLine;for(const a of s.members){const i=this.getTypeInfo(a.type,a.attributes);r.members.push(new Wr(a.name,i,a.attributes))}return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof vs){const s=e,r=s.format instanceof G,a=s.format?r?this.getTypeInfo(s.format,null):new Mt(s.format,null):null,i=new Yn(s.name,a,t,s.access);return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof C){const s=e,r=s.format?this.getTypeInfo(s.format,null):null,a=new Yn(s.name,r,t,s.access);return this._types.set(e,a),this._updateTypeInfo(a),a}const n=new Mt(e.name,t);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){var t,n,s;const r=this._getTypeSize(e);if(e.size=(t=r==null?void 0:r.size)!==null&&t!==void 0?t:0,e instanceof Pn&&e.format){const a=this._getTypeSize(e.format);e.stride=Math.max((n=a==null?void 0:a.size)!==null&&n!==void 0?n:0,(s=a==null?void 0:a.align)!==null&&s!==void 0?s:0),this._updateTypeInfo(e.format)}e instanceof fr&&this._updateTypeInfo(e.format),e instanceof On&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let n=0,s=0,r=0,a=0;for(let i=0,c=e.members.length;i<c;++i){const h=e.members[i],f=this._getTypeSize(h);if(!f)continue;(t=this._getAlias(h.type.name))!==null&&t!==void 0||h.type;const w=f.align,B=f.size;n=this._roundUp(w,n+s),s=B,r=n,a=Math.max(a,w),h.offset=n,h.size=B,this._updateTypeInfo(h.type)}e.size=this._roundUp(a,r+s),e.align=a}_getTypeSize(e){var t,n;if(e==null)return null;const s=this._getAttributeNum(e.attributes,"size",0),r=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Wr&&(e=e.type),e instanceof Mt){const a=this._getAlias(e.name);a!==null&&(e=a)}{const a=rn._typeInfo[e.name];if(a!==void 0){const i=((t=e.format)===null||t===void 0?void 0:t.name)==="f16"?2:1;return new Xs(Math.max(r,a.align/i),Math.max(s,a.size/i))}}{const a=rn._typeInfo[e.name.substring(0,e.name.length-1)];if(a){const i=e.name[e.name.length-1]==="h"?2:1;return new Xs(Math.max(r,a.align/i),Math.max(s,a.size/i))}}if(e instanceof Pn){let a=e,i=8,c=8;const h=this._getTypeSize(a.format);return h!==null&&(c=h.size,i=h.align),c=a.count*this._getAttributeNum((n=e==null?void 0:e.attributes)!==null&&n!==void 0?n:null,"stride",this._roundUp(i,c)),s&&(c=s),new Xs(Math.max(r,i),Math.max(s,c))}if(e instanceof On){let a=0,i=0,c=0,h=0,f=0;for(const w of e.members){const B=this._getTypeSize(w.type);B!==null&&(a=Math.max(B.align,a),c=this._roundUp(B.align,c+h),h=B.size,f=c)}return i=this._roundUp(a,f+h),new Xs(Math.max(r,a),Math.max(s,i))}return null}_isUniformVar(e){return e instanceof fn&&e.storage=="uniform"}_isStorageVar(e){return e instanceof fn&&e.storage=="storage"}_isTextureVar(e){return e instanceof fn&&e.type!==null&&rn._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof fn&&e.type!==null&&rn._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const n=e;if(!n||!n.attributes)return null;const s=n.attributes;for(let r of s)if(r.name==t)return r;return null}_getAttributeNum(e,t,n){if(e===null)return n;for(let s of e)if(s.name==t){let r=s!==null&&s.value!==null?s.value:n;return r instanceof Array&&(r=r[0]),typeof r=="number"?r:typeof r=="string"?parseInt(r):n}return n}_roundUp(e,t){return Math.ceil(t/e)*e}}rn._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},rn._textureTypes=b.any_texture_type.map(u=>u.name),rn._samplerTypes=b.sampler_type.map(u=>u.name);let Pr=0;class Cr{constructor(e,t,n){this.id=Pr++,this.name=e,this.value=t,this.node=n}clone(){return new Cr(this.name,this.value,this.node)}}class Br{constructor(e){this.id=Pr++,this.name=e.name,this.node=e}clone(){return new Br(this.node)}}class Ur{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=Pr++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?(t=this.variables.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?(t=this.functions.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,n){this.variables.set(e,new Cr(e,t,n??null))}setVariable(e,t,n){const s=this.getVariable(e);s!==null?s.value=t:this.createVariable(e,t,n)}getVariableValue(e){var t;const n=this.getVariable(e);return(t=n==null?void 0:n.value)!==null&&t!==void 0?t:null}clone(){return new Ur(this)}}class Ya{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class Qa{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const n=this.exec.evalExpression(e.args[0],t);let s=!0;if(n instanceof T)return n.data.forEach(r=>{r||(s=!1)}),new M(s?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T){const s=n.data.some(r=>r);return new M(s?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const n=this.exec.evalExpression(e.args[2],t);if(!(n instanceof M))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return n.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.evalExpression(n,t);if(s instanceof Ie&&s.typeInfo.size===0){const r=s.typeInfo,a=s.buffer.byteLength/r.stride;return new M(a,this.getTypeInfo("u32"))}return new M(s.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.abs(r)),n.typeInfo);const s=n;return new M(Math.abs(s.value),s.typeInfo)}Acos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.acos(r)),n.typeInfo);const s=n;return new M(Math.acos(s.value),n.typeInfo)}Acosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.acosh(r)),n.typeInfo);const s=n;return new M(Math.acosh(s.value),n.typeInfo)}Asin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.asin(r)),n.typeInfo);const s=n;return new M(Math.asin(s.value),n.typeInfo)}Asinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.asinh(r)),n.typeInfo);const s=n;return new M(Math.asinh(s.value),n.typeInfo)}Atan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.atan(r)),n.typeInfo);const s=n;return new M(Math.atan(s.value),n.typeInfo)}Atanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.atanh(r)),n.typeInfo);const s=n;return new M(Math.atanh(s.value),n.typeInfo)}Atan2(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof T&&s instanceof T)return new T(n.data.map((i,c)=>Math.atan2(i,s.data[c])),n.typeInfo);const r=n,a=s;return new M(Math.atan2(r.value,a.value),n.typeInfo)}Ceil(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.ceil(r)),n.typeInfo);const s=n;return new M(Math.ceil(s.value),n.typeInfo)}_clamp(e,t,n){return Math.min(Math.max(e,t),n)}Clamp(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),r=this.exec.evalExpression(e.args[2],t);if(n instanceof T&&s instanceof T&&r instanceof T)return new T(n.data.map((h,f)=>this._clamp(h,s.data[f],r.data[f])),n.typeInfo);const a=n,i=s,c=r;return new M(this._clamp(a.value,i.value,c.value),n.typeInfo)}Cos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.cos(r)),n.typeInfo);const s=n;return new M(Math.cos(s.value),n.typeInfo)}Cosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.cosh(r)),n.typeInfo);const s=n;return new M(Math.cos(s.value),n.typeInfo)}CountLeadingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.clz32(r)),n.typeInfo);const s=n;return new M(Math.clz32(s.value),n.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>this._countOneBits(r)),n.typeInfo);const s=n;return new M(this._countOneBits(s.value),n.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>this._countTrailingZeros(r)),n.typeInfo);const s=n;return new M(this._countTrailingZeros(s.value),n.typeInfo)}Cross(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof T&&s instanceof T){if(n.data.length!==3||s.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const r=n.data,a=s.data;return new T([r[1]*a[2]-a[1]*r[2],r[2]*a[0]-a[2]*r[0],r[0]*a[1]-a[0]*r[1]],n.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const n=this.exec.evalExpression(e.args[0],t),s=180/Math.PI;return n instanceof T?new T(n.data.map(r=>r*s),n.typeInfo):new M(n.value*s,this.getTypeInfo("f32"))}Determinant(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof oe){const s=n.data,r=n.typeInfo.getTypeName(),a=r.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(r==="mat2x2"||r==="mat2x2f"||r==="mat2x2h")return new M(s[0]*s[3]-s[1]*s[2],a);if(r==="mat2x3"||r==="mat2x3f"||r==="mat2x3h")return new M(s[0]*(s[4]*s[8]-s[5]*s[7])-s[1]*(s[3]*s[8]-s[5]*s[6])+s[2]*(s[3]*s[7]-s[4]*s[6]),a);if(r==="mat2x4"||r==="mat2x4f"||r==="mat2x4h")console.error(`TODO: Determinant for ${r}`);else if(r==="mat3x2"||r==="mat3x2f"||r==="mat3x2h")console.error(`TODO: Determinant for ${r}`);else{if(r==="mat3x3"||r==="mat3x3f"||r==="mat3x3h")return new M(s[0]*(s[4]*s[8]-s[5]*s[7])-s[1]*(s[3]*s[8]-s[5]*s[6])+s[2]*(s[3]*s[7]-s[4]*s[6]),a);r==="mat3x4"||r==="mat3x4f"||r==="mat3x4h"||r==="mat4x2"||r==="mat4x2f"||r==="mat4x2h"||r==="mat4x3"||r==="mat4x3f"||r==="mat4x3h"?console.error(`TODO: Determinant for ${r}`):r!=="mat4x4"&&r!=="mat4x4f"&&r!=="mat4x4h"||console.error(`TODO: Determinant for ${r}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof T&&s instanceof T){let i=0;for(let c=0;c<n.data.length;++c)i+=(n.data[c]-s.data[c])*(n.data[c]-s.data[c]);return new M(Math.sqrt(i),this.getTypeInfo("f32"))}const r=n,a=s;return new M(Math.abs(r.value-a.value),n.typeInfo)}_dot(e,t){let n=0;for(let s=0;s<e.length;++s)n+=t[s]*e[s];return n}Dot(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);return n instanceof T&&s instanceof T?new M(this._dot(n.data,s.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.exp(r)),n.typeInfo);const s=n;return new M(Math.exp(s.value),n.typeInfo)}Exp2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.pow(2,r)),n.typeInfo);const s=n;return new M(Math.pow(2,s.value),n.typeInfo)}ExtractBits(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),r=this.exec.evalExpression(e.args[2],t);if(s.typeInfo.name!=="u32"&&s.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(r.typeInfo.name!=="u32"&&r.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const a=s.value,i=r.value;if(n instanceof T)return new T(n.data.map(h=>h>>a&(1<<i)-1),n.typeInfo);if(n.typeInfo.name!=="i32"&&n.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const c=n.value;return new M(c>>a&(1<<i)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),r=this.exec.evalExpression(e.args[2],t);if(n instanceof T&&s instanceof T&&r instanceof T){const a=this._dot(s.data,r.data);return new T(a<0?Array.from(n.data):n.data.map(i=>-i),n.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>this._firstLeadingBit(r)),n.typeInfo);const s=n;return new M(this._firstLeadingBit(s.value),n.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>this._firstTrailingBit(r)),n.typeInfo);const s=n;return new M(this._firstTrailingBit(s.value),n.typeInfo)}Floor(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.floor(r)),n.typeInfo);const s=n;return new M(Math.floor(s.value),n.typeInfo)}Fma(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),r=this.exec.evalExpression(e.args[2],t);if(n instanceof T&&s instanceof T&&r instanceof T)return n.data.length!==s.data.length||n.data.length!==r.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new T(n.data.map((h,f)=>h*s.data[f]+r.data[f]),n.typeInfo);const a=n,i=s,c=r;return new M(a.value*i.value+c.value,a.typeInfo)}Fract(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>r-Math.floor(r)),n.typeInfo);const s=n;return new M(s.value-Math.floor(s.value),n.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),r=this.exec.evalExpression(e.args[2],t),a=this.exec.evalExpression(e.args[3],t);if(r.typeInfo.name!=="u32"&&r.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const i=r.value,c=(1<<a.value)-1<<i,h=~c;if(n instanceof T&&s instanceof T)return new T(n.data.map((B,F)=>B&h|s.data[F]<<i&c),n.typeInfo);const f=n.value,w=s.value;return new M(f&h|w<<i&c,n.typeInfo)}InverseSqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>1/Math.sqrt(r)),n.typeInfo);const s=n;return new M(1/Math.sqrt(s.value),n.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T){let r=0;return n.data.forEach(a=>{r+=a*a}),new M(Math.sqrt(r),this.getTypeInfo("f32"))}const s=n;return new M(Math.abs(s.value),n.typeInfo)}Log(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.log(r)),n.typeInfo);const s=n;return new M(Math.log(s.value),n.typeInfo)}Log2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.log2(r)),n.typeInfo);const s=n;return new M(Math.log2(s.value),n.typeInfo)}Max(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof T&&s instanceof T)return new T(n.data.map((i,c)=>Math.max(i,s.data[c])),n.typeInfo);const r=n,a=s;return new M(Math.max(r.value,a.value),n.typeInfo)}Min(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof T&&s instanceof T)return new T(n.data.map((i,c)=>Math.min(i,s.data[c])),n.typeInfo);const r=n,a=s;return new M(Math.min(r.value,a.value),n.typeInfo)}Mix(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),r=this.exec.evalExpression(e.args[2],t);if(n instanceof T&&s instanceof T&&r instanceof T)return new T(n.data.map((c,h)=>n.data[h]*(1-r.data[h])+s.data[h]*r.data[h]),n.typeInfo);const a=s,i=r;return new M(n.value*(1-i.value)+a.value*i.value,n.typeInfo)}Modf(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof T&&s instanceof T)return new T(n.data.map((a,i)=>a%s.data[i]),n.typeInfo);const r=s;return new M(n.value%r.value,n.typeInfo)}Normalize(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T){const s=this.Length(e,t).value;return new T(n.data.map(r=>r/s),n.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof T&&s instanceof T)return new T(n.data.map((i,c)=>Math.pow(i,s.data[c])),n.typeInfo);const r=n,a=s;return new M(Math.pow(r.value,a.value),n.typeInfo)}QuantizeToF16(e,t){const n=this.exec.evalExpression(e.args[0],t);return n instanceof T?new T(n.data.map(s=>s),n.typeInfo):new M(n.value,n.typeInfo)}Radians(e,t){const n=this.exec.evalExpression(e.args[0],t);return n instanceof T?new T(n.data.map(s=>s*Math.PI/180),n.typeInfo):new M(n.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof T&&s instanceof T){const r=this._dot(n.data,s.data);return new T(n.data.map((a,i)=>a-2*r*s.data[i]),n.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),r=this.exec.evalExpression(e.args[2],t);if(n instanceof T&&s instanceof T&&r instanceof M){const a=this._dot(s.data,n.data);return new T(n.data.map((i,c)=>{const h=1-r.value*r.value*(1-a*a);if(h<0)return 0;const f=Math.sqrt(h);return r.value*i-(r.value*a+f)*s.data[c]}),n.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.round(r)),n.typeInfo);const s=n;return new M(Math.round(s.value),n.typeInfo)}Saturate(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.min(Math.max(r,0),1)),n.typeInfo);const s=n;return new M(Math.min(Math.max(s.value,0),1),n.typeInfo)}Sign(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.sign(r)),n.typeInfo);const s=n;return new M(Math.sign(s.value),n.typeInfo)}Sin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.sin(r)),n.typeInfo);const s=n;return new M(Math.sin(s.value),n.typeInfo)}Sinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.sinh(r)),n.typeInfo);const s=n;return new M(Math.sinh(s.value),n.typeInfo)}_smoothstep(e,t,n){const s=Math.min(Math.max((n-e)/(t-e),0),1);return s*s*(3-2*s)}SmoothStep(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),r=this.exec.evalExpression(e.args[2],t);if(r instanceof T&&n instanceof T&&s instanceof T)return new T(r.data.map((h,f)=>this._smoothstep(n.data[f],s.data[f],h)),r.typeInfo);const a=n,i=s,c=r;return new M(this._smoothstep(a.value,i.value,c.value),r.typeInfo)}Sqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.sqrt(r)),n.typeInfo);const s=n;return new M(Math.sqrt(s.value),n.typeInfo)}Step(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(s instanceof T&&n instanceof T)return new T(s.data.map((a,i)=>a<n.data[i]?0:1),s.typeInfo);const r=n;return new M(s.value<r.value?0:1,r.typeInfo)}Tan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.tan(r)),n.typeInfo);const s=n;return new M(Math.tan(s.value),n.typeInfo)}Tanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.tanh(r)),n.typeInfo);const s=n;return new M(Math.tanh(s.value),n.typeInfo)}_getTransposeType(e){const t=e.getTypeName();return t==="mat2x2f"||t==="mat2x2h"?e:t==="mat2x3f"?this.getTypeInfo("mat3x2f"):t==="mat2x3h"?this.getTypeInfo("mat3x2h"):t==="mat2x4f"?this.getTypeInfo("mat4x2f"):t==="mat2x4h"?this.getTypeInfo("mat4x2h"):t==="mat3x2f"?this.getTypeInfo("mat2x3f"):t==="mat3x2h"?this.getTypeInfo("mat2x3h"):t==="mat3x3f"||t==="mat3x3h"?e:t==="mat3x4f"?this.getTypeInfo("mat4x3f"):t==="mat3x4h"?this.getTypeInfo("mat4x3h"):t==="mat4x2f"?this.getTypeInfo("mat2x4f"):t==="mat4x2h"?this.getTypeInfo("mat2x4h"):t==="mat4x3f"?this.getTypeInfo("mat3x4f"):t==="mat4x3h"?this.getTypeInfo("mat3x4h"):(t==="mat4x4f"||t==="mat4x4h"||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const n=this.exec.evalExpression(e.args[0],t);if(!(n instanceof oe))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const s=this._getTransposeType(n.typeInfo);if(n.typeInfo.name==="mat2x2"||n.typeInfo.name==="mat2x2f"||n.typeInfo.name==="mat2x2h"){const r=n.data;return new oe([r[0],r[2],r[1],r[3]],s)}if(n.typeInfo.name==="mat2x3"||n.typeInfo.name==="mat2x3f"||n.typeInfo.name==="mat2x3h"){const r=n.data;return new oe([r[0],r[3],r[6],r[1],r[4],r[7]],s)}if(n.typeInfo.name==="mat2x4"||n.typeInfo.name==="mat2x4f"||n.typeInfo.name==="mat2x4h"){const r=n.data;return new oe([r[0],r[4],r[8],r[12],r[1],r[5],r[9],r[13]],s)}if(n.typeInfo.name==="mat3x2"||n.typeInfo.name==="mat3x2f"||n.typeInfo.name==="mat3x2h"){const r=n.data;return new oe([r[0],r[3],r[1],r[4],r[2],r[5]],s)}if(n.typeInfo.name==="mat3x3"||n.typeInfo.name==="mat3x3f"||n.typeInfo.name==="mat3x3h"){const r=n.data;return new oe([r[0],r[3],r[6],r[1],r[4],r[7],r[2],r[5],r[8]],s)}if(n.typeInfo.name==="mat3x4"||n.typeInfo.name==="mat3x4f"||n.typeInfo.name==="mat3x4h"){const r=n.data;return new oe([r[0],r[4],r[8],r[12],r[1],r[5],r[9],r[13],r[2],r[6],r[10],r[14]],s)}if(n.typeInfo.name==="mat4x2"||n.typeInfo.name==="mat4x2f"||n.typeInfo.name==="mat4x2h"){const r=n.data;return new oe([r[0],r[4],r[1],r[5],r[2],r[6]],s)}if(n.typeInfo.name==="mat4x3"||n.typeInfo.name==="mat4x3f"||n.typeInfo.name==="mat4x3h"){const r=n.data;return new oe([r[0],r[4],r[8],r[1],r[5],r[9],r[2],r[6],r[10]],s)}if(n.typeInfo.name==="mat4x4"||n.typeInfo.name==="mat4x4f"||n.typeInfo.name==="mat4x4h"){const r=n.data;return new oe([r[0],r[4],r[8],r[12],r[1],r[5],r[9],r[13],r[2],r[6],r[10],r[14],r[3],r[7],r[11],r[15]],s)}return console.error(`Invalid matrix type ${n.typeInfo.name}`),null}Trunc(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof T)return new T(n.data.map(r=>Math.trunc(r)),n.typeInfo);const s=n;return new M(Math.trunc(s.value),n.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){const n=e.args[0],s=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(n instanceof vt){const r=n.name,a=t.getVariableValue(r);if(a instanceof on){if(s<0||s>=a.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;const i=a.getMipLevelSize(s),c=a.dimension;return c==="1d"?new M(i[0],this.getTypeInfo("u32")):c==="3d"?new T(i,this.getTypeInfo("vec3u")):c==="2d"?new T(i.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${c} not found. Line ${e.line}`),null)}return console.error(`Texture ${r} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){const n=e.args[0],s=this.exec.evalExpression(e.args[1],t),r=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(s instanceof T)||s.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(n instanceof vt){const a=n.name,i=t.getVariableValue(a);if(i instanceof on){const c=Math.floor(s.data[0]),h=Math.floor(s.data[1]);if(c<0||c>=i.width||h<0||h>=i.height)return console.error(`Texture ${a} out of bounds. Line ${e.line}`),null;const f=i.getPixel(c,h,0,r);return f===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new T(f,this.getTypeInfo("vec4f"))}return console.error(`Texture ${a} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){const n=e.args[0];if(n instanceof vt){const s=n.name,r=t.getVariableValue(s);return r instanceof on?new M(r.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${s} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){const n=e.args[0];if(n instanceof vt){const s=n.name,r=t.getVariableValue(s);return r instanceof on?new M(r.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${s} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){const n=e.args[0];if(n instanceof vt){const s=n.name,r=t.getVariableValue(s);return r instanceof on?new M(r.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${s} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){const n=e.args[0],s=this.exec.evalExpression(e.args[1],t),r=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,a=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(a.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(s instanceof T)||s.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(n instanceof vt){const i=n.name,c=t.getVariableValue(i);if(c instanceof on){const h=c.getMipLevelSize(0),f=Math.floor(s.data[0]),w=Math.floor(s.data[1]);return f<0||f>=h[0]||w<0||w>=h[1]?(console.error(`Texture ${i} out of bounds. Line ${e.line}`),null):(c.setPixel(f,w,0,r,Array.from(a)),null)}return console.error(`Texture ${i} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t);return t.getVariable(s).value.getSubData(this.exec,n.postfix,t)}AtomicStore(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t),r=t.getVariable(s);let a=e.args[1];const i=this.exec.evalExpression(a,t),c=r.value.getSubData(this.exec,n.postfix,t);return c instanceof M&&i instanceof M&&(c.value=i.value),r.value instanceof Ie&&r.value.setDataValue(this.exec,c,n.postfix,t),null}AtomicAdd(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t),r=t.getVariable(s);let a=e.args[1];const i=this.exec.evalExpression(a,t),c=r.value.getSubData(this.exec,n.postfix,t),h=new M(c.value,c.typeInfo);return c instanceof M&&i instanceof M&&(c.value+=i.value),r.value instanceof Ie&&r.value.setDataValue(this.exec,c,n.postfix,t),h}AtomicSub(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t),r=t.getVariable(s);let a=e.args[1];const i=this.exec.evalExpression(a,t),c=r.value.getSubData(this.exec,n.postfix,t),h=new M(c.value,c.typeInfo);return c instanceof M&&i instanceof M&&(c.value-=i.value),r.value instanceof Ie&&r.value.setDataValue(this.exec,c,n.postfix,t),h}AtomicMax(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t),r=t.getVariable(s);let a=e.args[1];const i=this.exec.evalExpression(a,t),c=r.value.getSubData(this.exec,n.postfix,t),h=new M(c.value,c.typeInfo);return c instanceof M&&i instanceof M&&(c.value=Math.max(c.value,i.value)),r.value instanceof Ie&&r.value.setDataValue(this.exec,c,n.postfix,t),h}AtomicMin(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t),r=t.getVariable(s);let a=e.args[1];const i=this.exec.evalExpression(a,t),c=r.value.getSubData(this.exec,n.postfix,t),h=new M(c.value,c.typeInfo);return c instanceof M&&i instanceof M&&(c.value=Math.min(c.value,i.value)),r.value instanceof Ie&&r.value.setDataValue(this.exec,c,n.postfix,t),h}AtomicAnd(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t),r=t.getVariable(s);let a=e.args[1];const i=this.exec.evalExpression(a,t),c=r.value.getSubData(this.exec,n.postfix,t),h=new M(c.value,c.typeInfo);return c instanceof M&&i instanceof M&&(c.value=c.value&i.value),r.value instanceof Ie&&r.value.setDataValue(this.exec,c,n.postfix,t),h}AtomicOr(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t),r=t.getVariable(s);let a=e.args[1];const i=this.exec.evalExpression(a,t),c=r.value.getSubData(this.exec,n.postfix,t),h=new M(c.value,c.typeInfo);return c instanceof M&&i instanceof M&&(c.value=c.value|i.value),r.value instanceof Ie&&r.value.setDataValue(this.exec,c,n.postfix,t),h}AtomicXor(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t),r=t.getVariable(s);let a=e.args[1];const i=this.exec.evalExpression(a,t),c=r.value.getSubData(this.exec,n.postfix,t),h=new M(c.value,c.typeInfo);return c instanceof M&&i instanceof M&&(c.value=c.value^i.value),r.value instanceof Ie&&r.value.setDataValue(this.exec,c,n.postfix,t),h}AtomicExchange(e,t){let n=e.args[0];n instanceof Oe&&(n=n.right);const s=this.exec.getVariableName(n,t),r=t.getVariable(s);let a=e.args[1];const i=this.exec.evalExpression(a,t),c=r.value.getSubData(this.exec,n.postfix,t),h=new M(c.value,c.typeInfo);return c instanceof M&&i instanceof M&&(c.value=i.value),r.value instanceof Ie&&r.value.setDataValue(this.exec,c,n.postfix,t),h}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}const hr={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},ut={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class Je extends Ya{constructor(e,t){var n;super(),this.ast=e??[],this.reflection=new rn,this.reflection.updateAST(this.ast),this.context=(n=t==null?void 0:t.clone())!==null&&n!==void 0?n:new Ur,this.builtins=new Qa(this),this.typeInfo={bool:this.getTypeInfo(G.bool),i32:this.getTypeInfo(G.i32),u32:this.getTypeInfo(G.u32),f32:this.getTypeInfo(G.f32),f16:this.getTypeInfo(G.f16),vec2f:this.getTypeInfo(C.vec2f),vec2u:this.getTypeInfo(C.vec2u),vec2i:this.getTypeInfo(C.vec2i),vec2h:this.getTypeInfo(C.vec2h),vec3f:this.getTypeInfo(C.vec3f),vec3u:this.getTypeInfo(C.vec3u),vec3i:this.getTypeInfo(C.vec3i),vec3h:this.getTypeInfo(C.vec3h),vec4f:this.getTypeInfo(C.vec4f),vec4u:this.getTypeInfo(C.vec4u),vec4i:this.getTypeInfo(C.vec4i),vec4h:this.getTypeInfo(C.vec4h),mat2x2f:this.getTypeInfo(C.mat2x2f),mat2x3f:this.getTypeInfo(C.mat2x3f),mat2x4f:this.getTypeInfo(C.mat2x4f),mat3x2f:this.getTypeInfo(C.mat3x2f),mat3x3f:this.getTypeInfo(C.mat3x3f),mat3x4f:this.getTypeInfo(C.mat3x4f),mat4x2f:this.getTypeInfo(C.mat4x2f),mat4x3f:this.getTypeInfo(C.mat4x3f),mat4x4f:this.getTypeInfo(C.mat4x4f)}}getVariableValue(e){var t,n;const s=(n=(t=this.context.getVariable(e))===null||t===void 0?void 0:t.value)!==null&&n!==void 0?n:null;if(s===null)return null;if(s instanceof M)return s.value;if(s instanceof T||s instanceof oe)return Array.from(s.data);if(s instanceof Ie&&s.typeInfo instanceof Pn){if(s.typeInfo.format.name==="u32")return Array.from(new Uint32Array(s.buffer,s.offset,s.typeInfo.count));if(s.typeInfo.format.name==="i32")return Array.from(new Int32Array(s.buffer,s.offset,s.typeInfo.count));if(s.typeInfo.format.name==="f32")return Array.from(new Float32Array(s.buffer,s.offset,s.typeInfo.count))}return console.error(`Unsupported return variable type ${s.typeInfo.name}`),null}execute(e){(e=e??{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,n,s){const r=this.context.clone();(s=s??{}).constants&&this._setOverrides(s.constants,r),this._execStatements(this.ast,r);const a=r.getFunction(e);if(!a)return void console.error(`Function ${e} not found`);if(typeof t=="number")t=[t,1,1];else{if(t.length===0)return void console.error("Invalid dispatch count");t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const i=t[0],c=t[1],h=t[2],f=this.getTypeInfo("vec3u");r.setVariable("@num_workgroups",new T(t,f));for(const w in n)for(const B in n[w]){const F=n[w][B];r.variables.forEach(Z=>{var ie;const ae=Z.node;if(ae!=null&&ae.attributes){let me=null,xe=null;for(const J of ae.attributes)J.name==="binding"?me=J.value:J.name==="group"&&(xe=J.value);if(B==me&&w==xe)if(F.texture!==void 0&&F.descriptor!==void 0){const J=new on(F.texture,this.getTypeInfo(ae.type),F.descriptor,(ie=F.texture.view)!==null&&ie!==void 0?ie:null);Z.value=J}else F.uniform!==void 0?Z.value=new Ie(F.uniform,this.getTypeInfo(ae.type)):Z.value=new Ie(F,this.getTypeInfo(ae.type))}})}for(let w=0;w<h;++w)for(let B=0;B<c;++B)for(let F=0;F<i;++F)r.setVariable("@workgroup_id",new T([F,B,w],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(a,[F,B,w],r)}execStatement(e,t){if(e instanceof Pi)return this.evalExpression(e.value,t);if(e instanceof Bi){if(e.condition){const n=this.evalExpression(e.condition,t);if(!(n instanceof M))throw new Error("Invalid break-if condition");if(!n.value)return null}return Je._breakObj}if(e instanceof Ui)return Je._continueObj;if(e instanceof Ts)this._let(e,t);else if(e instanceof fn)this._var(e,t);else if(e instanceof Ys)this._const(e,t);else if(e instanceof Is)this._function(e,t);else{if(e instanceof Oi)return this._if(e,t);if(e instanceof Mi)return this._switch(e,t);if(e instanceof Ai)return this._for(e,t);if(e instanceof Ii)return this._while(e,t);if(e instanceof Ni)return this._loop(e,t);if(e instanceof dr){const n=t.clone();return n.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,n)}if(e instanceof Di)this._assign(e,t);else if(e instanceof Si)this._increment(e,t);else{if(e instanceof an)return null;if(e instanceof Dr){const n=e.name;t.getVariable(n)===null&&t.setVariable(n,new M(0,this.getTypeInfo("u32")))}else if(e instanceof Nr)this._call(e,t);else{if(e instanceof Ci||e instanceof Mr)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof Rt?this._evalBinaryOp(e,t):e instanceof Re?this._evalLiteral(e,t):e instanceof vt?this._evalVariable(e,t):e instanceof Or?this._evalCall(e,t):e instanceof Zt?this._evalCreate(e,t):e instanceof Li?this._evalConst(e,t):e instanceof Ri?this._evalBitcast(e,t):e instanceof Oe?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof G){const s=this.reflection.getTypeInfo(e);if(s!==null)return s}let n=(t=this.typeInfo[e])!==null&&t!==void 0?t:null;return n!==null||(n=this.reflection.getTypeInfoByName(e)),n}_setOverrides(e,t){for(const n in e){const s=e[n],r=this.reflection.getOverrideInfo(n);r!==null?(r.type===null&&(r.type=this.getTypeInfo("u32")),r.type.name==="u32"||r.type.name==="i32"||r.type.name==="f32"||r.type.name==="f16"?t.setVariable(n,new M(s,r.type)):r.type.name==="bool"?t.setVariable(n,new M(s?1:0,r.type)):r.type.name==="vec2"||r.type.name==="vec3"||r.type.name==="vec4"||r.type.name==="vec2f"||r.type.name==="vec3f"||r.type.name==="vec4f"||r.type.name==="vec2i"||r.type.name==="vec3i"||r.type.name==="vec4i"||r.type.name==="vec2u"||r.type.name==="vec3u"||r.type.name==="vec4u"||r.type.name==="vec2h"||r.type.name==="vec3h"||r.type.name==="vec4h"?t.setVariable(n,new T(s,r.type)):console.error(`Invalid constant type for ${n}`)):console.error(`Override ${n} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,n){const s=[1,1,1];for(const f of e.node.attributes)if(f.name==="workgroup_size"){if(f.value.length>0){const w=n.getVariableValue(f.value[0]);s[0]=w instanceof M?w.value:parseInt(f.value[0])}if(f.value.length>1){const w=n.getVariableValue(f.value[1]);s[1]=w instanceof M?w.value:parseInt(f.value[1])}if(f.value.length>2){const w=n.getVariableValue(f.value[2]);s[2]=w instanceof M?w.value:parseInt(f.value[2])}}const r=this.getTypeInfo("vec3u"),a=this.getTypeInfo("u32");n.setVariable("@workgroup_size",new T(s,r));const i=s[0],c=s[1],h=s[2];for(let f=0,w=0;f<h;++f)for(let B=0;B<c;++B)for(let F=0;F<i;++F,++w){const Z=[F,B,f],ie=[F+t[0]*s[0],B+t[1]*s[1],f+t[2]*s[2]];n.setVariable("@local_invocation_id",new T(Z,r)),n.setVariable("@global_invocation_id",new T(ie,r)),n.setVariable("@local_invocation_index",new M(w,a)),this._dispatchExec(e,n)}}_dispatchExec(e,t){for(const n of e.node.args)for(const s of n.attributes)if(s.name==="builtin"){const r=`@${s.value}`,a=t.getVariable(r);a!==void 0&&t.variables.set(n.name,a)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof Oe;)e=e.right;return e instanceof vt?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(const n of e){if(n instanceof Array){const r=t.clone(),a=this._execStatements(n,r);if(a)return a;continue}const s=this.execStatement(n,t);if(s)return s}return null}_call(e,t){const n=t.clone();n.currentFunctionName=e.name;const s=t.getFunction(e.name);if(s){for(let r=0;r<s.node.args.length;++r){const a=s.node.args[r],i=this.evalExpression(e.args[r],n);n.setVariable(a.name,i,a)}this._execStatements(s.node.body,n)}else e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){const n=this.getVariableName(e.variable,t),s=t.getVariable(n);s?e.operator==="++"?s.value instanceof M?s.value.value++:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):e.operator==="--"?s.value instanceof M?s.value.value--:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${n} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof vt){const n=this.getVariableName(e,t),s=t.getVariable(n);return s===null?(console.error(`Variable ${n} not found. Line ${e.line}`),null):s.value.getSubData(this,e.postfix,t)}if(e instanceof Oe){if(e.operator==="*"){const n=this._getVariableData(e.right,t);return n instanceof jn?n.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator==="&"){const n=this._getVariableData(e.right,t);return new jn(n)}}return null}_assign(e,t){let n=null,s="<var>",r=null;if(e.variable instanceof Oe){const c=this._getVariableData(e.variable,t),h=this.evalExpression(e.value,t),f=e.operator;if(f==="="){if(c instanceof M||c instanceof T||c instanceof oe){if(h instanceof M||h instanceof T||h instanceof oe&&c.data.length===h.data.length)return void c.data.set(h.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(c instanceof Ie&&h instanceof Ie&&c.buffer.byteLength-c.offset>=h.buffer.byteLength-h.offset)return void(c.buffer.byteLength%4==0?new Uint32Array(c.buffer,c.offset,c.typeInfo.size/4).set(new Uint32Array(h.buffer,h.offset,h.typeInfo.size/4)):new Uint8Array(c.buffer,c.offset,c.typeInfo.size).set(new Uint8Array(h.buffer,h.offset,h.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(f==="+=")return c instanceof M||c instanceof T||c instanceof oe?h instanceof M||h instanceof T||h instanceof oe?void c.data.set(h.data.map((w,B)=>c.data[B]+w)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(f==="-=")return(c instanceof M||c instanceof T||c instanceof oe)&&(h instanceof M||h instanceof T||h instanceof oe)?void c.data.set(h.data.map((w,B)=>c.data[B]-w)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof Oe){if(e.variable.operator==="*"){s=this.getVariableName(e.variable.right,t);const c=t.getVariable(s);if(!(c&&c.value instanceof jn))return void console.error(`Variable ${s} is not a pointer. Line ${e.line}`);n=c.value.reference;let h=e.variable.postfix;if(!h){let f=e.variable.right;for(;f instanceof Oe;){if(f.postfix){h=f.postfix;break}f=f.right}}h&&(n=n.getSubData(this,h,t))}}else{r=e.variable.postfix,s=this.getVariableName(e.variable,t);const c=t.getVariable(s);if(c===null)return void console.error(`Variable ${s} not found. Line ${e.line}`);n=c.value}if(n instanceof jn&&(n=n.reference),n===null)return void console.error(`Variable ${s} not found. Line ${e.line}`);const a=this.evalExpression(e.value,t),i=e.operator;if(i==="=")if(n instanceof Ie)n.setDataValue(this,a,r,t);else if(r){if(!(n instanceof T||n instanceof oe))return void console.error(`Variable ${s} is not a vector or matrix. Line ${e.line}`);if(r instanceof xs){const c=this.evalExpression(r.index,t).value;if(n instanceof T){if(!(a instanceof M))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[c]=a.value}else{if(!(n instanceof oe))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);{const h=this.evalExpression(r.index,t).value;if(h<0)return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);if(!(a instanceof T))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);{const f=n.typeInfo.getTypeName();if(f==="mat2x2"||f==="mat2x2f"||f==="mat2x2h"){if(!(h<2&&a.data.length===2))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[2*h]=a.data[0],n.data[2*h+1]=a.data[1]}else if(f==="mat2x3"||f==="mat2x3f"||f==="mat2x3h"){if(!(h<2&&a.data.length===3))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[3*h]=a.data[0],n.data[3*h+1]=a.data[1],n.data[3*h+2]=a.data[2]}else if(f==="mat2x4"||f==="mat2x4f"||f==="mat2x4h"){if(!(h<2&&a.data.length===4))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[4*h]=a.data[0],n.data[4*h+1]=a.data[1],n.data[4*h+2]=a.data[2],n.data[4*h+3]=a.data[3]}else if(f==="mat3x2"||f==="mat3x2f"||f==="mat3x2h"){if(!(h<3&&a.data.length===2))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[2*h]=a.data[0],n.data[2*h+1]=a.data[1]}else if(f==="mat3x3"||f==="mat3x3f"||f==="mat3x3h"){if(!(h<3&&a.data.length===3))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[3*h]=a.data[0],n.data[3*h+1]=a.data[1],n.data[3*h+2]=a.data[2]}else if(f==="mat3x4"||f==="mat3x4f"||f==="mat3x4h"){if(!(h<3&&a.data.length===4))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[4*h]=a.data[0],n.data[4*h+1]=a.data[1],n.data[4*h+2]=a.data[2],n.data[4*h+3]=a.data[3]}else if(f==="mat4x2"||f==="mat4x2f"||f==="mat4x2h"){if(!(h<4&&a.data.length===2))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[2*h]=a.data[0],n.data[2*h+1]=a.data[1]}else if(f==="mat4x3"||f==="mat4x3f"||f==="mat4x3h"){if(!(h<4&&a.data.length===3))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[3*h]=a.data[0],n.data[3*h+1]=a.data[1],n.data[3*h+2]=a.data[2]}else{if(f!=="mat4x4"&&f!=="mat4x4f"&&f!=="mat4x4h")return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);if(!(h<4&&a.data.length===4))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);n.data[4*h]=a.data[0],n.data[4*h+1]=a.data[1],n.data[4*h+2]=a.data[2],n.data[4*h+3]=a.data[3]}}}}}else if(r instanceof Qn){const c=r.value;if(!(n instanceof T))return void console.error(`Invalid assignment to ${c}. Variable ${s} is not a vector. Line ${e.line}`);if(a instanceof M){if(c.length>1)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${e.line}`);if(c==="x")n.data[0]=a.value;else if(c==="y"){if(n.data.length<2)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${e.line}`);n.data[1]=a.value}else if(c==="z"){if(n.data.length<3)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${e.line}`);n.data[2]=a.value}else if(c==="w"){if(n.data.length<4)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${e.line}`);n.data[3]=a.value}}else{if(!(a instanceof T))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);if(c.length!==a.data.length)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${e.line}`);for(let h=0;h<c.length;++h){const f=c[h];if(f==="x"||f==="r")n.data[0]=a.data[h];else if(f==="y"||f==="g"){if(a.data.length<2)return void console.error(`Invalid assignment to ${f} for variable ${s}. Line ${e.line}`);n.data[1]=a.data[h]}else if(f==="z"||f==="b"){if(a.data.length<3)return void console.error(`Invalid assignment to ${f} for variable ${s}. Line ${e.line}`);n.data[2]=a.data[h]}else{if(f!=="w"&&f!=="a")return void console.error(`Invalid assignment to ${f} for variable ${s}. Line ${e.line}`);if(a.data.length<4)return void console.error(`Invalid assignment to ${f} for variable ${s}. Line ${e.line}`);n.data[3]=a.data[h]}}}}}else n instanceof M&&a instanceof M?n.value=a.value:n instanceof T&&a instanceof T||n instanceof oe&&a instanceof oe?n.data.set(a.data):console.error(`Invalid assignment to ${s}. Line ${e.line}`);else{const c=n.getSubData(this,r,t);if(c instanceof T&&a instanceof M){const h=c.data,f=a.value;if(i==="+=")for(let w=0;w<h.length;++w)h[w]+=f;else if(i==="-=")for(let w=0;w<h.length;++w)h[w]-=f;else if(i==="*=")for(let w=0;w<h.length;++w)h[w]*=f;else if(i==="/=")for(let w=0;w<h.length;++w)h[w]/=f;else if(i==="%=")for(let w=0;w<h.length;++w)h[w]%=f;else if(i==="&=")for(let w=0;w<h.length;++w)h[w]&=f;else if(i==="|=")for(let w=0;w<h.length;++w)h[w]|=f;else if(i==="^=")for(let w=0;w<h.length;++w)h[w]^=f;else if(i==="<<=")for(let w=0;w<h.length;++w)h[w]<<=f;else if(i===">>=")for(let w=0;w<h.length;++w)h[w]>>=f;else console.error(`Invalid operator ${i}. Line ${e.line}`)}else if(c instanceof T&&a instanceof T){const h=c.data,f=a.data;if(h.length!==f.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(i==="+=")for(let w=0;w<h.length;++w)h[w]+=f[w];else if(i==="-=")for(let w=0;w<h.length;++w)h[w]-=f[w];else if(i==="*=")for(let w=0;w<h.length;++w)h[w]*=f[w];else if(i==="/=")for(let w=0;w<h.length;++w)h[w]/=f[w];else if(i==="%=")for(let w=0;w<h.length;++w)h[w]%=f[w];else if(i==="&=")for(let w=0;w<h.length;++w)h[w]&=f[w];else if(i==="|=")for(let w=0;w<h.length;++w)h[w]|=f[w];else if(i==="^=")for(let w=0;w<h.length;++w)h[w]^=f[w];else if(i==="<<=")for(let w=0;w<h.length;++w)h[w]<<=f[w];else if(i===">>=")for(let w=0;w<h.length;++w)h[w]>>=f[w];else console.error(`Invalid operator ${i}. Line ${e.line}`)}else{if(!(c instanceof M&&a instanceof M))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);i==="+="?c.value+=a.value:i==="-="?c.value-=a.value:i==="*="?c.value*=a.value:i==="/="?c.value/=a.value:i==="%="?c.value%=a.value:i==="&="?c.value&=a.value:i==="|="?c.value|=a.value:i==="^="?c.value^=a.value:i==="<<="?c.value<<=a.value:i===">>="?c.value>>=a.value:console.error(`Invalid operator ${i}. Line ${e.line}`)}n instanceof Ie&&n.setDataValue(this,c,r,t)}}_function(e,t){const n=new Br(e);t.functions.set(e.name,n)}_const(e,t){let n=null;e.value!==null&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_let(e,t){let n=null;if(e.value!==null){if(n=this.evalExpression(e.value,t),n===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof Oe||(n=n.clone())}else{const s=e.type.name;if(s==="f32"||s==="i32"||s==="u32"||s==="bool"||s==="f16"||s==="vec2"||s==="vec3"||s==="vec4"||s==="vec2f"||s==="vec3f"||s==="vec4f"||s==="vec2i"||s==="vec3i"||s==="vec4i"||s==="vec2u"||s==="vec3u"||s==="vec4u"||s==="vec2h"||s==="vec3h"||s==="vec4h"||s==="vec2b"||s==="vec3b"||s==="vec4b"||s==="mat2x2"||s==="mat2x3"||s==="mat2x4"||s==="mat3x2"||s==="mat3x3"||s==="mat3x4"||s==="mat4x2"||s==="mat4x3"||s==="mat4x4"||s==="mat2x2f"||s==="mat2x3f"||s==="mat2x4f"||s==="mat3x2f"||s==="mat3x3f"||s==="mat3x4f"||s==="mat4x2f"||s==="mat4x3f"||s==="mat4x4f"||s==="mat2x2h"||s==="mat2x3h"||s==="mat2x4h"||s==="mat3x2h"||s==="mat3x3h"||s==="mat3x4h"||s==="mat4x2h"||s==="mat4x3h"||s==="mat4x4h"||s==="array"){const r=new Zt(e.type,[]);n=this._evalCreate(r,t)}}t.createVariable(e.name,n,e)}_var(e,t){let n=null;if(e.value!==null){if(n=this.evalExpression(e.value,t),n===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof Oe||(n=n.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);const s=e.type.name;if(s==="f32"||s==="i32"||s==="u32"||s==="bool"||s==="f16"||s==="vec2"||s==="vec3"||s==="vec4"||s==="vec2f"||s==="vec3f"||s==="vec4f"||s==="vec2i"||s==="vec3i"||s==="vec4i"||s==="vec2u"||s==="vec3u"||s==="vec4u"||s==="vec2h"||s==="vec3h"||s==="vec4h"||s==="vec2b"||s==="vec3b"||s==="vec4b"||s==="mat2x2"||s==="mat2x3"||s==="mat2x4"||s==="mat3x2"||s==="mat3x3"||s==="mat3x4"||s==="mat4x2"||s==="mat4x3"||s==="mat4x4"||s==="mat2x2f"||s==="mat2x3f"||s==="mat2x4f"||s==="mat3x2f"||s==="mat3x3f"||s==="mat3x4f"||s==="mat4x2f"||s==="mat4x3f"||s==="mat4x4f"||s==="mat2x2h"||s==="mat2x3h"||s==="mat2x4h"||s==="mat3x2h"||s==="mat3x3h"||s==="mat3x4h"||s==="mat4x2h"||s==="mat4x3h"||s==="mat4x4h"||e.type instanceof Es||e.type instanceof an||e.type instanceof C){const r=new Zt(e.type,[]);n=this._evalCreate(r,t)}}t.createVariable(e.name,n,e)}_switch(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof M))return console.error(`Invalid if condition. Line ${e.line}`),null;let s=null;for(const r of e.cases)if(r instanceof Vi)for(const a of r.selectors){if(a instanceof js){s=r;continue}const i=this.evalExpression(a,t);if(!(i instanceof M))return console.error(`Invalid case selector. Line ${e.line}`),null;if(i.value===n.value)return this._execStatements(r.body,t)}else r instanceof Gi&&(s=r);return s?this._execStatements(s.body,t):null}_if(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof M))return console.error(`Invalid if condition. Line ${e.line}`),null;if(n.value)return this._execStatements(e.body,t);for(const s of e.elseif){const r=this.evalExpression(s.condition,t);if(!(r instanceof M))return console.error(`Invalid if condition. Line ${e.line}`),null;if(r.value)return this._execStatements(s.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof M?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===Je._breakObj)break;if(n!==null&&n!==Je._continueObj)return n;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const n=this._execStatements(e.body,t);if(n===Je._breakObj)break;if(n===Je._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===Je._breakObj)break}else if(n!==null)return n}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===Je._breakObj)break;if(n!==Je._continueObj&&n!==null)return n}return null}_evalBitcast(e,t){const n=this.evalExpression(e.value,t),s=e.type;if(n instanceof M){const r=Kr(n.value,n.typeInfo.name,s.name);return new M(r,this.getTypeInfo(s))}if(n instanceof T){const r=n.typeInfo.getTypeName();let a="";if(r.endsWith("f"))a="f32";else if(r.endsWith("i"))a="i32";else if(r.endsWith("u"))a="u32";else if(r.endsWith("b"))a="bool";else{if(!r.endsWith("h"))return console.error(`Unknown vector type ${r}. Line ${e.line}`),null;a="f16"}const i=s.getTypeName();let c="";if(i.endsWith("f"))c="f32";else if(i.endsWith("i"))c="i32";else if(i.endsWith("u"))c="u32";else if(i.endsWith("b"))c="bool";else{if(!i.endsWith("h"))return console.error(`Unknown vector type ${c}. Line ${e.line}`),null;c="f16"}const h=function(f,w,B){if(w===B)return f;const F=new Array(f.length);for(let Z=0;Z<f.length;Z++)F[Z]=Kr(f[Z],w,B);return F}(Array.from(n.data),a,c);return new T(h,this.getTypeInfo(s))}return console.error(`TODO: bitcast for ${n.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var n;if(e instanceof Zt){if(e.type===null)return pr.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}const s=e instanceof Zt?e.type.name:e.name,r=e instanceof Zt?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(r===null)return console.error(`Unknown type ${s}. Line ${e.line}`),null;if(r.size===0)return null;const a=new Ie(new ArrayBuffer(r.size),r,0);if(r instanceof On){if(e.args)for(let i=0;i<e.args.length;++i){const c=r.members[i],h=e.args[i],f=this.evalExpression(h,t);a.setData(this,f,c.type,c.offset,t)}}else if(r instanceof Pn){let i=0;if(e.args)for(let c=0;c<e.args.length;++c){const h=e.args[c],f=this.evalExpression(h,t);r.format===null&&(((n=f.typeInfo)===null||n===void 0?void 0:n.name)==="x32"?r.format=this.getTypeInfo("i32"):r.format=f.typeInfo),a.setData(this,f,r.format,i,t),i+=r.stride}}else console.error(`Unknown type "${s}". Line ${e.line}`);return e instanceof Zt?a.getSubData(this,e.postfix,t):a}_evalLiteral(e,t){const n=this.getTypeInfo(e.type),s=n.name;return s==="x32"||s==="u32"||s==="f32"||s==="f16"||s==="i32"||s==="bool"?new M(e.scalarValue,n):s==="vec2"||s==="vec3"||s==="vec4"||s==="vec2f"||s==="vec3f"||s==="vec4f"||s==="vec2h"||s==="vec3h"||s==="vec4h"||s==="vec2i"||s==="vec3i"||s==="vec4i"||s==="vec2u"||s==="vec3u"||s==="vec4u"?this._callConstructorVec(e,t):s==="mat2x2"||s==="mat2x3"||s==="mat2x4"||s==="mat3x2"||s==="mat3x3"||s==="mat3x4"||s==="mat4x2"||s==="mat4x3"||s==="mat4x4"||s==="mat2x2f"||s==="mat2x3f"||s==="mat2x4f"||s==="mat3x2f"||s==="mat3x3f"||s==="mat3x4f"||s==="mat4x2f"||s==="mat4x3f"||s==="mat4x4f"||s==="mat2x2h"||s==="mat2x3h"||s==="mat2x4h"||s==="mat3x2h"||s==="mat3x3h"||s==="mat3x4h"||s==="mat4x2h"||s==="mat4x3h"||s==="mat4x4h"?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const n=t.getVariableValue(e.name);return n===null?n:n.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if(t.name==="f32")return t;for(let n=1;n<e.length;++n){const s=Je._priority.get(t.name);Je._priority.get(e[n].name)<s&&(t=e[n])}return t.name==="x32"?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const n=this.evalExpression(e.right,t);if(e.operator==="&")return new jn(n);if(e.operator==="*")return n instanceof jn?n.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);const s=n instanceof M?n.value:n instanceof T?Array.from(n.data):null;switch(e.operator){case"+":{if(j(s)){const i=s.map((c,h)=>+c);return new T(i,n.typeInfo)}const r=s,a=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new M(+r,a)}case"-":{if(j(s)){const i=s.map((c,h)=>-c);return new T(i,n.typeInfo)}const r=s,a=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new M(-r,a)}case"!":{if(j(s)){const i=s.map((c,h)=>c?0:1);return new T(i,n.typeInfo)}const r=s,a=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new M(r?0:1,a)}case"~":{if(j(s)){const i=s.map((c,h)=>~c);return new T(i,n.typeInfo)}const r=s,a=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new M(~r,a)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const n=this.evalExpression(e.left,t),s=this.evalExpression(e.right,t),r=n instanceof M?n.value:n instanceof T||n instanceof oe?Array.from(n.data):null,a=s instanceof M?s.value:s instanceof T||s instanceof oe?Array.from(s.data):null;switch(e.operator){case"+":{if(j(r)&&j(a)){const f=r,w=a;if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F+w[Z]);return new T(B,n.typeInfo)}if(j(r)){const f=a,w=r.map((B,F)=>B+f);return new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f+B);return new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i+c,h)}case"-":{if(j(r)&&j(a)){const f=r,w=a;if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F-w[Z]);return new T(B,n.typeInfo)}if(j(r)){const f=a,w=r.map((B,F)=>B-f);return new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f-B);return new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i-c,h)}case"*":{if(j(r)&&j(a)){const f=r,w=a;if(n instanceof oe&&s instanceof oe){const B=function(ae,me,xe,J){if(ut[me.name]===void 0||ut[J.name]===void 0)return null;const te=ut[me.name][0],Ee=ut[me.name][1],we=ut[J.name][0];if(te!==ut[J.name][1])return null;const tt=new Array(we*Ee);for(let Fe=0;Fe<Ee;Fe++)for(let $e=0;$e<we;$e++){let Ne=0;for(let ze=0;ze<te;ze++)Ne+=ae[ze*Ee+Fe]*xe[$e*te+ze];tt[Fe*we+$e]=Ne}return tt}(f,n.typeInfo,w,s.typeInfo);if(B===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;const F=ut[s.typeInfo.name][0],Z=ut[n.typeInfo.name][1],ie=this.getTypeInfo(`mat${F}x${Z}f`);return new oe(B,ie)}if(n instanceof oe&&s instanceof T){const B=function(F,Z,ie,ae){if(ut[Z.name]===void 0||hr[ae.name]===void 0)return null;const me=ut[Z.name][0],xe=ut[Z.name][1];if(me!==ie.length)return null;const J=new Array(xe);for(let te=0;te<xe;te++){let Ee=0;for(let we=0;we<me;we++)Ee+=F[we*xe+te]*ie[we];J[te]=Ee}return J}(f,n.typeInfo,w,s.typeInfo);return B===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new T(B,s.typeInfo)}if(n instanceof T&&s instanceof oe){const B=function(F,Z,ie,ae){if(hr[Z.name]===void 0||ut[ae.name]===void 0)return null;const me=ut[ae.name][0],xe=ut[ae.name][1];if(xe!==F.length)return null;const J=[];for(let te=0;te<me;te++){let Ee=0;for(let we=0;we<xe;we++)Ee+=F[we]*ie[we*me+te];J[te]=Ee}return J}(f,n.typeInfo,w,s.typeInfo);return B===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new T(B,n.typeInfo)}{if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F*w[Z]);return new T(B,n.typeInfo)}}if(j(r)){const f=a,w=r.map((B,F)=>B*f);return n instanceof oe?new oe(w,n.typeInfo):new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f*B);return s instanceof oe?new oe(w,s.typeInfo):new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i*c,h)}case"%":{if(j(r)&&j(a)){const f=r,w=a;if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F%w[Z]);return new T(B,n.typeInfo)}if(j(r)){const f=a,w=r.map((B,F)=>B%f);return new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f%B);return new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i%c,h)}case"/":{if(j(r)&&j(a)){const f=r,w=a;if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F/w[Z]);return new T(B,n.typeInfo)}if(j(r)){const f=a,w=r.map((B,F)=>B/f);return new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f/B);return new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i/c,h)}case"&":{if(j(r)&&j(a)){const f=r,w=a;if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F&w[Z]);return new T(B,n.typeInfo)}if(j(r)){const f=a,w=r.map((B,F)=>B&f);return new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f&B);return new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i&c,h)}case"|":{if(j(r)&&j(a)){const f=r,w=a;if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F|w[Z]);return new T(B,n.typeInfo)}if(j(r)){const f=a,w=r.map((B,F)=>B|f);return new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f|B);return new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i|c,h)}case"^":{if(j(r)&&j(a)){const f=r,w=a;if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F^w[Z]);return new T(B,n.typeInfo)}if(j(r)){const f=a,w=r.map((B,F)=>B^f);return new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f^B);return new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i^c,h)}case"<<":{if(j(r)&&j(a)){const f=r,w=a;if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F<<w[Z]);return new T(B,n.typeInfo)}if(j(r)){const f=a,w=r.map((B,F)=>B<<f);return new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f<<B);return new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i<<c,h)}case">>":{if(j(r)&&j(a)){const f=r,w=a;if(f.length!==w.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const B=f.map((F,Z)=>F>>w[Z]);return new T(B,n.typeInfo)}if(j(r)){const f=a,w=r.map((B,F)=>B>>f);return new T(w,n.typeInfo)}if(j(a)){const f=r,w=a.map((B,F)=>f>>B);return new T(w,s.typeInfo)}const i=r,c=a,h=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new M(i>>c,h)}case">":if(j(r)&&j(a)){const i=r,c=a;if(i.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=i.map((f,w)=>f>c[w]?1:0);return new T(h,n.typeInfo)}if(j(r)){const i=a,c=r.map((h,f)=>h>i?1:0);return new T(c,n.typeInfo)}if(j(a)){const i=r,c=a.map((h,f)=>i>h?1:0);return new T(c,s.typeInfo)}return new M(r>a?1:0,this.getTypeInfo("bool"));case"<":if(j(r)&&j(a)){const i=r,c=a;if(i.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=i.map((f,w)=>f<c[w]?1:0);return new T(h,n.typeInfo)}if(j(r)){const i=a,c=r.map((h,f)=>h<i?1:0);return new T(c,n.typeInfo)}if(j(a)){const i=r,c=a.map((h,f)=>i<h?1:0);return new T(c,s.typeInfo)}return new M(r<a?1:0,this.getTypeInfo("bool"));case"==":if(j(r)&&j(a)){const i=r,c=a;if(i.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=i.map((f,w)=>f===c[w]?1:0);return new T(h,n.typeInfo)}if(j(r)){const i=a,c=r.map((h,f)=>h==i?1:0);return new T(c,n.typeInfo)}if(j(a)){const i=r,c=a.map((h,f)=>i==h?1:0);return new T(c,s.typeInfo)}return new M(r===a?1:0,this.getTypeInfo("bool"));case"!=":if(j(r)&&j(a)){const i=r,c=a;if(i.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=i.map((f,w)=>f!==c[w]?1:0);return new T(h,n.typeInfo)}if(j(r)){const i=a,c=r.map((h,f)=>h!==i?1:0);return new T(c,n.typeInfo)}if(j(a)){const i=r,c=a.map((h,f)=>i!==h?1:0);return new T(c,s.typeInfo)}return new M(r!==a?1:0,this.getTypeInfo("bool"));case">=":if(j(r)&&j(a)){const i=r,c=a;if(i.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=i.map((f,w)=>f>=c[w]?1:0);return new T(h,n.typeInfo)}if(j(r)){const i=a,c=r.map((h,f)=>h>=i?1:0);return new T(c,n.typeInfo)}if(j(a)){const i=r,c=a.map((h,f)=>i>=h?1:0);return new T(c,s.typeInfo)}return new M(r>=a?1:0,this.getTypeInfo("bool"));case"<=":if(j(r)&&j(a)){const i=r,c=a;if(i.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=i.map((f,w)=>f<=c[w]?1:0);return new T(h,n.typeInfo)}if(j(r)){const i=a,c=r.map((h,f)=>h<=i?1:0);return new T(c,n.typeInfo)}if(j(a)){const i=r,c=a.map((h,f)=>i<=h?1:0);return new T(c,s.typeInfo)}return new M(r<=a?1:0,this.getTypeInfo("bool"));case"&&":if(j(r)&&j(a)){const i=r,c=a;if(i.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=i.map((f,w)=>f&&c[w]?1:0);return new T(h,n.typeInfo)}if(j(r)){const i=a,c=r.map((h,f)=>h&&i?1:0);return new T(c,n.typeInfo)}if(j(a)){const i=r,c=a.map((h,f)=>i&&h?1:0);return new T(c,s.typeInfo)}return new M(r&&a?1:0,this.getTypeInfo("bool"));case"||":if(j(r)&&j(a)){const i=r,c=a;if(i.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const h=i.map((f,w)=>f||c[w]?1:0);return new T(h,n.typeInfo)}if(j(r)){const i=a,c=r.map((h,f)=>h||i?1:0);return new T(c,n.typeInfo)}if(j(a)){const i=r,c=a.map((h,f)=>i||h?1:0);return new T(c,s.typeInfo)}return new M(r||a?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;const n=t.clone();n.currentFunctionName=e.name;const s=t.getFunction(e.name);if(!s)return e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let r=0;r<s.node.args.length;++r){const a=s.node.args[r],i=this.evalExpression(e.args[r],n);n.createVariable(a.name,i,a)}return this._execStatements(s.node.body,n)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothStep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const n=t.getFunction(e.name);if(n){const s=t.clone();for(let r=0;r<n.node.args.length;++r){const a=n.node.args[r],i=this.evalExpression(e.args[r],s);s.setVariable(a.name,i,a)}return this._execStatements(n.node.body,s)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new M(0,this.getTypeInfo(e.type));const n=this.evalExpression(e.args[0],t);return n.typeInfo=this.getTypeInfo(e.type),n.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){const n=this.getTypeInfo(e.type),s=e.type.getTypeName(),r=hr[s];if(r===void 0)return console.error(`Invalid vec constructor ${s}. Line ${e.line}`),null;const a=[];if(e instanceof Re)if(e.isVector){const i=e.vectorValue;for(const c of i)a.push(c)}else a.push(e.scalarValue);else if(e.args)for(const i of e.args){const c=this.evalExpression(i,t);if(c instanceof T){const h=c.data;for(let f=0;f<h.length;++f){let w=h[f];a.push(w)}}else if(c instanceof M){let h=c.value;a.push(h)}}if(e.type instanceof C&&e.type.format===null&&(e.type.format=C.f32),a.length===0){const i=new Array(r).fill(0);return new T(i,n).getSubData(this,e.postfix,t)}if(a.length===1)for(;a.length<r;)a.push(a[0]);return a.length<r?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new T(a.length>r?a.slice(0,r):a,n).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){const n=this.getTypeInfo(e.type),s=e.type.getTypeName(),r=ut[s];if(r===void 0)return console.error(`Invalid matrix constructor ${s}. Line ${e.line}`),null;const a=[];if(e instanceof Re)if(e.isVector){const i=e.vectorValue;for(const c of i)a.push(c)}else a.push(e.scalarValue);else if(e.args)for(const i of e.args){const c=this.evalExpression(i,t);c instanceof T?a.push(...c.data):c instanceof M?a.push(c.value):c instanceof oe&&a.push(...c.data)}if(n instanceof Yn&&n.format===null&&(n.format=this.getTypeInfo("f32")),a.length===0){const i=new Array(r[2]).fill(0);return new oe(i,n).getSubData(this,e.postfix,t)}return a.length!==r[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new oe(a,n).getSubData(this,e.postfix,t)}}Je._breakObj=new Ot(new Mt("BREAK",null),null),Je._continueObj=new Ot(new Mt("CONTINUE",null),null),Je._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class ja{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class Za{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new ja,this._exec=new Je,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const n=this._global_decl_or_directive();if(!n)break;t.push(n)}if(this._deferArrayCountEval.length>0){for(const n of this._deferArrayCountEval){const s=n.arrayType,r=n.countNode;if(r instanceof vt){const a=r.name,i=this._context.constants.get(a);if(i)try{const c=i.constEvaluate(this._exec);s.count=c}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const n of t)n.search(s=>{s instanceof jr||s instanceof Qs?s.type=this._forwardType(s.type):s instanceof Es?s.format=this._forwardType(s.format):s instanceof fn||s instanceof Ts||s instanceof Ys?s.type=this._forwardType(s.type):s instanceof Is?s.returnType=this._forwardType(s.returnType):s instanceof Qr&&(s.type=this._forwardType(s.type))});return t}_forwardType(e){if(e instanceof Yr){const t=this._getType(e.name);if(t)return t}else e instanceof Qs?e.type=this._forwardType(e.type):e instanceof Es&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if(typeof e=="string"){const t=new $a(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==b.eof}_match(e){if(e instanceof P)return!!this._check(e)&&(this._advance(),!0);for(let t=0,n=e.length;t<n;++t){const s=e[t];if(this._check(s))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const n=t.type;let s=!1;for(const r of e){if(n===r)return!0;r===b.tokens.name&&(s=!0)}if(s){const r=b.tokens.name.rule.exec(t.lexeme);if(r&&r.index==0&&r[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===b.tokens.name){const n=b.tokens.name.rule.exec(t.lexeme);return n&&n.index==0&&n[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(b.tokens.semicolon)&&!this._isAtEnd(););if(this._match(b.keywords.alias)){const t=this._type_alias();return this._consume(b.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(b.keywords.diagnostic)){const t=this._diagnostic();return this._consume(b.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(b.keywords.requires)){const t=this._requires_directive();return this._consume(b.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(b.keywords.enable)){const t=this._enable_directive();return this._consume(b.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}const e=this._attribute();if(this._check(b.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(b.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(b.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(b.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(b.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(b.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(b.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(b.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(b.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(b.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(b.keywords.fn))return null;const e=this._currentLine,t=this._consume(b.tokens.ident,"Expected function name.").toString();this._consume(b.tokens.paren_left,"Expected '(' for function arguments.");const n=[];if(!this._check(b.tokens.paren_right))do{if(this._check(b.tokens.paren_right))break;const i=this._attribute(),c=this._consume(b.tokens.name,"Expected argument name.").toString();this._consume(b.tokens.colon,"Expected ':' for argument type.");const h=this._attribute(),f=this._type_decl();f!=null&&(f.attributes=h,n.push(this._updateNode(new Qr(c,f,i))))}while(this._match(b.tokens.comma));this._consume(b.tokens.paren_right,"Expected ')' after function arguments.");let s=null;if(this._match(b.tokens.arrow)){const i=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=i)}const r=this._compound_statement(),a=this._currentLine;return this._updateNode(new Is(t,n,s,r,e,a),e)}_compound_statement(){const e=[];for(this._consume(b.tokens.brace_left,"Expected '{' for block.");!this._check(b.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(b.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(b.tokens.semicolon)&&!this._isAtEnd(););if(this._check(b.tokens.attr)&&this._attribute(),this._check(b.keywords.if))return this._if_statement();if(this._check(b.keywords.switch))return this._switch_statement();if(this._check(b.keywords.loop))return this._loop_statement();if(this._check(b.keywords.for))return this._for_statement();if(this._check(b.keywords.while))return this._while_statement();if(this._check(b.keywords.continuing))return this._continuing_statement();if(this._check(b.keywords.static_assert))return this._static_assert_statement();if(this._check(b.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(b.keywords.return))e=this._return_statement();else if(this._check([b.keywords.var,b.keywords.let,b.keywords.const]))e=this._variable_statement();else if(this._match(b.keywords.discard))e=this._updateNode(new La);else if(this._match(b.keywords.break)){const t=this._updateNode(new Bi);if(this._currentLoop.length>0){const n=this._currentLoop[this._currentLoop.length-1];t.loopId=n.id}e=t,this._check(b.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(b.keywords.continue)){const t=this._updateNode(new Ui);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const n=this._currentLoop[this._currentLoop.length-1];t.loopId=n.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(b.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(b.keywords.static_assert))return null;const e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new Ca(t),e)}_while_statement(){if(!this._match(b.keywords.while))return null;const e=this._updateNode(new Ii(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(b.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){const e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(b.keywords.continuing))return null;const t=this._currentLine,n=this._compound_statement();return this._updateNode(new dr(n,e),t)}_for_statement(){if(!this._match(b.keywords.for))return null;this._consume(b.tokens.paren_left,"Expected '('.");const e=this._updateNode(new Ai(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(b.tokens.semicolon)?null:this._for_init(),this._consume(b.tokens.semicolon,"Expected ';'."),e.condition=this._check(b.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(b.tokens.semicolon,"Expected ';'."),e.increment=this._check(b.tokens.paren_right)?null:this._for_increment(),this._consume(b.tokens.paren_right,"Expected ')'."),this._check(b.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(b.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(b.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new fn(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(b.keywords.let)){const e=this._currentLine,t=this._consume(b.tokens.name,"Expected name for let.").toString();let n=null;if(this._match(b.tokens.colon)){const r=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=r)}this._consume(b.tokens.equal,"Expected '=' for let.");const s=this._short_circuit_or_expression();return this._updateNode(new Ts(t,n,null,null,s),e)}if(this._match(b.keywords.const)){const e=this._currentLine,t=this._consume(b.tokens.name,"Expected name for const.").toString();let n=null;if(this._match(b.tokens.colon)){const r=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=r)}this._consume(b.tokens.equal,"Expected '=' for const.");const s=this._short_circuit_or_expression();return n===null&&s instanceof Re&&(n=s.type),this._updateNode(new Ys(t,n,null,null,s),e)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(b.increment_operators))return this._current=e,null;const n=this._consume(b.increment_operators,"Expected increment operator");return this._updateNode(new Si(n.type===b.tokens.plus_plus?ts.increment:ts.decrement,t))}_assignment_statement(){let e=null;const t=this._currentLine;if(this._check(b.tokens.brace_right))return null;let n=this._match(b.tokens.underscore);if(n||(e=this._unary_expression()),!n&&e==null)return null;const s=this._consume(b.assignment_operators,"Expected assignment operator."),r=this._short_circuit_or_expression();return this._updateNode(new Di(ws.parse(s.lexeme),e,r),t)}_func_call_statement(){if(!this._check(b.tokens.ident))return null;const e=this._currentLine,t=this._current,n=this._consume(b.tokens.ident,"Expected function name."),s=this._argument_expression_list();return s===null?(this._current=t,null):this._updateNode(new Nr(n.lexeme,s),e)}_loop_statement(){if(!this._match(b.keywords.loop))return null;this._check(b.tokens.attr)&&this._attribute(),this._consume(b.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new Ni([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let n of t)e.body.push(n);else e.body.push(t);if(t instanceof dr){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(b.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(b.keywords.switch))return null;const e=this._updateNode(new Mi(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(b.tokens.attr)&&this._attribute(),this._consume(b.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(b.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([b.keywords.default,b.keywords.case]);){if(this._match(b.keywords.case)){const n=this._case_selectors();for(const r of n)if(r instanceof js){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(b.tokens.colon),this._check(b.tokens.attr)&&this._attribute(),this._consume(b.tokens.brace_left,"Exected '{' for switch case.");const s=this._case_body();this._consume(b.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new Vi(n,s)))}if(this._match(b.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(b.tokens.colon),this._check(b.tokens.attr)&&this._attribute(),this._consume(b.tokens.brace_left,"Exected '{' for switch default.");const n=this._case_body();this._consume(b.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new Gi(n)))}}return e}_case_selectors(){const e=[];for(this._match(b.keywords.default)?e.push(this._updateNode(new js)):e.push(this._shift_expression());this._match(b.tokens.comma);)this._match(b.keywords.default)?e.push(this._updateNode(new js)):e.push(this._shift_expression());return e}_case_body(){if(this._match(b.keywords.fallthrough))return this._consume(b.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(b.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(b.tokens.attr)&&this._attribute();const n=this._compound_statement();let s=[];this._match_elseif()&&(this._check(b.tokens.attr)&&this._attribute(),s=this._elseif_statement(s));let r=null;return this._match(b.keywords.else)&&(this._check(b.tokens.attr)&&this._attribute(),r=this._compound_statement()),this._updateNode(new Oi(t,n,s,r),e)}_match_elseif(){return this._tokens[this._current].type===b.keywords.else&&this._tokens[this._current+1].type===b.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),n=this._compound_statement();return e.push(this._updateNode(new Ra(t,n))),this._match_elseif()&&(this._check(b.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(b.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new Pi(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(b.tokens.or_or);)e=this._updateNode(new Rt(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(b.tokens.and_and);)e=this._updateNode(new Rt(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(b.tokens.or);)e=this._updateNode(new Rt(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(b.tokens.xor);)e=this._updateNode(new Rt(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(b.tokens.and);)e=this._updateNode(new Rt(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([b.tokens.equal_equal,b.tokens.not_equal])?this._updateNode(new Rt(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([b.tokens.less_than,b.tokens.greater_than,b.tokens.less_than_equal,b.tokens.greater_than_equal]);)e=this._updateNode(new Rt(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([b.tokens.shift_left,b.tokens.shift_right]);)e=this._updateNode(new Rt(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([b.tokens.plus,b.tokens.minus]);)e=this._updateNode(new Rt(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([b.tokens.star,b.tokens.forward_slash,b.tokens.modulo]);)e=this._updateNode(new Rt(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([b.tokens.minus,b.tokens.bang,b.tokens.tilde,b.tokens.star,b.tokens.and])?this._updateNode(new Oe(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(b.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(b.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new xs(e)),n=this._postfix_expression();return n&&(t.postfix=n),t}if(this._match(b.tokens.period)){const e=this._consume(b.tokens.name,"Expected member name."),t=this._postfix_expression(),n=this._updateNode(new Qn(e.lexeme));return t&&(n.postfix=t),n}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(t!==null)return t;switch(e){case"void":return G.void;case"bool":return G.bool;case"i32":return G.i32;case"u32":return G.u32;case"f32":return G.f32;case"f16":return G.f16;case"vec2f":return C.vec2f;case"vec3f":return C.vec3f;case"vec4f":return C.vec4f;case"vec2i":return C.vec2i;case"vec3i":return C.vec3i;case"vec4i":return C.vec4i;case"vec2u":return C.vec2u;case"vec3u":return C.vec3u;case"vec4u":return C.vec4u;case"vec2h":return C.vec2h;case"vec3h":return C.vec3h;case"vec4h":return C.vec4h;case"mat2x2f":return C.mat2x2f;case"mat2x3f":return C.mat2x3f;case"mat2x4f":return C.mat2x4f;case"mat3x2f":return C.mat3x2f;case"mat3x3f":return C.mat3x3f;case"mat3x4f":return C.mat3x4f;case"mat4x2f":return C.mat4x2f;case"mat4x3f":return C.mat4x3f;case"mat4x4f":return C.mat4x4f;case"mat2x2h":return C.mat2x2h;case"mat2x3h":return C.mat2x3h;case"mat2x4h":return C.mat2x4h;case"mat3x2h":return C.mat3x2h;case"mat3x3h":return C.mat3x3h;case"mat3x4h":return C.mat3x4h;case"mat4x2h":return C.mat4x2h;case"mat4x3h":return C.mat4x3h;case"mat4x4h":return C.mat4x4h;case"mat2x2i":return C.mat2x2i;case"mat2x3i":return C.mat2x3i;case"mat2x4i":return C.mat2x4i;case"mat3x2i":return C.mat3x2i;case"mat3x3i":return C.mat3x3i;case"mat3x4i":return C.mat3x4i;case"mat4x2i":return C.mat4x2i;case"mat4x3i":return C.mat4x3i;case"mat4x4i":return C.mat4x4i;case"mat2x2u":return C.mat2x2u;case"mat2x3u":return C.mat2x3u;case"mat2x4u":return C.mat2x4u;case"mat3x2u":return C.mat3x2u;case"mat3x3u":return C.mat3x3u;case"mat3x4u":return C.mat3x4u;case"mat4x2u":return C.mat4x2u;case"mat4x3u":return C.mat4x3u;case"mat4x4u":return C.mat4x4u}return null}_validateTypeRange(e,t){if(t.name==="i32"){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name==="u32"&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(b.tokens.ident)){const n=this._previous().toString();if(this._check(b.tokens.paren_left)){const s=this._argument_expression_list(),r=this._getType(n);return r!==null?this._updateNode(new Zt(r,s)):this._updateNode(new Or(n,s))}if(this._context.constants.has(n)){const s=this._context.constants.get(n);return this._updateNode(new Li(n,s.value))}return this._updateNode(new vt(n))}if(this._match(b.tokens.int_literal)){const n=this._previous().toString();let s=n.endsWith("i")||n.endsWith("i")?G.i32:n.endsWith("u")||n.endsWith("U")?G.u32:G.x32;const r=parseInt(n);return this._validateTypeRange(r,s),this._updateNode(new Re(new M(r,this._exec.getTypeInfo(s)),s))}if(this._match(b.tokens.uint_literal)){const n=parseInt(this._previous().toString());return this._validateTypeRange(n,G.u32),this._updateNode(new Re(new M(n,this._exec.getTypeInfo(G.u32)),G.u32))}if(this._match([b.tokens.decimal_float_literal,b.tokens.hex_float_literal])){let n=this._previous().toString(),s=n.endsWith("h");s&&(n=n.substring(0,n.length-1));const r=parseFloat(n);this._validateTypeRange(r,s?G.f16:G.f32);const a=s?G.f16:G.f32;return this._updateNode(new Re(new M(r,this._exec.getTypeInfo(a)),a))}if(this._match([b.keywords.true,b.keywords.false])){let n=this._previous().toString()===b.keywords.true.rule;return this._updateNode(new Re(new M(n?1:0,this._exec.getTypeInfo(G.bool)),G.bool))}if(this._check(b.tokens.paren_left))return this._paren_expression();if(this._match(b.keywords.bitcast)){this._consume(b.tokens.less_than,"Expected '<'.");const n=this._type_decl();this._consume(b.tokens.greater_than,"Expected '>'.");const s=this._paren_expression();return this._updateNode(new Ri(n,s))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new Zt(e,t))}_argument_expression_list(){if(!this._match(b.tokens.paren_left))return null;const e=[];do{if(this._check(b.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(b.tokens.comma));return this._consume(b.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(b.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(b.tokens.paren_right),e}_paren_expression(){this._consume(b.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(b.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(b.keywords.struct))return null;const e=this._currentLine,t=this._consume(b.tokens.ident,"Expected name for struct.").toString();this._consume(b.tokens.brace_left,"Expected '{' for struct body.");const n=[];for(;!this._check(b.tokens.brace_right);){const a=this._attribute(),i=this._consume(b.tokens.name,"Expected variable name.").toString();this._consume(b.tokens.colon,"Expected ':' for struct member type.");const c=this._attribute(),h=this._type_decl();h!=null&&(h.attributes=c),this._check(b.tokens.brace_right)?this._match(b.tokens.comma):this._consume(b.tokens.comma,"Expected ',' for struct member."),n.push(this._updateNode(new jr(i,h,a)))}this._consume(b.tokens.brace_right,"Expected '}' after struct body.");const s=this._currentLine,r=this._updateNode(new an(t,n,e,s),e);return this._context.structs.set(t,r),r}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(b.tokens.equal)){const t=this._const_expression();e.value=t}if(e.type!==null&&e.value instanceof Re){if(e.value.type.name!=="x32"&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof Re&&(e.type=e.value.type.name==="x32"?G.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(b.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(b.keywords.const))return null;const t=this._consume(b.tokens.name,"Expected variable name"),n=this._currentLine;let s=null;if(this._match(b.tokens.colon)){const c=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=c)}let r=null;this._consume(b.tokens.equal,"const declarations require an assignment");const a=this._short_circuit_or_expression();try{let c=[G.f32],h=a.constEvaluate(this._exec,c);h instanceof M&&this._validateTypeRange(h.value,c[0]),c[0]instanceof C&&c[0].format===null&&h.typeInfo instanceof Yn&&h.typeInfo.format!==null&&(h.typeInfo.format.name==="f16"?c[0].format=G.f16:h.typeInfo.format.name==="f32"?c[0].format=G.f32:h.typeInfo.format.name==="i32"?c[0].format=G.i32:h.typeInfo.format.name==="u32"?c[0].format=G.u32:h.typeInfo.format.name==="bool"?c[0].format=G.bool:console.error(`TODO: impelement template format type ${h.typeInfo.format.name}`)),r=this._updateNode(new Re(h,c[0])),this._exec.context.setVariable(t.toString(),h)}catch{r=a}if(s!==null&&r instanceof Re){if(r.type.name!=="x32"&&s.getTypeName()!==r.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${s.name}. Line:${this._currentLine}`);r.type=s,r.isScalar&&this._validateTypeRange(r.scalarValue,r.type)}else s===null&&r instanceof Re&&(s=(e=r==null?void 0:r.type)!==null&&e!==void 0?e:G.f32,s===G.x32&&(s=G.i32));const i=this._updateNode(new Ys(t.toString(),s,"","",r),n);return this._context.constants.set(i.name,i),i}_global_let_decl(){if(!this._match(b.keywords.let))return null;const e=this._currentLine,t=this._consume(b.tokens.name,"Expected variable name");let n=null;if(this._match(b.tokens.colon)){const r=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=r)}let s=null;if(this._match(b.tokens.equal)&&(s=this._const_expression()),n!==null&&s instanceof Re){if(s.type.name!=="x32"&&n.getTypeName()!==s.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${s.type.name} to ${n.name}. Line:${this._currentLine}`);s.type=n}else n===null&&s instanceof Re&&(n=s.type.name==="x32"?G.i32:s.type);return s instanceof Re&&s.isScalar&&this._validateTypeRange(s.scalarValue,n),this._updateNode(new Ts(t.toString(),n,"","",s),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(b.keywords.var))return null;const e=this._currentLine;let t="",n="";this._match(b.tokens.less_than)&&(t=this._consume(b.storage_class,"Expected storage_class.").toString(),this._match(b.tokens.comma)&&(n=this._consume(b.access_mode,"Expected access_mode.").toString()),this._consume(b.tokens.greater_than,"Expected '>'."));const s=this._consume(b.tokens.name,"Expected variable name");let r=null;if(this._match(b.tokens.colon)){const a=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=a)}return this._updateNode(new fn(s.toString(),r,t,n,null),e)}_override_decl(){if(!this._match(b.keywords.override))return null;const e=this._consume(b.tokens.name,"Expected variable name");let t=null;if(this._match(b.tokens.colon)){const n=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=n)}return this._updateNode(new Dr(e.toString(),t,null))}_diagnostic(){this._consume(b.tokens.paren_left,"Expected '('");const e=this._consume(b.tokens.ident,"Expected severity control name.");this._consume(b.tokens.comma,"Expected ','");let t=this._consume(b.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(b.tokens.period)&&(t+=`.${this._consume(b.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(b.tokens.paren_right,"Expected ')'"),this._updateNode(new Ci(e.toString(),t))}_enable_directive(){const e=this._consume(b.tokens.ident,"identity expected.");return this._updateNode(new Ba(e.toString()))}_requires_directive(){const e=[this._consume(b.tokens.ident,"identity expected.").toString()];for(;this._match(b.tokens.comma);){const t=this._consume(b.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new Ua(e))}_type_alias(){const e=this._consume(b.tokens.ident,"identity expected.");this._consume(b.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const n=this._updateNode(new Mr(e.toString(),t));return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([b.tokens.ident,...b.texel_format,b.keywords.bool,b.keywords.f32,b.keywords.i32,b.keywords.u32])){const n=this._advance().toString();if(this._context.structs.has(n))return this._context.structs.get(n);if(this._context.aliases.has(n))return this._context.aliases.get(n).type;if(!this._getType(n)){const s=this._updateNode(new Yr(n));return this._forwardTypeCount++,s}return this._updateNode(new G(n))}let e=this._texture_sampler_types();if(e)return e;if(this._check(b.template_types)){let n=this._advance().toString(),s=null,r=null;return this._match(b.tokens.less_than)&&(s=this._type_decl(),r=null,this._match(b.tokens.comma)&&(r=this._consume(b.access_mode,"Expected access_mode for pointer").toString()),this._consume(b.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new C(n,s,r))}if(this._match(b.keywords.ptr)){let n=this._previous().toString();this._consume(b.tokens.less_than,"Expected '<' for pointer.");const s=this._consume(b.storage_class,"Expected storage_class for pointer");this._consume(b.tokens.comma,"Expected ',' for pointer.");const r=this._type_decl();let a=null;return this._match(b.tokens.comma)&&(a=this._consume(b.access_mode,"Expected access_mode for pointer").toString()),this._consume(b.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new Qs(n,s.toString(),r,a))}const t=this._attribute();if(this._match(b.keywords.array)){let n=null,s=-1;const r=this._previous();let a=null;if(this._match(b.tokens.less_than)){n=this._type_decl(),this._context.aliases.has(n.name)&&(n=this._context.aliases.get(n.name).type);let c="";if(this._match(b.tokens.comma)){a=this._shift_expression();try{c=a.constEvaluate(this._exec).toString(),a=null}catch{c="1"}}this._consume(b.tokens.greater_than,"Expected '>' for array."),s=c?parseInt(c):0}const i=this._updateNode(new Es(r.toString(),t,n,s));return a&&this._deferArrayCountEval.push({arrayType:i,countNode:a}),i}return null}_texture_sampler_types(){if(this._match(b.sampler_type))return this._updateNode(new vs(this._previous().toString(),null,null));if(this._match(b.depth_texture_type))return this._updateNode(new vs(this._previous().toString(),null,null));if(this._match(b.sampled_texture_type)||this._match(b.multisampled_texture_type)){const e=this._previous();this._consume(b.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(b.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new vs(e.toString(),t,null))}if(this._match(b.storage_texture_type)){const e=this._previous();this._consume(b.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(b.texel_format,"Invalid texel format.").toString();this._consume(b.tokens.comma,"Expected ',' after texel format.");const n=this._consume(b.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(b.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new vs(e.toString(),t,n))}return null}_attribute(){let e=[];for(;this._match(b.tokens.attr);){const t=this._consume(b.attribute_name,"Expected attribute name"),n=this._updateNode(new zi(t.toString(),null));if(this._match(b.tokens.paren_left)){if(n.value=this._consume(b.literal_or_ident,"Expected attribute value").toString(),this._check(b.tokens.comma)){this._advance();do{const s=this._consume(b.literal_or_ident,"Expected attribute value").toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(s)}while(this._match(b.tokens.comma))}this._consume(b.tokens.paren_right,"Expected ')'")}e.push(n)}return e.length==0?null:e}}class qi extends rn{constructor(e){super(),e&&this.update(e)}update(e){const t=new Za().parse(e);this.updateAST(t)}}const De=Pe({INDEX:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,VERTEX:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,STORAGE:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,UNIFORM:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,READABLE:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST,WRITABLE:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,QUERY:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),Jr={operation:"add",srcFactor:"one",dstFactor:"zero"},ei={operation:"add",srcFactor:"one",dstFactor:"one"},ti={operation:"add",srcFactor:"one",dstFactor:"one-minus-src-alpha"},ni={operation:"add",srcFactor:"one-minus-dst-alpha",dstFactor:"one"},si={operation:"add",srcFactor:"dst-alpha",dstFactor:"zero"},ri={operation:"add",srcFactor:"zero",dstFactor:"src-alpha"},ii={operation:"add",srcFactor:"one-minus-dst-alpha",dstFactor:"zero"},ai={operation:"add",srcFactor:"zero",dstFactor:"one-minus-src-alpha"},oi={operation:"add",srcFactor:"dst-alpha",dstFactor:"one-minus-src-alpha"},ci={operation:"add",srcFactor:"one-minus-dst-alpha",dstFactor:"src-alpha"},Io=Pe({COPY:Pe({color:Jr,alpha:Jr}),ADDITIVE:Pe({color:ei,alpha:ei}),SOURCE_OVER:Pe({color:ti,alpha:ti}),DESTINATION_OVER:Pe({color:ni,alpha:ni}),SOURCE_IN:Pe({color:si,alpha:si}),DESTINATION_IN:Pe({color:ri,alpha:ri}),SOURCE_OUT:Pe({color:ii,alpha:ii}),DESTINATION_OUT:Pe({color:ai,alpha:ai}),SOURCE_ATOP:Pe({color:oi,alpha:oi}),DESTINATION_ATOP:Pe({color:ci,alpha:ci})});var Wi="@vertex fn vertex()->@builtin(position)vec4f {return vec4f(0);}@fragment fn fragment()->@location(0)vec4f {return vec4f(0);}@compute @workgroup_size(1)fn compute(){}",Bn,Un,gn,_n,As,Ss,ns,yn,ht,bs,Zn,Xi,yi;let Hi=(yi=class{constructor(e,t,n){W(this,ht);W(this,Bn);W(this,Un);W(this,gn);ct(this,"Device");ct(this,"BindGroups",[]);ct(this,"Reflect");W(this,_n);ct(this,"Pipeline");ct(this,"Descriptor");W(this,As);W(this,Ss);W(this,ns);W(this,yn,[]);!e&&ee(Y.DEVICE_NOT_REQUESTED),$(this,Bn,n),this.Device=e,$(this,Un,t),$(this,gn,this.CreatePipelineLabel("Command Encoder"))}CreatePipelineLabel(e){return p(this,Un)&&e&&`${p(this,Un)} ${e}`||""}CreatePipelineLayout(e,t){t??(t=this.CreatePipelineLabel(`${p(this,Bn)} Pipeline Layout`));const n=Array.isArray(e)&&e||[e];return this.Device.createPipelineLayout({label:t,bindGroupLayouts:n})}CreateTimestampWrites(e,t,n){return{querySet:e,beginningOfPassWriteIndex:t,endOfPassWriteIndex:n}}ResolveQuerySet(e,t,n=0,s=e.count,r=0){this.GetCommandEncoder(!0).resolveQuerySet(e,n,s,t,r)}CreateShaderModule(e,t,n,s){e||(e=Wi,Ve(Y.SHADER_CODE_NOT_FOUND)),t??(t=this.CreatePipelineLabel("Shader Module"));const r=Array.isArray(e)&&e.join(`

`)||e;return this.Reflect=new qi(r),this.Device.createShaderModule({label:t,code:r,sourceMap:n,compilationHints:s})}GetShaderModule(e){return e instanceof GPUShaderModule&&e||e.module}CreateBuffer(e){const t=e.label??this.CreatePipelineLabel("Buffer");return this.Device.createBuffer({label:t,...e})}CreateReadableBuffer(e){let t=typeof e=="number"&&e;t||(t=e.size);const n=(e==null?void 0:e.label)??"Readable Buffer";return this.CreateBuffer({label:n,size:t,usage:De.READABLE,...e})}CreateWritableBuffer(e){let t=typeof e=="number"&&e;t||(t=e.size);const n=(e==null?void 0:e.label)??"Writable Buffer";return this.CreateBuffer({label:n,size:t,usage:De.WRITABLE,...e})}CreateStorageBuffer(e,t=1){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,"`CreateStorageBuffer`.\n            Use `CreateShaderModule` before creating a storage buffer.");const n=this.Reflect.storage.find(({name:f})=>e===f);!n&&ee(Y.STORAGE_NOT_FOUND,`\`${e}\` in shader bindings.`);const s=typeof t=="number"&&t||t.length,r=t.label??`${e} Storage Buffer`,a=n.format.size*s,i=new ArrayBuffer(a),c=f=>(Object.keys(f).forEach(w=>{if(!(f[w].buffer instanceof ArrayBuffer))c(f[w]);else{const B=f[w].constructor,F=a/B.BYTES_PER_ELEMENT;f[w]=new B(i,0,F)}}),f),h=Q(this,ht,bs).call(this,n,i);return{buffer:this.CreateBuffer({label:r,size:a,usage:De.STORAGE,...t}),[e]:h.buffer instanceof ArrayBuffer?new h.constructor(i,0,s):c(h)}}CreateUniformBuffer(e,t){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,"`CreateUniformBuffer`.\n            Use `CreateShaderModule` before creating a uniform buffer.");const n=this.Reflect.uniforms.find(({name:a})=>e===a);!n&&ee(Y.UNIFORM_NOT_FOUND,`\`${e}\` in shader uniforms.`),e==="resolution"&&Ve(Y.INVALID_UNIFORM_NAME,`\`${e}\`.`);const s=(t==null?void 0:t.label)??`${e} Uniform Buffer`,r=new ArrayBuffer(n.size);return{buffer:this.CreateBuffer({label:s,size:r.byteLength,usage:De.UNIFORM,...t}),[e]:Q(this,ht,bs).call(this,n,r)}}CreateUniformBufferLayout(e){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,"`CreateUniformBufferLayout`.\n            Use `CreateShaderModule` before creating a uniform buffer layout.");const t=this.Reflect.uniforms.find(({name:n})=>e===n);return!t&&ee(Y.UNIFORM_NOT_FOUND,`\`${e}\` in shader uniforms.`),e==="resolution"&&Ve(Y.INVALID_UNIFORM_NAME,`\`${e}\`.`),Q(this,ht,bs).call(this,t,new ArrayBuffer(t.size))}WriteBuffer(e,t,n=0,s,r){this.Device.queue.writeBuffer(e,n,t,s,r)}CopyBufferToBuffer(e,t,n=t.size,s=0,r=0){this.GetCommandEncoder(!0).copyBufferToBuffer(e,s,t,r,n)}GetBufferMinBindingSize(e){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,"`GetBufferMinBindingSize`.\n            Use `CreateShaderModule` before requesting buffer's min binding size.");const n=this.Reflect.getBindGroups().flat().find(({name:s})=>e===s);return(n==null?void 0:n.size)??ee(Y.BINDING_NOT_FOUND,`\`${e}\` in shader bind groups.`)}CreateBufferBindingLayout(e,t,n,s,r){return s??(s=Q(this,ht,Zn).call(this)),{binding:r,visibility:s,buffer:{type:e,hasDynamicOffset:t,minBindingSize:n}}}CreateSamplerBindingLayout(e,t,n){return t??(t=Q(this,ht,Zn).call(this)),{binding:n,visibility:t,sampler:{type:e}}}CreateTextureBindingLayout(e,t,n,s,r){return s??(s=Q(this,ht,Zn).call(this)),{binding:r,visibility:s,texture:{sampleType:e,viewDimension:t,multisampled:n}}}CreateStorageTextureBindingLayout(e,t,n,s,r){return s??(s=Q(this,ht,Zn).call(this)),{binding:r,visibility:s,storageTexture:{access:t,format:e,viewDimension:n}}}CreateExternalTextureBindingLayout(e,t){return e??(e=Q(this,ht,Zn).call(this)),{binding:t,visibility:e,externalTexture:{}}}CreateBindGroupEntries(e,t=0){return Array.isArray(e)&&e.map((n,s)=>({binding:(t==null?void 0:t[s])??s,resource:n}))||[{binding:t,resource:e}]}CreateBindGroupLayout(e,t){return t??(t=this.CreatePipelineLabel("Bind Group Layout")),e=Array.isArray(e)&&e.map((n,s)=>({...n,binding:n.binding??s}))||[{...e,binding:e.binding??0}],this.Device.createBindGroupLayout({entries:e,label:t})}CreateBindGroup(e,t=0,n){return n??(n=this.CreatePipelineLabel("Bind Group")),typeof t=="number"&&(t=this.Pipeline?this.Pipeline.getBindGroupLayout(t):ee(Y.PIPELINE_NOT_FOUND,`${p(this,Bn)}Pipeline.`)),this.Device.createBindGroup({entries:e,label:n,layout:t})}SetBindGroups(e,t){const n=Array.isArray(e),s=Array.isArray(t);t=n&&s?t.map(r=>Array.isArray(r)&&r||[r]):s&&t||t&&[t],t=t&&t||[],this.BindGroups=n&&e.map((r,a)=>({bindGroup:r,dynamicOffsets:t,active:!0}))||[{bindGroup:e,dynamicOffsets:t,active:!0}]}AddBindGroups(e,t){const n=Array.isArray(e),s=Array.isArray(t);t=n&&s?t.map(a=>Array.isArray(a)&&a||[a]):s&&t||t&&[t],t=t&&t||[];const r=this.BindGroups.push(...n&&e.map(a=>({bindGroup:a,dynamicOffsets:t,active:!0}))||[{bindGroup:e,dynamicOffsets:t,active:!0}])-1;return!n&&[r]||Array.from({length:e.length}).map((a,i)=>r-i)}SetActiveBindGroups(e){e=Array.isArray(e)&&e||[e];for(let t=this.BindGroups.length;t--;)this.BindGroups[t].active=e.includes(t)}ClearBindGroups(){this.BindGroups.splice(0)}GetBindGroupsInfo(){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,"`GetBindGroupsInfo`.\n            Use `CreateShaderModule` before requesting bind groups information.");const e=this.BindGroups.length,t=new Array(e),n=this.Reflect.getBindGroups();for(let s=0;s<e;++s){const{bindGroup:{label:r},dynamicOffsets:a,active:i}=this.BindGroups[s];t[s]={label:r,active:i,dynamicOffsets:a,bindings:n[s]}}return t}CreateCommandEncoder(){return $(this,_n,this.Device.createCommandEncoder({label:p(this,gn)}))}SetCommandEncoder(e){$(this,_n,e)}GetCommandEncoder(e=!1){if(!p(this,_n)){if(e){const t=`${p(this,gn)&&`Label: "${p(this,gn)}".`}`;Ve(Y.COMMAND_ENCODER_NOT_FOUND,` ${t} Creating a new one.`)}return this.CreateCommandEncoder()}return p(this,_n)}SubmitCommandBuffer(){this.Device.queue.submit([p(this,_n).finish()])}SetPipeline(e){return this.Pipeline=e}SavePipelineState(){$(this,ns,this.Reflect),$(this,Ss,this.Pipeline),$(this,As,this.Descriptor),$(this,yn,[...this.BindGroups])}ResetPipelineState(){this.ClearBindGroups()}RestorePipelineState(){this.Descriptor=p(this,As),this.SetPipeline(p(this,Ss)),this.Reflect=p(this,ns),Q(this,ht,Xi).call(this)}set CommandEncoderLabel(e){$(this,gn,e)}get ProgramName(){return p(this,Un)}Destroy(){this.ResetPipelineState(),$(this,ns,void 0),p(this,yn).splice(0),this.SetCommandEncoder(void 0)}},Bn=new WeakMap,Un=new WeakMap,gn=new WeakMap,_n=new WeakMap,As=new WeakMap,Ss=new WeakMap,ns=new WeakMap,yn=new WeakMap,ht=new WeakSet,bs=function(e,t,n=0,s=[]){const{format:r}=e.type,a=e.type.members??(r==null?void 0:r.members);let i=n+(e.offset??0);if(a)for(let c=0,h={},f=(r==null?void 0:r.isStruct)&&e.count||1;c<f;++c)a.forEach(w=>h[w.name]=Q(this,ht,bs).call(this,w,t,i)),r!=null&&r.isStruct&&(i+=e.stride),s.push(h);else{const c=aa((r??e.type).name),h=e.size/oa(c),f=ca(c);return new f(t,i,h)}return s.length===1&&s[0]||s},Zn=function(){return p(this,Bn)==="Render"&&GPUShaderStage.FRAGMENT||GPUShaderStage.COMPUTE},Xi=function(){const e=p(this,yn).map(({bindGroup:r})=>r),t=p(this,yn).map(({dynamicOffsets:r})=>r),n=t.some(r=>typeof r=="number")&&t||void 0,s=p(this,yn).map(({active:r},a)=>r&&a).filter(r=>typeof r=="number");this.SetBindGroups(e,n),this.SetActiveBindGroups(s)},yi);const rr=Pe({RENDER:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,STORAGE:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING}),So=Pe({CLAMP:"clamp-to-edge",REPEAT:"repeat",MIRROR:"mirror-repeat"}),ir=Pe({NEAREST:"nearest",LINEAR:"linear"});var Yi="const QUAD=array(vec2f(-1.0,-1.0),vec2f(1.0,-1.0),vec2f(1.0,1.0),vec2f(1.0,1.0),vec2f(-1.0,1.0),vec2f(-1.0,-1.0));fn GetQuadCoord(index: u32)->vec2f{return QUAD[index];}struct VertexOutput{@builtin(position)position: vec4f,@location(0)textureCoord: vec2f};@group(0)@binding(0)var Sampler: sampler;@group(0)@binding(1)var Texture: texture_2d<f32>;@vertex fn vertex(@builtin(vertex_index)index: u32)->VertexOutput {let position=GetQuadCoord(index);let coord=(position+1)*0.5;var output: VertexOutput;output.position=vec4f(position,0.0,1.0);output.textureCoord=vec2f(coord.x,1-coord.y);return output;}@fragment fn fragment(@location(0)textureCoord: vec2f)->@location(0)vec4f {return textureSample(Texture,Sampler,textureCoord);}",$t,Vt,ue,xn,wn,Ae,dn,Kn,mr,gr;class ui{constructor(e,t){W(this,Ae);W(this,$t);W(this,Vt);W(this,ue);W(this,xn);W(this,wn);!e&&ee(Y.DEVICE_NOT_REQUESTED),$(this,ue,t),$(this,$t,e)}CreateSampler(e){if(!e)return p(this,$t).createSampler();const{addressModeUV:t,addressMode:n,minMagFilter:s,filter:r}=e;return t&&(e.addressModeU=e.addressModeV=t),n&&(e.addressModeU=e.addressModeV=e.addressModeW=n),s&&(e.minFilter=e.magFilter=s),r&&(e.minFilter=e.magFilter=e.mipmapFilter=r),p(this,$t).createSampler(e)}CreateTexture(e){const t=e.label??"Texture",{format:n="rgba8unorm",usage:s=rr.RENDER}=e;return p(this,$t).createTexture({label:t,format:n,usage:s,...e})}WriteTexture(e,t){const{texture:n,mipLevel:s,origin:r,aspect:a,offset:i,rowsPerImage:c}=t,[h,f]=Q(this,Ae,dn).call(this,n);let{bytesPerRow:w}=t;w??(w=(t.width??h)*Float32Array.BYTES_PER_ELEMENT),p(this,$t).queue.writeTexture({texture:n,mipLevel:s,origin:r,aspect:a},e,{offset:i,bytesPerRow:w,rowsPerImage:c},Q(this,Ae,Kn).call(this,{width:h,height:f,...t},"WriteTexture"))}CreateStorageTexture(e){let{size:t}=e;const n=rr.STORAGE|e.usage,s=e.label??"Storage Texture",{format:r=this.PreferredStorageFormat}=e;return t=p(this,ue)&&!t?p(this,ue).CanvasSize:t,this.CreateTexture({label:s,size:t,format:r,...e,usage:n})}CreateBitmapImage(e,t){return createImageBitmap(e,t)}CreateTextureFromSource(e,t={}){t=typeof t=="boolean"&&{}||t;const n=t.size,s=t.size,r=t.mipLevelCount??((t.mipmaps??!0)&&this.GetMipmapLevels(e)||void 0),a=Array.isArray(t.size)||!t.size?n??Q(this,Ae,dn).call(this,e):[s.width,s.height];return this.CreateTexture({size:a,mipLevelCount:r,...t})}ImportExternalTexture(e,t,n){return p(this,$t).importExternalTexture({source:e,label:t,colorSpace:n})}CreateMultisampleTexture(e=!1,t=4,n){var i;!p(this,ue)&&ee(Y.LEGACY_RENDER_PIPELINE_NOT_FOUND,"creating a multisample texture.");const{width:s,height:r,format:a}=p(this,ue).CurrentTexture;return(e||!p(this,Vt)||p(this,Vt).width!==s||p(this,Vt).height!==r)&&((i=p(this,Vt))==null||i.destroy(),$(this,Vt,this.CreateTexture({usage:GPUTextureUsage.RENDER_ATTACHMENT,label:n??"Multisample Texture",size:[s,r],sampleCount:t,format:a}))),p(this,Vt)}CopyImageToTexture(e,t={create:!0}){var F;let{create:n,texture:s}=t;const[r,a]=Q(this,Ae,dn).call(this,e),{flipY:i,mipLevel:c,aspect:h,colorSpace:f,premultipliedAlpha:w,mipmaps:B}=t;return B===!1&&((F=n=typeof n=="object"&&n||{}).mipmaps??(F.mipmaps=!1)),!s&&!n&&ee(Y.TEXTURE_NOT_FOUND,"`CopyImageToTexture`."),s??(s=this.CreateTextureFromSource(e,n)),p(this,$t).queue.copyExternalImageToTexture({source:e,origin:t.sourceOrigin,flipY:i},{texture:s,mipLevel:c,origin:t.destinationOrigin,aspect:h,colorSpace:f,premultipliedAlpha:w},Q(this,Ae,Kn).call(this,{width:r,height:a,...t},"CopyImageToTexture")),(B??!0)&&1<s.mipLevelCount&&(s.depthOrArrayLayers===1?this.GenerateMipmaps(s):this.GenerateCubeMipmaps(s)),s}CopyTextureToTexture(e){const{source:t,create:n}=e;let{srcTexture:s,dstTexture:r}=e;!p(this,ue)&&ee(Y.LEGACY_RENDER_PIPELINE_NOT_FOUND,"copying a texture to a texture."),!s&&!t&&!n&&ee(Y.TEXTURE_NOT_FOUND,"`CopyTextureToTexture`."),s??(s=this.CreateTextureFromSource(t,n)),r??(r=this.CreateTextureFromSource(s,n));const{srcMipLevel:a,srcOrigin:i,srcAspect:c}=e,{dstMipLevel:h,dstOrigin:f,dstAspect:w}=e,[B,F]=Q(this,Ae,dn).call(this,s);p(this,ue).GetCommandEncoder(!0).copyTextureToTexture({texture:s,mipLevel:a,origin:i,aspect:c},{texture:r,mipLevel:h,origin:f,aspect:w},Q(this,Ae,Kn).call(this,{width:B,height:F,...e},"CopyTextureToTexture"))}CopyTextureToBuffer(e){const{source:t,create:n}=e;let{texture:s,bytesPerRow:r}=e;!p(this,ue)&&ee(Y.LEGACY_RENDER_PIPELINE_NOT_FOUND,"copying a texture to a buffer."),!s&&!t&&!n&&ee(Y.TEXTURE_NOT_FOUND,"`CopyTextureToBuffer`."),s??(s=this.CreateTextureFromSource(t,n));const[a,i]=Q(this,Ae,dn).call(this,s),{buffer:c,offset:h,rowsPerImage:f,mipLevel:w,origin:B,aspect:F}=e;r??(r=(e.width??a)*Float32Array.BYTES_PER_ELEMENT),Q(this,Ae,mr).call(this,r,"CopyTextureToBuffer"),p(this,ue).GetCommandEncoder(!0).copyTextureToBuffer({texture:s,mipLevel:w,origin:B,aspect:F},{buffer:c,offset:h,bytesPerRow:r,rowsPerImage:f},Q(this,Ae,Kn).call(this,{width:a,height:i,...e},"CopyTextureToBuffer"))}CopyBufferToTexture(e){const{source:t,create:n}=e;let{texture:s,bytesPerRow:r}=e;!p(this,ue)&&ee(Y.LEGACY_RENDER_PIPELINE_NOT_FOUND,"copying a buffer to a texture."),!s&&!t&&!n&&ee(Y.TEXTURE_NOT_FOUND,"`CopyBufferToTexture`."),s??(s=this.CreateTextureFromSource(t,n));const[a,i]=Q(this,Ae,dn).call(this,s),{buffer:c,offset:h,rowsPerImage:f,mipLevel:w,origin:B,aspect:F}=e;r??(r=(e.width??a)*Float32Array.BYTES_PER_ELEMENT),Q(this,Ae,mr).call(this,r,"CopyBufferToTexture"),p(this,ue).GetCommandEncoder(!0).copyBufferToTexture({buffer:c,offset:h,bytesPerRow:r,rowsPerImage:f},{texture:s,mipLevel:w,origin:B,aspect:F},Q(this,Ae,Kn).call(this,{width:a,height:i,...e},"CopyBufferToTexture"))}get PreferredStorageFormat(){const e=Yt.PreferredCanvasFormat;return p(this,$t).features.has("bgra8unorm-storage")&&e==="bgra8unorm"?e:"rgba8unorm"}GenerateCubeMipmaps(e){Q(this,Ae,gr).call(this,e,{minMagFilter:ir.LINEAR},t=>{for(let n=0;n<e.depthOrArrayLayers;++n)p(this,ue).SetBindGroups(p(this,ue).CreateBindGroup(p(this,ue).CreateBindGroupEntries([p(this,xn),e.createView({baseMipLevel:t-1,arrayLayerCount:1,baseArrayLayer:n,mipLevelCount:1,dimension:"2d"})]))),p(this,ue).CreatePassDescriptor(p(this,ue).CreateColorAttachment(e.createView({arrayLayerCount:1,baseArrayLayer:n,mipLevelCount:1,dimension:"2d",baseMipLevel:t}))),p(this,ue).Render(6,!1),p(this,ue).DestroyCurrentPass()})}GenerateMipmaps(e){Q(this,Ae,gr).call(this,e,{minFilter:ir.LINEAR},t=>{p(this,ue).SetBindGroups(p(this,ue).CreateBindGroup(p(this,ue).CreateBindGroupEntries([p(this,xn),e.createView({baseMipLevel:t-1,mipLevelCount:1})]))),p(this,ue).CreatePassDescriptor(p(this,ue).CreateColorAttachment(e.createView({baseMipLevel:t,mipLevelCount:1}))),p(this,ue).Render(6,!1),p(this,ue).DestroyCurrentPass()})}GetMipmapLevels(e){const[t,n]=Q(this,Ae,dn).call(this,e);return(Math.log2(Math.max(t,n))|0)+1}set LegacyRenderer(e){$(this,ue,e)}SetRenderer(e){this.LegacyRenderer=e}Destroy(){var e;$(this,Vt,(e=p(this,Vt))==null?void 0:e.destroy())}}$t=new WeakMap,Vt=new WeakMap,ue=new WeakMap,xn=new WeakMap,wn=new WeakMap,Ae=new WeakSet,dn=function(e){return e instanceof HTMLVideoElement?[e.videoWidth,e.videoHeight]:e instanceof VideoFrame?[e.codedWidth,e.codedHeight]:[e.width,e.height]},Kn=function(e,t){const{size:n,width:s,height:r,depthOrArrayLayers:a}=e;return!n&&!s&&ee(Y.TEXTURE_SIZE_NOT_FOUND,`\`${t}\` method.`),n??{width:s,height:r,depthOrArrayLayers:a}},mr=function(e,t){const n=e/256;n!==(n|0)&&Ve(Y.INVALID_BYTES_PER_ROW,`\`${t}\` options.`)},gr=function(e,t,n){!p(this,ue)&&ee(Y.LEGACY_RENDER_PIPELINE_NOT_FOUND,"creating a texture with mipmaps."),p(this,ue).SavePipelineState(),p(this,ue).ResetPipelineState(),(!p(this,wn)||!p(this,xn))&&($(this,wn,p(this,ue).CreateShaderModule(Yi)),$(this,xn,this.CreateSampler(t))),p(this,ue).CreatePipeline({vertex:p(this,ue).CreateVertexState(p(this,wn)),fragment:p(this,ue).CreateFragmentState(p(this,wn),void 0,p(this,ue).CreateTargetState(e.format))});for(let s=1;s<e.mipLevelCount;++s)n(s);p(this,ue).SubmitCommandBuffer(),p(this,ue).SetCommandEncoder(void 0),p(this,ue).RestorePipelineState(),$(this,wn,$(this,xn,void 0))};var Gt,zt,ve,vn,bn,Se,pn,Jn,_r,yr;class Lr{constructor(e,t){W(this,Se);W(this,Gt);W(this,zt);W(this,ve);W(this,vn);W(this,bn);!e&&ee(Y.DEVICE_NOT_REQUESTED),$(this,ve,t),$(this,Gt,e)}CreateSampler(e){if(!e)return p(this,Gt).createSampler();const{addressModeUV:t,addressMode:n,minMagFilter:s,filter:r}=e;return t&&(e.addressModeU=e.addressModeV=t),n&&(e.addressModeU=e.addressModeV=e.addressModeW=n),s&&(e.minFilter=e.magFilter=s),r&&(e.minFilter=e.magFilter=e.mipmapFilter=r),p(this,Gt).createSampler(e)}CreateTexture(e){const t=e.label??"Texture",{format:n=Yt.PreferredCanvasFormat,usage:s=rr.RENDER}=e;return p(this,Gt).createTexture({label:t,format:n,usage:s,...e})}WriteTexture(e,t){const{texture:n,mipLevel:s,origin:r,aspect:a,offset:i,rowsPerImage:c}=t,[h,f]=Q(this,Se,pn).call(this,n);let{bytesPerRow:w}=t;w??(w=(t.width??h)*Float32Array.BYTES_PER_ELEMENT),p(this,Gt).queue.writeTexture({texture:n,mipLevel:s,origin:r,aspect:a},e,{offset:i,bytesPerRow:w,rowsPerImage:c},Q(this,Se,Jn).call(this,{width:h,height:f,...t},"WriteTexture"))}CreateStorageTexture(e){let{size:t}=e;const n=rr.STORAGE|e.usage,s=e.label??"Storage Texture",{format:r=this.PreferredStorageFormat}=e;return t=p(this,ve)&&!t?p(this,ve).CanvasSize:t,this.CreateTexture({label:s,size:t,format:r,...e,usage:n})}CreateBitmapImage(e,t){return createImageBitmap(e,t)}CreateTextureFromSource(e,t={}){t=typeof t=="boolean"&&{}||t;const n=t.size,s=t.size,r=t.mipLevelCount??((t.mipmaps??!0)&&this.GetMipmapLevels(e)||void 0),a=Array.isArray(t.size)||!t.size?n??Q(this,Se,pn).call(this,e):[s.width,s.height];return this.CreateTexture({size:a,mipLevelCount:r,...t})}ImportExternalTexture(e,t,n){return p(this,Gt).importExternalTexture({source:e,label:t,colorSpace:n})}async LoadExternalImageSource(e,t={}){return new Promise(n=>{const s=new Image;for(const r in t)s[r]=t[r];s.onload=()=>n(s),s.src=e})}CreateMultisampleTexture(e=!1,t=4,n){var i;!p(this,ve)&&ee(Y.RENDERER_NOT_FOUND,"creating a multisample texture.");const{width:s,height:r,format:a}=p(this,ve).CurrentTexture;return(e||!p(this,zt)||p(this,zt).width!==s||p(this,zt).height!==r)&&((i=p(this,zt))==null||i.destroy(),$(this,zt,this.CreateTexture({usage:GPUTextureUsage.RENDER_ATTACHMENT,label:n??"Multisample Texture",size:[s,r],sampleCount:t,format:a}))),p(this,zt)}async CopyImageToTexture(e,t={create:!0}){var F;let{create:n,texture:s}=t;const[r,a]=Q(this,Se,pn).call(this,e),{flipY:i,mipLevel:c,aspect:h,colorSpace:f,premultipliedAlpha:w,mipmaps:B}=t;return B===!1&&((F=n=typeof n=="object"&&n||{}).mipmaps??(F.mipmaps=!1)),!s&&!n&&ee(Y.TEXTURE_NOT_FOUND,"`CopyImageToTexture`."),s??(s=this.CreateTextureFromSource(e,n)),p(this,Gt).queue.copyExternalImageToTexture({source:e,origin:t.sourceOrigin,flipY:i},{texture:s,mipLevel:c,origin:t.destinationOrigin,aspect:h,colorSpace:f,premultipliedAlpha:w},Q(this,Se,Jn).call(this,{width:r,height:a,...t},"CopyImageToTexture")),(B??!0)&&1<s.mipLevelCount&&(s.depthOrArrayLayers===1?await this.GenerateMipmaps(s):await this.GenerateCubeMipmaps(s)),s}async GenerateCubeMipmaps(e){return Q(this,Se,yr).call(this,e,{minMagFilter:ir.LINEAR},(t,n)=>{for(let s=0;s<e.depthOrArrayLayers;++s)t.SetBindGroups(t.CreateBindGroup(t.CreateBindGroupEntries([p(this,vn),e.createView({baseMipLevel:n-1,arrayLayerCount:1,baseArrayLayer:s,mipLevelCount:1,dimension:"2d"})]))),p(this,ve).CreatePassDescriptor(p(this,ve).CreateColorAttachment(void 0,e.createView({arrayLayerCount:1,baseArrayLayer:s,mipLevelCount:1,dimension:"2d",baseMipLevel:n}))),p(this,ve).Render(!1)})}async GenerateMipmaps(e){return Q(this,Se,yr).call(this,e,{minFilter:ir.LINEAR},(t,n)=>{t.SetBindGroups(t.CreateBindGroup(t.CreateBindGroupEntries([p(this,vn),e.createView({baseMipLevel:n-1,mipLevelCount:1})]))),p(this,ve).CreatePassDescriptor(p(this,ve).CreateColorAttachment(void 0,e.createView({baseMipLevel:n,mipLevelCount:1}))),p(this,ve).Render(!1)})}CopyTextureToTexture(e){const{source:t,create:n}=e;let{srcTexture:s,dstTexture:r}=e;!p(this,ve)&&ee(Y.RENDERER_NOT_FOUND,"copying a texture to a texture."),!s&&!t&&!n&&ee(Y.TEXTURE_NOT_FOUND,"`CopyTextureToTexture`."),s??(s=this.CreateTextureFromSource(t,n)),r??(r=this.CreateTextureFromSource(s,n));const{srcMipLevel:a,srcOrigin:i,srcAspect:c}=e,{dstMipLevel:h,dstOrigin:f,dstAspect:w}=e,[B,F]=Q(this,Se,pn).call(this,s);p(this,ve).GetCommandEncoder(!0).copyTextureToTexture({texture:s,mipLevel:a,origin:i,aspect:c},{texture:r,mipLevel:h,origin:f,aspect:w},Q(this,Se,Jn).call(this,{width:B,height:F,...e},"CopyTextureToTexture"))}CopyTextureToBuffer(e){const{source:t,create:n}=e;let{texture:s,bytesPerRow:r}=e;!p(this,ve)&&ee(Y.RENDERER_NOT_FOUND,"copying a texture to a buffer."),!s&&!t&&!n&&ee(Y.TEXTURE_NOT_FOUND,"`CopyTextureToBuffer`."),s??(s=this.CreateTextureFromSource(t,n));const[a,i]=Q(this,Se,pn).call(this,s),{buffer:c,offset:h,rowsPerImage:f,mipLevel:w,origin:B,aspect:F}=e;r??(r=(e.width??a)*Float32Array.BYTES_PER_ELEMENT),Q(this,Se,_r).call(this,r,"CopyTextureToBuffer"),p(this,ve).GetCommandEncoder(!0).copyTextureToBuffer({texture:s,mipLevel:w,origin:B,aspect:F},{buffer:c,offset:h,bytesPerRow:r,rowsPerImage:f},Q(this,Se,Jn).call(this,{width:a,height:i,...e},"CopyTextureToBuffer"))}CopyBufferToTexture(e){const{source:t,create:n}=e;let{texture:s,bytesPerRow:r}=e;!p(this,ve)&&ee(Y.RENDERER_NOT_FOUND,"copying a buffer to a texture."),!s&&!t&&!n&&ee(Y.TEXTURE_NOT_FOUND,"`CopyBufferToTexture`."),s??(s=this.CreateTextureFromSource(t,n));const[a,i]=Q(this,Se,pn).call(this,s),{buffer:c,offset:h,rowsPerImage:f,mipLevel:w,origin:B,aspect:F}=e;r??(r=(e.width??a)*Float32Array.BYTES_PER_ELEMENT),Q(this,Se,_r).call(this,r,"CopyBufferToTexture"),p(this,ve).GetCommandEncoder(!0).copyBufferToTexture({buffer:c,offset:h,bytesPerRow:r,rowsPerImage:f},{texture:s,mipLevel:w,origin:B,aspect:F},Q(this,Se,Jn).call(this,{width:a,height:i,...e},"CopyBufferToTexture"))}get PreferredStorageFormat(){const e=Yt.PreferredCanvasFormat;return p(this,Gt).features.has("bgra8unorm-storage")&&e==="bgra8unorm"?e:"rgba8unorm"}GetMipmapLevels(e){const[t,n]=Q(this,Se,pn).call(this,e);return(Math.log2(Math.max(t,n))|0)+1}set Renderer(e){$(this,ve,e)}Destroy(){var e;$(this,zt,(e=p(this,zt))==null?void 0:e.destroy())}}Gt=new WeakMap,zt=new WeakMap,ve=new WeakMap,vn=new WeakMap,bn=new WeakMap,Se=new WeakSet,pn=function(e){return e instanceof HTMLVideoElement?[e.videoWidth,e.videoHeight]:e instanceof VideoFrame?[e.codedWidth,e.codedHeight]:[e.width,e.height]},Jn=function(e,t){const{size:n,width:s,height:r,depthOrArrayLayers:a}=e;return!n&&!s&&ee(Y.TEXTURE_SIZE_NOT_FOUND,`\`${t}\` method.`),n??{width:s,height:r,depthOrArrayLayers:a}},_r=function(e,t){const n=e/256;n!==(n|0)&&Ve(Y.INVALID_BYTES_PER_ROW,`\`${t}\` options.`)},yr=async function(e,t,n){!p(this,ve)&&ee(Y.RENDERER_NOT_FOUND,"creating a texture with mipmaps.");const s=new(p(this,ve)).Pipeline;s.DestroyPassEncoder=!0,s.SetDrawParams(6),(!p(this,bn)||!p(this,vn))&&($(this,bn,s.CreateShaderModule(Yi)),$(this,vn,this.CreateSampler(t))),await p(this,ve).AddPipeline(s,{vertex:s.CreateVertexState(p(this,bn)),fragment:s.CreateFragmentState(p(this,bn),void 0,s.CreateColorTargetState(e.format))});for(let r=1;r<e.mipLevelCount;++r)n(s,r);p(this,ve).SubmitCommandBuffer(),p(this,ve).CommandEncoder=void 0,p(this,ve).RemovePipeline(s),$(this,bn,$(this,vn,void 0))};function Ka(u,e){return class extends u{constructor(...t){super(...t),e(this)}}}const Ja=Ka(Array,u=>u.fill(0));let le=1e-6;function eo(u){function e(S=0,D=0){const N=new u(2);return S!==void 0&&(N[0]=S,D!==void 0&&(N[1]=D)),N}const t=e;function n(S,D,N){const o=N??new u(2);return o[0]=S,o[1]=D,o}function s(S,D){const N=D??new u(2);return N[0]=Math.ceil(S[0]),N[1]=Math.ceil(S[1]),N}function r(S,D){const N=D??new u(2);return N[0]=Math.floor(S[0]),N[1]=Math.floor(S[1]),N}function a(S,D){const N=D??new u(2);return N[0]=Math.round(S[0]),N[1]=Math.round(S[1]),N}function i(S,D=0,N=1,o){const v=o??new u(2);return v[0]=Math.min(N,Math.max(D,S[0])),v[1]=Math.min(N,Math.max(D,S[1])),v}function c(S,D,N){const o=N??new u(2);return o[0]=S[0]+D[0],o[1]=S[1]+D[1],o}function h(S,D,N,o){const v=o??new u(2);return v[0]=S[0]+D[0]*N,v[1]=S[1]+D[1]*N,v}function f(S,D){const N=S[0],o=S[1],v=D[0],m=D[1],_=Math.sqrt(N*N+o*o),d=Math.sqrt(v*v+m*m),y=_*d,A=y&&$e(S,D)/y;return Math.acos(A)}function w(S,D,N){const o=N??new u(2);return o[0]=S[0]-D[0],o[1]=S[1]-D[1],o}const B=w;function F(S,D){return Math.abs(S[0]-D[0])<le&&Math.abs(S[1]-D[1])<le}function Z(S,D){return S[0]===D[0]&&S[1]===D[1]}function ie(S,D,N,o){const v=o??new u(2);return v[0]=S[0]+N*(D[0]-S[0]),v[1]=S[1]+N*(D[1]-S[1]),v}function ae(S,D,N,o){const v=o??new u(2);return v[0]=S[0]+N[0]*(D[0]-S[0]),v[1]=S[1]+N[1]*(D[1]-S[1]),v}function me(S,D,N){const o=N??new u(2);return o[0]=Math.max(S[0],D[0]),o[1]=Math.max(S[1],D[1]),o}function xe(S,D,N){const o=N??new u(2);return o[0]=Math.min(S[0],D[0]),o[1]=Math.min(S[1],D[1]),o}function J(S,D,N){const o=N??new u(2);return o[0]=S[0]*D,o[1]=S[1]*D,o}const te=J;function Ee(S,D,N){const o=N??new u(2);return o[0]=S[0]/D,o[1]=S[1]/D,o}function we(S,D){const N=D??new u(2);return N[0]=1/S[0],N[1]=1/S[1],N}const tt=we;function Fe(S,D,N){const o=N??new u(3),v=S[0]*D[1]-S[1]*D[0];return o[0]=0,o[1]=0,o[2]=v,o}function $e(S,D){return S[0]*D[0]+S[1]*D[1]}function Ne(S){const D=S[0],N=S[1];return Math.sqrt(D*D+N*N)}const ze=Ne;function nt(S){const D=S[0],N=S[1];return D*D+N*N}const Ct=nt;function qe(S,D){const N=S[0]-D[0],o=S[1]-D[1];return Math.sqrt(N*N+o*o)}const fe=qe;function de(S,D){const N=S[0]-D[0],o=S[1]-D[1];return N*N+o*o}const he=de;function st(S,D){const N=D??new u(2),o=S[0],v=S[1],m=Math.sqrt(o*o+v*v);return m>1e-5?(N[0]=o/m,N[1]=v/m):(N[0]=0,N[1]=0),N}function Bt(S,D){const N=D??new u(2);return N[0]=-S[0],N[1]=-S[1],N}function be(S,D){const N=D??new u(2);return N[0]=S[0],N[1]=S[1],N}const Ut=be;function ft(S,D,N){const o=N??new u(2);return o[0]=S[0]*D[0],o[1]=S[1]*D[1],o}const Lt=ft;function dt(S,D,N){const o=N??new u(2);return o[0]=S[0]/D[0],o[1]=S[1]/D[1],o}const Tt=dt;function Et(S=1,D){const N=D??new u(2),o=Math.random()*2*Math.PI;return N[0]=Math.cos(o)*S,N[1]=Math.sin(o)*S,N}function L(S){const D=S??new u(2);return D[0]=0,D[1]=0,D}function q(S,D,N){const o=N??new u(2),v=S[0],m=S[1];return o[0]=v*D[0]+m*D[4]+D[12],o[1]=v*D[1]+m*D[5]+D[13],o}function I(S,D,N){const o=N??new u(2),v=S[0],m=S[1];return o[0]=D[0]*v+D[4]*m+D[8],o[1]=D[1]*v+D[5]*m+D[9],o}function l(S,D,N,o){const v=o??new u(2),m=S[0]-D[0],_=S[1]-D[1],d=Math.sin(N),y=Math.cos(N);return v[0]=m*y-_*d+D[0],v[1]=m*d+_*y+D[1],v}function x(S,D,N){const o=N??new u(2);return st(S,o),J(o,D,o)}function g(S,D,N){const o=N??new u(2);return Ne(S)>D?x(S,D,o):be(S,o)}function k(S,D,N){const o=N??new u(2);return ie(S,D,.5,o)}return{create:e,fromValues:t,set:n,ceil:s,floor:r,round:a,clamp:i,add:c,addScaled:h,angle:f,subtract:w,sub:B,equalsApproximately:F,equals:Z,lerp:ie,lerpV:ae,max:me,min:xe,mulScalar:J,scale:te,divScalar:Ee,inverse:we,invert:tt,cross:Fe,dot:$e,length:Ne,len:ze,lengthSq:nt,lenSq:Ct,distance:qe,dist:fe,distanceSq:de,distSq:he,normalize:st,negate:Bt,copy:be,clone:Ut,multiply:ft,mul:Lt,divide:dt,div:Tt,random:Et,zero:L,transformMat4:q,transformMat3:I,rotate:l,setLength:x,truncate:g,midpoint:k}}const li=new Map;function Qi(u){let e=li.get(u);return e||(e=eo(u),li.set(u,e)),e}function to(u){function e(d,y,A){const E=new u(3);return d!==void 0&&(E[0]=d,y!==void 0&&(E[1]=y,A!==void 0&&(E[2]=A))),E}const t=e;function n(d,y,A,E){const R=E??new u(3);return R[0]=d,R[1]=y,R[2]=A,R}function s(d,y){const A=y??new u(3);return A[0]=Math.ceil(d[0]),A[1]=Math.ceil(d[1]),A[2]=Math.ceil(d[2]),A}function r(d,y){const A=y??new u(3);return A[0]=Math.floor(d[0]),A[1]=Math.floor(d[1]),A[2]=Math.floor(d[2]),A}function a(d,y){const A=y??new u(3);return A[0]=Math.round(d[0]),A[1]=Math.round(d[1]),A[2]=Math.round(d[2]),A}function i(d,y=0,A=1,E){const R=E??new u(3);return R[0]=Math.min(A,Math.max(y,d[0])),R[1]=Math.min(A,Math.max(y,d[1])),R[2]=Math.min(A,Math.max(y,d[2])),R}function c(d,y,A){const E=A??new u(3);return E[0]=d[0]+y[0],E[1]=d[1]+y[1],E[2]=d[2]+y[2],E}function h(d,y,A,E){const R=E??new u(3);return R[0]=d[0]+y[0]*A,R[1]=d[1]+y[1]*A,R[2]=d[2]+y[2]*A,R}function f(d,y){const A=d[0],E=d[1],R=d[2],V=y[0],z=y[1],K=y[2],H=Math.sqrt(A*A+E*E+R*R),X=Math.sqrt(V*V+z*z+K*K),ne=H*X,ce=ne&&$e(d,y)/ne;return Math.acos(ce)}function w(d,y,A){const E=A??new u(3);return E[0]=d[0]-y[0],E[1]=d[1]-y[1],E[2]=d[2]-y[2],E}const B=w;function F(d,y){return Math.abs(d[0]-y[0])<le&&Math.abs(d[1]-y[1])<le&&Math.abs(d[2]-y[2])<le}function Z(d,y){return d[0]===y[0]&&d[1]===y[1]&&d[2]===y[2]}function ie(d,y,A,E){const R=E??new u(3);return R[0]=d[0]+A*(y[0]-d[0]),R[1]=d[1]+A*(y[1]-d[1]),R[2]=d[2]+A*(y[2]-d[2]),R}function ae(d,y,A,E){const R=E??new u(3);return R[0]=d[0]+A[0]*(y[0]-d[0]),R[1]=d[1]+A[1]*(y[1]-d[1]),R[2]=d[2]+A[2]*(y[2]-d[2]),R}function me(d,y,A){const E=A??new u(3);return E[0]=Math.max(d[0],y[0]),E[1]=Math.max(d[1],y[1]),E[2]=Math.max(d[2],y[2]),E}function xe(d,y,A){const E=A??new u(3);return E[0]=Math.min(d[0],y[0]),E[1]=Math.min(d[1],y[1]),E[2]=Math.min(d[2],y[2]),E}function J(d,y,A){const E=A??new u(3);return E[0]=d[0]*y,E[1]=d[1]*y,E[2]=d[2]*y,E}const te=J;function Ee(d,y,A){const E=A??new u(3);return E[0]=d[0]/y,E[1]=d[1]/y,E[2]=d[2]/y,E}function we(d,y){const A=y??new u(3);return A[0]=1/d[0],A[1]=1/d[1],A[2]=1/d[2],A}const tt=we;function Fe(d,y,A){const E=A??new u(3),R=d[2]*y[0]-d[0]*y[2],V=d[0]*y[1]-d[1]*y[0];return E[0]=d[1]*y[2]-d[2]*y[1],E[1]=R,E[2]=V,E}function $e(d,y){return d[0]*y[0]+d[1]*y[1]+d[2]*y[2]}function Ne(d){const y=d[0],A=d[1],E=d[2];return Math.sqrt(y*y+A*A+E*E)}const ze=Ne;function nt(d){const y=d[0],A=d[1],E=d[2];return y*y+A*A+E*E}const Ct=nt;function qe(d,y){const A=d[0]-y[0],E=d[1]-y[1],R=d[2]-y[2];return Math.sqrt(A*A+E*E+R*R)}const fe=qe;function de(d,y){const A=d[0]-y[0],E=d[1]-y[1],R=d[2]-y[2];return A*A+E*E+R*R}const he=de;function st(d,y){const A=y??new u(3),E=d[0],R=d[1],V=d[2],z=Math.sqrt(E*E+R*R+V*V);return z>1e-5?(A[0]=E/z,A[1]=R/z,A[2]=V/z):(A[0]=0,A[1]=0,A[2]=0),A}function Bt(d,y){const A=y??new u(3);return A[0]=-d[0],A[1]=-d[1],A[2]=-d[2],A}function be(d,y){const A=y??new u(3);return A[0]=d[0],A[1]=d[1],A[2]=d[2],A}const Ut=be;function ft(d,y,A){const E=A??new u(3);return E[0]=d[0]*y[0],E[1]=d[1]*y[1],E[2]=d[2]*y[2],E}const Lt=ft;function dt(d,y,A){const E=A??new u(3);return E[0]=d[0]/y[0],E[1]=d[1]/y[1],E[2]=d[2]/y[2],E}const Tt=dt;function Et(d=1,y){const A=y??new u(3),E=Math.random()*2*Math.PI,R=Math.random()*2-1,V=Math.sqrt(1-R*R)*d;return A[0]=Math.cos(E)*V,A[1]=Math.sin(E)*V,A[2]=R*d,A}function L(d){const y=d??new u(3);return y[0]=0,y[1]=0,y[2]=0,y}function q(d,y,A){const E=A??new u(3),R=d[0],V=d[1],z=d[2],K=y[3]*R+y[7]*V+y[11]*z+y[15]||1;return E[0]=(y[0]*R+y[4]*V+y[8]*z+y[12])/K,E[1]=(y[1]*R+y[5]*V+y[9]*z+y[13])/K,E[2]=(y[2]*R+y[6]*V+y[10]*z+y[14])/K,E}function I(d,y,A){const E=A??new u(3),R=d[0],V=d[1],z=d[2];return E[0]=R*y[0*4+0]+V*y[1*4+0]+z*y[2*4+0],E[1]=R*y[0*4+1]+V*y[1*4+1]+z*y[2*4+1],E[2]=R*y[0*4+2]+V*y[1*4+2]+z*y[2*4+2],E}function l(d,y,A){const E=A??new u(3),R=d[0],V=d[1],z=d[2];return E[0]=R*y[0]+V*y[4]+z*y[8],E[1]=R*y[1]+V*y[5]+z*y[9],E[2]=R*y[2]+V*y[6]+z*y[10],E}function x(d,y,A){const E=A??new u(3),R=y[0],V=y[1],z=y[2],K=y[3]*2,H=d[0],X=d[1],ne=d[2],ce=V*ne-z*X,se=z*H-R*ne,re=R*X-V*H;return E[0]=H+ce*K+(V*re-z*se)*2,E[1]=X+se*K+(z*ce-R*re)*2,E[2]=ne+re*K+(R*se-V*ce)*2,E}function g(d,y){const A=y??new u(3);return A[0]=d[12],A[1]=d[13],A[2]=d[14],A}function k(d,y,A){const E=A??new u(3),R=y*4;return E[0]=d[R+0],E[1]=d[R+1],E[2]=d[R+2],E}function S(d,y){const A=y??new u(3),E=d[0],R=d[1],V=d[2],z=d[4],K=d[5],H=d[6],X=d[8],ne=d[9],ce=d[10];return A[0]=Math.sqrt(E*E+R*R+V*V),A[1]=Math.sqrt(z*z+K*K+H*H),A[2]=Math.sqrt(X*X+ne*ne+ce*ce),A}function D(d,y,A,E){const R=E??new u(3),V=[],z=[];return V[0]=d[0]-y[0],V[1]=d[1]-y[1],V[2]=d[2]-y[2],z[0]=V[0],z[1]=V[1]*Math.cos(A)-V[2]*Math.sin(A),z[2]=V[1]*Math.sin(A)+V[2]*Math.cos(A),R[0]=z[0]+y[0],R[1]=z[1]+y[1],R[2]=z[2]+y[2],R}function N(d,y,A,E){const R=E??new u(3),V=[],z=[];return V[0]=d[0]-y[0],V[1]=d[1]-y[1],V[2]=d[2]-y[2],z[0]=V[2]*Math.sin(A)+V[0]*Math.cos(A),z[1]=V[1],z[2]=V[2]*Math.cos(A)-V[0]*Math.sin(A),R[0]=z[0]+y[0],R[1]=z[1]+y[1],R[2]=z[2]+y[2],R}function o(d,y,A,E){const R=E??new u(3),V=[],z=[];return V[0]=d[0]-y[0],V[1]=d[1]-y[1],V[2]=d[2]-y[2],z[0]=V[0]*Math.cos(A)-V[1]*Math.sin(A),z[1]=V[0]*Math.sin(A)+V[1]*Math.cos(A),z[2]=V[2],R[0]=z[0]+y[0],R[1]=z[1]+y[1],R[2]=z[2]+y[2],R}function v(d,y,A){const E=A??new u(3);return st(d,E),J(E,y,E)}function m(d,y,A){const E=A??new u(3);return Ne(d)>y?v(d,y,E):be(d,E)}function _(d,y,A){const E=A??new u(3);return ie(d,y,.5,E)}return{create:e,fromValues:t,set:n,ceil:s,floor:r,round:a,clamp:i,add:c,addScaled:h,angle:f,subtract:w,sub:B,equalsApproximately:F,equals:Z,lerp:ie,lerpV:ae,max:me,min:xe,mulScalar:J,scale:te,divScalar:Ee,inverse:we,invert:tt,cross:Fe,dot:$e,length:Ne,len:ze,lengthSq:nt,lenSq:Ct,distance:qe,dist:fe,distanceSq:de,distSq:he,normalize:st,negate:Bt,copy:be,clone:Ut,multiply:ft,mul:Lt,divide:dt,div:Tt,random:Et,zero:L,transformMat4:q,transformMat4Upper3x3:I,transformMat3:l,transformQuat:x,getTranslation:g,getAxis:k,getScaling:S,rotateX:D,rotateY:N,rotateZ:o,setLength:v,truncate:m,midpoint:_}}const hi=new Map;function or(u){let e=hi.get(u);return e||(e=to(u),hi.set(u,e)),e}function no(u){const e=Qi(u),t=or(u);function n(l,x,g,k,S,D,N,o,v){const m=new u(12);return m[3]=0,m[7]=0,m[11]=0,l!==void 0&&(m[0]=l,x!==void 0&&(m[1]=x,g!==void 0&&(m[2]=g,k!==void 0&&(m[4]=k,S!==void 0&&(m[5]=S,D!==void 0&&(m[6]=D,N!==void 0&&(m[8]=N,o!==void 0&&(m[9]=o,v!==void 0&&(m[10]=v))))))))),m}function s(l,x,g,k,S,D,N,o,v,m){const _=m??new u(12);return _[0]=l,_[1]=x,_[2]=g,_[3]=0,_[4]=k,_[5]=S,_[6]=D,_[7]=0,_[8]=N,_[9]=o,_[10]=v,_[11]=0,_}function r(l,x){const g=x??new u(12);return g[0]=l[0],g[1]=l[1],g[2]=l[2],g[3]=0,g[4]=l[4],g[5]=l[5],g[6]=l[6],g[7]=0,g[8]=l[8],g[9]=l[9],g[10]=l[10],g[11]=0,g}function a(l,x){const g=x??new u(12),k=l[0],S=l[1],D=l[2],N=l[3],o=k+k,v=S+S,m=D+D,_=k*o,d=S*o,y=S*v,A=D*o,E=D*v,R=D*m,V=N*o,z=N*v,K=N*m;return g[0]=1-y-R,g[1]=d+K,g[2]=A-z,g[3]=0,g[4]=d-K,g[5]=1-_-R,g[6]=E+V,g[7]=0,g[8]=A+z,g[9]=E-V,g[10]=1-_-y,g[11]=0,g}function i(l,x){const g=x??new u(12);return g[0]=-l[0],g[1]=-l[1],g[2]=-l[2],g[4]=-l[4],g[5]=-l[5],g[6]=-l[6],g[8]=-l[8],g[9]=-l[9],g[10]=-l[10],g}function c(l,x,g){const k=g??new u(12);return k[0]=l[0]*x,k[1]=l[1]*x,k[2]=l[2]*x,k[4]=l[4]*x,k[5]=l[5]*x,k[6]=l[6]*x,k[8]=l[8]*x,k[9]=l[9]*x,k[10]=l[10]*x,k}const h=c;function f(l,x,g){const k=g??new u(12);return k[0]=l[0]+x[0],k[1]=l[1]+x[1],k[2]=l[2]+x[2],k[4]=l[4]+x[4],k[5]=l[5]+x[5],k[6]=l[6]+x[6],k[8]=l[8]+x[8],k[9]=l[9]+x[9],k[10]=l[10]+x[10],k}function w(l,x){const g=x??new u(12);return g[0]=l[0],g[1]=l[1],g[2]=l[2],g[4]=l[4],g[5]=l[5],g[6]=l[6],g[8]=l[8],g[9]=l[9],g[10]=l[10],g}const B=w;function F(l,x){return Math.abs(l[0]-x[0])<le&&Math.abs(l[1]-x[1])<le&&Math.abs(l[2]-x[2])<le&&Math.abs(l[4]-x[4])<le&&Math.abs(l[5]-x[5])<le&&Math.abs(l[6]-x[6])<le&&Math.abs(l[8]-x[8])<le&&Math.abs(l[9]-x[9])<le&&Math.abs(l[10]-x[10])<le}function Z(l,x){return l[0]===x[0]&&l[1]===x[1]&&l[2]===x[2]&&l[4]===x[4]&&l[5]===x[5]&&l[6]===x[6]&&l[8]===x[8]&&l[9]===x[9]&&l[10]===x[10]}function ie(l){const x=l??new u(12);return x[0]=1,x[1]=0,x[2]=0,x[4]=0,x[5]=1,x[6]=0,x[8]=0,x[9]=0,x[10]=1,x}function ae(l,x){const g=x??new u(12);if(g===l){let y;return y=l[1],l[1]=l[4],l[4]=y,y=l[2],l[2]=l[8],l[8]=y,y=l[6],l[6]=l[9],l[9]=y,g}const k=l[0*4+0],S=l[0*4+1],D=l[0*4+2],N=l[1*4+0],o=l[1*4+1],v=l[1*4+2],m=l[2*4+0],_=l[2*4+1],d=l[2*4+2];return g[0]=k,g[1]=N,g[2]=m,g[4]=S,g[5]=o,g[6]=_,g[8]=D,g[9]=v,g[10]=d,g}function me(l,x){const g=x??new u(12),k=l[0*4+0],S=l[0*4+1],D=l[0*4+2],N=l[1*4+0],o=l[1*4+1],v=l[1*4+2],m=l[2*4+0],_=l[2*4+1],d=l[2*4+2],y=d*o-v*_,A=-d*N+v*m,E=_*N-o*m,R=1/(k*y+S*A+D*E);return g[0]=y*R,g[1]=(-d*S+D*_)*R,g[2]=(v*S-D*o)*R,g[4]=A*R,g[5]=(d*k-D*m)*R,g[6]=(-v*k+D*N)*R,g[8]=E*R,g[9]=(-_*k+S*m)*R,g[10]=(o*k-S*N)*R,g}function xe(l){const x=l[0],g=l[0*4+1],k=l[0*4+2],S=l[1*4+0],D=l[1*4+1],N=l[1*4+2],o=l[2*4+0],v=l[2*4+1],m=l[2*4+2];return x*(D*m-v*N)-S*(g*m-v*k)+o*(g*N-D*k)}const J=me;function te(l,x,g){const k=g??new u(12),S=l[0],D=l[1],N=l[2],o=l[4],v=l[5],m=l[6],_=l[8],d=l[9],y=l[10],A=x[0],E=x[1],R=x[2],V=x[4],z=x[5],K=x[6],H=x[8],X=x[9],ne=x[10];return k[0]=S*A+o*E+_*R,k[1]=D*A+v*E+d*R,k[2]=N*A+m*E+y*R,k[4]=S*V+o*z+_*K,k[5]=D*V+v*z+d*K,k[6]=N*V+m*z+y*K,k[8]=S*H+o*X+_*ne,k[9]=D*H+v*X+d*ne,k[10]=N*H+m*X+y*ne,k}const Ee=te;function we(l,x,g){const k=g??ie();return l!==k&&(k[0]=l[0],k[1]=l[1],k[2]=l[2],k[4]=l[4],k[5]=l[5],k[6]=l[6]),k[8]=x[0],k[9]=x[1],k[10]=1,k}function tt(l,x){const g=x??e.create();return g[0]=l[8],g[1]=l[9],g}function Fe(l,x,g){const k=g??e.create(),S=x*4;return k[0]=l[S+0],k[1]=l[S+1],k}function $e(l,x,g,k){const S=k===l?l:w(l,k),D=g*4;return S[D+0]=x[0],S[D+1]=x[1],S}function Ne(l,x){const g=x??e.create(),k=l[0],S=l[1],D=l[4],N=l[5];return g[0]=Math.sqrt(k*k+S*S),g[1]=Math.sqrt(D*D+N*N),g}function ze(l,x){const g=x??t.create(),k=l[0],S=l[1],D=l[2],N=l[4],o=l[5],v=l[6],m=l[8],_=l[9],d=l[10];return g[0]=Math.sqrt(k*k+S*S+D*D),g[1]=Math.sqrt(N*N+o*o+v*v),g[2]=Math.sqrt(m*m+_*_+d*d),g}function nt(l,x){const g=x??new u(12);return g[0]=1,g[1]=0,g[2]=0,g[4]=0,g[5]=1,g[6]=0,g[8]=l[0],g[9]=l[1],g[10]=1,g}function Ct(l,x,g){const k=g??new u(12),S=x[0],D=x[1],N=l[0],o=l[1],v=l[2],m=l[1*4+0],_=l[1*4+1],d=l[1*4+2],y=l[2*4+0],A=l[2*4+1],E=l[2*4+2];return l!==k&&(k[0]=N,k[1]=o,k[2]=v,k[4]=m,k[5]=_,k[6]=d),k[8]=N*S+m*D+y,k[9]=o*S+_*D+A,k[10]=v*S+d*D+E,k}function qe(l,x){const g=x??new u(12),k=Math.cos(l),S=Math.sin(l);return g[0]=k,g[1]=S,g[2]=0,g[4]=-S,g[5]=k,g[6]=0,g[8]=0,g[9]=0,g[10]=1,g}function fe(l,x,g){const k=g??new u(12),S=l[0*4+0],D=l[0*4+1],N=l[0*4+2],o=l[1*4+0],v=l[1*4+1],m=l[1*4+2],_=Math.cos(x),d=Math.sin(x);return k[0]=_*S+d*o,k[1]=_*D+d*v,k[2]=_*N+d*m,k[4]=_*o-d*S,k[5]=_*v-d*D,k[6]=_*m-d*N,l!==k&&(k[8]=l[8],k[9]=l[9],k[10]=l[10]),k}function de(l,x){const g=x??new u(12),k=Math.cos(l),S=Math.sin(l);return g[0]=1,g[1]=0,g[2]=0,g[4]=0,g[5]=k,g[6]=S,g[8]=0,g[9]=-S,g[10]=k,g}function he(l,x,g){const k=g??new u(12),S=l[4],D=l[5],N=l[6],o=l[8],v=l[9],m=l[10],_=Math.cos(x),d=Math.sin(x);return k[4]=_*S+d*o,k[5]=_*D+d*v,k[6]=_*N+d*m,k[8]=_*o-d*S,k[9]=_*v-d*D,k[10]=_*m-d*N,l!==k&&(k[0]=l[0],k[1]=l[1],k[2]=l[2]),k}function st(l,x){const g=x??new u(12),k=Math.cos(l),S=Math.sin(l);return g[0]=k,g[1]=0,g[2]=-S,g[4]=0,g[5]=1,g[6]=0,g[8]=S,g[9]=0,g[10]=k,g}function Bt(l,x,g){const k=g??new u(12),S=l[0*4+0],D=l[0*4+1],N=l[0*4+2],o=l[2*4+0],v=l[2*4+1],m=l[2*4+2],_=Math.cos(x),d=Math.sin(x);return k[0]=_*S-d*o,k[1]=_*D-d*v,k[2]=_*N-d*m,k[8]=_*o+d*S,k[9]=_*v+d*D,k[10]=_*m+d*N,l!==k&&(k[4]=l[4],k[5]=l[5],k[6]=l[6]),k}const be=qe,Ut=fe;function ft(l,x){const g=x??new u(12);return g[0]=l[0],g[1]=0,g[2]=0,g[4]=0,g[5]=l[1],g[6]=0,g[8]=0,g[9]=0,g[10]=1,g}function Lt(l,x,g){const k=g??new u(12),S=x[0],D=x[1];return k[0]=S*l[0*4+0],k[1]=S*l[0*4+1],k[2]=S*l[0*4+2],k[4]=D*l[1*4+0],k[5]=D*l[1*4+1],k[6]=D*l[1*4+2],l!==k&&(k[8]=l[8],k[9]=l[9],k[10]=l[10]),k}function dt(l,x){const g=x??new u(12);return g[0]=l[0],g[1]=0,g[2]=0,g[4]=0,g[5]=l[1],g[6]=0,g[8]=0,g[9]=0,g[10]=l[2],g}function Tt(l,x,g){const k=g??new u(12),S=x[0],D=x[1],N=x[2];return k[0]=S*l[0*4+0],k[1]=S*l[0*4+1],k[2]=S*l[0*4+2],k[4]=D*l[1*4+0],k[5]=D*l[1*4+1],k[6]=D*l[1*4+2],k[8]=N*l[2*4+0],k[9]=N*l[2*4+1],k[10]=N*l[2*4+2],k}function Et(l,x){const g=x??new u(12);return g[0]=l,g[1]=0,g[2]=0,g[4]=0,g[5]=l,g[6]=0,g[8]=0,g[9]=0,g[10]=1,g}function L(l,x,g){const k=g??new u(12);return k[0]=x*l[0*4+0],k[1]=x*l[0*4+1],k[2]=x*l[0*4+2],k[4]=x*l[1*4+0],k[5]=x*l[1*4+1],k[6]=x*l[1*4+2],l!==k&&(k[8]=l[8],k[9]=l[9],k[10]=l[10]),k}function q(l,x){const g=x??new u(12);return g[0]=l,g[1]=0,g[2]=0,g[4]=0,g[5]=l,g[6]=0,g[8]=0,g[9]=0,g[10]=l,g}function I(l,x,g){const k=g??new u(12);return k[0]=x*l[0*4+0],k[1]=x*l[0*4+1],k[2]=x*l[0*4+2],k[4]=x*l[1*4+0],k[5]=x*l[1*4+1],k[6]=x*l[1*4+2],k[8]=x*l[2*4+0],k[9]=x*l[2*4+1],k[10]=x*l[2*4+2],k}return{add:f,clone:B,copy:w,create:n,determinant:xe,equals:Z,equalsApproximately:F,fromMat4:r,fromQuat:a,get3DScaling:ze,getAxis:Fe,getScaling:Ne,getTranslation:tt,identity:ie,inverse:me,invert:J,mul:Ee,mulScalar:h,multiply:te,multiplyScalar:c,negate:i,rotate:fe,rotateX:he,rotateY:Bt,rotateZ:Ut,rotation:qe,rotationX:de,rotationY:st,rotationZ:be,scale:Lt,scale3D:Tt,scaling:ft,scaling3D:dt,set:s,setAxis:$e,setTranslation:we,translate:Ct,translation:nt,transpose:ae,uniformScale:L,uniformScale3D:I,uniformScaling:Et,uniformScaling3D:q}}const fi=new Map;function so(u){let e=fi.get(u);return e||(e=no(u),fi.set(u,e)),e}function ro(u){const e=or(u);function t(o,v,m,_,d,y,A,E,R,V,z,K,H,X,ne,ce){const se=new u(16);return o!==void 0&&(se[0]=o,v!==void 0&&(se[1]=v,m!==void 0&&(se[2]=m,_!==void 0&&(se[3]=_,d!==void 0&&(se[4]=d,y!==void 0&&(se[5]=y,A!==void 0&&(se[6]=A,E!==void 0&&(se[7]=E,R!==void 0&&(se[8]=R,V!==void 0&&(se[9]=V,z!==void 0&&(se[10]=z,K!==void 0&&(se[11]=K,H!==void 0&&(se[12]=H,X!==void 0&&(se[13]=X,ne!==void 0&&(se[14]=ne,ce!==void 0&&(se[15]=ce)))))))))))))))),se}function n(o,v,m,_,d,y,A,E,R,V,z,K,H,X,ne,ce,se){const re=se??new u(16);return re[0]=o,re[1]=v,re[2]=m,re[3]=_,re[4]=d,re[5]=y,re[6]=A,re[7]=E,re[8]=R,re[9]=V,re[10]=z,re[11]=K,re[12]=H,re[13]=X,re[14]=ne,re[15]=ce,re}function s(o,v){const m=v??new u(16);return m[0]=o[0],m[1]=o[1],m[2]=o[2],m[3]=0,m[4]=o[4],m[5]=o[5],m[6]=o[6],m[7]=0,m[8]=o[8],m[9]=o[9],m[10]=o[10],m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,m}function r(o,v){const m=v??new u(16),_=o[0],d=o[1],y=o[2],A=o[3],E=_+_,R=d+d,V=y+y,z=_*E,K=d*E,H=d*R,X=y*E,ne=y*R,ce=y*V,se=A*E,re=A*R,_e=A*V;return m[0]=1-H-ce,m[1]=K+_e,m[2]=X-re,m[3]=0,m[4]=K-_e,m[5]=1-z-ce,m[6]=ne+se,m[7]=0,m[8]=X+re,m[9]=ne-se,m[10]=1-z-H,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,m}function a(o,v){const m=v??new u(16);return m[0]=-o[0],m[1]=-o[1],m[2]=-o[2],m[3]=-o[3],m[4]=-o[4],m[5]=-o[5],m[6]=-o[6],m[7]=-o[7],m[8]=-o[8],m[9]=-o[9],m[10]=-o[10],m[11]=-o[11],m[12]=-o[12],m[13]=-o[13],m[14]=-o[14],m[15]=-o[15],m}function i(o,v,m){const _=m??new u(16);return _[0]=o[0]+v[0],_[1]=o[1]+v[1],_[2]=o[2]+v[2],_[3]=o[3]+v[3],_[4]=o[4]+v[4],_[5]=o[5]+v[5],_[6]=o[6]+v[6],_[7]=o[7]+v[7],_[8]=o[8]+v[8],_[9]=o[9]+v[9],_[10]=o[10]+v[10],_[11]=o[11]+v[11],_[12]=o[12]+v[12],_[13]=o[13]+v[13],_[14]=o[14]+v[14],_[15]=o[15]+v[15],_}function c(o,v,m){const _=m??new u(16);return _[0]=o[0]*v,_[1]=o[1]*v,_[2]=o[2]*v,_[3]=o[3]*v,_[4]=o[4]*v,_[5]=o[5]*v,_[6]=o[6]*v,_[7]=o[7]*v,_[8]=o[8]*v,_[9]=o[9]*v,_[10]=o[10]*v,_[11]=o[11]*v,_[12]=o[12]*v,_[13]=o[13]*v,_[14]=o[14]*v,_[15]=o[15]*v,_}const h=c;function f(o,v){const m=v??new u(16);return m[0]=o[0],m[1]=o[1],m[2]=o[2],m[3]=o[3],m[4]=o[4],m[5]=o[5],m[6]=o[6],m[7]=o[7],m[8]=o[8],m[9]=o[9],m[10]=o[10],m[11]=o[11],m[12]=o[12],m[13]=o[13],m[14]=o[14],m[15]=o[15],m}const w=f;function B(o,v){return Math.abs(o[0]-v[0])<le&&Math.abs(o[1]-v[1])<le&&Math.abs(o[2]-v[2])<le&&Math.abs(o[3]-v[3])<le&&Math.abs(o[4]-v[4])<le&&Math.abs(o[5]-v[5])<le&&Math.abs(o[6]-v[6])<le&&Math.abs(o[7]-v[7])<le&&Math.abs(o[8]-v[8])<le&&Math.abs(o[9]-v[9])<le&&Math.abs(o[10]-v[10])<le&&Math.abs(o[11]-v[11])<le&&Math.abs(o[12]-v[12])<le&&Math.abs(o[13]-v[13])<le&&Math.abs(o[14]-v[14])<le&&Math.abs(o[15]-v[15])<le}function F(o,v){return o[0]===v[0]&&o[1]===v[1]&&o[2]===v[2]&&o[3]===v[3]&&o[4]===v[4]&&o[5]===v[5]&&o[6]===v[6]&&o[7]===v[7]&&o[8]===v[8]&&o[9]===v[9]&&o[10]===v[10]&&o[11]===v[11]&&o[12]===v[12]&&o[13]===v[13]&&o[14]===v[14]&&o[15]===v[15]}function Z(o){const v=o??new u(16);return v[0]=1,v[1]=0,v[2]=0,v[3]=0,v[4]=0,v[5]=1,v[6]=0,v[7]=0,v[8]=0,v[9]=0,v[10]=1,v[11]=0,v[12]=0,v[13]=0,v[14]=0,v[15]=1,v}function ie(o,v){const m=v??new u(16);if(m===o){let pe;return pe=o[1],o[1]=o[4],o[4]=pe,pe=o[2],o[2]=o[8],o[8]=pe,pe=o[3],o[3]=o[12],o[12]=pe,pe=o[6],o[6]=o[9],o[9]=pe,pe=o[7],o[7]=o[13],o[13]=pe,pe=o[11],o[11]=o[14],o[14]=pe,m}const _=o[0*4+0],d=o[0*4+1],y=o[0*4+2],A=o[0*4+3],E=o[1*4+0],R=o[1*4+1],V=o[1*4+2],z=o[1*4+3],K=o[2*4+0],H=o[2*4+1],X=o[2*4+2],ne=o[2*4+3],ce=o[3*4+0],se=o[3*4+1],re=o[3*4+2],_e=o[3*4+3];return m[0]=_,m[1]=E,m[2]=K,m[3]=ce,m[4]=d,m[5]=R,m[6]=H,m[7]=se,m[8]=y,m[9]=V,m[10]=X,m[11]=re,m[12]=A,m[13]=z,m[14]=ne,m[15]=_e,m}function ae(o,v){const m=v??new u(16),_=o[0*4+0],d=o[0*4+1],y=o[0*4+2],A=o[0*4+3],E=o[1*4+0],R=o[1*4+1],V=o[1*4+2],z=o[1*4+3],K=o[2*4+0],H=o[2*4+1],X=o[2*4+2],ne=o[2*4+3],ce=o[3*4+0],se=o[3*4+1],re=o[3*4+2],_e=o[3*4+3],pe=X*_e,Ce=re*ne,Be=V*_e,Ue=re*z,Ge=V*ne,We=X*z,He=y*_e,Xe=re*A,Ye=y*ne,Qe=X*A,rt=y*z,it=V*A,at=K*se,ot=ce*H,_t=E*se,yt=ce*R,xt=E*H,Fs=K*R,$s=_*se,Vs=ce*d,Gs=_*H,zs=K*d,qs=_*R,Ws=E*d,$r=pe*R+Ue*H+Ge*se-(Ce*R+Be*H+We*se),Vr=Ce*d+He*H+Qe*se-(pe*d+Xe*H+Ye*se),Gr=Be*d+Xe*R+rt*se-(Ue*d+He*R+it*se),zr=We*d+Ye*R+it*H-(Ge*d+Qe*R+rt*H),je=1/(_*$r+E*Vr+K*Gr+ce*zr);return m[0]=je*$r,m[1]=je*Vr,m[2]=je*Gr,m[3]=je*zr,m[4]=je*(Ce*E+Be*K+We*ce-(pe*E+Ue*K+Ge*ce)),m[5]=je*(pe*_+Xe*K+Ye*ce-(Ce*_+He*K+Qe*ce)),m[6]=je*(Ue*_+He*E+it*ce-(Be*_+Xe*E+rt*ce)),m[7]=je*(Ge*_+Qe*E+rt*K-(We*_+Ye*E+it*K)),m[8]=je*(at*z+yt*ne+xt*_e-(ot*z+_t*ne+Fs*_e)),m[9]=je*(ot*A+$s*ne+zs*_e-(at*A+Vs*ne+Gs*_e)),m[10]=je*(_t*A+Vs*z+qs*_e-(yt*A+$s*z+Ws*_e)),m[11]=je*(Fs*A+Gs*z+Ws*ne-(xt*A+zs*z+qs*ne)),m[12]=je*(_t*X+Fs*re+ot*V-(xt*re+at*V+yt*X)),m[13]=je*(Gs*re+at*y+Vs*X-($s*X+zs*re+ot*y)),m[14]=je*($s*V+Ws*re+yt*y-(qs*re+_t*y+Vs*V)),m[15]=je*(qs*X+xt*y+zs*V-(Gs*V+Ws*X+Fs*y)),m}function me(o){const v=o[0],m=o[0*4+1],_=o[0*4+2],d=o[0*4+3],y=o[1*4+0],A=o[1*4+1],E=o[1*4+2],R=o[1*4+3],V=o[2*4+0],z=o[2*4+1],K=o[2*4+2],H=o[2*4+3],X=o[3*4+0],ne=o[3*4+1],ce=o[3*4+2],se=o[3*4+3],re=K*se,_e=ce*H,pe=E*se,Ce=ce*R,Be=E*H,Ue=K*R,Ge=_*se,We=ce*d,He=_*H,Xe=K*d,Ye=_*R,Qe=E*d,rt=re*A+Ce*z+Be*ne-(_e*A+pe*z+Ue*ne),it=_e*m+Ge*z+Xe*ne-(re*m+We*z+He*ne),at=pe*m+We*A+Ye*ne-(Ce*m+Ge*A+Qe*ne),ot=Ue*m+He*A+Qe*z-(Be*m+Xe*A+Ye*z);return v*rt+y*it+V*at+X*ot}const xe=ae;function J(o,v,m){const _=m??new u(16),d=o[0],y=o[1],A=o[2],E=o[3],R=o[4],V=o[5],z=o[6],K=o[7],H=o[8],X=o[9],ne=o[10],ce=o[11],se=o[12],re=o[13],_e=o[14],pe=o[15],Ce=v[0],Be=v[1],Ue=v[2],Ge=v[3],We=v[4],He=v[5],Xe=v[6],Ye=v[7],Qe=v[8],rt=v[9],it=v[10],at=v[11],ot=v[12],_t=v[13],yt=v[14],xt=v[15];return _[0]=d*Ce+R*Be+H*Ue+se*Ge,_[1]=y*Ce+V*Be+X*Ue+re*Ge,_[2]=A*Ce+z*Be+ne*Ue+_e*Ge,_[3]=E*Ce+K*Be+ce*Ue+pe*Ge,_[4]=d*We+R*He+H*Xe+se*Ye,_[5]=y*We+V*He+X*Xe+re*Ye,_[6]=A*We+z*He+ne*Xe+_e*Ye,_[7]=E*We+K*He+ce*Xe+pe*Ye,_[8]=d*Qe+R*rt+H*it+se*at,_[9]=y*Qe+V*rt+X*it+re*at,_[10]=A*Qe+z*rt+ne*it+_e*at,_[11]=E*Qe+K*rt+ce*it+pe*at,_[12]=d*ot+R*_t+H*yt+se*xt,_[13]=y*ot+V*_t+X*yt+re*xt,_[14]=A*ot+z*_t+ne*yt+_e*xt,_[15]=E*ot+K*_t+ce*yt+pe*xt,_}const te=J;function Ee(o,v,m){const _=m??Z();return o!==_&&(_[0]=o[0],_[1]=o[1],_[2]=o[2],_[3]=o[3],_[4]=o[4],_[5]=o[5],_[6]=o[6],_[7]=o[7],_[8]=o[8],_[9]=o[9],_[10]=o[10],_[11]=o[11]),_[12]=v[0],_[13]=v[1],_[14]=v[2],_[15]=1,_}function we(o,v){const m=v??e.create();return m[0]=o[12],m[1]=o[13],m[2]=o[14],m}function tt(o,v,m){const _=m??e.create(),d=v*4;return _[0]=o[d+0],_[1]=o[d+1],_[2]=o[d+2],_}function Fe(o,v,m,_){const d=_===o?_:f(o,_),y=m*4;return d[y+0]=v[0],d[y+1]=v[1],d[y+2]=v[2],d}function $e(o,v){const m=v??e.create(),_=o[0],d=o[1],y=o[2],A=o[4],E=o[5],R=o[6],V=o[8],z=o[9],K=o[10];return m[0]=Math.sqrt(_*_+d*d+y*y),m[1]=Math.sqrt(A*A+E*E+R*R),m[2]=Math.sqrt(V*V+z*z+K*K),m}function Ne(o,v,m,_,d){const y=d??new u(16),A=Math.tan(Math.PI*.5-.5*o);if(y[0]=A/v,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=A,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,Number.isFinite(_)){const E=1/(m-_);y[10]=_*E,y[14]=_*m*E}else y[10]=-1,y[14]=-m;return y}function ze(o,v,m,_=1/0,d){const y=d??new u(16),A=1/Math.tan(o*.5);if(y[0]=A/v,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=A,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,_===1/0)y[10]=0,y[14]=m;else{const E=1/(_-m);y[10]=m*E,y[14]=_*m*E}return y}function nt(o,v,m,_,d,y,A){const E=A??new u(16);return E[0]=2/(v-o),E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[5]=2/(_-m),E[6]=0,E[7]=0,E[8]=0,E[9]=0,E[10]=1/(d-y),E[11]=0,E[12]=(v+o)/(o-v),E[13]=(_+m)/(m-_),E[14]=d/(d-y),E[15]=1,E}function Ct(o,v,m,_,d,y,A){const E=A??new u(16),R=v-o,V=_-m,z=d-y;return E[0]=2*d/R,E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[5]=2*d/V,E[6]=0,E[7]=0,E[8]=(o+v)/R,E[9]=(_+m)/V,E[10]=y/z,E[11]=-1,E[12]=0,E[13]=0,E[14]=d*y/z,E[15]=0,E}function qe(o,v,m,_,d,y=1/0,A){const E=A??new u(16),R=v-o,V=_-m;if(E[0]=2*d/R,E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[5]=2*d/V,E[6]=0,E[7]=0,E[8]=(o+v)/R,E[9]=(_+m)/V,E[11]=-1,E[12]=0,E[13]=0,E[15]=0,y===1/0)E[10]=0,E[14]=d;else{const z=1/(y-d);E[10]=d*z,E[14]=y*d*z}return E}const fe=e.create(),de=e.create(),he=e.create();function st(o,v,m,_){const d=_??new u(16);return e.normalize(e.subtract(v,o,he),he),e.normalize(e.cross(m,he,fe),fe),e.normalize(e.cross(he,fe,de),de),d[0]=fe[0],d[1]=fe[1],d[2]=fe[2],d[3]=0,d[4]=de[0],d[5]=de[1],d[6]=de[2],d[7]=0,d[8]=he[0],d[9]=he[1],d[10]=he[2],d[11]=0,d[12]=o[0],d[13]=o[1],d[14]=o[2],d[15]=1,d}function Bt(o,v,m,_){const d=_??new u(16);return e.normalize(e.subtract(o,v,he),he),e.normalize(e.cross(m,he,fe),fe),e.normalize(e.cross(he,fe,de),de),d[0]=fe[0],d[1]=fe[1],d[2]=fe[2],d[3]=0,d[4]=de[0],d[5]=de[1],d[6]=de[2],d[7]=0,d[8]=he[0],d[9]=he[1],d[10]=he[2],d[11]=0,d[12]=o[0],d[13]=o[1],d[14]=o[2],d[15]=1,d}function be(o,v,m,_){const d=_??new u(16);return e.normalize(e.subtract(o,v,he),he),e.normalize(e.cross(m,he,fe),fe),e.normalize(e.cross(he,fe,de),de),d[0]=fe[0],d[1]=de[0],d[2]=he[0],d[3]=0,d[4]=fe[1],d[5]=de[1],d[6]=he[1],d[7]=0,d[8]=fe[2],d[9]=de[2],d[10]=he[2],d[11]=0,d[12]=-(fe[0]*o[0]+fe[1]*o[1]+fe[2]*o[2]),d[13]=-(de[0]*o[0]+de[1]*o[1]+de[2]*o[2]),d[14]=-(he[0]*o[0]+he[1]*o[1]+he[2]*o[2]),d[15]=1,d}function Ut(o,v){const m=v??new u(16);return m[0]=1,m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=1,m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=1,m[11]=0,m[12]=o[0],m[13]=o[1],m[14]=o[2],m[15]=1,m}function ft(o,v,m){const _=m??new u(16),d=v[0],y=v[1],A=v[2],E=o[0],R=o[1],V=o[2],z=o[3],K=o[1*4+0],H=o[1*4+1],X=o[1*4+2],ne=o[1*4+3],ce=o[2*4+0],se=o[2*4+1],re=o[2*4+2],_e=o[2*4+3],pe=o[3*4+0],Ce=o[3*4+1],Be=o[3*4+2],Ue=o[3*4+3];return o!==_&&(_[0]=E,_[1]=R,_[2]=V,_[3]=z,_[4]=K,_[5]=H,_[6]=X,_[7]=ne,_[8]=ce,_[9]=se,_[10]=re,_[11]=_e),_[12]=E*d+K*y+ce*A+pe,_[13]=R*d+H*y+se*A+Ce,_[14]=V*d+X*y+re*A+Be,_[15]=z*d+ne*y+_e*A+Ue,_}function Lt(o,v){const m=v??new u(16),_=Math.cos(o),d=Math.sin(o);return m[0]=1,m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=_,m[6]=d,m[7]=0,m[8]=0,m[9]=-d,m[10]=_,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,m}function dt(o,v,m){const _=m??new u(16),d=o[4],y=o[5],A=o[6],E=o[7],R=o[8],V=o[9],z=o[10],K=o[11],H=Math.cos(v),X=Math.sin(v);return _[4]=H*d+X*R,_[5]=H*y+X*V,_[6]=H*A+X*z,_[7]=H*E+X*K,_[8]=H*R-X*d,_[9]=H*V-X*y,_[10]=H*z-X*A,_[11]=H*K-X*E,o!==_&&(_[0]=o[0],_[1]=o[1],_[2]=o[2],_[3]=o[3],_[12]=o[12],_[13]=o[13],_[14]=o[14],_[15]=o[15]),_}function Tt(o,v){const m=v??new u(16),_=Math.cos(o),d=Math.sin(o);return m[0]=_,m[1]=0,m[2]=-d,m[3]=0,m[4]=0,m[5]=1,m[6]=0,m[7]=0,m[8]=d,m[9]=0,m[10]=_,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,m}function Et(o,v,m){const _=m??new u(16),d=o[0*4+0],y=o[0*4+1],A=o[0*4+2],E=o[0*4+3],R=o[2*4+0],V=o[2*4+1],z=o[2*4+2],K=o[2*4+3],H=Math.cos(v),X=Math.sin(v);return _[0]=H*d-X*R,_[1]=H*y-X*V,_[2]=H*A-X*z,_[3]=H*E-X*K,_[8]=H*R+X*d,_[9]=H*V+X*y,_[10]=H*z+X*A,_[11]=H*K+X*E,o!==_&&(_[4]=o[4],_[5]=o[5],_[6]=o[6],_[7]=o[7],_[12]=o[12],_[13]=o[13],_[14]=o[14],_[15]=o[15]),_}function L(o,v){const m=v??new u(16),_=Math.cos(o),d=Math.sin(o);return m[0]=_,m[1]=d,m[2]=0,m[3]=0,m[4]=-d,m[5]=_,m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=1,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,m}function q(o,v,m){const _=m??new u(16),d=o[0*4+0],y=o[0*4+1],A=o[0*4+2],E=o[0*4+3],R=o[1*4+0],V=o[1*4+1],z=o[1*4+2],K=o[1*4+3],H=Math.cos(v),X=Math.sin(v);return _[0]=H*d+X*R,_[1]=H*y+X*V,_[2]=H*A+X*z,_[3]=H*E+X*K,_[4]=H*R-X*d,_[5]=H*V-X*y,_[6]=H*z-X*A,_[7]=H*K-X*E,o!==_&&(_[8]=o[8],_[9]=o[9],_[10]=o[10],_[11]=o[11],_[12]=o[12],_[13]=o[13],_[14]=o[14],_[15]=o[15]),_}function I(o,v,m){const _=m??new u(16);let d=o[0],y=o[1],A=o[2];const E=Math.sqrt(d*d+y*y+A*A);d/=E,y/=E,A/=E;const R=d*d,V=y*y,z=A*A,K=Math.cos(v),H=Math.sin(v),X=1-K;return _[0]=R+(1-R)*K,_[1]=d*y*X+A*H,_[2]=d*A*X-y*H,_[3]=0,_[4]=d*y*X-A*H,_[5]=V+(1-V)*K,_[6]=y*A*X+d*H,_[7]=0,_[8]=d*A*X+y*H,_[9]=y*A*X-d*H,_[10]=z+(1-z)*K,_[11]=0,_[12]=0,_[13]=0,_[14]=0,_[15]=1,_}const l=I;function x(o,v,m,_){const d=_??new u(16);let y=v[0],A=v[1],E=v[2];const R=Math.sqrt(y*y+A*A+E*E);y/=R,A/=R,E/=R;const V=y*y,z=A*A,K=E*E,H=Math.cos(m),X=Math.sin(m),ne=1-H,ce=V+(1-V)*H,se=y*A*ne+E*X,re=y*E*ne-A*X,_e=y*A*ne-E*X,pe=z+(1-z)*H,Ce=A*E*ne+y*X,Be=y*E*ne+A*X,Ue=A*E*ne-y*X,Ge=K+(1-K)*H,We=o[0],He=o[1],Xe=o[2],Ye=o[3],Qe=o[4],rt=o[5],it=o[6],at=o[7],ot=o[8],_t=o[9],yt=o[10],xt=o[11];return d[0]=ce*We+se*Qe+re*ot,d[1]=ce*He+se*rt+re*_t,d[2]=ce*Xe+se*it+re*yt,d[3]=ce*Ye+se*at+re*xt,d[4]=_e*We+pe*Qe+Ce*ot,d[5]=_e*He+pe*rt+Ce*_t,d[6]=_e*Xe+pe*it+Ce*yt,d[7]=_e*Ye+pe*at+Ce*xt,d[8]=Be*We+Ue*Qe+Ge*ot,d[9]=Be*He+Ue*rt+Ge*_t,d[10]=Be*Xe+Ue*it+Ge*yt,d[11]=Be*Ye+Ue*at+Ge*xt,o!==d&&(d[12]=o[12],d[13]=o[13],d[14]=o[14],d[15]=o[15]),d}const g=x;function k(o,v){const m=v??new u(16);return m[0]=o[0],m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=o[1],m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=o[2],m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,m}function S(o,v,m){const _=m??new u(16),d=v[0],y=v[1],A=v[2];return _[0]=d*o[0*4+0],_[1]=d*o[0*4+1],_[2]=d*o[0*4+2],_[3]=d*o[0*4+3],_[4]=y*o[1*4+0],_[5]=y*o[1*4+1],_[6]=y*o[1*4+2],_[7]=y*o[1*4+3],_[8]=A*o[2*4+0],_[9]=A*o[2*4+1],_[10]=A*o[2*4+2],_[11]=A*o[2*4+3],o!==_&&(_[12]=o[12],_[13]=o[13],_[14]=o[14],_[15]=o[15]),_}function D(o,v){const m=v??new u(16);return m[0]=o,m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=o,m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=o,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,m}function N(o,v,m){const _=m??new u(16);return _[0]=v*o[0*4+0],_[1]=v*o[0*4+1],_[2]=v*o[0*4+2],_[3]=v*o[0*4+3],_[4]=v*o[1*4+0],_[5]=v*o[1*4+1],_[6]=v*o[1*4+2],_[7]=v*o[1*4+3],_[8]=v*o[2*4+0],_[9]=v*o[2*4+1],_[10]=v*o[2*4+2],_[11]=v*o[2*4+3],o!==_&&(_[12]=o[12],_[13]=o[13],_[14]=o[14],_[15]=o[15]),_}return{add:i,aim:st,axisRotate:x,axisRotation:I,cameraAim:Bt,clone:w,copy:f,create:t,determinant:me,equals:F,equalsApproximately:B,fromMat3:s,fromQuat:r,frustum:Ct,frustumReverseZ:qe,getAxis:tt,getScaling:$e,getTranslation:we,identity:Z,inverse:ae,invert:xe,lookAt:be,mul:te,mulScalar:h,multiply:J,multiplyScalar:c,negate:a,ortho:nt,perspective:Ne,perspectiveReverseZ:ze,rotate:g,rotateX:dt,rotateY:Et,rotateZ:q,rotation:l,rotationX:Lt,rotationY:Tt,rotationZ:L,scale:S,scaling:k,set:n,setAxis:Fe,setTranslation:Ee,translate:ft,translation:Ut,transpose:ie,uniformScale:N,uniformScaling:D}}const di=new Map;function io(u){let e=di.get(u);return e||(e=ro(u),di.set(u,e)),e}function ao(u){const e=or(u);function t(L,q,I,l){const x=new u(4);return L!==void 0&&(x[0]=L,q!==void 0&&(x[1]=q,I!==void 0&&(x[2]=I,l!==void 0&&(x[3]=l)))),x}const n=t;function s(L,q,I,l,x){const g=x??new u(4);return g[0]=L,g[1]=q,g[2]=I,g[3]=l,g}function r(L,q,I){const l=I??new u(4),x=q*.5,g=Math.sin(x);return l[0]=g*L[0],l[1]=g*L[1],l[2]=g*L[2],l[3]=Math.cos(x),l}function a(L,q){const I=q??e.create(3),l=Math.acos(L[3])*2,x=Math.sin(l*.5);return x>le?(I[0]=L[0]/x,I[1]=L[1]/x,I[2]=L[2]/x):(I[0]=1,I[1]=0,I[2]=0),{angle:l,axis:I}}function i(L,q){const I=Ne(L,q);return Math.acos(2*I*I-1)}function c(L,q,I){const l=I??new u(4),x=L[0],g=L[1],k=L[2],S=L[3],D=q[0],N=q[1],o=q[2],v=q[3];return l[0]=x*v+S*D+g*o-k*N,l[1]=g*v+S*N+k*D-x*o,l[2]=k*v+S*o+x*N-g*D,l[3]=S*v-x*D-g*N-k*o,l}const h=c;function f(L,q,I){const l=I??new u(4),x=q*.5,g=L[0],k=L[1],S=L[2],D=L[3],N=Math.sin(x),o=Math.cos(x);return l[0]=g*o+D*N,l[1]=k*o+S*N,l[2]=S*o-k*N,l[3]=D*o-g*N,l}function w(L,q,I){const l=I??new u(4),x=q*.5,g=L[0],k=L[1],S=L[2],D=L[3],N=Math.sin(x),o=Math.cos(x);return l[0]=g*o-S*N,l[1]=k*o+D*N,l[2]=S*o+g*N,l[3]=D*o-k*N,l}function B(L,q,I){const l=I??new u(4),x=q*.5,g=L[0],k=L[1],S=L[2],D=L[3],N=Math.sin(x),o=Math.cos(x);return l[0]=g*o+k*N,l[1]=k*o-g*N,l[2]=S*o+D*N,l[3]=D*o-S*N,l}function F(L,q,I,l){const x=l??new u(4),g=L[0],k=L[1],S=L[2],D=L[3];let N=q[0],o=q[1],v=q[2],m=q[3],_=g*N+k*o+S*v+D*m;_<0&&(_=-_,N=-N,o=-o,v=-v,m=-m);let d,y;if(1-_>le){const A=Math.acos(_),E=Math.sin(A);d=Math.sin((1-I)*A)/E,y=Math.sin(I*A)/E}else d=1-I,y=I;return x[0]=d*g+y*N,x[1]=d*k+y*o,x[2]=d*S+y*v,x[3]=d*D+y*m,x}function Z(L,q){const I=q??new u(4),l=L[0],x=L[1],g=L[2],k=L[3],S=l*l+x*x+g*g+k*k,D=S?1/S:0;return I[0]=-l*D,I[1]=-x*D,I[2]=-g*D,I[3]=k*D,I}function ie(L,q){const I=q??new u(4);return I[0]=-L[0],I[1]=-L[1],I[2]=-L[2],I[3]=L[3],I}function ae(L,q){const I=q??new u(4),l=L[0]+L[5]+L[10];if(l>0){const x=Math.sqrt(l+1);I[3]=.5*x;const g=.5/x;I[0]=(L[6]-L[9])*g,I[1]=(L[8]-L[2])*g,I[2]=(L[1]-L[4])*g}else{let x=0;L[5]>L[0]&&(x=1),L[10]>L[x*4+x]&&(x=2);const g=(x+1)%3,k=(x+2)%3,S=Math.sqrt(L[x*4+x]-L[g*4+g]-L[k*4+k]+1);I[x]=.5*S;const D=.5/S;I[3]=(L[g*4+k]-L[k*4+g])*D,I[g]=(L[g*4+x]+L[x*4+g])*D,I[k]=(L[k*4+x]+L[x*4+k])*D}return I}function me(L,q,I,l,x){const g=x??new u(4),k=L*.5,S=q*.5,D=I*.5,N=Math.sin(k),o=Math.cos(k),v=Math.sin(S),m=Math.cos(S),_=Math.sin(D),d=Math.cos(D);switch(l){case"xyz":g[0]=N*m*d+o*v*_,g[1]=o*v*d-N*m*_,g[2]=o*m*_+N*v*d,g[3]=o*m*d-N*v*_;break;case"xzy":g[0]=N*m*d-o*v*_,g[1]=o*v*d-N*m*_,g[2]=o*m*_+N*v*d,g[3]=o*m*d+N*v*_;break;case"yxz":g[0]=N*m*d+o*v*_,g[1]=o*v*d-N*m*_,g[2]=o*m*_-N*v*d,g[3]=o*m*d+N*v*_;break;case"yzx":g[0]=N*m*d+o*v*_,g[1]=o*v*d+N*m*_,g[2]=o*m*_-N*v*d,g[3]=o*m*d-N*v*_;break;case"zxy":g[0]=N*m*d-o*v*_,g[1]=o*v*d+N*m*_,g[2]=o*m*_+N*v*d,g[3]=o*m*d-N*v*_;break;case"zyx":g[0]=N*m*d-o*v*_,g[1]=o*v*d+N*m*_,g[2]=o*m*_-N*v*d,g[3]=o*m*d+N*v*_;break;default:throw new Error(`Unknown rotation order: ${l}`)}return g}function xe(L,q){const I=q??new u(4);return I[0]=L[0],I[1]=L[1],I[2]=L[2],I[3]=L[3],I}const J=xe;function te(L,q,I){const l=I??new u(4);return l[0]=L[0]+q[0],l[1]=L[1]+q[1],l[2]=L[2]+q[2],l[3]=L[3]+q[3],l}function Ee(L,q,I){const l=I??new u(4);return l[0]=L[0]-q[0],l[1]=L[1]-q[1],l[2]=L[2]-q[2],l[3]=L[3]-q[3],l}const we=Ee;function tt(L,q,I){const l=I??new u(4);return l[0]=L[0]*q,l[1]=L[1]*q,l[2]=L[2]*q,l[3]=L[3]*q,l}const Fe=tt;function $e(L,q,I){const l=I??new u(4);return l[0]=L[0]/q,l[1]=L[1]/q,l[2]=L[2]/q,l[3]=L[3]/q,l}function Ne(L,q){return L[0]*q[0]+L[1]*q[1]+L[2]*q[2]+L[3]*q[3]}function ze(L,q,I,l){const x=l??new u(4);return x[0]=L[0]+I*(q[0]-L[0]),x[1]=L[1]+I*(q[1]-L[1]),x[2]=L[2]+I*(q[2]-L[2]),x[3]=L[3]+I*(q[3]-L[3]),x}function nt(L){const q=L[0],I=L[1],l=L[2],x=L[3];return Math.sqrt(q*q+I*I+l*l+x*x)}const Ct=nt;function qe(L){const q=L[0],I=L[1],l=L[2],x=L[3];return q*q+I*I+l*l+x*x}const fe=qe;function de(L,q){const I=q??new u(4),l=L[0],x=L[1],g=L[2],k=L[3],S=Math.sqrt(l*l+x*x+g*g+k*k);return S>1e-5?(I[0]=l/S,I[1]=x/S,I[2]=g/S,I[3]=k/S):(I[0]=0,I[1]=0,I[2]=0,I[3]=1),I}function he(L,q){return Math.abs(L[0]-q[0])<le&&Math.abs(L[1]-q[1])<le&&Math.abs(L[2]-q[2])<le&&Math.abs(L[3]-q[3])<le}function st(L,q){return L[0]===q[0]&&L[1]===q[1]&&L[2]===q[2]&&L[3]===q[3]}function Bt(L){const q=L??new u(4);return q[0]=0,q[1]=0,q[2]=0,q[3]=1,q}const be=e.create(),Ut=e.create(),ft=e.create();function Lt(L,q,I){const l=I??new u(4),x=e.dot(L,q);return x<-.999999?(e.cross(Ut,L,be),e.len(be)<1e-6&&e.cross(ft,L,be),e.normalize(be,be),r(be,Math.PI,l),l):x>.999999?(l[0]=0,l[1]=0,l[2]=0,l[3]=1,l):(e.cross(L,q,be),l[0]=be[0],l[1]=be[1],l[2]=be[2],l[3]=1+x,de(l,l))}const dt=new u(4),Tt=new u(4);function Et(L,q,I,l,x,g){const k=g??new u(4);return F(L,l,x,dt),F(q,I,x,Tt),F(dt,Tt,2*x*(1-x),k),k}return{create:t,fromValues:n,set:s,fromAxisAngle:r,toAxisAngle:a,angle:i,multiply:c,mul:h,rotateX:f,rotateY:w,rotateZ:B,slerp:F,inverse:Z,conjugate:ie,fromMat:ae,fromEuler:me,copy:xe,clone:J,add:te,subtract:Ee,sub:we,mulScalar:tt,scale:Fe,divScalar:$e,dot:Ne,lerp:ze,length:nt,len:Ct,lengthSq:qe,lenSq:fe,normalize:de,equalsApproximately:he,equals:st,identity:Bt,rotationTo:Lt,sqlerp:Et}}const pi=new Map;function oo(u){let e=pi.get(u);return e||(e=ao(u),pi.set(u,e)),e}function co(u){function e(I,l,x,g){const k=new u(4);return I!==void 0&&(k[0]=I,l!==void 0&&(k[1]=l,x!==void 0&&(k[2]=x,g!==void 0&&(k[3]=g)))),k}const t=e;function n(I,l,x,g,k){const S=k??new u(4);return S[0]=I,S[1]=l,S[2]=x,S[3]=g,S}function s(I,l){const x=l??new u(4);return x[0]=Math.ceil(I[0]),x[1]=Math.ceil(I[1]),x[2]=Math.ceil(I[2]),x[3]=Math.ceil(I[3]),x}function r(I,l){const x=l??new u(4);return x[0]=Math.floor(I[0]),x[1]=Math.floor(I[1]),x[2]=Math.floor(I[2]),x[3]=Math.floor(I[3]),x}function a(I,l){const x=l??new u(4);return x[0]=Math.round(I[0]),x[1]=Math.round(I[1]),x[2]=Math.round(I[2]),x[3]=Math.round(I[3]),x}function i(I,l=0,x=1,g){const k=g??new u(4);return k[0]=Math.min(x,Math.max(l,I[0])),k[1]=Math.min(x,Math.max(l,I[1])),k[2]=Math.min(x,Math.max(l,I[2])),k[3]=Math.min(x,Math.max(l,I[3])),k}function c(I,l,x){const g=x??new u(4);return g[0]=I[0]+l[0],g[1]=I[1]+l[1],g[2]=I[2]+l[2],g[3]=I[3]+l[3],g}function h(I,l,x,g){const k=g??new u(4);return k[0]=I[0]+l[0]*x,k[1]=I[1]+l[1]*x,k[2]=I[2]+l[2]*x,k[3]=I[3]+l[3]*x,k}function f(I,l,x){const g=x??new u(4);return g[0]=I[0]-l[0],g[1]=I[1]-l[1],g[2]=I[2]-l[2],g[3]=I[3]-l[3],g}const w=f;function B(I,l){return Math.abs(I[0]-l[0])<le&&Math.abs(I[1]-l[1])<le&&Math.abs(I[2]-l[2])<le&&Math.abs(I[3]-l[3])<le}function F(I,l){return I[0]===l[0]&&I[1]===l[1]&&I[2]===l[2]&&I[3]===l[3]}function Z(I,l,x,g){const k=g??new u(4);return k[0]=I[0]+x*(l[0]-I[0]),k[1]=I[1]+x*(l[1]-I[1]),k[2]=I[2]+x*(l[2]-I[2]),k[3]=I[3]+x*(l[3]-I[3]),k}function ie(I,l,x,g){const k=g??new u(4);return k[0]=I[0]+x[0]*(l[0]-I[0]),k[1]=I[1]+x[1]*(l[1]-I[1]),k[2]=I[2]+x[2]*(l[2]-I[2]),k[3]=I[3]+x[3]*(l[3]-I[3]),k}function ae(I,l,x){const g=x??new u(4);return g[0]=Math.max(I[0],l[0]),g[1]=Math.max(I[1],l[1]),g[2]=Math.max(I[2],l[2]),g[3]=Math.max(I[3],l[3]),g}function me(I,l,x){const g=x??new u(4);return g[0]=Math.min(I[0],l[0]),g[1]=Math.min(I[1],l[1]),g[2]=Math.min(I[2],l[2]),g[3]=Math.min(I[3],l[3]),g}function xe(I,l,x){const g=x??new u(4);return g[0]=I[0]*l,g[1]=I[1]*l,g[2]=I[2]*l,g[3]=I[3]*l,g}const J=xe;function te(I,l,x){const g=x??new u(4);return g[0]=I[0]/l,g[1]=I[1]/l,g[2]=I[2]/l,g[3]=I[3]/l,g}function Ee(I,l){const x=l??new u(4);return x[0]=1/I[0],x[1]=1/I[1],x[2]=1/I[2],x[3]=1/I[3],x}const we=Ee;function tt(I,l){return I[0]*l[0]+I[1]*l[1]+I[2]*l[2]+I[3]*l[3]}function Fe(I){const l=I[0],x=I[1],g=I[2],k=I[3];return Math.sqrt(l*l+x*x+g*g+k*k)}const $e=Fe;function Ne(I){const l=I[0],x=I[1],g=I[2],k=I[3];return l*l+x*x+g*g+k*k}const ze=Ne;function nt(I,l){const x=I[0]-l[0],g=I[1]-l[1],k=I[2]-l[2],S=I[3]-l[3];return Math.sqrt(x*x+g*g+k*k+S*S)}const Ct=nt;function qe(I,l){const x=I[0]-l[0],g=I[1]-l[1],k=I[2]-l[2],S=I[3]-l[3];return x*x+g*g+k*k+S*S}const fe=qe;function de(I,l){const x=l??new u(4),g=I[0],k=I[1],S=I[2],D=I[3],N=Math.sqrt(g*g+k*k+S*S+D*D);return N>1e-5?(x[0]=g/N,x[1]=k/N,x[2]=S/N,x[3]=D/N):(x[0]=0,x[1]=0,x[2]=0,x[3]=0),x}function he(I,l){const x=l??new u(4);return x[0]=-I[0],x[1]=-I[1],x[2]=-I[2],x[3]=-I[3],x}function st(I,l){const x=l??new u(4);return x[0]=I[0],x[1]=I[1],x[2]=I[2],x[3]=I[3],x}const Bt=st;function be(I,l,x){const g=x??new u(4);return g[0]=I[0]*l[0],g[1]=I[1]*l[1],g[2]=I[2]*l[2],g[3]=I[3]*l[3],g}const Ut=be;function ft(I,l,x){const g=x??new u(4);return g[0]=I[0]/l[0],g[1]=I[1]/l[1],g[2]=I[2]/l[2],g[3]=I[3]/l[3],g}const Lt=ft;function dt(I){const l=I??new u(4);return l[0]=0,l[1]=0,l[2]=0,l[3]=0,l}function Tt(I,l,x){const g=x??new u(4),k=I[0],S=I[1],D=I[2],N=I[3];return g[0]=l[0]*k+l[4]*S+l[8]*D+l[12]*N,g[1]=l[1]*k+l[5]*S+l[9]*D+l[13]*N,g[2]=l[2]*k+l[6]*S+l[10]*D+l[14]*N,g[3]=l[3]*k+l[7]*S+l[11]*D+l[15]*N,g}function Et(I,l,x){const g=x??new u(4);return de(I,g),xe(g,l,g)}function L(I,l,x){const g=x??new u(4);return Fe(I)>l?Et(I,l,g):st(I,g)}function q(I,l,x){const g=x??new u(4);return Z(I,l,.5,g)}return{create:e,fromValues:t,set:n,ceil:s,floor:r,round:a,clamp:i,add:c,addScaled:h,subtract:f,sub:w,equalsApproximately:B,equals:F,lerp:Z,lerpV:ie,max:ae,min:me,mulScalar:xe,scale:J,divScalar:te,inverse:Ee,invert:we,dot:tt,length:Fe,len:$e,lengthSq:Ne,lenSq:ze,distance:nt,dist:Ct,distanceSq:qe,distSq:fe,normalize:de,negate:he,copy:st,clone:Bt,multiply:be,mul:Ut,divide:ft,div:Lt,zero:dt,transformMat4:Tt,setLength:Et,truncate:L,midpoint:q}}const mi=new Map;function uo(u){let e=mi.get(u);return e||(e=co(u),mi.set(u,e)),e}function Rr(u,e,t,n,s,r){return{mat3:so(u),mat4:io(e),quat:oo(t),vec2:Qi(n),vec3:or(s),vec4:uo(r)}}const{mat3:gi,mat4:_i,vec2:Do}=Rr(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array);Rr(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array);Rr(Ja,Array,Array,Array,Array,Array);var Ds,tn,ss,rs,kn,ke,Tn,is,Ln,Rn,It,At,Le,St,Fn,cn,qt,En,as,os,cs,$n,nn,kt,xr,wr,vr,ji,xi;let lo=(xi=class extends Hi{constructor(t,n,s,r){super(t,n,"Render");W(this,kt);W(this,Ds);W(this,tn,!1);W(this,ss,gi.identity());W(this,rs,new Float32Array(3));W(this,kn,!1);W(this,ke);W(this,Tn);W(this,is,_i.identity());W(this,Ln);W(this,Rn);W(this,It);W(this,At);W(this,Le);W(this,St);W(this,Fn);W(this,cn,[0,0,0,0]);W(this,qt,[]);W(this,En);W(this,as);W(this,os);W(this,cs,[0,0,0,0]);W(this,$n);W(this,nn);!s&&ee(Y.CANVAS_NOT_FOUND);const a=s.getContext("webgpu");!a&&ee(Y.CONTEXT_NOT_FOUND),a.configure({device:t,...r}),$(this,Ln,this.CreateBuffer({size:p(this,rs).length*Float32Array.BYTES_PER_ELEMENT,label:"Render Pipeline Resolution Buffer",usage:De.UNIFORM})),$(this,ke,s),$(this,Tn,a),Q(this,kt,xr).call(this),$(this,Fn,r.format),this.CreatePassDescriptor(this.CreateColorAttachment())}ConfigureContext(t){const n=t.format??p(this,Fn);p(this,Tn).configure({device:this.Device,format:n,...t})}CreateColorAttachment(t,n="clear",s="store",r,a,i){const c=r&&Q(this,kt,wr).call(this,r);return{view:t,loadOp:n,storeOp:s,clearValue:c,resolveTarget:a,depthSlice:i}}CreateDepthAttachment(t,n=1,s="clear",r="store",a){return $(this,kn,!0),$(this,Rn,new Lr(this.Device)),{view:t,depthClearValue:n,depthLoadOp:s,depthStoreOp:r,depthReadOnly:a}}CreateStencilAttachment(t,n="clear",s="store",r){return{stencilClearValue:t,stencilLoadOp:n,stencilStoreOp:s,stencilReadOnly:r}}CreatePassDescriptor(t,n,s,r,a,i){const c=Array.isArray(t)&&t||[t];return $(this,tn,!c.some(({view:h})=>!!h)),n??(n=this.CreatePipelineLabel("Render Pass")),this.Descriptor={colorAttachments:c,depthStencilAttachment:s,occlusionQuerySet:r,timestampWrites:a,maxDrawCount:i,label:n}}CreateIndexBuffer(t,n){const s=(n==null?void 0:n.label)??"Index Buffer";return t=Array.isArray(t)&&new Uint32Array(t)||t,this.CreateBuffer({label:s,size:t.byteLength,usage:De.INDEX,...n})}CreateVertexBufferAttribute(t,n=0,s=0){return Q(this,kt,vr).call(this,t,n,s)}CreateVertexBufferLayout(t,n,s="vertex"){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,"`LegacyRenderer.CreateVertexBufferLayout`.\n            Call `LegacyRenderer.CreateShaderModule` before creating a vertex layout or vertex buffer.");const{entry:{vertex:r}}=this.Reflect,a=r.find(({name:h})=>s===h);!a&&ee(Y.VERTEX_ENTRY_NOT_FOUND,`\`${s}\` in vertex shader entries.`),t=Array.isArray(t)&&t||[t];let i=[],c=0;for(let h=0,f=t.length;h<f;++h){const w=t[h],B=typeof w=="string",F=B?w:w.name,Z=a.inputs.find(({name:ie})=>F===ie);if(Z){const ie=B?ra(Z.type.size):w.format;i.push(Q(this,kt,vr).call(this,ie,+Z.location,c)),c+=ia(ie);continue}Ve(Y.VERTEX_ATTRIBUTE_NOT_FOUND,`\`${F}\` in vertex shader inputs.`)}return{arrayStride:c,stepMode:n,attributes:i}}CreateVertexBuffer(t,n=1,s,r="vertex"){const a=n.label??"Vertex Buffer";if(t instanceof Float32Array)return this.CreateBuffer({label:a,size:t.byteLength,usage:De.VERTEX,...n});const i=this.CreateVertexBufferLayout(t,s,r),c=(typeof n=="number"&&n||(n.count??1))*i.arrayStride;return{buffer:this.CreateBuffer({label:a,size:c,usage:De.VERTEX,...n}),layout:i}}CreateVertexState(t,n="vertex",s,r){return s=Array.isArray(s)&&s||[s],{module:t,entryPoint:n,buffers:s,constants:r}}CreateBlendComponent(t="add",n="one",s="zero"){return{operation:t,srcFactor:n,dstFactor:s}}CreateTargetState(t=p(this,Fn),n,s){return n&&(n={color:n.color??{},alpha:n.alpha??{}}),{format:t,blend:n,writeMask:s}}CreateFragmentState(t,n="fragment",s,r){return s??(s=this.CreateTargetState()),s=Array.isArray(s)&&s||[s],{module:t,entryPoint:n,targets:s,constants:r}}CreateStencilFaceState(t,n,s,r){return{compare:t,failOp:n,depthFailOp:s,passOp:r}}CreateDepthStencilState(t="depth24plus",n=!0,s="less",r,a,i,c,h,f,w){return{format:t,depthWriteEnabled:n,depthCompare:s,stencilFront:r,stencilBack:a,stencilReadMask:i,stencilWriteMask:c,depthBias:h,depthBiasSlopeScale:f,depthBiasClamp:w}}CreateMultisampleState(t=4,n,s){return{count:t,mask:n,alphaToCoverageEnabled:s}}CreateStorageTextureBindingLayout(t=p(this,Fn),n,s,r,a){return{binding:a,visibility:GPUShaderStage.FRAGMENT,storageTexture:{access:n,format:t,viewDimension:s}}}CreatePipeline(t={},n){let s=this.GetShaderModule(t),{vertex:r,fragment:a}=t;!s&&!r&&(s=this.CreateShaderModule()),s&&(r??(r=this.CreateVertexState(s)),a??(a=this.CreateFragmentState(s)));const i=t.label??this.CreatePipelineLabel("Render Pipeline"),c=t.layout??"auto";return this.SetPipeline(this.Device.createRenderPipeline({label:i,layout:c,vertex:r,fragment:a,...t})),n&&(p(this,Le)?p(this,Le).setPipeline(this.Pipeline):Ve(Y.RENDER_PASS_NOT_FOUND)),this.Pipeline}SavePipelineState(){super.SavePipelineState(),$(this,nn,p(this,St)),$(this,En,p(this,qt)),$(this,cs,p(this,cn)),$(this,$n,p(this,At)),$(this,as,p(this,tn)),$(this,os,p(this,kn)),p(this,nn)&&$(this,nn,Object.values(p(this,nn)))}ResetPipelineState(){var t;super.ResetPipelineState(),this.SetVertexBuffers([]),this.SetIndexBuffer(void 0),$(this,tn,!1),$(this,cs,[0,0,0,0]),$(this,kn,!1),$(this,At,(t=p(this,At))==null?void 0:t.destroy())}RestorePipelineState(){super.RestorePipelineState(),$(this,qt,p(this,En)),$(this,cn,p(this,cs)),$(this,At,p(this,$n)),$(this,tn,p(this,as)),$(this,kn,p(this,os)),this.SetIndexBuffer(...Array.isArray(p(this,nn))&&p(this,nn)||[void 0])}SetVertexBuffers(t,n,s){n=Array.isArray(n)&&n||[n],s=Array.isArray(s)&&s||[s],$(this,qt,Array.isArray(t)&&t.map((r,a)=>({buffer:r,offset:n[a],size:s[a]}))||[{buffer:t,offset:n[0],size:s[0]}])}AddVertexBuffers(t,n,s){n=Array.isArray(n)&&n||[n],s=Array.isArray(s)&&s||[s],p(this,qt).push(...Array.isArray(t)&&t.map((r,a)=>({buffer:r,offset:n[a],size:s[a]}))||[{buffer:t,offset:n[0],size:s[0]}])}SetIndexBuffer(t,n="uint32",s,r){$(this,St,t&&{buffer:t,format:n,offset:s,size:r})}SetCanvasSize(t,n,s=!0){!this.Device&&ee(Y.DEVICE_NOT_FOUND),!p(this,ke)&&ee(Y.CANVAS_NOT_FOUND);let r=this.DevicePixelRatio*t|0,a=this.DevicePixelRatio*n|0;const i=this.Device.limits.maxTextureDimension2D;r=Math.max(1,Math.min(r,i)),a=Math.max(1,Math.min(a,i)),(p(this,ke).width!==r||p(this,ke).height!==a)&&(p(this,ke).height=a,p(this,ke).width=r,Q(this,kt,xr).call(this),s&&(p(this,ke).style.width=`${t}px`,p(this,ke).style.height=`${n}px`))}SetTextureView(t,n=0){this.Descriptor.colorAttachments[n].view=t,$(this,tn,!t)}UpdateOrthographicProjection(t=1,n=1e3,s=0,r=p(this,ke).clientWidth,a=p(this,ke).clientHeight,i=0){return _i.ortho(i,r,a,s,t,n,p(this,is)),p(this,is)}UpdateProjection2D(t=p(this,ke).clientWidth,n=p(this,ke).clientHeight){return gi.set(2/t,0,0,0,-2/n,0,-1,1,1,p(this,ss)),p(this,ss)}Render(t,n=!0){p(this,kn)&&Q(this,kt,ji).call(this),p(this,Le)||(p(this,At)?(this.Descriptor.colorAttachments[0].view=p(this,At).createView(),this.Descriptor.colorAttachments[0].resolveTarget=this.CurrentTextureView):p(this,tn)&&(this.Descriptor.colorAttachments[0].view=this.CurrentTextureView),$(this,Le,this.GetCommandEncoder().beginRenderPass(this.Descriptor)),p(this,Le).setPipeline(this.Pipeline),$(this,Ds,p(this,St)?p(this,Le).drawIndexed.bind(p(this,Le)):p(this,Le).draw.bind(p(this,Le))));for(let s=0,r=p(this,qt).length;s<r;++s){const{buffer:a,offset:i,size:c}=p(this,qt)[s];p(this,Le).setVertexBuffer(s,a,i,c)}p(this,St)&&p(this,Le).setIndexBuffer(p(this,St).buffer,p(this,St).format,p(this,St).offset,p(this,St).size);for(let s=0,r=0,a=this.BindGroups.length;s<a;++s){const{bindGroup:i,dynamicOffsets:c,active:h}=this.BindGroups[s];h&&p(this,Le).setBindGroup(r++,i,c)}p(this,Le).setBlendConstant(p(this,cn)),p(this,Ds).call(this,...Array.isArray(t)&&t||[t]),n&&this.Submit()}DestroyCurrentPass(){var t;(t=p(this,Le))==null||t.end(),$(this,Le,void 0)}Submit(){this.DestroyCurrentPass(),this.SubmitCommandBuffer(),this.SetCommandEncoder(void 0)}get Canvas(){return p(this,ke)}get Context(){return p(this,Tn)}get CurrentPass(){return p(this,Le)}get AspectRatio(){return!p(this,ke)&&ee(Y.CANVAS_NOT_FOUND),p(this,ke).width/p(this,ke).height}get Projection2D(){return p(this,ss)}get DepthTexture(){return p(this,It)}get CurrentTexture(){return p(this,Tn).getCurrentTexture()}get CurrentTextureView(){return this.CurrentTexture.createView()}get OrthographicProjection(){return p(this,is)}set MultisampleTexture(t){$(this,At,t)}get MultisampleTexture(){return p(this,At)}set BlendConstant(t){$(this,cn,Q(this,kt,wr).call(this,t))}get BlendConstant(){return p(this,cn)}get ResolutionBuffer(){return p(this,Ln)}get DevicePixelRatio(){return globalThis.devicePixelRatio??1}set TextureView(t){this.Descriptor.colorAttachments[0].view=t,$(this,tn,!t)}get BaseCanvasSize(){const{width:t,height:n}=p(this,ke),s=this.DevicePixelRatio;return[t/s,n/s]}get CanvasSize(){return[p(this,ke).width,p(this,ke).height]}Destroy(){var t,n,s,r,a,i,c;super.Destroy(),this.DestroyCurrentPass(),p(this,Ln).destroy(),$(this,cn,[0,0,0,0]),$(this,Rn,(t=p(this,Rn))==null?void 0:t.Destroy()),$(this,It,(n=p(this,It))==null?void 0:n.destroy()),$(this,$n,(s=p(this,$n))==null?void 0:s.destroy()),$(this,as,$(this,os,!1)),(r=p(this,En))==null||r.forEach(({buffer:h})=>h.destroy()),p(this,qt).forEach(({buffer:h})=>h.destroy()),(a=p(this,St))==null||a.buffer.destroy(),(i=p(this,nn))==null||i.splice(0),$(this,nn,void 0),(c=p(this,En))==null||c.splice(0),$(this,En,void 0),p(this,qt).splice(0),this.ResetPipelineState(),p(this,Tn).unconfigure()}},Ds=new WeakMap,tn=new WeakMap,ss=new WeakMap,rs=new WeakMap,kn=new WeakMap,ke=new WeakMap,Tn=new WeakMap,is=new WeakMap,Ln=new WeakMap,Rn=new WeakMap,It=new WeakMap,At=new WeakMap,Le=new WeakMap,St=new WeakMap,Fn=new WeakMap,cn=new WeakMap,qt=new WeakMap,En=new WeakMap,as=new WeakMap,os=new WeakMap,cs=new WeakMap,$n=new WeakMap,nn=new WeakMap,kt=new WeakSet,xr=function(){p(this,rs).set([p(this,ke).width,p(this,ke).height,this.DevicePixelRatio]),this.WriteBuffer(p(this,Ln),p(this,rs))},wr=function(t){return t instanceof Ks?t.rgba:t},vr=function(t,n=0,s=0){return{format:t,shaderLocation:n,offset:s}},ji=function(){var r,a;const t=this.CurrentTexture,{width:n,height:s}=t;(!p(this,It)||p(this,It).width!==n||p(this,It).height!==s)&&((r=p(this,It))==null||r.destroy(),$(this,It,p(this,Rn).CreateTextureFromSource(t,{sampleCount:((a=p(this,At))==null?void 0:a.sampleCount)??1,usage:GPUTextureUsage.RENDER_ATTACHMENT,label:"Depth Texture",format:"depth24plus",mipmaps:!1}))),this.Descriptor.depthStencilAttachment.view=p(this,It).createView()},xi);var Ns,wi;let ho=(wi=class extends Hi{constructor(t,n){super(t,n,"Compute");W(this,Ns,[1]);this.CreatePassDescriptor()}CreatePassDescriptor(t,n){return t??(t=this.CreatePipelineLabel("Compute Pass")),this.Descriptor={label:t,timestampWrites:n}}CreatePipeline(t){const n=t.label??this.CreatePipelineLabel("Compute Pipeline"),s=t.layout??"auto",r=this.GetShaderModule(t)??this.CreateShaderModule();return this.SetPipeline(this.Device.createComputePipeline({label:n,layout:s,compute:{module:r,...t}}))}Compute(t=!1){const n=this.GetCommandEncoder().beginComputePass(this.Descriptor);n.setPipeline(this.Pipeline);for(let s=0,r=0,a=this.BindGroups.length;s<a;++s){const{bindGroup:i,dynamicOffsets:c,active:h}=this.BindGroups[s];h&&n.setBindGroup(r++,i,c)}n.dispatchWorkgroups(...p(this,Ns)),n.end(),t&&this.Submit()}Submit(){this.SubmitCommandBuffer(),this.SetCommandEncoder(void 0)}set Workgroups(t){$(this,Ns,Array.isArray(t)&&t||[t])}Destroy(){super.Destroy(),this.Workgroups=1}},Ns=new WeakMap,wi);var In,An,Sn,Vn,Dn,es;class Zi{constructor(e,t,n){W(this,Dn);ct(this,"Pipelines",[]);W(this,In);ct(this,"Device");W(this,An);W(this,Sn);W(this,Vn);$(this,Vn,n),$(this,Sn,t),this.Device=e,$(this,An,this.CreateStageLabel("Command Encoder"))}CreateStageLabel(e){return p(this,Vn)&&e&&`${p(this,Vn)} ${e}`||""}CreateTimestampWrites(e,t=0,n=1){return{querySet:e,beginningOfPassWriteIndex:t,endOfPassWriteIndex:n}}ResolveQuerySet(e,t,n=0,s=e.count,r=0){this.GetCommandEncoder(!0).resolveQuerySet(e,n,s,t,r)}CreateBufferBindingLayout(e,t,n,s,r){return s??(s=Q(this,Dn,es).call(this)),{binding:r,visibility:s,buffer:{type:e,hasDynamicOffset:t,minBindingSize:n}}}CreateSamplerBindingLayout(e,t,n){return t??(t=Q(this,Dn,es).call(this)),{binding:n,visibility:t,sampler:{type:e}}}CreateTextureBindingLayout(e,t,n,s,r){return s??(s=Q(this,Dn,es).call(this)),{binding:r,visibility:s,texture:{sampleType:e,viewDimension:t,multisampled:n}}}CreateStorageTextureBindingLayout(e,t,n,s,r){return s??(s=Q(this,Dn,es).call(this)),{binding:r,visibility:s,storageTexture:{access:t,format:e,viewDimension:n}}}CreateExternalTextureBindingLayout(e,t){return e??(e=Q(this,Dn,es).call(this)),{binding:t,visibility:e,externalTexture:{}}}CreateCommandEncoder(){return $(this,In,this.Device.createCommandEncoder({label:p(this,An)}))}GetCommandEncoder(e=!1){if(!p(this,In)){if(e){const t=`${p(this,An)&&`Label: "${p(this,An)}".`}`;Ve(Y.COMMAND_ENCODER_NOT_FOUND,` ${t} Creating a new one.`)}return this.CreateCommandEncoder()}return p(this,In)}SubmitCommandBuffer(){this.Device.queue.submit([p(this,In).finish()])}CreateBuffer(e){const t=e.label??this.CreateStageLabel("Buffer");return this.Device.createBuffer({label:t,...e})}WriteBuffer(e,t,n=0,s,r){this.Device.queue.writeBuffer(e,n,t,s,r)}CopyBufferToBuffer(e,t,n=t.size,s=0,r=0){this.GetCommandEncoder(!0).copyBufferToBuffer(e,s,t,r,n)}RemovePipeline(e){const t=this.Pipelines.indexOf(e);t<0?(Ve(Y.PIPELINE_NOT_FOUND,`${p(this,Sn)}Pipeline. The following pipeline was not found when
                calling \`${p(this,Sn)==="Render"&&`${p(this,Sn)}er`||"Computation"}.RemovePipeline\` method.`),console.warn(e)):(this.Pipelines[t].Destroy(),this.Pipelines.splice(t,1))}set CommandEncoder(e){$(this,In,e)}set CommandEncoderLabel(e){$(this,An,e)}get Name(){return p(this,Vn)}Destroy(){this.Pipelines.forEach(e=>e.Destroy()),this.CommandEncoder=void 0,this.Pipelines.splice(0)}}In=new WeakMap,An=new WeakMap,Sn=new WeakMap,Vn=new WeakMap,Dn=new WeakSet,es=function(){return p(this,Sn)==="Render"&&GPUShaderStage.FRAGMENT||GPUShaderStage.COMPUTE};var us,lt,Dt,ls,Zs;class Ki{constructor(e,t,n){W(this,ls);W(this,us);ct(this,"Active");W(this,lt);ct(this,"Device");W(this,Dt,[]);ct(this,"Reflect");ct(this,"GPUPipeline");$(this,us,n),$(this,lt,t),this.Active=!0,this.Device=e}CreatePipelineLabel(e){return p(this,us)&&e&&`${p(this,us)} ${e}`||""}CreatePipelineLayout(e,t){return t??(t=this.CreatePipelineLabel(`${p(this,lt)} Pipeline Layout`)),e=et(e),this.Device.createPipelineLayout({label:t,bindGroupLayouts:e})}CreateShaderModule(e,t,n,s){e||(e=Wi,Ve(Y.SHADER_CODE_NOT_FOUND)),t??(t=this.CreatePipelineLabel("Shader Module"));const r=Array.isArray(e)&&e.join(`

`)||e;return this.Reflect=new qi(r),this.Device.createShaderModule({label:t,code:r,sourceMap:n,compilationHints:s})}CreateBuffer(e){const t=e.label??this.CreatePipelineLabel("Buffer");return this.Device.createBuffer({label:t,...e})}CreateReadableBuffer(e){const t=typeof e=="number",n=De.READABLE|(!t&&e.usage||0);let s=t&&e;s||(s=e.size);const r=(e==null?void 0:e.label)??"Readable Buffer";return this.CreateBuffer({label:r,size:s,...e,usage:n})}CreateWritableBuffer(e){const t=typeof e=="number",n=De.WRITABLE|(!t&&e.usage||0);let s=t&&e;s||(s=e.size);const r=(e==null?void 0:e.label)??"Writable Buffer";return this.CreateBuffer({label:r,size:s,...e,usage:n})}CreateUniformBuffer(e,t){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,`\`${p(this,lt)}Pipeline.CreateUniformBuffer\`.
            Use \`${p(this,lt)}Pipeline.CreateShaderModule\` before creating a uniform buffer.`);const n=this.Reflect.uniforms.find(({name:i})=>e===i);!n&&ee(Y.UNIFORM_NOT_FOUND,`\`${e}\` in shader uniforms.`),e==="resolution"&&Ve(Y.INVALID_UNIFORM_NAME,`\`${e}\`.`);const s=(t==null?void 0:t.label)??`${e} Uniform Buffer`,r=new ArrayBuffer(n.size),a=De.UNIFORM|(t==null?void 0:t.usage);return{buffer:this.CreateBuffer({label:s,size:r.byteLength,...t,usage:a}),[e]:Q(this,ls,Zs).call(this,n,r)}}CreateStorageBuffer(e,t=1){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,`\`${p(this,lt)}Pipeline.CreateStorageBuffer\`.
            Use \`${p(this,lt)}Pipeline.CreateShaderModule\` before creating a storage buffer.`);const n=this.Reflect.storage.find(({name:B})=>e===B);!n&&ee(Y.STORAGE_NOT_FOUND,`\`${e}\` in shader bindings.`);const s=typeof t=="number",r=s&&t||t.length,a=De.STORAGE|(!s&&t.usage||0),i=!s&&t.label||`${e} Storage Buffer`,c=n.format.size*r,h=new ArrayBuffer(c),f=B=>(Object.keys(B).forEach(F=>{if(!(B[F].buffer instanceof ArrayBuffer))f(B[F]);else{const Z=B[F].constructor,ie=c/Z.BYTES_PER_ELEMENT;B[F]=new Z(h,0,ie)}}),B),w=Q(this,ls,Zs).call(this,n,h);return{buffer:this.CreateBuffer({label:i,size:c,...t,usage:a}),[e]:w.buffer instanceof ArrayBuffer?new w.constructor(h,0,r):f(w)}}WriteBuffer(e,t,n=0,s,r){this.Device.queue.writeBuffer(e,n,t,s,r)}GetBufferMinBindingSize(e){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,`\`${p(this,lt)}Pipeline.GetBufferMinBindingSize\`.
            Use \`${p(this,lt)}Pipeline.CreateShaderModule\` before requesting buffer's min binding size.`);const n=this.Reflect.getBindGroups().flat().find(({name:s})=>e===s);return(n==null?void 0:n.size)??ee(Y.BINDING_NOT_FOUND,`\`${e}\` in shader bind groups.`)}CreateBindGroupEntries(e,t=0){return Array.isArray(e)&&e.map((n,s)=>({binding:(t==null?void 0:t[s])??s,resource:n}))||[{binding:t,resource:e}]}CreateBindGroupLayout(e,t){return t??(t=this.CreatePipelineLabel("Bind Group Layout")),e=Array.isArray(e)&&e.map((n,s)=>({...n,binding:n.binding??s}))||[{...e,binding:e.binding??0}],this.Device.createBindGroupLayout({entries:e,label:t})}CreateBindGroup(e,t=0,n){return n??(n=this.CreatePipelineLabel("Bind Group")),typeof t=="number"&&(t=this.GPUPipeline?this.GPUPipeline.getBindGroupLayout(t):ee(Y.PIPELINE_NOT_FOUND,`${p(this,lt)}Pipeline.
                    Use \`${p(this,lt)}Stage.AddPipeline\` before creating a bind group.`)),this.Device.createBindGroup({entries:e,label:n,layout:t})}SetBindGroups(e,t){const n=Array.isArray(e),s=Array.isArray(t);t=n&&s?t.map(r=>et(r)):s&&t||t&&[t],t=t&&t||[],$(this,Dt,n&&e.map((r,a)=>({bindGroup:r,dynamicOffsets:t,active:!0}))||[{bindGroup:e,dynamicOffsets:t,active:!0}])}AddBindGroups(e,t){const n=Array.isArray(e),s=Array.isArray(t);return t=n&&s?t.map(r=>et(r)):s&&t||t&&[t],t=t&&t||[],p(this,Dt).push(...n&&e.map(r=>({bindGroup:r,dynamicOffsets:t,active:!0}))||[{bindGroup:e,dynamicOffsets:t,active:!0}])}SetActiveBindGroups(e){e=et(e);for(let t=p(this,Dt).length;t--;)p(this,Dt)[t].active=e.includes(t)}UseBindGroups(e){for(let t=0,n=0,s=p(this,Dt).length;t<s;++t){const{bindGroup:r,dynamicOffsets:a,active:i}=p(this,Dt)[t];i&&e.setBindGroup(n++,r,a)}}GetBindGroupsInfo(){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,`\`${p(this,lt)}Pipeline.GetBindGroupsInfo\`.
            Use \`${p(this,lt)}Pipeline.CreateShaderModule\` before requesting bind groups information.`);const e=p(this,Dt).length,t=new Array(e),n=this.Reflect.getBindGroups();for(let s=0;s<e;++s){const{bindGroup:{label:r},dynamicOffsets:a,active:i}=p(this,Dt)[s];t[s]={label:r,active:i,dynamicOffsets:a,bindings:n[s]}}return t}ClearBindGroups(){p(this,Dt).splice(0)}Destroy(){this.ClearBindGroups()}}us=new WeakMap,lt=new WeakMap,Dt=new WeakMap,ls=new WeakSet,Zs=function(e,t,n=0,s=[]){const{format:r}=e.type,a=e.type.members??(r==null?void 0:r.members);let i=n+(e.offset??0);if(a)for(let c=0,h={},f=(r==null?void 0:r.isStruct)&&e.count||1;c<f;++c)a.forEach(w=>h[w.name]=Q(this,ls,Zs).call(this,w,t,i)),r!=null&&r.isStruct&&(i+=e.stride),s.push(h);else{const c=aa((r??e.type).name),h=e.size/oa(c),f=ca(c);return new f(t,i,h)}return s.length===1&&s[0]||s};var un,Wt,Ms,hs,Ht,ar,Ji;class fo extends Ki{constructor(t,n,s){super(t,"Render",s);W(this,ar);ct(this,"DestroyPassEncoder",!1);W(this,un,[]);W(this,Wt);W(this,Ms);ct(this,"TextureView");W(this,hs,[0,0,0,0]);W(this,Ht,[0,void 0,void 0,void 0,void 0]);$(this,Ms,n)}async Init(t={}){let n=cr(t),{vertex:s,fragment:r}=t;!n&&!s&&(n=this.CreateShaderModule()),n&&(s??(s=this.CreateVertexState(n)),r??(r=this.CreateFragmentState(n)));const a=t.label??this.CreatePipelineLabel("Render Pipeline"),i=t.layout??"auto";return this.GPUPipeline=await this.Device.createRenderPipelineAsync({label:a,layout:i,vertex:s,fragment:r,...t})}CreateBlendComponent(t="add",n="one",s="zero"){return{operation:t,srcFactor:n,dstFactor:s}}CreateColorTargetState(t=p(this,Ms),n,s){return n&&(n={color:n.color??{},alpha:n.alpha??{}}),{format:t,blend:n,writeMask:s}}CreateMultisampleState(t=4,n,s){return{count:t,mask:n,alphaToCoverageEnabled:s}}CreateStencilFaceState(t,n,s,r){return{compare:t,failOp:n,depthFailOp:s,passOp:r}}CreateDepthStencilState(t="depth24plus",n=!0,s="less",r,a,i,c,h,f,w){return{format:t,depthWriteEnabled:n,depthCompare:s,stencilFront:r,stencilBack:a,stencilReadMask:i,stencilWriteMask:c,depthBias:h,depthBiasSlopeScale:f,depthBiasClamp:w}}CreateVertexState(t,n="vertex",s,r){return s=et(s),{module:t,entryPoint:n,buffers:s,constants:r}}CreateFragmentState(t,n="fragment",s,r){return s??(s=this.CreateColorTargetState()),s=et(s),{module:t,entryPoint:n,targets:s,constants:r}}CreateVertexBufferLayout(t,n,s="vertex"){!this.Reflect&&ee(Y.SHADER_MODULE_NOT_FOUND,"`RenderPipeline.CreateVertexBufferLayout`.\n            Call `RenderPipeline.CreateShaderModule` before creating a vertex layout or vertex buffer.");const{entry:{vertex:r}}=this.Reflect,a=r.find(({name:h})=>s===h);!a&&ee(Y.VERTEX_ENTRY_NOT_FOUND,`\`${s}\` in vertex shader entries.`),t=et(t);let i=[],c=0;for(let h=0,f=t.length;h<f;++h){const w=t[h],B=typeof w=="string",F=B?w:w.name,Z=a.inputs.find(({name:ie})=>F===ie);if(Z){const ie=B?ra(Z.type.size):w.format;i.push(Q(this,ar,Ji).call(this,ie,+Z.location,c)),c+=ia(ie);continue}Ve(Y.VERTEX_ATTRIBUTE_NOT_FOUND,`\`${F}\` in vertex shader inputs.`)}return{arrayStride:c,stepMode:n,attributes:i}}CreateVertexBuffer(t,n=1,s,r="vertex"){const a=typeof n=="number",i=!a&&n.label||"Vertex Buffer",c=De.VERTEX|(!a&&n.usage||0);if(t instanceof Float32Array)return this.CreateBuffer({label:i,size:t.byteLength,...n,usage:c});const h=this.CreateVertexBufferLayout(t,s,r),f=(a&&n||(n.count??1))*h.arrayStride;return{buffer:this.CreateBuffer({label:i,size:f,...n,usage:c}),layout:h}}SetVertexBuffers(t,n,s){s=et(s),n=et(n),$(this,un,Array.isArray(t)&&t.map((r,a)=>({buffer:r,offset:n[a],size:s[a]}))||[{buffer:t,offset:n[0],size:s[0]}])}AddVertexBuffers(t,n,s){return s=et(s),n=et(n),p(this,un).push(...Array.isArray(t)&&t.map((r,a)=>({buffer:r,offset:n[a],size:s[a]}))||[{buffer:t,offset:n[0],size:s[0]}])}CreateIndexBuffer(t,n){const s=De.INDEX|(n==null?void 0:n.usage),r=(n==null?void 0:n.label)??"Index Buffer";return t=Array.isArray(t)&&new Uint32Array(t)||t,this.CreateBuffer({label:r,size:t.byteLength,...n,usage:s})}SetIndexBuffer(t,n="uint32",s,r){$(this,Wt,t&&{buffer:t,format:n,offset:s,size:r})}UseRenderBuffers(t){for(let n=0,s=p(this,un).length;n<s;++n){const{buffer:r,offset:a,size:i}=p(this,un)[n];t.setVertexBuffer(n,r,a,i)}p(this,Wt)&&t.setIndexBuffer(p(this,Wt).buffer,p(this,Wt).format,p(this,Wt).offset,p(this,Wt).size)}SetDrawParams(t,n,s,r,a){p(this,Ht)[0]=t,p(this,Ht)[1]=n,p(this,Ht)[2]=s,p(this,Ht)[3]=r,p(this,Ht)[4]=a,a!==void 0&&(p(this,Ht)[3]=a,p(this,Ht)[4]=r)}get ColorAttachment(){return 0}set BlendConstant(t){$(this,hs,ua(t))}get BlendConstant(){return p(this,hs)}get DrawMethod(){return p(this,Wt)&&"drawIndexed"||"draw"}get DrawParams(){return p(this,Ht)}Destroy(){var t;super.Destroy(),this.DestroyPassEncoder=!1,$(this,hs,[0,0,0,0]),p(this,un).forEach(({buffer:n})=>n.destroy()),(t=p(this,Wt))==null||t.buffer.destroy(),p(this,un).splice(0)}}un=new WeakMap,Wt=new WeakMap,Ms=new WeakMap,hs=new WeakMap,Ht=new WeakMap,ar=new WeakSet,Ji=function(t,n=0,s=0){return{format:t,shaderLocation:n,offset:s}};class po extends Ki{constructor(e,t){super(e,"Compute",t)}async Init(e){const t=e.label??this.CreatePipelineLabel("Compute Pipeline"),n=e.layout??"auto",s=cr(e)??this.CreateShaderModule();return this.GPUPipeline=await this.Device.createComputePipelineAsync({label:t,layout:n,compute:{module:s,...e}})}}var Os,Ps,Cs,br;class mo extends Zi{constructor(t,n){super(t,"Compute",n);W(this,Cs);W(this,Os,[1]);W(this,Ps);this.CreatePassDescriptor()}CreatePassDescriptor(t,n){return t??(t=this.CreateStageLabel("Compute Pass")),$(this,Ps,{label:t,timestampWrites:n})}GetMaxEvenWorkgroupDimension(t=1){const{maxComputeInvocationsPerWorkgroup:n}=this.Device.limits;return(t===3?Math.cbrt(n):t===2?Math.sqrt(n):n)|0}async CreatePipeline(t){const n=new this.Pipeline(t.pipelineName);return t=cr(t)??n.CreateShaderModule(...Object.values((Array.isArray(t)||typeof t=="string")&&[t]||t)),await this.AddPipeline(n,t),n}async AddPipeline(t,n){return await t.Init(n),Reflect.deleteProperty(t,"Init"),this.Pipelines.push(t),t}Compute(t=!0){const n=this.GetCommandEncoder().beginComputePass(p(this,Ps)),s=this.Pipelines.length;if(!(s-1)&&this.Pipelines[0].Active)Q(this,Cs,br).call(this,n,this.Pipelines[0]);else for(let r=0;r<s;++r){const a=this.Pipelines[r];a.Active&&Q(this,Cs,br).call(this,n,a)}t&&this.Submit()}Submit(){this.SubmitCommandBuffer(),this.CommandEncoder=void 0}set Workgroups(t){$(this,Os,et(t).map(Math.ceil))}get Pipeline(){const{Name:t,Device:n}=this;return class extends po{constructor(s=t){super(n,s)}}}Destroy(){super.Destroy(),this.Workgroups=1}}Os=new WeakMap,Ps=new WeakMap,Cs=new WeakSet,br=function(t,n){t.setPipeline(n.GPUPipeline),n.UseBindGroups(t),t.dispatchWorkgroups(...p(this,Os)),t.end()};var Bs,fs,Us,Me,Nn,Gn,zn,Ls,qn,Nt,Wn,Mn,Ke,Qt,ea,_o,kr,Tr;class go extends Zi{constructor(t,n,s,r){super(t,"Render",n);W(this,Qt);W(this,Bs);W(this,fs,new Float32Array(3));W(this,Us,!1);W(this,Me);W(this,Nn);W(this,Gn);W(this,zn);W(this,Ls);W(this,qn);W(this,Nt);W(this,Wn);W(this,Mn);W(this,Ke);!s&&ee(Y.CANVAS_NOT_FOUND);const a=s.getContext("webgpu");!a&&ee(Y.CONTEXT_NOT_FOUND),a.configure({device:t,...r}),$(this,Gn,this.CreateBuffer({size:p(this,fs).length*Float32Array.BYTES_PER_ELEMENT,label:"Render Pipeline Resolution Buffer",usage:De.UNIFORM})),$(this,Me,s),$(this,Nn,a),Q(this,Qt,kr).call(this),$(this,Wn,r.format),this.CreatePassDescriptor(this.CreateColorAttachment())}ConfigureContext(t){const n=t.format??p(this,Wn);p(this,Nn).configure({device:this.Device,format:n,...t})}CreateColorAttachment(t,n,s="clear",r="store",a,i){const c=t&&ua(t);return{view:n,loadOp:s,storeOp:r,clearValue:c,resolveTarget:a,depthSlice:i}}CreateStencilAttachment(t=0,n="clear",s="store",r){return{stencilClearValue:t,stencilLoadOp:n,stencilStoreOp:s,stencilReadOnly:r}}CreateDepthStencilAttachment(t,n=1,s="clear",r="store",a,i){return $(this,Us,!0),$(this,zn,new Lr(this.Device)),{view:t,depthClearValue:n,depthLoadOp:s,depthStoreOp:r,depthReadOnly:a,...i}}CreatePassDescriptor(t,n,s,r,a,i){const c=et(t);return s??(s=this.CreateStageLabel("Render Pass")),$(this,qn,{colorAttachments:c,depthStencilAttachment:n,occlusionQuerySet:r,timestampWrites:a,maxDrawCount:i,label:s})}CreateStorageTextureBindingLayout(t=p(this,Wn),n,s,r,a){return{binding:a,visibility:GPUShaderStage.FRAGMENT,storageTexture:{access:n,format:t,viewDimension:s}}}SetCanvasSize(t,n,s=!0){!this.Device&&ee(Y.DEVICE_NOT_FOUND),!p(this,Me)&&ee(Y.CANVAS_NOT_FOUND);let r=this.DevicePixelRatio*t|0,a=this.DevicePixelRatio*n|0;const i=this.Device.limits.maxTextureDimension2D;r=Math.max(1,Math.min(r,i)),a=Math.max(1,Math.min(a,i)),(p(this,Me).width!==r||p(this,Me).height!==a)&&(p(this,Me).height=a,p(this,Me).width=r,Q(this,Qt,kr).call(this),s&&(p(this,Me).style.width=`${t}px`,p(this,Me).style.height=`${n}px`))}async CreatePipeline(t,n){const s=new this.Pipeline(t.pipelineName);return t=cr(t)??s.CreateShaderModule(...Object.values((Array.isArray(t)||typeof t=="string")&&[t]||t)),await this.AddPipeline(s,t,n),s}async AddPipeline(t,n,s){const r=await t.Init(n);return s&&(p(this,Ke)?p(this,Ke).setPipeline(r):Ve(Y.RENDER_PASS_NOT_FOUND)),Reflect.deleteProperty(t,"Init"),this.Pipelines.push(t),t}Render(t=!0){p(this,Us)&&Q(this,Qt,ea).call(this);const n=this.Pipelines.length;if(!(n-1)&&this.Pipelines[0].Active)Q(this,Qt,Tr).call(this,this.Pipelines[0],t);else for(let s=0;s<n;++s){const r=this.Pipelines[s];r.Active&&Q(this,Qt,Tr).call(this,r,t)}t&&this.Submit()}DestroyRenderPass(){var t;(t=p(this,Ke))==null||t.end(),$(this,Ke,void 0)}Submit(){this.DestroyRenderPass(),this.SubmitCommandBuffer(),this.CommandEncoder=void 0}get Canvas(){return p(this,Me)}get Context(){return p(this,Nn)}get RenderPass(){return p(this,Ke)}get DepthTexture(){return p(this,Nt)}get CurrentTexture(){return p(this,Nn).getCurrentTexture()}get CurrentTextureView(){return this.CurrentTexture.createView()}set MultisampleTexture(t){$(this,Mn,t)}get MultisampleTexture(){return p(this,Mn)}set DevicePixelRatio(t){$(this,Ls,t)}get DevicePixelRatio(){return p(this,Ls)??globalThis.devicePixelRatio??1}get ResolutionBuffer(){return p(this,Gn)}get BaseCanvasSize(){const{width:t,height:n}=p(this,Me),s=this.DevicePixelRatio;return[t/s,n/s]}get CanvasSize(){return[p(this,Me).width,p(this,Me).height]}get AspectRatio(){return!p(this,Me)&&ee(Y.CANVAS_NOT_FOUND),p(this,Me).width/p(this,Me).height}get Pipeline(){const{Name:t,Device:n}=this,s=p(this,Wn);return class extends fo{constructor(r=t){super(n,s,r)}}}Destroy(){var t,n;super.Destroy(),this.DestroyRenderPass(),p(this,Gn).destroy(),$(this,Nt,(t=p(this,Nt))==null?void 0:t.destroy()),$(this,zn,(n=p(this,zn))==null?void 0:n.Destroy()),p(this,Nn).unconfigure()}}Bs=new WeakMap,fs=new WeakMap,Us=new WeakMap,Me=new WeakMap,Nn=new WeakMap,Gn=new WeakMap,zn=new WeakMap,Ls=new WeakMap,qn=new WeakMap,Nt=new WeakMap,Wn=new WeakMap,Mn=new WeakMap,Ke=new WeakMap,Qt=new WeakSet,ea=function(){var r,a;const t=this.CurrentTexture,{width:n,height:s}=t;(!p(this,Nt)||p(this,Nt).width!==n||p(this,Nt).height!==s)&&((r=p(this,Nt))==null||r.destroy(),$(this,Nt,p(this,zn).CreateTextureFromSource(t,{sampleCount:((a=p(this,Mn))==null?void 0:a.sampleCount)??1,usage:GPUTextureUsage.RENDER_ATTACHMENT,label:"Depth Texture",format:"depth24plus",mipmaps:!1}))),p(this,qn).depthStencilAttachment.view=p(this,Nt).createView()},_o=function(t,n=0,s=0){return{format:t,shaderLocation:n,offset:s}},kr=function(){p(this,fs).set([p(this,Me).width,p(this,Me).height,this.DevicePixelRatio]),this.WriteBuffer(p(this,Gn),p(this,fs))},Tr=function(t,n){if(!p(this,Ke)){let s="view";const r=p(this,qn).colorAttachments[t.ColorAttachment];p(this,Mn)&&(s="resolveTarget",r.view=p(this,Mn).createView()),r[s]=t.TextureView||this.CurrentTextureView,$(this,Ke,this.GetCommandEncoder().beginRenderPass(p(this,qn))),$(this,Bs,p(this,Ke)[t.DrawMethod].bind(p(this,Ke))),p(this,Ke).setPipeline(t.GPUPipeline)}t.UseRenderBuffers(p(this,Ke)),t.UseBindGroups(p(this,Ke)),p(this,Ke).setBlendConstant(t.BlendConstant),p(this,Bs).call(this,...t.DrawParams),t.DestroyPassEncoder&&!n&&this.DestroyRenderPass()};var ds,Hn,ps,ms,sn,bt,ks,ta,na,sa;const Ft=class Ft{static async CreateQuerySet(e,t){const s=(await this.GPUDevice).createQuerySet({type:e,count:t});return p(this,ds).push(s),s}static RenderPipeline(e,t="",n={}){return n.format??(n.format=this.PreferredCanvasFormat),Q(this,bt,ks).call(this,t),(async()=>{const s=await this.GPUDevice;return new Proxy(lo,{construct(r){return new r(s,t,e,n)}})})()}static Renderer(e,t="",n={}){return n.format??(n.format=this.PreferredCanvasFormat),Q(this,bt,ks).call(this,t),(async()=>{const s=await this.GPUDevice;return new Proxy(go,{construct(r){return new r(s,t,e,n)}})})()}static ComputePipeline(e=""){return Q(this,bt,ks).call(this,e),(async()=>{const t=await this.GPUDevice;return new Proxy(ho,{construct(n){return new n(t,e)}})})()}static Computation(e=""){return Q(this,bt,ks).call(this,e),(async()=>{const t=await this.GPUDevice;return new Proxy(mo,{construct(n){return new n(t,e)}})})()}static LegacyTexture(e){return(async()=>{const t=await this.GPUDevice;return new Proxy(ui,{construct(n){return new ui(t,e)}})})()}static Texture(e){return(async()=>{const t=await this.GPUDevice;return new Proxy(Lr,{construct(n){return new n(t,e)}})})()}static Destroy(e,t){var n;p(this,ds).forEach(s=>s.destroy()),e=et(e),e.forEach(s=>s==null?void 0:s.destroy()),t=et(t),t.forEach(s=>s==null?void 0:s.destroy()),(n=p(this,Hn))==null||n.destroy(),p(this,ds).splice(0),p(this,sn).requiredFeatures.clear(),$(this,ps,$(this,Hn,null)),this.DescriptorLabel=this.RequiredLimits=void 0,this.PowerPreference=this.ForceFallbackAdapter=void 0}static set PowerPreference(e){p(this,ms).powerPreference=e}static set ForceFallbackAdapter(e){p(this,ms).forceFallbackAdapter=e}static set DescriptorLabel(e){p(this,sn).label=e}static async SetRequiredFeatures(e){const t=(await this.Adapter).features;return e=et(e),e.forEach(n=>t.has(n)?p(this,sn).requiredFeatures.add(n):Ve(Y.FEATURE_NOT_FOUND,`"${n}".
It will be skipped when requesting a GPUDevice.`)),p(this,sn).requiredFeatures}static set RequiredLimits(e){p(this,sn).requiredLimits=e}static get PreferredCanvasFormat(){return!navigator.gpu&&ee(Y.WEBGPU_NOT_SUPPORTED),navigator.gpu.getPreferredCanvasFormat()}static get Adapter(){return(async()=>p(this,ps)??await Q(this,bt,na).call(this)())()}static get GPUDevice(){return(async()=>p(this,Hn)??await Q(this,bt,sa).call(this)())()}static set OnDeviceLost(e){this.OnLost=e}static get OnDeviceLost(){return this.OnLost}static get Device(){return this.GPUDevice}static get VERSION(){return"0.0.12"}};ds=new WeakMap,Hn=new WeakMap,ps=new WeakMap,ms=new WeakMap,sn=new WeakMap,bt=new WeakSet,ks=function(e){var t;(t=p(this,sn)).label??(t.label=e&&`${e} Device`||"")},ta=function(e){if(Ft.OnLost)return Ft.OnLost(e);const t=(e.message&&` | Message: ${e.message}`)??".";ee(Y.DEVICE_LOST,`Reason: ${e.reason}`+t)},na=function(){return!navigator.gpu&&ee(Y.WEBGPU_NOT_SUPPORTED),async()=>{const e=await navigator.gpu.requestAdapter(p(this,ms));return!e&&ee(Y.ADAPTER_NOT_FOUND),$(this,ps,e)}},sa=function(){return async()=>{const{requiredFeatures:e,requiredLimits:t,label:n}=p(this,sn),s=await(await this.Adapter).requestDevice({requiredFeatures:e,requiredLimits:t,defaultQueue:{label:n}});return!s&&ee(Y.DEVICE_NOT_FOUND),s.lost.then(Q(this,bt,ta)),$(this,Hn,s)}},W(Ft,bt),W(Ft,ds,[]),W(Ft,Hn,null),W(Ft,ps,null),W(Ft,ms,{powerPreference:void 0,forceFallbackAdapter:!1}),ct(Ft,"OnLost"),W(Ft,sn,{label:void 0,requiredFeatures:new Set,requiredLimits:void 0});let Yt=Ft;var ln,pt,gs,_s,mt,Rs,Er;class yo{constructor(e){W(this,Rs);W(this,ln);W(this,pt);W(this,gs,[]);W(this,_s,!1);W(this,mt);$(this,mt,e),Yt.GPUDevice.then(({features:t})=>{t.has("timestamp-query")?($(this,_s,!0),Q(this,Rs,Er).call(this)):Ve(Y.TIMESTAMP_QUERY_NOT_FOUND)})}async ResolveAndSubmit(){if(!p(this,mt).RenderPass&&ee(Y.RENDER_PASS_ENDED),!this.Enabled)return p(this,mt).Submit(),NaN;p(this,mt).DestroyRenderPass();const e=p(this,gs).pop()??p(this,mt).CreateBuffer({size:p(this,ln).size,usage:De.READABLE});p(this,mt).ResolveQuerySet(p(this,pt),p(this,ln)),p(this,mt).CopyBufferToBuffer(p(this,ln),e),p(this,mt).SubmitCommandBuffer(),p(this,mt).CommandEncoder=void 0,await e.mapAsync(GPUMapMode.READ);const t=new BigInt64Array(e.getMappedRange()),n=Number(t[1]-t[0]);return e.unmap(),p(this,gs).push(e),n}get QuerySet(){return p(this,pt)??(async()=>{if(!(await Yt.GPUDevice).features.has("timestamp-query"))Ve(Y.TIMESTAMP_QUERY_NOT_FOUND);else return await Q(this,Rs,Er).call(this),p(this,pt)})()}get Enabled(){return p(this,_s)}Destroy(){var e,t;$(this,_s,!1),$(this,pt,(e=p(this,pt))==null?void 0:e.destroy()),$(this,ln,(t=p(this,ln))==null?void 0:t.destroy())}}ln=new WeakMap,pt=new WeakMap,gs=new WeakMap,_s=new WeakMap,mt=new WeakMap,Rs=new WeakSet,Er=async function(){return p(this,pt)?p(this,pt):($(this,pt,await Yt.CreateQuerySet("timestamp",2)),p(this,gs).push(p(this,mt).CreateBuffer({label:"GPUTiming Result Buffer",size:p(this,pt).count*8,usage:De.READABLE})),$(this,ln,p(this,mt).CreateBuffer({label:"GPUTiming Resolve Buffer",size:p(this,pt).count*8,usage:De.QUERY})),p(this,pt))};var Xt,hn,gt,Xn,ys,Cn,Ir,Ar;class xo{constructor(e){W(this,Cn);W(this,Xt);W(this,hn);W(this,gt);W(this,Xn,!1);W(this,ys,[]);$(this,Xt,e),Yt.GPUDevice.then(({features:t})=>{t.has("timestamp-query")&&($(this,Xn,!0),Q(this,Cn,Ir).call(this))})}async ResolveAndSubmit(){if(!p(this,Xn))return Q(this,Cn,Ar).call(this),NaN;const e=p(this,ys).pop()||p(this,Xt).CreateBuffer({size:p(this,hn).size,usage:De.READABLE});p(this,Xt).ResolveQuerySet(p(this,gt),p(this,hn)),p(this,Xt).CopyBufferToBuffer(p(this,hn),e),Q(this,Cn,Ar).call(this),await e.mapAsync(GPUMapMode.READ);const t=new BigInt64Array(e.getMappedRange()),n=Number(t[1]-t[0]);return e.unmap(),p(this,ys).push(e),n}get QuerySet(){return p(this,gt)??(async()=>{if(!(await Yt.GPUDevice).features.has("timestamp-query"))Ve(Y.TIMESTAMP_QUERY_NOT_FOUND);else return await Q(this,Cn,Ir).call(this),p(this,gt)})()}get Enabled(){return p(this,Xn)}Destroy(){var e,t;$(this,Xn,!1),$(this,gt,(e=p(this,gt))==null?void 0:e.destroy()),$(this,hn,(t=p(this,hn))==null?void 0:t.destroy())}}Xt=new WeakMap,hn=new WeakMap,gt=new WeakMap,Xn=new WeakMap,ys=new WeakMap,Cn=new WeakSet,Ir=async function(){return p(this,gt)?p(this,gt):($(this,gt,await Yt.CreateQuerySet("timestamp",2)),p(this,ys).push(p(this,Xt).CreateBuffer({label:"LegacyGPUTiming Result Buffer",size:p(this,gt).count*8,usage:De.READABLE})),$(this,hn,p(this,Xt).CreateBuffer({label:"LegacyGPUTiming Resolve Buffer",size:p(this,gt).count*8,usage:De.QUERY})),p(this,gt))},Ar=function(){p(this,Xt).SubmitCommandBuffer(),p(this,Xt).SetCommandEncoder(void 0)};function Pe(u){for(let e in u)u[e]={value:u[e]};return Object.freeze(Object.create(null,u))}function wo(u){return vi.RAD*u}function vo(u){return vi.DEG*u}function bo(u,e){return(u%e+e)%e}function ko(u,e=0,t=1){return u<=e?0:u>=t?1:(u=(u-e)/(t-e),u*u*u*(u*(u*6-15)+10))}function To(u,e=0,t=1){return u<=e?0:u>=t?1:(u=(u-e)/(t-e),u*u*(3-2*u))}function ra(u){switch(u){case 2:return"unorm8x2";case 4:return"float32";case 8:return"float32x2";case 12:return"float32x3";case 16:return"float32x4"}}function ia(u){switch(u){case"uint8x2":case"sint8x2":case"unorm8x2":case"snorm8x2":return 2;case"uint32":case"sint32":case"float32":case"uint8x4":case"sint8x4":case"unorm8x4":case"snorm8x4":case"uint16x2":case"sint16x2":case"unorm16x2":case"snorm16x2":case"float16x2":return 4;case"uint16x4":case"sint16x4":case"uint32x2":case"sint32x2":case"unorm16x4":case"snorm16x4":case"float16x4":case"float32x2":return 8;case"uint32x3":case"sint32x3":case"float32x3":return 12;case"uint32x4":case"sint32x4":case"float32x4":return 16}return 0}function aa(u){return u==="f16"||u.includes("h")?"f16":u.includes("f")?"f32":u.includes("u")?"u32":"i32"}function oa(u){return+u.slice(1)/8}function ca(u){return u==="f16"&&ee(Y.FORMAT_NOT_SUPPORTED,`${u}.`),u==="f32"?Float32Array:u==="u32"?Uint32Array:Int32Array}function et(u){return Array.isArray(u)&&u||[u]}function ua(u){return u instanceof Ks?u.rgba:u}function cr(u){return u instanceof GPUShaderModule&&u||u.module}/**
 * @module UWAL
 * @author Ustym Ukhman <ustym.ukhman@gmail.com>
 * @description Unopinionated WebGPU Abstraction Library
 * @version 0.0.12
 * @license MIT
 */const Oo={DegreesToRadians:wo,RadiansToDegrees:vo,LegacyGPUTiming:xo,EuclideanModulo:bo,SmootherStep:ko,SmoothStep:To,GPUTiming:yo};console.info("%cUWAL v0.0.12","background:#005a9c;padding:3px;color:#fff;");export{So as A,Io as B,Ks as C,Yt as D,Y as E,ir as F,et as G,vi as N,ee as T,Oo as U,_i as a,De as b,Pe as c,wo as d,gi as m,Do as v};
